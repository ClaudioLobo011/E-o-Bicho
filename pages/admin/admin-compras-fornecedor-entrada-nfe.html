<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Entrada de NF-e - E o Bicho</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="../../src/output.css">
</head>
<body class="bg-gray-100">
  <div id="admin-header-placeholder"></div>

  <main class="container mx-auto px-4 pt-1 pb-8 min-h-screen">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      <aside class="md:col-span-4">
        <div id="admin-sidebar-placeholder"></div>
      </aside>

      <div class="md:col-span-4 space-y-6">
        <header class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="space-y-2">
            <div class="flex items-center gap-2 text-sm text-gray-500">
              <span class="inline-flex items-center gap-1 rounded-full bg-primary/10 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-primary">
                <i class="fas fa-shopping-basket"></i>
                Compras
              </span>
              <i class="fas fa-angle-right text-xs"></i>
              <span class="font-medium text-gray-600">Fornecedores</span>
              <i class="fas fa-angle-right text-xs"></i>
              <span class="font-semibold text-gray-800">Entrada de NF-e</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">Entrada de NF-e</h1>
              <p class="text-sm text-gray-600">Cadastre entradas modelo 55 com dados exigidos pelo Manual de Orientação do Contribuinte 4.0 e notas técnicas vigentes para NFC-e, NF-e e NFSe.</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button type="button" data-open-import-modal class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
              <i class="fas fa-file-upload"></i>
              Importar XML
            </button>
            <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
              <i class="fas fa-barcode"></i>
              Consultar SEFAZ
            </button>
          </div>
        </header>

        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
          <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-gray-800">Cabeçalho da Nota</h2>
              <p class="text-sm text-gray-500">Preencha o identificador da nota, dados do fornecedor e referência numérica conforme layout nacional da NF-e/NFC-e.</p>
            </div>
            <div class="rounded-lg border border-emerald-100 bg-emerald-50 px-4 py-2 text-right">
              <span class="text-xs font-medium text-emerald-700 block">Total da Nota</span>
              <span class="text-xl font-bold text-emerald-900" data-nfe-total>R$ 0,00</span>
              <p class="text-[11px] text-emerald-700">Somatório automático dos itens</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label for="nfe-code" class="block text-sm font-medium text-gray-700 mb-1">Código</label>
              <div class="relative">
                <input type="text" id="nfe-code" class="w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500" value="Gerado automaticamente" readonly>
                <span class="absolute inset-y-0 right-3 flex items-center text-gray-400 text-xs">AUTO</span>
              </div>
            </div>
            <div>
              <label for="nfe-number" class="block text-sm font-medium text-gray-700 mb-1">NF* (número da nota)</label>
              <input type="text" id="nfe-number" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="10245" required>
            </div>
            <div>
              <label for="nfe-supplier" class="block text-sm font-medium text-gray-700 mb-1">Fornecedor*</label>
              <select id="nfe-supplier" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                <option value="">Selecione o fornecedor</option>
                <option value="30090856000160">30290856000160 - Distribuidora Nacional de Produtos Veterinários Ltda</option>
                <option value="06117473000150">06117473000150 - MSD Saúde Animal Comércio de Produtos Veterinários Ltda</option>
                <option value="07404231000110">07404231000110 - Ourofino Saúde Animal Ltda</option>
              </select>
            </div>
            <div>
              <label for="nfe-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
              <select id="nfe-type" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                <option value="NF" selected>NF</option>
                <option value="NFCe">NFC-e</option>
                <option value="NFSe">NFS-e</option>
              </select>
            </div>
            <div>
              <label for="nfe-series" class="block text-sm font-medium text-gray-700 mb-1">Série</label>
              <input type="text" id="nfe-series" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1">
            </div>
            <div>
              <label for="nfe-protocol" class="block text-sm font-medium text-gray-700 mb-1">Protocolo SEFAZ</label>
              <input type="text" id="nfe-protocol" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240784593211000160550010004273341431819234">
              <p class="mt-1 text-xs text-gray-500">Número conforme retorno da autorização na SEFAZ.</p>
            </div>
            <div class="lg:col-span-2">
              <label for="nfe-reference" class="block text-sm font-medium text-gray-700 mb-1">Referência Fiscal</label>
              <input type="text" id="nfe-reference" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="NF-e emitida pela SEFAZ/SP em ambiente de produção">
            </div>
          </div>
        </section>

        <section class="bg-white rounded-xl shadow-sm border border-gray-100">
          <nav class="flex flex-wrap gap-2 border-b border-gray-100 px-6 pt-6">
            <button type="button" class="tab-button active" data-tab="dados">Dados da Nota</button>
            <button type="button" class="tab-button" data-tab="totais">Totais da Nota</button>
            <button type="button" class="tab-button" data-tab="observacoes">Obs / Outras Informações</button>
            <button type="button" class="tab-button" data-tab="produtos">Produtos</button>
            <button type="button" class="tab-button" data-tab="transportadora">Transportadora</button>
            <button type="button" class="tab-button" data-tab="duplicatas">Duplicatas</button>
            <button type="button" class="tab-button" data-tab="ajustes">Débitos e Créditos</button>
            <button type="button" class="tab-button" data-tab="documentos">Documentos Vinculados</button>
          </nav>

          <div class="p-6 space-y-6">
            <div class="tab-panel" data-tab-panel="dados">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="issue-date" class="block text-sm font-medium text-gray-700 mb-1">Data Emissão*</label>
                  <input type="date" id="issue-date" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                </div>
                <div>
                  <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Empresa*</label>
                  <select id="company" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="vila-bicho">VILA E O BICHO LTDA - CNPJ 11.222.333/0001-44</option>
                    <option value="vilabicho-filial">VILA E O BICHO VAREJO LTDA - CNPJ 33.444.555/0001-66</option>
                  </select>
                </div>
                <div>
                  <label for="nfe-model" class="block text-sm font-medium text-gray-700 mb-1">Modelo da Nota Fiscal*</label>
                  <select id="nfe-model" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="55" selected>55 – Nota Fiscal Eletrônica (NF-e)</option>
                    <option value="65">65 – Nota Fiscal de Consumidor Eletrônica (NFC-e)</option>
                    <option value="57">57 – Conhecimento de Transporte Eletrônico (CT-e)</option>
                    <option value="nfs-e">NFS-e – Nota Fiscal de Serviços Eletrônica</option>
                  </select>
                </div>
                <div>
                  <label for="access-key" class="block text-sm font-medium text-gray-700 mb-1">Chave da NFe (44 dígitos)</label>
                  <input type="text" id="access-key" maxlength="44" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240730290856000160550010000100011999999999">
                  <p class="mt-1 text-xs text-gray-500">Composição: cUF + AAMM + CNPJ + modelo + série + número + tpEmis + cNF + DV.</p>
                </div>
                <div>
                  <label for="entry-date" class="block text-sm font-medium text-gray-700 mb-1">Data Entrada*</label>
                  <input type="date" id="entry-date" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                </div>
                <div>
                  <label for="deposit" class="block text-sm font-medium text-gray-700 mb-1">Depósito*</label>
                  <select id="deposit" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="loja-vila-isabel">Loja Vila Isabel</option>
                    <option value="cd-niteroi">Centro de Distribuição Niterói</option>
                    <option value="cd-jacarepagua">CD Jacarepaguá</option>
                  </select>
                </div>
                <div>
                  <label for="entry-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Entrada*</label>
                  <select id="entry-type" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="revenda">Compra para Revenda</option>
                    <option value="industrializacao">Industrialização</option>
                    <option value="consumo">Uso e Consumo</option>
                    <option value="imobilizado">Ativo Imobilizado</option>
                  </select>
                </div>
                <div>
                  <label for="natureza-operacao" class="block text-sm font-medium text-gray-700 mb-1">Natureza da Operação (NatOp)</label>
                  <input type="text" id="natureza-operacao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.102 - Compra para comercialização">
                </div>
                <div>
                  <label for="cfop" class="block text-sm font-medium text-gray-700 mb-1">CFOP padrão da entrada</label>
                  <input type="text" id="cfop" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.102">
                </div>
                <div>
                  <label for="finalidade" class="block text-sm font-medium text-gray-700 mb-1">Finalidade da NFe</label>
                  <select id="finalidade" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="normal" selected>Normal</option>
                    <option value="devolucao">Devolução</option>
                    <option value="ajuste">Ajuste</option>
                  </select>
                </div>
                <div>
                  <label for="indicador-presenca" class="block text-sm font-medium text-gray-700 mb-1">Indicador de Presença (indPres)</label>
                  <select id="indicador-presenca" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="0">0 – Não se aplica (NF-e)</option>
                    <option value="1">1 – Operação presencial</option>
                    <option value="2">2 – Internet</option>
                    <option value="3">3 – Teleatendimento</option>
                    <option value="4">4 – Entrega em domicílio</option>
                    <option value="5">5 – Operação presencial fora do estabelecimento</option>
                    <option value="9">9 – Operação não presencial, outros</option>
                  </select>
                </div>
                <div>
                  <label for="tipo-emissao" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Emissão (tpEmis)</label>
                  <select id="tipo-emissao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="1" selected>1 – Emissão normal</option>
                    <option value="2">2 – Contingência FS-IA</option>
                    <option value="3">3 – Contingência SCAN</option>
                    <option value="4">4 – Contingência DPEC</option>
                    <option value="5">5 – Contingência FS-DA</option>
                    <option value="6">6 – Contingência SVC-AN</option>
                    <option value="7">7 – Contingência SVC-RS</option>
                    <option value="9">9 – Contingência off-line da NFC-e</option>
                  </select>
                </div>
              </div>

              <div class="mt-6 border-t border-gray-100 pt-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-4">Dados do Fornecedor</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label for="supplier-cnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ / CPF</label>
                    <input type="text" id="supplier-cnpj" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30.290.856/0001-60">
                  </div>
                  <div>
                    <label for="supplier-ie" class="block text-sm font-medium text-gray-700 mb-1">Inscrição Estadual</label>
                    <input type="text" id="supplier-ie" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="244/0178792">
                  </div>
                  <div>
                    <label for="supplier-uf" class="block text-sm font-medium text-gray-700 mb-1">UF</label>
                    <select id="supplier-uf" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                      <option value="">Selecione</option>
                      <option value="SP">SP - São Paulo</option>
                      <option value="RJ">RJ - Rio de Janeiro</option>
                      <option value="MG">MG - Minas Gerais</option>
                      <option value="RS">RS - Rio Grande do Sul</option>
                      <option value="PR">PR - Paraná</option>
                      <option value="SC">SC - Santa Catarina</option>
                      <option value="BA">BA - Bahia</option>
                      <option value="PE">PE - Pernambuco</option>
                      <option value="CE">CE - Ceará</option>
                      <option value="DF">DF - Distrito Federal</option>
                    </select>
                  </div>
                  <div>
                    <label for="supplier-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail fiscal</label>
                    <input type="email" id="supplier-email" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="nfe@distribuidora.com.br">
                  </div>
                  <div class="md:col-span-2 lg:col-span-4">
                    <label for="supplier-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço completo</label>
                    <input type="text" id="supplier-address" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Av. Paulista, 1800 - Bela Vista, São Paulo - SP, 01310-200">
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="totais">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div>
                    <label for="valor-produtos" class="block text-sm font-medium text-gray-700 mb-1">Valor Produtos (R$)</label>
                    <input type="number" step="0.01" id="valor-produtos" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="14000.00">
                  </div>
                  <div>
                    <label for="base-icms" class="block text-sm font-medium text-gray-700 mb-1">Base ICMS (R$)</label>
                    <input type="number" step="0.01" id="base-icms" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-icms" class="block text-sm font-medium text-gray-700 mb-1">Valor ICMS (R$)</label>
                    <input type="number" step="0.01" id="valor-icms" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="icms-st" class="block text-sm font-medium text-gray-700 mb-1">ICMS Subst. (R$)</label>
                    <input type="number" step="0.01" id="icms-st" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-fcp-st" class="block text-sm font-medium text-gray-700 mb-1">Valor FCP ST (R$)</label>
                    <input type="number" step="0.01" id="valor-fcp-st" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="total-servicos" class="block text-sm font-medium text-gray-700 mb-1">Total Serviços (R$)</label>
                    <input type="number" step="0.01" id="total-servicos" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-ajuste-esquerda" class="block text-sm font-medium text-gray-700 mb-1">Valor do Ajuste (R$)</label>
                    <input type="number" step="0.01" id="valor-ajuste-esquerda" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                </div>

                <div class="space-y-4">
                  <div>
                    <label for="desconto" class="block text-sm font-medium text-gray-700 mb-1">Desconto (R$)</label>
                    <input type="number" step="0.01" id="desconto" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="outras-despesas" class="block text-sm font-medium text-gray-700 mb-1">Outras Despesas (R$)</label>
                    <input type="number" step="0.01" id="outras-despesas" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-frete" class="block text-sm font-medium text-gray-700 mb-1">Valor Frete (R$)</label>
                    <input type="number" step="0.01" id="valor-frete" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-ipi" class="block text-sm font-medium text-gray-700 mb-1">Valor IPI (R$)</label>
                    <input type="number" step="0.01" id="valor-ipi" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="desconto-unitario" class="block text-sm font-medium text-gray-700 mb-1">Desconto Unitário (R$)</label>
                    <input type="number" step="0.01" id="desconto-unitario" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-seguro" class="block text-sm font-medium text-gray-700 mb-1">Valor Seguro (R$)</label>
                    <input type="number" step="0.01" id="valor-seguro" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-dolar" class="block text-sm font-medium text-gray-700 mb-1">Valor da NF em Dólar</label>
                    <input type="number" step="0.01" id="valor-dolar" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="2974.55">
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="observacoes">
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Pagar Frete
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Não Alterar Estoque
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Valor Seguro
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Não escriturar o valor de ICMS
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="condicao-pagamento" class="block text-sm font-medium text-gray-700 mb-1">Condição de Pagamento</label>
                    <input type="text" id="condicao-pagamento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30/60/90 dias">
                  </div>
                  <div>
                    <label for="cliente-retorno" class="block text-sm font-medium text-gray-700 mb-1">Cliente para retorno parcial (F2)</label>
                    <input type="text" id="cliente-retorno" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Pesquisar cliente">
                  </div>
                  <div>
                    <label for="centro-custo" class="block text-sm font-medium text-gray-700 mb-1">Centro de Custo (F2)</label>
                    <input type="text" id="centro-custo" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="01.02.03 - Comercial">
                  </div>
                  <div>
                    <label for="forma-pagamento" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                    <input type="text" id="forma-pagamento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="À Vista">
                  </div>
                </div>

                <div>
                  <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">Observação</label>
                  <textarea id="observacao" rows="4" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Informações complementares sobre a operação."></textarea>
                </div>
                <div>
                  <label for="informacoes-complementares" class="block text-sm font-medium text-gray-700 mb-1">Informações Complementares ao Fisco/Contribuinte</label>
                  <textarea id="informacoes-complementares" rows="3" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Referência à legislação municipal ou mensagens obrigatórias da SEFAZ."></textarea>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="produtos">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-sm font-semibold text-gray-700">Itens da nota</h3>
                <div class="flex flex-wrap gap-2">
                  <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-plus-circle"></i>
                    Adicionar Produto
                  </button>
                  <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-exchange-alt"></i>
                    Alterar Fornecedor por Produto
                  </button>
                </div>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Item</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Não escriturar o valor de ICMS</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Código</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Descrição</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Qtde.</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Multiplicador</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Unitário (R$)</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Desc (%)</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
                    <tr>
                      <td class="px-4 py-3 text-gray-600">1</td>
                      <td class="px-4 py-3">
                        <label class="inline-flex items-center gap-2 text-xs text-gray-600">
                          <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                          Não
                        </label>
                      </td>
                      <td class="px-4 py-3 text-gray-600">PROD-0001</td>
                      <td class="px-4 py-3 text-gray-700">
                        Vacina Polivalente V8 50ml
                        <p class="text-xs text-gray-500">UN: FR · NCM 3002.20.29 · CEST 13.001.00</p>
                        <p class="text-xs text-gray-500">CFOP 1.102 · CST 00 · ICMS 18% · IPI 0%</p>
                        <p class="text-xs text-gray-500">PIS/COFINS: CST 01 · Alíquotas 1,65% / 7,60%</p>
                      </td>
                      <td class="px-4 py-3 text-right text-gray-600">12</td>
                      <td class="px-4 py-3 text-right text-gray-600">1,000</td>
                      <td class="px-4 py-3 text-right text-gray-600">48,90</td>
                      <td class="px-4 py-3 text-right text-gray-600">0,00</td>
                    </tr>
                    <tr>
                      <td class="px-4 py-3 text-gray-600">2</td>
                      <td class="px-4 py-3">
                        <label class="inline-flex items-center gap-2 text-xs text-gray-600">
                          <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                          Sim
                        </label>
                      </td>
                      <td class="px-4 py-3 text-gray-600">PROD-0002</td>
                      <td class="px-4 py-3 text-gray-700">
                        Ração Premium Cães Adultos 15kg
                        <p class="text-xs text-gray-500">UN: SC · NCM 2309.10.90 · CEST 07.002.00</p>
                        <p class="text-xs text-gray-500">CFOP 1.403 · CST 20 · ICMS 12% (BC R$ 960,00)</p>
                        <p class="text-xs text-gray-500">Frete R$ 120,00 · Seguro R$ 45,00</p>
                      </td>
                      <td class="px-4 py-3 text-right text-gray-600">8</td>
                      <td class="px-4 py-3 text-right text-gray-600">1,000</td>
                      <td class="px-4 py-3 text-right text-gray-600">126,50</td>
                      <td class="px-4 py-3 text-right text-gray-600">3,00</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="transportadora">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="transportadora-cnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                  <input type="text" id="transportadora-cnpj" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="12.345.678/0001-99">
                </div>
                <div>
                  <label for="transportadora-ie" class="block text-sm font-medium text-gray-700 mb-1">IE – Transportadora</label>
                  <input type="text" id="transportadora-ie" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="111.222.333.444">
                </div>
                <div>
                  <label for="transportadora-uf" class="block text-sm font-medium text-gray-700 mb-1">UF – Transportadora</label>
                  <select id="transportadora-uf" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="">Selecione</option>
                    <option value="SP">SP - São Paulo</option>
                    <option value="RJ">RJ - Rio de Janeiro</option>
                    <option value="MG">MG - Minas Gerais</option>
                    <option value="ES">ES - Espírito Santo</option>
                  </select>
                </div>
                <div>
                  <label for="transportadora-placa" class="block text-sm font-medium text-gray-700 mb-1">Placa – Transportadora</label>
                  <input type="text" id="transportadora-placa" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="RIO1A23">
                </div>
                <div>
                  <label for="transportadora-uf-placa" class="block text-sm font-medium text-gray-700 mb-1">UF Placa – Transportadora</label>
                  <select id="transportadora-uf-placa" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="">Selecione</option>
                    <option value="SP">SP</option>
                    <option value="RJ">RJ</option>
                    <option value="MG">MG</option>
                    <option value="ES">ES</option>
                  </select>
                </div>
                <div>
                  <label for="peso-bruto" class="block text-sm font-medium text-gray-700 mb-1">Peso Bruto</label>
                  <input type="number" step="0.001" id="peso-bruto" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="185.750">
                </div>
                <div>
                  <label for="peso-liquido" class="block text-sm font-medium text-gray-700 mb-1">Peso Líquido</label>
                  <input type="number" step="0.001" id="peso-liquido" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="172.300">
                </div>
                <div>
                  <label for="modalidade-frete" class="block text-sm font-medium text-gray-700 mb-1">Modalidade do Frete (modFrete)</label>
                  <select id="modalidade-frete" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="0" selected>0 – Por conta do emitente</option>
                    <option value="1">1 – Por conta do destinatário/remetente</option>
                    <option value="2">2 – Por conta de terceiros</option>
                    <option value="3">3 – Transporte próprio por conta do remetente</option>
                    <option value="4">4 – Transporte próprio por conta do destinatário</option>
                    <option value="9">9 – Sem frete</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label for="transportadora-razao" class="block text-sm font-medium text-gray-700 mb-1">Razão Social / Nome</label>
                  <input type="text" id="transportadora-razao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Transportes RodoVia Ltda">
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="duplicatas">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="conta-contabil" class="block text-sm font-medium text-gray-700 mb-1">Conta Contábil (F2)*</label>
                  <input type="text" id="conta-contabil" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.1.3.01 - Fornecedores Nacionais" required>
                </div>
                <div>
                  <label for="forma-pagamento-duplicata" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                  <select id="forma-pagamento-duplicata" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="boleto">Boleto</option>
                    <option value="transferencia">Transferência</option>
                    <option value="pix">PIX</option>
                    <option value="dinheiro">Dinheiro</option>
                  </select>
                </div>
                <div>
                  <label for="conta-corrente" class="block text-sm font-medium text-gray-700 mb-1">Conta Corrente* </label>
                  <select id="conta-corrente" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="001-12345-6">Banco do Brasil 001 - Ag. 1234 - C/C 56789-0</option>
                    <option value="104-98765-4">Caixa 104 - Ag. 2222 - C/C 33333-3</option>
                  </select>
                </div>
                <div>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 mt-7">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Considerar Inativos
                  </label>
                </div>
                <div>
                  <label for="duplicata-data-emissao" class="block text-sm font-medium text-gray-700 mb-1">Data Emissão</label>
                  <input type="date" id="duplicata-data-emissao" class="w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500" value="2024-07-05" readonly>
                </div>
                <div>
                  <label for="doc-mercantil" class="block text-sm font-medium text-gray-700 mb-1">Doc. Mercantil</label>
                  <select id="doc-mercantil" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="boleto" selected>BOLETO</option>
                    <option value="dup">DUPLICATA</option>
                    <option value="nf">Nota Fiscal</option>
                  </select>
                </div>
                <div>
                  <label for="numero-doc-bancario" class="block text-sm font-medium text-gray-700 mb-1">Nº Doc. Bancário</label>
                  <input type="text" id="numero-doc-bancario" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="0001234567">
                </div>
                <div>
                  <label for="parcelas" class="block text-sm font-medium text-gray-700 mb-1">Parcelas*</label>
                  <input type="number" id="parcelas" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" min="1" value="3" required>
                </div>
                <div>
                  <label for="dias-vencimento" class="block text-sm font-medium text-gray-700 mb-1">Dias Vencimento Inicial</label>
                  <input type="number" id="dias-vencimento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30">
                </div>
                <div>
                  <label for="vencimento-inicial" class="block text-sm font-medium text-gray-700 mb-1">Vencimento Inicial</label>
                  <input type="date" id="vencimento-inicial" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="tipo-dias" class="block text-sm font-medium text-gray-700 mb-1">Tipo dias</label>
                  <select id="tipo-dias" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="dias" selected>Nº de dias</option>
                    <option value="data">Data fixa</option>
                  </select>
                </div>
                <div>
                  <label for="dias" class="block text-sm font-medium text-gray-700 mb-1">Dias</label>
                  <input type="number" id="dias" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30">
                </div>
                <div>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 mt-7">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Previsão
                  </label>
                </div>
              </div>

              <div class="mt-6 flex flex-wrap items-center gap-3">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-calculator"></i>
                  Gerar
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Parcela</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Dias</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Vencimento Inicial</th>
                      <th class="px-4 py-3 text-right font-semibold text-gray-700">Valor (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Observação</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Conta Contábil</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Código Conta Contábil</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Doc. Mercantil</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Conta Corrente</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
                    <tr>
                      <td class="px-4 py-3 text-gray-600">1/3</td>
                      <td class="px-4 py-3 text-gray-600">30</td>
                      <td class="px-4 py-3 text-gray-600">05/08/2024</td>
                      <td class="px-4 py-3 text-right text-gray-800 font-semibold">R$ 5.162,44</td>
                      <td class="px-4 py-3 text-gray-600">Pagamento via boleto</td>
                      <td class="px-4 py-3 text-gray-600">Fornecedores Nacionais</td>
                      <td class="px-4 py-3 text-gray-600">1.1.3.01</td>
                      <td class="px-4 py-3 text-gray-600">BOLETO</td>
                      <td class="px-4 py-3 text-gray-600">001-12345-6</td>
                    </tr>
                    <tr>
                      <td class="px-4 py-3 text-gray-600">2/3</td>
                      <td class="px-4 py-3 text-gray-600">60</td>
                      <td class="px-4 py-3 text-gray-600">04/09/2024</td>
                      <td class="px-4 py-3 text-right text-gray-800 font-semibold">R$ 5.162,44</td>
                      <td class="px-4 py-3 text-gray-600">Pagamento via boleto</td>
                      <td class="px-4 py-3 text-gray-600">Fornecedores Nacionais</td>
                      <td class="px-4 py-3 text-gray-600">1.1.3.01</td>
                      <td class="px-4 py-3 text-gray-600">BOLETO</td>
                      <td class="px-4 py-3 text-gray-600">001-12345-6</td>
                    </tr>
                    <tr>
                      <td class="px-4 py-3 text-gray-600">3/3</td>
                      <td class="px-4 py-3 text-gray-600">90</td>
                      <td class="px-4 py-3 text-gray-600">04/10/2024</td>
                      <td class="px-4 py-3 text-right text-gray-800 font-semibold">R$ 5.162,44</td>
                      <td class="px-4 py-3 text-gray-600">Pagamento via boleto</td>
                      <td class="px-4 py-3 text-gray-600">Fornecedores Nacionais</td>
                      <td class="px-4 py-3 text-gray-600">1.1.3.01</td>
                      <td class="px-4 py-3 text-gray-600">BOLETO</td>
                      <td class="px-4 py-3 text-gray-600">001-12345-6</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="ajustes">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="origem" class="block text-sm font-medium text-gray-700 mb-1">Origem</label>
                  <select id="origem" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="nacional" selected>Nacional</option>
                    <option value="importada-direta">Importada - Adquirida no exterior</option>
                    <option value="importada-interna">Importada - Adquirida no mercado interno</option>
                  </select>
                </div>
                <div>
                  <label for="cst" class="block text-sm font-medium text-gray-700 mb-1">CST</label>
                  <input type="text" id="cst" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="090">
                </div>
                <div>
                  <label for="base-calculo" class="block text-sm font-medium text-gray-700 mb-1">Base de Cálculo (R$)</label>
                  <input type="number" step="0.01" id="base-calculo" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="aliquota" class="block text-sm font-medium text-gray-700 mb-1">Alíquota (%)</label>
                  <input type="number" step="0.01" id="aliquota" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="valor-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Valor do Ajuste (R$)</label>
                  <input type="number" step="0.01" id="valor-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="motivo-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                  <input type="text" id="motivo-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Táxi">
                </div>
                <div>
                  <label for="codigo-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Código do Ajuste (F2)</label>
                  <input type="text" id="codigo-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="RJ090000">
                </div>
              </div>

              <div class="mt-6 flex flex-wrap gap-3">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-plus"></i>
                  Adicionar
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-eraser"></i>
                  Limpar
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Origem</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">CST</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Base de Cálculo (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Alíquota (%)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Valor do Ajuste (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Motivo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Código do Ajuste</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
                    <tr>
                      <td class="px-4 py-3 text-gray-600">Nacional</td>
                      <td class="px-4 py-3 text-gray-600">090</td>
                      <td class="px-4 py-3 text-gray-600">R$ 1.500,00</td>
                      <td class="px-4 py-3 text-gray-600">18%</td>
                      <td class="px-4 py-3 text-gray-600">R$ 270,00</td>
                      <td class="px-4 py-3 text-gray-600">Táxi</td>
                      <td class="px-4 py-3 text-gray-600">RJ090000</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="documentos">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-sm font-semibold text-gray-700">Documentos vinculados</h3>
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-link"></i>
                  Adicionar NF
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Modelo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Número da Nota</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Chave de Acesso</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Data Emissão</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
                    <tr>
                      <td class="px-4 py-3 text-gray-600">Pedido de Compra</td>
                      <td class="px-4 py-3 text-gray-600">55</td>
                      <td class="px-4 py-3 text-gray-600">45001234</td>
                      <td class="px-4 py-3 text-gray-600">35240730290856000160550010000100011999999999</td>
                      <td class="px-4 py-3 text-gray-600">02/07/2024</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <button type="button" data-open-import-modal class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-file-import"></i>
                  Importar XML
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-eye"></i>
                  Visualizar Lotes
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-tags"></i>
                  Alterar Preços
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-clipboard-list"></i>
                  Pedidos
                </button>
              </div>

              <div class="mt-4 flex flex-wrap gap-2 text-xs text-gray-500">
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-file-excel"></i>
                  Excel
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-file-pdf"></i>
                  PDF
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-table"></i>
                  Layout
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-expand"></i>
                  Tela Cheia
                </button>
              </div>
            </div>
          </div>
        </section>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
          <h2 class="text-lg font-semibold text-gray-800">Referências oficiais</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Portal Nacional da NF-e</h3>
              <p class="mt-2 text-sm text-gray-600">Consulta autorizada e download de esquemas para NF-e, NFC-e e eventos vinculados.</p>
              <a href="https://www.nfe.fazenda.gov.br/portal" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Acessar portal
              </a>
            </article>
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Manual de Orientação do Contribuinte 4.0</h3>
              <p class="mt-2 text-sm text-gray-600">Layout nacional de NF-e (modelo 55) e NFC-e (modelo 65) atualizado com NT 2023.</p>
              <a href="https://www.nfe.fazenda.gov.br/portal/exibirArquivo.aspx?conteudo=j6Nz6xH3O9E=" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Baixar MOC
              </a>
            </article>
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Portal de NFSe Nacional</h3>
              <p class="mt-2 text-sm text-gray-600">Documentação oficial da ABRASF e padrão nacional de serviços eletrônicos.</p>
              <a href="https://www.gov.br/nfse/pt-br" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Consultar NFSe</a>
            </article>
          </div>
        </div>

        <div class="flex flex-col gap-3 md:flex-row md:justify-end">
          <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
            <i class="fas fa-file-archive"></i>
            Salvar rascunho
          </button>
          <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
            <i class="fas fa-save"></i>
            Registrar entrada da NF-e
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="import-xml-modal" class="fixed inset-0 z-[999] hidden">
    <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" data-close-import-modal></div>
    <div class="relative mx-auto flex min-h-full w-full items-start justify-center px-3 py-6 sm:items-center">
      <div data-import-modal-card class="relative flex w-full max-w-[1352px] transform-gpu flex-col overflow-hidden rounded-2xl bg-white shadow-2xl opacity-0 transition-all duration-200 ease-out scale-95 max-h-[90vh] min-h-0 text-[12px] leading-[1.35]">
        <header class="flex flex-col gap-2.5 border-b border-gray-100 px-4 py-3 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <span class="inline-flex items-center gap-1.5 rounded-full bg-primary/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-primary">
              <i class="fas fa-file-import"></i>
              Importação de NF-e
            </span>
            <h2 class="mt-1.5 text-lg font-semibold text-gray-900">Importar XML autorizado na SEFAZ</h2>
            <p class="mt-1 max-w-3xl text-[11px] text-gray-600">Utilize um XML emitido conforme o Manual de Orientação do Contribuinte 4.0 ou informe a chave de acesso válida (44 dígitos) para recuperar automaticamente dados oficiais da NF-e, NFC-e ou NFS-e.</p>
          </div>
          <button type="button" data-close-import-modal class="inline-flex items-center justify-center rounded-full border border-gray-200 p-1.5 text-gray-500 transition hover:bg-gray-50 hover:text-gray-700">
            <span class="sr-only">Fechar modal</span>
            <i class="fas fa-times"></i>
          </button>
        </header>

        <nav class="flex flex-wrap gap-2 border-b border-gray-100 px-4 pt-2.5">
          <button type="button" data-import-tab="pending" class="import-tab-button active">Notas Pendentes</button>
          <button type="button" data-import-tab="xml" class="import-tab-button">Importar XML</button>
        </nav>

        <div class="flex-1 overflow-y-auto px-4 py-4">
          <div data-import-tab-panel="pending" class="space-y-3.5">
            <div class="grid grid-cols-1 gap-3 lg:grid-cols-2">
              <article class="rounded-xl border border-amber-200 bg-amber-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-amber-900">NF-e 35240730290856000160550010000100011999999999</h3>
                    <p class="text-[10px] text-amber-800">Autorizada em 02/07/2024 · SEFAZ/SP · Distribuidora Nacional de Produtos Veterinários Ltda</p>
                  </div>
                  <span class="rounded-full bg-amber-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-amber-700">Pendência</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-amber-900">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 15.487,32</dd>
                  </div>
                  <div>
                    <dt class="font-medium">CFOP predominante</dt>
                    <dd>1.102 · Compra para comercialização</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Modelo</dt>
                    <dd>55 – NF-e</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Origem</dt>
                    <dd>Portal Nacional da NF-e</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg bg-primary px-2.5 py-1.5 text-[10px] font-semibold text-white shadow-sm transition hover:bg-primary/90">
                    <i class="fas fa-download"></i>
                    Baixar XML autorizado
                  </button>
                  <span class="text-[9px] text-amber-700">Baseado em XML de exemplo oficial SEFAZ/SP.</span>
                </div>
              </article>

              <article class="rounded-xl border border-sky-200 bg-sky-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-sky-900">NFC-e 41230676107918000173550010012345678901234567</h3>
                    <p class="text-[10px] text-sky-800">Autorizada em 18/06/2024 · SEFAZ/PR · Contingência NFC-e homologação</p>
                  </div>
                  <span class="rounded-full bg-sky-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-sky-700">Pendente</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-sky-900">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 289,40</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Destinatário</dt>
                    <dd>Consumidor final</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Modelo</dt>
                    <dd>65 – NFC-e</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Prazo</dt>
                    <dd>Pagamento imediato</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-sky-200 px-2.5 py-1.5 text-[10px] font-semibold text-sky-800 transition hover:bg-sky-100">
                    <i class="fas fa-eye"></i>
                    Visualizar DANFE NFC-e
                  </button>
                  <span class="text-[9px] text-sky-700">Com base em arquivo de contingência SEFAZ/PR.</span>
                </div>
              </article>

              <article class="lg:col-span-2 rounded-xl border border-emerald-200 bg-emerald-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-emerald-900">NFS-e padrão nacional · Exemplo ABRASF</h3>
                    <p class="text-[10px] text-emerald-800">Competência 06/2024 · Prefeitura do Rio de Janeiro · RPS 23145</p>
                  </div>
                  <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-emerald-700">Pendente</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-emerald-900 sm:grid-cols-4">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 1.250,00</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Alíquota ISS</dt>
                    <dd>3,00%</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Natureza</dt>
                    <dd>Código LC 116 · Serviços veterinários</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Município</dt>
                    <dd>Rio de Janeiro/RJ</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-emerald-200 px-2.5 py-1.5 text-[10px] font-semibold text-emerald-800 transition hover:bg-emerald-100">
                    <i class="fas fa-eye"></i>
                    Visualizar RPS
                  </button>
                  <span class="text-[9px] text-emerald-700">Layout Simpliss/ABRASF 2.03 em ambiente oficial.</span>
                </div>
              </article>
            </div>

            <div class="rounded-xl border border-dashed border-gray-200 bg-gray-50 p-3 text-[10px] text-gray-600">
              <h4 class="text-xs font-semibold text-gray-800">Fluxo resumido</h4>
              <ul class="mt-1.5 space-y-1">
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Consulta portal nacional NF-e/NFC-e ou NFSe Nacional.</span>
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Validação XML conforme MOC 4.0, NT 2023.004 e padrão ABRASF.</span>
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Itens e tributos são conciliados antes da escrituração.</span>
                </li>
              </ul>
            </div>
          </div>

          <div data-import-tab-panel="xml" class="hidden space-y-3.5">
            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Selecione como deseja importar</h3>
                  <p class="text-[11px] text-gray-600">Utilize uma chave de acesso autorizada, ou faça upload de um XML oficial baixado no Portal Nacional.</p>
                </div>
                <div class="flex flex-col gap-0.5 text-[10px] text-gray-600 sm:flex-row sm:items-center">
                  <span class="inline-flex items-center gap-1 text-primary">
                    <i class="fas fa-shield-check text-[11px]"></i>
                    Validação XSD oficial
                  </span>
                  <span class="inline-flex items-center gap-1 text-emerald-600">
                    <i class="fas fa-file-code text-[11px]"></i>
                    NF-e 4.0 · NFC-e 4.0 · NFS-e ABRASF
                  </span>
                </div>
              </header>
              <div class="grid grid-cols-1 gap-2.5 p-3.5 lg:grid-cols-3">
                <div class="space-y-1.5">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Tipo de importação</label>
                  <div class="grid grid-cols-2 gap-1.5 text-[10px] font-medium text-gray-600">
                    <label class="inline-flex items-center gap-2 rounded-lg border border-primary/40 bg-primary/10 px-2.5 py-1.5">
                      <input type="radio" name="import-mode" value="access-key" class="h-3 w-3 text-primary focus:ring-primary/40" checked>
                      Chave de acesso
                    </label>
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="radio" name="import-mode" value="file" class="h-3 w-3 text-primary focus:ring-primary/40">
                      Arquivo XML
                    </label>
                  </div>
                </div>
                <div class="space-y-1.5" data-import-mode-panel="access-key">
                  <label for="import-access-key" class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Informe a chave</label>
                  <div class="flex gap-1.5">
                    <input type="text" id="import-access-key" maxlength="44" class="w-full rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240730290856000160550010000100011999999999">
                    <button type="button" class="inline-flex items-center gap-1.5 rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-white shadow-sm transition hover:bg-primary/90">
                      <i class="fas fa-search"></i>
                      Consultar portal
                    </button>
                  </div>
                  <p class="text-[9px] text-gray-500">Consulta automática ao Portal Nacional da NF-e/NFC-e ou NFSe Nacional.</p>
                </div>
                <div class="space-y-1.5 hidden" data-import-mode-panel="file">
                  <label for="import-file-input" class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Envie o XML</label>
                  <label for="import-file-input" class="flex cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 px-3 py-5 text-center text-[10px] text-gray-500 transition hover:border-primary hover:text-primary">
                    <i class="fas fa-cloud-upload-alt text-lg"></i>
                    <span>Selecione ou arraste o arquivo XML autorizado</span>
                    <input id="import-file-input" type="file" accept=".xml" class="hidden">
                  </label>
                  <p class="text-[9px] text-gray-500">Validação com esquemas oficiais (XSD) e regras de negócio SEFAZ.</p>
                  <div data-file-feedback class="hidden rounded-lg border px-3 py-2 text-[10px] font-medium"></div>
                  <div data-import-supplier-status class="hidden rounded-lg border px-3 py-2 text-[10px] text-gray-600 space-y-1.5 sm:flex sm:items-start sm:justify-between sm:gap-3">
                    <div class="flex items-start gap-1.5">
                      <i data-supplier-status-icon class="fas fa-circle-info mt-0.5 text-[12px]"></i>
                      <div class="space-y-0.5">
                        <p data-supplier-message class="text-[11px] font-semibold text-gray-700 leading-snug"></p>
                        <p data-supplier-description class="text-[10px] text-gray-600 leading-snug"></p>
                      </div>
                    </div>
                    <div data-supplier-actions class="flex flex-wrap gap-1.5 sm:mt-0"></div>
                  </div>
                  <div data-import-supplier-summary class="hidden rounded-lg border border-gray-200 bg-white px-3 py-2 text-[10px] text-gray-600 space-y-1.5">
                    <p data-supplier-summary-name class="text-[11px] font-semibold text-gray-700 leading-snug"></p>
                    <dl class="grid grid-cols-1 gap-1 sm:grid-cols-2 sm:gap-y-1.5">
                      <div>
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Documento</dt>
                        <dd data-supplier-summary-document class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div>
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Inscrição Estadual</dt>
                        <dd data-supplier-summary-ie class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div class="sm:col-span-2">
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Endereço</dt>
                        <dd data-supplier-summary-address class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div class="sm:col-span-2">
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Contato</dt>
                        <dd data-supplier-summary-contact class="text-gray-700 leading-snug"></dd>
                      </div>
                    </dl>
                  </div>
                </div>
                <div class="space-y-1.5">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Ações rápidas</label>
                  <div class="grid grid-cols-1 gap-1.5 text-[10px] font-medium text-gray-600 sm:grid-cols-2">
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="checkbox" class="h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40" checked>
                      Importar automaticamente produtos novos
                    </label>
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="checkbox" class="h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40" checked>
                      Atualizar preços de compra existentes
                    </label>
                  </div>
                </div>
              </div>
            </section>

            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Dados da nota fiscal</h3>
                  <p class="text-[11px] text-gray-600">Resumo preenchido automaticamente conforme leiaute nacional 4.0 da NF-e.</p>
                </div>
                <div class="text-right text-[10px] text-gray-500">
                  <span class="block font-semibold text-gray-700">MOC 4.0</span>
                  <span>NT 2023.003 · NT 2023.004</span>
                </div>
              </header>
              <div class="grid grid-cols-1 gap-2.5 p-3.5 text-[10px] text-gray-600 lg:grid-cols-4">
                <div class="lg:col-span-2">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Emitente</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-emitente-nome>Informe a chave ou importe o XML</p>
                    <p data-import-emitente-document>Documento não identificado</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Chave de acesso</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-mono text-[12px] text-gray-700" data-import-access-key>------------------------------</p>
                    <p data-import-access-key-details>DV -- · Ambiente não identificado</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Protocolo</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p data-import-protocol>Protocolo não informado</p>
                    <p data-import-protocol-received>Recebimento não disponível</p>
                  </div>
                </div>
                <div class="lg:col-span-4 grid grid-cols-1 gap-2.5 sm:grid-cols-2 xl:grid-cols-4">
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">NF</span>
                    <input type="text" data-import-summary-field="nf-number" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Série</span>
                    <input type="text" data-import-summary-field="nf-serie" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Emissão</span>
                    <input type="text" data-import-summary-field="nf-emissao" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Entrada</span>
                    <input type="text" data-import-summary-field="nf-entrada" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                </div>
                <div class="lg:col-span-2">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Fornecedor</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-supplier-name>Fornecedor não localizado</p>
                    <p data-import-supplier-document>Documento não disponível</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Valor total</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-right text-gray-700">
                    <p class="text-sm font-semibold" data-import-total>R$ 0,00</p>
                    <p class="text-[10px] text-emerald-600" data-import-total-status>Aguardando importação do XML</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Destinatário</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-destinatario-nome>Destinatário não identificado</p>
                    <p data-import-destinatario-document>Documento não disponível</p>
                  </div>
                </div>
                <div class="lg:col-span-4 grid grid-cols-1 gap-2.5 sm:grid-cols-2 xl:grid-cols-4">
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">CFOP predominante</span>
                    <input type="text" data-import-summary-field="cfop" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Natureza da operação</span>
                    <input type="text" data-import-summary-field="natureza" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Modalidade frete</span>
                    <input type="text" data-import-summary-field="modalidade-frete" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Indicador IE destinatário</span>
                    <input type="text" data-import-summary-field="indicador-ie" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                </div>
              </div>
            </section>

            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Produtos importados</h3>
                  <p class="text-[11px] text-gray-600">Itens conforme o XML, com tributos ICMS, ST, IPI, PIS e COFINS.</p>
                </div>
                <div class="flex flex-wrap items-center gap-1.5 text-[10px] text-gray-500">
                  <span class="inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-0.5" data-import-xml-label>
                    <i class="fas fa-layer-group text-[11px]"></i>
                    <span data-import-xml-number>XML não importado</span>
                  </span>
                  <span class="inline-flex items-center gap-1 rounded-full border border-sky-200 bg-sky-50 px-2 py-0.5 text-sky-700" data-import-xml-validation>
                    <i class="fas fa-circle-info text-[11px]" data-import-xml-validation-icon></i>
                    <span data-import-xml-validation-text>Aguardando validação fiscal</span>
                  </span>
                </div>
              </header>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-[10px]" data-import-products-table>
                  <thead class="bg-gray-50 text-[9px] uppercase tracking-wide text-gray-500">
                    <tr>
                      <th class="sticky left-0 z-10 bg-gray-50 px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500 shadow-sm">Cadastrar</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Unitarizar</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Selecionar</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Cod. Interno (SKU)</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Nome</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Cod_Fornecedor</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Cod_Barras</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Nome no Fornecedor</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Multiplicador/Divisão</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">Unidade</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Quantidade</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Unitário (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Desconto (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Total</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">NCM</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">CFOP</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">CST</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">ICMS (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Base ICMS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor ICMS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">IVA (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">ICMS ST (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor ICMS ST (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">IPI (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Base IPI (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor IPI (R$)</th>
                      <th class="px-2 py-1.5 text-left font-semibold uppercase tracking-wide text-gray-500">ST IPI</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Alíquota PIS (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Base PIS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor PIS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">ST CONFINS (%)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Base CONFINS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor CONFINS (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Frete (R$)</th>
                      <th class="px-2 py-1.5 text-right font-semibold uppercase tracking-wide text-gray-500">Valor Outros (R$)</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 bg-white" data-import-products-body></tbody>
                </table>
              </div>
            </section>
          </div>
          <footer class="flex flex-col gap-3 border-t border-gray-100 bg-gray-50 px-5 py-3 sm:flex-row sm:items-center sm:justify-end">
            <div class="flex w-full flex-col-reverse gap-2 sm:w-auto sm:flex-row sm:items-center">
              <button type="button" data-close-import-modal class="inline-flex items-center justify-center gap-1.5 rounded-lg border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-100">Cancelar</button>
              <button type="button" class="inline-flex items-center justify-center gap-1.5 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary/90">
                <i class="fas fa-file-import"></i>
                Importar
              </button>
            </div>
          </footer>
      </div>
    </div>
  </div>

  <div id="admin-footer-placeholder"></div>

  <script>var basePath = '../../';</script>
  <script src="../../scripts/core/config.js"></script>
  <script src="../../scripts/core/ui.js"></script>
  <script src="../../scripts/core/main.js"></script>
  <script src="../../scripts/admin/admin.js"></script>
  <script src="/scripts/common/modal-bridge.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabPanels = document.querySelectorAll('.tab-panel');

      function activateTab(tabId) {
        tabButtons.forEach((button) => {
          const isActive = button.dataset.tab === tabId;
          button.classList.toggle('active', isActive);
          button.classList.toggle('bg-primary/10', isActive);
          button.classList.toggle('text-primary', isActive);
          button.classList.toggle('border', true);
          button.classList.toggle('border-transparent', isActive);
          button.classList.toggle('border-gray-200', !isActive);
          button.classList.toggle('text-gray-600', !isActive);
        });

        tabPanels.forEach((panel) => {
          panel.classList.toggle('hidden', panel.dataset.tabPanel !== tabId);
        });
      }

      tabButtons.forEach((button) => {
        button.classList.add('inline-flex', 'items-center', 'gap-2', 'rounded-lg', 'px-3', 'py-2', 'text-xs', 'font-semibold', 'transition');
        if (!button.classList.contains('active')) {
          button.classList.add('text-gray-600', 'border', 'border-gray-200');
        } else {
          button.classList.add('bg-primary/10', 'text-primary', 'border', 'border-transparent');
        }

        button.addEventListener('click', () => {
          activateTab(button.dataset.tab);
        });
      });

      const importModal = document.getElementById('import-xml-modal');
      if (importModal) {
        const importModalCard = importModal.querySelector('[data-import-modal-card]');
        const openImportModalButtons = document.querySelectorAll('[data-open-import-modal]');
        const closeImportModalButtons = importModal.querySelectorAll('[data-close-import-modal]');
        const importTabButtons = importModal.querySelectorAll('.import-tab-button');
        const importTabPanels = importModal.querySelectorAll('[data-import-tab-panel]');
        const importModeRadios = importModal.querySelectorAll('input[name="import-mode"]');
        const importModePanels = importModal.querySelectorAll('[data-import-mode-panel]');
        const importFilePanel = importModal.querySelector('[data-import-mode-panel="file"]');
        const importFileInput = document.getElementById('import-file-input');
        const importFileFeedback = importModal.querySelector('[data-file-feedback]');
        const importSupplierStatus = importModal.querySelector('[data-import-supplier-status]');
        const importSupplierMessage = importSupplierStatus ? importSupplierStatus.querySelector('[data-supplier-message]') : null;
        const importSupplierDescription = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-description]')
          : null;
        const importSupplierActions = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-actions]')
          : null;
        const importSupplierIcon = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-status-icon]')
          : null;
        const importSupplierSummary = importModal.querySelector('[data-import-supplier-summary]');
        const importSupplierSummaryName = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-name]')
          : null;
        const importSupplierSummaryDocument = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-document]')
          : null;
        const importSupplierSummaryIe = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-ie]')
          : null;
        const importSupplierSummaryAddress = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-address]')
          : null;
        const importSupplierSummaryContact = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-contact]')
          : null;
        const importSummaryEmitenteName = importModal.querySelector('[data-import-emitente-nome]');
        const importSummaryEmitenteDocument = importModal.querySelector('[data-import-emitente-document]');
        const importSummaryAccessKey = importModal.querySelector('[data-import-access-key]');
        const importSummaryAccessKeyDetails = importModal.querySelector('[data-import-access-key-details]');
        const importSummaryProtocol = importModal.querySelector('[data-import-protocol]');
        const importSummaryProtocolReceived = importModal.querySelector('[data-import-protocol-received]');
        const importSummarySupplierName = importModal.querySelector('[data-import-supplier-name]');
        const importSummarySupplierDocument = importModal.querySelector('[data-import-supplier-document]');
        const importSummaryTotal = importModal.querySelector('[data-import-total]');
        const importSummaryTotalStatus = importModal.querySelector('[data-import-total-status]');
        const importSummaryDestName = importModal.querySelector('[data-import-destinatario-nome]');
        const importSummaryDestDocument = importModal.querySelector('[data-import-destinatario-document]');
        const importXmlLabelWrapper = importModal.querySelector('[data-import-xml-label]');
        const importXmlNumber = importModal.querySelector('[data-import-xml-number]');
        const importXmlValidationBadge = importModal.querySelector('[data-import-xml-validation]');
        const importXmlValidationText = importModal.querySelector('[data-import-xml-validation-text]');
        const importXmlValidationIcon = importModal.querySelector('[data-import-xml-validation-icon]');
        const importProductsTableBody = importModal.querySelector('[data-import-products-body]');
        const importSummaryFields = Array.from(importModal.querySelectorAll('[data-import-summary-field]')).reduce(
          (accumulator, element) => {
            accumulator[element.dataset.importSummaryField] = element;
            return accumulator;
          },
          {}
        );
        const supplierSelect = document.getElementById('nfe-supplier');
        const companySelect = document.getElementById('company');
        const nfeNumberInput = document.getElementById('nfe-number');
        const nfeSeriesInput = document.getElementById('nfe-series');
        const nfeProtocolInput = document.getElementById('nfe-protocol');
        const nfeReferenceInput = document.getElementById('nfe-reference');
        const issueDateInput = document.getElementById('issue-date');
        const entryDateInput = document.getElementById('entry-date');
        const nfeModelSelect = document.getElementById('nfe-model');
        const nfeTypeSelect = document.getElementById('nfe-type');
        const importAccessKeyInput = document.getElementById('import-access-key');
        const accessKeyInput = document.getElementById('access-key');
        const totalAmountDisplay = document.querySelector('[data-nfe-total]');
        let previouslyFocusedElement = null;
        const apiBaseUrl =
          typeof API_CONFIG !== 'undefined' && API_CONFIG?.BASE_URL
            ? API_CONFIG.BASE_URL.replace(/\/+$/, '')
            : '/api';
        const suppliersEndpoint = `${apiBaseUrl}/suppliers`;

        const notify = (message, type = 'info') => {
          if (typeof window.showToast === 'function') {
            window.showToast(message, type);
          } else if (type === 'error') {
            console.error(message);
          } else {
            console.log(message);
          }
        };

        const handleAuthError = () => {
          notify('Sessão expirada. Faça login novamente para continuar.', 'error');
        };

        const getToken = () => {
          try {
            const raw = localStorage.getItem('loggedInUser');
            if (!raw) return '';
            const parsed = JSON.parse(raw);
            return parsed?.token || '';
          } catch (error) {
            console.warn('Não foi possível recuperar o token de autenticação.', error);
            return '';
          }
        };

        const buildAuthHeaders = () => {
          const headers = new Headers({ Accept: 'application/json' });
          const token = getToken();
          if (token) {
            headers.set('Authorization', `Bearer ${token}`);
          }
          return headers;
        };

        const supplierRegistry = {
          loaded: false,
          loadingPromise: null,
          byDocument: new Map(),
          lastLoadedAt: 0,
          error: null,
        };

        let lastSupplierData = null;
        let lastNfeData = null;
        const PRODUCT_DRAFT_STORAGE_KEY = 'nfeImportProductDraft';
        const productLookupCache = new Map();
        const productLookupPromises = new Map();
        let productValidationSequence = 0;
        const PRODUCT_TABLE_COLUMN_COUNT = 35;

        const STATUS_CLASS_MAP = {
          success: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-800'],
          warning: ['border-amber-200', 'bg-amber-50', 'text-amber-800'],
          error: ['border-rose-200', 'bg-rose-50', 'text-rose-800'],
          info: ['border-sky-200', 'bg-sky-50', 'text-sky-800'],
        };

        const STATUS_ICONS = {
          success: 'fas fa-circle-check',
          warning: 'fas fa-triangle-exclamation',
          error: 'fas fa-circle-exclamation',
          info: 'fas fa-circle-info',
        };

        const VALIDATION_BADGE_STYLES = {
          success: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700'],
          warning: ['border-amber-200', 'bg-amber-50', 'text-amber-700'],
          error: ['border-rose-200', 'bg-rose-50', 'text-rose-700'],
          info: ['border-sky-200', 'bg-sky-50', 'text-sky-700'],
        };

        const VALIDATION_ICONS = {
          success: 'fas fa-check',
          warning: 'fas fa-triangle-exclamation',
          error: 'fas fa-circle-exclamation',
          info: 'fas fa-circle-info',
        };

        const ALL_STATUS_CLASSES = Array.from(new Set(Object.values(STATUS_CLASS_MAP).flat()));
        const ALL_VALIDATION_CLASSES = Array.from(new Set(Object.values(VALIDATION_BADGE_STYLES).flat()));

        const SUPPLIER_ACTION_VARIANTS = {
          primary: [
            'border-primary',
            'bg-primary',
            'text-white',
            'hover:bg-primary/90',
            'focus:ring-primary/40',
          ],
          secondary: [
            'border-gray-200',
            'text-gray-700',
            'hover:border-primary/40',
            'hover:text-primary',
            'focus:ring-primary/20',
          ],
        };

        const digitsOnly = (value) => String(value ?? '').replace(/\D+/g, '');

        const normalizeBarcodeForComparison = (value) => {
          const digits = digitsOnly(value);
          if (!digits) return '';
          if (/^0+$/.test(digits)) return '';
          return digits;
        };

        const normalizeGtin = (value) => normalizeBarcodeForComparison(value);

        const formatGtinDisplay = (value) => {
          const raw = String(value ?? '').trim();
          if (!raw) return 'SEM GTIN';
          if (/sem\s*gtin/i.test(raw)) return 'SEM GTIN';
          const digits = digitsOnly(raw);
          if (!digits || /^0+$/.test(digits)) return 'SEM GTIN';
          return raw;
        };

        const parseNumber = (value) => {
          if (value === null || typeof value === 'undefined') return null;
          const raw = String(value).trim();
          if (!raw) return null;
          const normalized = raw.replace(',', '.');
          const numeric = Number.parseFloat(normalized);
          return Number.isFinite(numeric) ? numeric : null;
        };

        const formatDecimal = (value, options = {}) => {
          const { minimumFractionDigits = 3, maximumFractionDigits = minimumFractionDigits } = options;
          const numericValue = Number.isFinite(value) ? value : parseNumber(value);
          const finalValue = Number.isFinite(numericValue) ? numericValue : 0;
          return finalValue.toLocaleString('pt-BR', {
            minimumFractionDigits,
            maximumFractionDigits,
          });
        };

        const formatQuantity = (value) => formatDecimal(value, { minimumFractionDigits: 3, maximumFractionDigits: 3 });

        const formatMoneyValue = (value) => formatDecimal(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const formatPercentValue = (value) => formatDecimal(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const INTERNAL_CODE_PREFIX = 'SKU-';

        const normalizeInternalCode = (value) => {
          if (typeof value === 'number' && Number.isFinite(value)) {
            return String(value);
          }
          if (typeof value === 'string') {
            return value.trim();
          }
          return '';
        };

        const buildTemporaryInternalCode = (index = 0) => {
          const sequence = Number.isFinite(index) ? index + 1 : 1;
          return `${INTERNAL_CODE_PREFIX}${String(sequence).padStart(5, '0')}`;
        };

        const ensureUniqueInternalCodes = (items) => {
          if (!Array.isArray(items) || !items.length) return;

          const usedCodes = new Set();

          items.forEach((item) => {
            const matchedCode = normalizeInternalCode(getProductCodeFromRecord(item?.matchedProduct));
            if (matchedCode) {
              item.internalCode = matchedCode;
            }
          });

          items.forEach((item, index) => {
            const baseCode = normalizeInternalCode(item.internalCode) || buildTemporaryInternalCode(item.index ?? index);
            let candidate = baseCode;
            let attempt = 1;

            while (usedCodes.has(candidate)) {
              attempt += 1;
              candidate = `${baseCode}-${String(attempt).padStart(2, '0')}`;
            }

            item.internalCode = candidate;
            usedCodes.add(candidate);
          });
        };

        const getProductCodeFromRecord = (product) =>
          product?.codigoInterno ||
          product?.cod ||
          product?.codigo ||
          product?.codInterno ||
          product?.codigoReferencia ||
          product?.sku ||
          product?.id ||
          '';

        const PRODUCT_BARCODE_FIELDS = [
          'codigoBarras',
          'codigoDeBarras',
          'barras',
          'ean',
          'eanTrib',
          'codbarras',
          'barcode',
          'codigo_barras',
        ];

        const getProductBarcodeFromRecord = (product) => {
          if (!product || typeof product !== 'object') return '';
          for (const field of PRODUCT_BARCODE_FIELDS) {
            const normalized = normalizeBarcodeForComparison(product[field]);
            if (normalized) return normalized;
          }
          if (Array.isArray(product.variacoes)) {
            for (const variation of product.variacoes) {
              const normalized = normalizeBarcodeForComparison(
                variation?.codigoBarras || variation?.barcode || variation?.ean
              );
              if (normalized) return normalized;
            }
          }
          return '';
        };

        const getOptionDocument = (option) => {
          if (!option) return '';
          const existingDataset = option.dataset?.supplierDocument;
          if (existingDataset) {
            return existingDataset;
          }
          const digits = digitsOnly(`${option.value}${option.textContent || ''}`);
          if (digits && option.dataset) {
            option.dataset.supplierDocument = digits;
          }
          return digits;
        };

        const formatDocumentForOption = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 14) {
            return digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
          }
          if (digits.length === 11) {
            return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
          }
          return digits;
        };

        const buildSupplierOptionLabel = (supplier, documentDigits) => {
          const formattedDocument = formatDocumentForOption(documentDigits);
          const name =
            supplier?.legalName ||
            supplier?.fantasyName ||
            supplier?.name ||
            formattedDocument;
          const codeValue = supplier?.code ?? supplier?.codeNumber;
          let codeText = '';
          if (typeof codeValue === 'number' && Number.isFinite(codeValue)) {
            codeText = `Código ${String(codeValue).padStart(4, '0')}`;
          } else if (typeof codeValue === 'string' && codeValue.trim()) {
            codeText = `Código ${codeValue.trim()}`;
          }
          return [formattedDocument, name, codeText].filter(Boolean).join(' · ');
        };

        const findSupplierOptionByDocument = (documentDigits) => {
          if (!supplierSelect || !documentDigits) return null;
          return (
            Array.from(supplierSelect.options || []).find(
              (option) => getOptionDocument(option) === documentDigits
            ) || null
          );
        };

        const ensureSupplierOption = (supplier, documentDigits) => {
          if (!supplierSelect || !documentDigits) return null;
          const existingOption = findSupplierOptionByDocument(documentDigits);
          const option = existingOption || document.createElement('option');
          const optionValue = supplier?._id || documentDigits;
          option.value = optionValue;
          option.textContent = buildSupplierOptionLabel(supplier, documentDigits);
          option.dataset.supplierDocument = documentDigits;
          if (supplier?._id) {
            option.dataset.supplierId = supplier._id;
          }
          option.dataset.supplierName =
            supplier?.legalName || supplier?.fantasyName || supplier?.name || '';
          if (!existingOption) {
            supplierSelect.appendChild(option);
          }
          return option;
        };

        const registerSupplierRecord = (supplier) => {
          if (!supplier) return null;
          const documentDigits = digitsOnly(supplier.cnpj || supplier.document);
          if (!documentDigits) return null;
          supplierRegistry.byDocument.set(documentDigits, supplier);
          return ensureSupplierOption(supplier, documentDigits);
        };

        const indexExistingSupplierOptions = () => {
          if (!supplierSelect) return;
          Array.from(supplierSelect.options || []).forEach((option) => {
            const digits = getOptionDocument(option);
            if (!digits) return;
            option.dataset.supplierDocument = digits;
          });
        };

        const loadSuppliersFromApi = async (forceReload = false) => {
          if (!suppliersEndpoint) return supplierRegistry.byDocument;
          if (forceReload) {
            supplierRegistry.loaded = false;
          }
          if (supplierRegistry.loaded && !forceReload) {
            return supplierRegistry.byDocument;
          }
          if (supplierRegistry.loadingPromise) {
            try {
              await supplierRegistry.loadingPromise;
            } catch (_) {
              // Ignorar erros anteriores, o estado já foi atualizado
            }
            return supplierRegistry.byDocument;
          }
          supplierRegistry.loadingPromise = (async () => {
            try {
              supplierRegistry.error = null;
              const response = await fetch(suppliersEndpoint, {
                headers: buildAuthHeaders(),
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) {
                if (response.status === 401) {
                  handleAuthError();
                }
                throw new Error(data?.message || `Falha ao consultar fornecedores (status ${response.status})`);
              }
              const suppliers = Array.isArray(data?.suppliers) ? data.suppliers : [];
              supplierRegistry.byDocument.clear();
              suppliers.forEach((entry) => {
                registerSupplierRecord(entry);
              });
              supplierRegistry.loaded = true;
              supplierRegistry.lastLoadedAt = Date.now();
            } catch (error) {
              supplierRegistry.error = error;
              supplierRegistry.loaded = false;
              console.error('Erro ao carregar fornecedores cadastrados:', error);
            } finally {
              supplierRegistry.loadingPromise = null;
            }
          })();
          try {
            await supplierRegistry.loadingPromise;
          } catch (_) {
            // Erro já tratado no bloco acima
          }
          return supplierRegistry.byDocument;
        };

        const setText = (element, value, fallback = '') => {
          if (!element) return;
          element.textContent = value || fallback;
        };

        const setInputValue = (element, value) => {
          if (!element) return;
          element.value = value ?? '';
        };

        const setSummaryInput = (key, value) => {
          const element = importSummaryFields[key];
          if (!element) return;
          element.value = value ?? '';
        };

        const formatDocument = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 14) {
            return `CNPJ ${digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5')}`;
          }
          if (digits.length === 11) {
            return `CPF ${digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}`;
          }
          return digits || value || '';
        };

        const composeDocumentLine = (documentValue, stateRegistration) => {
          const documentText = formatDocument(documentValue);
          if (documentText && stateRegistration) {
            return `${documentText} · IE ${stateRegistration}`;
          }
          if (documentText) return documentText;
          if (stateRegistration) return `IE ${stateRegistration}`;
          return '';
        };

        const formatCep = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 8) {
            return digits.replace(/(\d{5})(\d{3})/, '$1-$2');
          }
          return digits || '';
        };

        const formatPhone = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 11) {
            return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
          }
          if (digits.length === 10) {
            return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
          }
          return digits || '';
        };

        const formatCurrencyBRL = (value) => {
          const numeric = Number.parseFloat(String(value || '').replace(',', '.'));
          if (Number.isFinite(numeric)) {
            return numeric.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          }
          return 'R$ 0,00';
        };

        const formatAddressLine = (address = {}) => {
          if (!address || typeof address !== 'object') return '';
          const parts = [];
          const streetParts = [];
          if (address.street) streetParts.push(address.street);
          if (address.number) streetParts.push(address.number);
          const streetLine = streetParts.join(', ');
          if (streetLine) parts.push(streetLine);
          if (address.complement) parts.push(address.complement);
          if (address.neighborhood) parts.push(address.neighborhood);
          const cityState = [address.city, address.state].filter(Boolean).join(' - ');
          if (cityState) parts.push(cityState);
          const cep = formatCep(address.cep);
          if (cep) parts.push(`CEP ${cep}`);
          if (address.country) parts.push(address.country);
          return parts.join(' · ');
        };

        const buildContactLine = (entity = {}) => {
          const parts = [];
          if (entity.email) parts.push(entity.email);
          const phone = formatPhone(entity.phone);
          if (phone) parts.push(phone);
          const mobile = formatPhone(entity.mobile);
          if (mobile && mobile !== phone) parts.push(mobile);
          return parts.length ? parts.join(' · ') : '';
        };

        const mapEnvironment = (value) => {
          if (value === '1') return 'Ambiente produção';
          if (value === '2') return 'Ambiente homologação';
          return 'Ambiente não identificado';
        };

        const mapFrete = (value) => {
          const map = {
            '0': '0 - Contratação do frete por conta do remetente (CIF)',
            '1': '1 - Contratação do frete por conta do destinatário/remetente (FOB)',
            '2': '2 - Contratação do frete por conta de terceiros',
            '3': '3 - Transporte próprio por conta do remetente',
            '4': '4 - Transporte próprio por conta do destinatário',
            '9': '9 - Sem frete',
          };
          return map[value] || value || '';
        };

        const formatIndIe = (value) => {
          const map = {
            '1': '1 - Contribuinte ICMS',
            '2': '2 - Contribuinte isento',
            '9': '9 - Não contribuinte ICMS',
          };
          return map[value] || value || '';
        };

        const mapModelToType = (model) => {
          if (model === '65') return 'NFCe';
          if (model === '55') return 'NF';
          return 'NF';
        };

        const normalizeDate = (value) => {
          if (!value) {
            return { dateInput: '', display: '', displayDateTime: '' };
          }
          let date = null;
          if (value.includes('T')) {
            date = new Date(value);
          } else if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            date = new Date(`${value}T00:00:00`);
          } else if (/^\d{8}$/.test(value)) {
            const formatted = `${value.slice(0, 4)}-${value.slice(4, 6)}-${value.slice(6, 8)}`;
            date = new Date(`${formatted}T00:00:00`);
          }
          if (date && !Number.isNaN(date.getTime())) {
            return {
              dateInput: date.toISOString().slice(0, 10),
              display: date.toLocaleDateString('pt-BR'),
              displayDateTime: date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
            };
          }
          return { dateInput: '', display: value, displayDateTime: value };
        };

        const setSelectValue = (select, value) => {
          if (!select || typeof value === 'undefined' || value === null) return;
          const option = Array.from(select.options || []).find((item) => item.value === value);
          if (option) {
            select.value = option.value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
          }
        };

        const clearStatusClasses = (element, classes) => {
          if (!element) return;
          const targetClasses = classes && classes.length ? classes : ALL_STATUS_CLASSES;
          if (targetClasses.length) {
            element.classList.remove(...targetClasses);
          }
        };

        const applyStatusClasses = (element, type = 'info') => {
          if (!element) return;
          clearStatusClasses(element, ALL_STATUS_CLASSES);
          const classes = STATUS_CLASS_MAP[type] || STATUS_CLASS_MAP.info;
          element.classList.add(...classes);
        };

        const applyValidationStyles = (type = 'info') => {
          if (!importXmlValidationBadge) return;
          importXmlValidationBadge.classList.remove(...ALL_VALIDATION_CLASSES);
          importXmlValidationBadge.classList.add(...(VALIDATION_BADGE_STYLES[type] || VALIDATION_BADGE_STYLES.info));
          if (importXmlValidationIcon) {
            importXmlValidationIcon.className = `${VALIDATION_ICONS[type] || VALIDATION_ICONS.info} text-[11px]`;
          }
        };

        const clearStatusMessages = () => {
          if (importFileFeedback) {
            importFileFeedback.classList.add('hidden');
            importFileFeedback.textContent = '';
            clearStatusClasses(importFileFeedback, ALL_STATUS_CLASSES);
          }
          if (importSupplierStatus) {
            importSupplierStatus.classList.add('hidden');
            if (importSupplierMessage) importSupplierMessage.textContent = '';
            if (importSupplierDescription) {
              importSupplierDescription.textContent = '';
              importSupplierDescription.classList.remove('hidden');
            }
            if (importSupplierActions) {
              importSupplierActions.innerHTML = '';
              importSupplierActions.classList.add('hidden');
            }
            if (importSupplierIcon) {
              importSupplierIcon.className = 'fas fa-circle-info mt-0.5 text-[12px]';
            }
            clearStatusClasses(importSupplierStatus, ALL_STATUS_CLASSES);
          }
        };

        const showFileFeedback = (message, type = 'info') => {
          if (!importFileFeedback) return;
          importFileFeedback.textContent = message;
          importFileFeedback.classList.remove('hidden');
          applyStatusClasses(importFileFeedback, type);
        };

        const setSupplierSummary = (supplier) => {
          if (!importSupplierSummary) return;
          if (!supplier || (!supplier.name && !supplier.document)) {
            importSupplierSummary.classList.add('hidden');
            if (importSupplierSummaryName) importSupplierSummaryName.textContent = '';
            if (importSupplierSummaryDocument) importSupplierSummaryDocument.textContent = '';
            if (importSupplierSummaryIe) importSupplierSummaryIe.textContent = '';
            if (importSupplierSummaryAddress) importSupplierSummaryAddress.textContent = '';
            if (importSupplierSummaryContact) importSupplierSummaryContact.textContent = '';
            return;
          }
          importSupplierSummary.classList.remove('hidden');
          if (importSupplierSummaryName) {
            importSupplierSummaryName.textContent = supplier.name || 'Emitente não identificado';
          }
          if (importSupplierSummaryDocument) {
            importSupplierSummaryDocument.textContent = formatDocument(supplier.document) || 'Documento não informado';
          }
          if (importSupplierSummaryIe) {
            importSupplierSummaryIe.textContent = supplier.stateRegistration || 'IE não informada';
          }
          if (importSupplierSummaryAddress) {
            importSupplierSummaryAddress.textContent =
              formatAddressLine(supplier.address) || 'Endereço não informado';
          }
          if (importSupplierSummaryContact) {
            importSupplierSummaryContact.textContent = buildContactLine(supplier) || 'Contato não informado';
          }
        };

        const updateSupplierStatusCard = (type = 'info', message = '', description = '', actions = []) => {
          if (!importSupplierStatus) return;

          importSupplierStatus.classList.remove('hidden');
          applyStatusClasses(importSupplierStatus, type);

          if (importSupplierIcon) {
            const iconClass = STATUS_ICONS[type] || STATUS_ICONS.info;
            importSupplierIcon.className = `${iconClass} mt-0.5 text-[12px]`;
          }

          if (importSupplierMessage) {
            importSupplierMessage.textContent = message || '';
          }

          if (importSupplierDescription) {
            if (description) {
              importSupplierDescription.textContent = description;
              importSupplierDescription.classList.remove('hidden');
            } else {
              importSupplierDescription.textContent = '';
              importSupplierDescription.classList.add('hidden');
            }
          }

          if (!importSupplierActions) return;

          importSupplierActions.innerHTML = '';
          if (Array.isArray(actions) && actions.length) {
            importSupplierActions.classList.remove('hidden');
            actions.forEach((actionConfig) => {
              if (!actionConfig || !actionConfig.label) return;
              const button = document.createElement('button');
              button.type = 'button';
              button.classList.add(
                'inline-flex',
                'items-center',
                'gap-1.5',
                'rounded-lg',
                'border',
                'px-2.5',
                'py-1',
                'text-[9.5px]',
                'font-semibold',
                'leading-tight',
                'transition',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-1'
              );
              const variantClasses = SUPPLIER_ACTION_VARIANTS[actionConfig.variant] || SUPPLIER_ACTION_VARIANTS.secondary;
              button.classList.add(...variantClasses);
              if (actionConfig.icon) {
                const icon = document.createElement('i');
                icon.className = `${actionConfig.icon} text-[11px]`;
                button.appendChild(icon);
              }
              const label = document.createElement('span');
              label.textContent = actionConfig.label;
              button.appendChild(label);
              if (typeof actionConfig.action === 'function') {
                button.addEventListener('click', actionConfig.action);
              }
              importSupplierActions.appendChild(button);
            });
          } else {
            importSupplierActions.classList.add('hidden');
          }
        };

        const buildSupplierRegistrationUrl = (supplier, nfeData) => {
          const url = new URL('admin-compras-fornecedor-cadastro.html', window.location.href);
          const params = new URLSearchParams();
          const documentDigits = digitsOnly(supplier?.document);
          if (documentDigits) {
            params.set('supplierCnpj', documentDigits);
            params.set('supplierType', documentDigits.length === 11 ? 'fisico' : 'juridico');
          }
          if (supplier?.name) params.set('supplierRazaoSocial', supplier.name);
          if (supplier?.fantasyName) params.set('supplierNomeFantasia', supplier.fantasyName);
          if (supplier?.stateRegistration) params.set('supplierIe', supplier.stateRegistration);
          if (supplier?.email) params.set('supplierEmail', supplier.email);
          if (supplier?.phone) params.set('supplierTelefone', digitsOnly(supplier.phone));
          if (supplier?.address?.cep) params.set('supplierCEP', digitsOnly(supplier.address.cep));
          if (supplier?.address?.street) params.set('supplierLogradouro', supplier.address.street);
          if (supplier?.address?.number) params.set('supplierNumero', supplier.address.number);
          if (supplier?.address?.complement) params.set('supplierComplemento', supplier.address.complement);
          if (supplier?.address?.neighborhood) params.set('supplierBairro', supplier.address.neighborhood);
          if (supplier?.address?.city) params.set('supplierCidade', supplier.address.city);
          if (supplier?.address?.state) params.set('supplierUF', supplier.address.state);
          if (supplier?.address?.country) params.set('supplierPais', supplier.address.country);
          if (nfeData?.accessKey) params.set('supplierObservacao', `Origem: XML NF-e ${nfeData.accessKey}`);
          params.set('from', 'nfe-import');
          url.search = params.toString();
          return url.toString();
        };

        const persistProductDraft = (item, nfeData) => {
          if (!item || typeof sessionStorage === 'undefined') return;
          try {
            const payload = {
              item,
              accessKey: nfeData?.accessKey || '',
              generatedAt: new Date().toISOString(),
            };
            sessionStorage.setItem(PRODUCT_DRAFT_STORAGE_KEY, JSON.stringify(payload));
          } catch (error) {
            console.warn('Não foi possível preparar o rascunho de cadastro do produto importado.', error);
          }
        };

        const buildProductRegistrationUrl = (item, nfeData) => {
          const url = new URL('admin-produtos.html', window.location.href);
          url.searchParams.set('from', 'nfe-import');
          if (nfeData?.accessKey) {
            url.searchParams.set('nfe', nfeData.accessKey);
          }
          const barcode = Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length
            ? item.barcodeCandidates[0]
            : '';
          if (barcode) {
            url.searchParams.set('barcode', barcode);
          }
          return url.toString();
        };

        const openProductRegistration = (item) => {
          if (!item) return;
          persistProductDraft(item, lastNfeData);
          const url = buildProductRegistrationUrl(item, lastNfeData);
          window.open(url, '_blank', 'noopener');
        };

        const updateProductValidationBadge = (items) => {
          if (!importXmlValidationText) return;
          if (!Array.isArray(items) || !items.length) {
            importXmlValidationText.textContent = 'Importe o XML autorizado para validar os itens.';
            applyValidationStyles('info');
            return;
          }
          const hasError = items.some((item) => item.validationStatus === 'error');
          if (hasError) {
            importXmlValidationText.textContent = 'Falha ao validar produtos na base cadastrada.';
            applyValidationStyles('error');
            return;
          }
          const isPending = items.some((item) => item.validationStatus === 'pending' || item.validationStatus === 'checking');
          if (isPending) {
            importXmlValidationText.textContent = 'Validando produtos pelo código de barras...';
            applyValidationStyles('info');
            return;
          }
          const withBarcode = items.filter((item) => Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length);
          const withoutBarcodeCount = items.length - withBarcode.length;
          const notFoundCount = withBarcode.filter((item) => item.validationStatus === 'not-found').length;
          if (!withBarcode.length) {
            importXmlValidationText.textContent = 'XML sem GTIN: valide os produtos manualmente.';
            applyValidationStyles('info');
            return;
          }
          if (notFoundCount > 0) {
            const suffix = notFoundCount === 1 ? '' : 's';
            importXmlValidationText.textContent = `${notFoundCount} produto${suffix} sem cadastro pelo código de barras.`;
            applyValidationStyles('warning');
            return;
          }
          if (withoutBarcodeCount > 0) {
            const suffix = withoutBarcodeCount === 1 ? '' : 's';
            importXmlValidationText.textContent = `${withoutBarcodeCount} item${suffix} sem GTIN precisa${suffix ? 'm' : ''} de revisão.`;
            applyValidationStyles('warning');
            return;
          }
          importXmlValidationText.textContent = 'Todos os produtos foram localizados na base.';
          applyValidationStyles('success');
        };

        function renderImportedProducts(items = []) {
          if (!importProductsTableBody) return;
          importProductsTableBody.innerHTML = '';

          if (!Array.isArray(items) || !items.length) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = PRODUCT_TABLE_COLUMN_COUNT;
            emptyCell.className = 'px-3 py-6 text-center text-[10px] text-gray-500';
            emptyCell.textContent = 'Importe um XML autorizado para listar os itens da NF-e.';
            emptyRow.appendChild(emptyCell);
            importProductsTableBody.appendChild(emptyRow);
            updateProductValidationBadge([]);
            return;
          }

          ensureUniqueInternalCodes(items);

          const fragment = document.createDocumentFragment();

          items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-primary/5';
            row.dataset.itemIndex = String(index);

            if (item.validationStatus === 'not-found') {
              row.classList.add('bg-amber-50/60');
            } else if (item.validationStatus === 'error') {
              row.classList.add('bg-rose-50/60');
            }

            const createBadge = (classes, iconClass, text) => {
              const badge = document.createElement('span');
              badge.classList.add(
                'inline-flex',
                'items-center',
                'gap-1',
                'rounded-full',
                'border',
                'px-1.5',
                'py-0.5',
                'text-[9px]',
                'font-semibold'
              );
              classes.forEach((cls) => badge.classList.add(cls));
              const icon = document.createElement('i');
              icon.className = `${iconClass} text-[10px]`;
              badge.appendChild(icon);
              const label = document.createElement('span');
              label.textContent = text;
              badge.appendChild(label);
              return badge;
            };

            const actionCell = document.createElement('td');
            actionCell.className = 'px-2 py-1.5 bg-white sticky left-0 z-10';
            actionCell.dataset.validationStatus = item.validationStatus || '';

            if (item.validationStatus === 'matched' && item.matchedProduct) {
              actionCell.appendChild(
                createBadge(
                  ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700'],
                  'fas fa-check',
                  'Cadastrado'
                )
              );
            } else if (item.validationStatus === 'pending' || item.validationStatus === 'checking') {
              actionCell.appendChild(
                createBadge(
                  ['border-sky-200', 'bg-sky-50', 'text-sky-700'],
                  'fas fa-spinner fa-spin',
                  'Validando'
                )
              );
            } else if (item.validationStatus === 'error') {
              actionCell.appendChild(
                createBadge(
                  ['border-rose-200', 'bg-rose-50', 'text-rose-700'],
                  'fas fa-circle-exclamation',
                  'Erro'
                )
              );
            } else if (!item.barcodeCandidates || item.barcodeCandidates.length === 0) {
              actionCell.appendChild(
                createBadge(
                  ['border-amber-200', 'bg-amber-50', 'text-amber-700'],
                  'fas fa-barcode',
                  'Sem GTIN'
                )
              );
            } else {
              const button = document.createElement('button');
              button.type = 'button';
              button.classList.add(
                'inline-flex',
                'items-center',
                'gap-1',
                'rounded-full',
                'border',
                'border-primary/40',
                'bg-primary/10',
                'px-1.5',
                'py-0.5',
                'text-[9px]',
                'font-semibold',
                'text-primary',
                'hover:bg-primary/20',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-primary/30'
              );
              button.dataset.productBarcode = item.barcodeCandidates?.[0] || '';
              const icon = document.createElement('i');
              icon.className = 'fas fa-plus';
              const label = document.createElement('span');
              label.textContent = 'Cadastrar';
              button.append(icon, label);
              button.addEventListener('click', () => openProductRegistration(item));
              actionCell.appendChild(button);
            }
            row.appendChild(actionCell);

            const unitarCell = document.createElement('td');
            unitarCell.className = 'px-2 py-1.5';
            const unitarLabel = document.createElement('label');
            unitarLabel.className = 'inline-flex items-center gap-2 text-[9px] text-gray-600';
            const unitarCheckbox = document.createElement('input');
            unitarCheckbox.type = 'checkbox';
            unitarCheckbox.className = 'h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40';
            const unitarText = document.createElement('span');
            unitarText.textContent = 'Unitário';
            unitarLabel.append(unitarCheckbox, unitarText);
            unitarCell.appendChild(unitarLabel);
            row.appendChild(unitarCell);

            const selectCell = document.createElement('td');
            selectCell.className = 'px-2 py-1.5';
            const selectCheckbox = document.createElement('input');
            selectCheckbox.type = 'checkbox';
            selectCheckbox.checked = true;
            selectCheckbox.className = 'h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40';
            selectCell.appendChild(selectCheckbox);
            row.appendChild(selectCell);

            const productCode = normalizeInternalCode(item.internalCode) || '—';
            const systemName = item.matchedProduct?.nome || item.description || '—';
            const supplierCode = item.supplierCode || '—';
            const barcodeText = item.barcodeDisplay || 'SEM GTIN';
            const supplierName = item.description || '—';
            const conversionText = formatDecimal(item.conversion, {
              minimumFractionDigits: 3,
              maximumFractionDigits: 3,
            });
            const quantityText = formatQuantity(item.quantity);
            const unitPriceText = formatMoneyValue(item.unitPrice);
            const discountText = formatMoneyValue(item.discount);
            const totalText = formatMoneyValue(item.total);
            const icmsRateText = formatPercentValue(item.icmsRate);
            const icmsBaseText = formatMoneyValue(item.icmsBase);
            const icmsValueText = formatMoneyValue(item.icmsValue);
            const ivaText = formatPercentValue(item.iva);
            const icmsStRateText = formatPercentValue(item.icmsStRate);
            const icmsStValueText = formatMoneyValue(item.icmsStValue);
            const ipiRateText = formatPercentValue(item.ipiRate);
            const ipiBaseText = formatMoneyValue(item.ipiBase);
            const ipiValueText = formatMoneyValue(item.ipiValue);
            const pisRateText = formatPercentValue(item.pisRate);
            const pisBaseText = formatMoneyValue(item.pisBase);
            const pisValueText = formatMoneyValue(item.pisValue);
            const cofinsRateText = formatPercentValue(item.cofinsRate);
            const cofinsBaseText = formatMoneyValue(item.cofinsBase);
            const cofinsValueText = formatMoneyValue(item.cofinsValue);
            const freightText = formatMoneyValue(item.freight);
            const otherText = formatMoneyValue(item.other);

            const appendCell = (value, className = 'px-2 py-1.5 text-gray-600') => {
              const cell = document.createElement('td');
              cell.className = className;
              cell.textContent = value && value !== '' ? value : '—';
              row.appendChild(cell);
            };

            appendCell(productCode, 'px-2 py-1.5 font-semibold text-gray-700');
            appendCell(systemName, 'px-2 py-1.5 text-gray-700');
            appendCell(supplierCode);
            appendCell(barcodeText);
            appendCell(supplierName);
            appendCell(conversionText);
            appendCell(item.unit || '—');
            appendCell(quantityText, 'px-2 py-1.5 text-right text-gray-600');
            appendCell(unitPriceText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(discountText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(totalText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(item.ncm || '—');
            appendCell(item.cfop || '—');
            appendCell(item.cst || '—');
            appendCell(icmsRateText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(icmsBaseText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(icmsValueText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(ivaText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(icmsStRateText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(icmsStValueText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(ipiRateText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(ipiBaseText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(ipiValueText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(item.ipiCst || '—');
            appendCell(pisRateText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(pisBaseText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(pisValueText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(cofinsRateText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(cofinsBaseText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(cofinsValueText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(freightText, 'px-2 py-1.5 text-right text-gray-700');
            appendCell(otherText, 'px-2 py-1.5 text-right text-gray-700');

            fragment.appendChild(row);
          });

          importProductsTableBody.appendChild(fragment);
          updateProductValidationBadge(items);
        }

        const findProductByBarcode = async (barcodeDigits) => {
          const normalized = normalizeBarcodeForComparison(barcodeDigits);
          if (!normalized) return null;
          if (productLookupCache.has(normalized)) {
            return productLookupCache.get(normalized);
          }
          if (productLookupPromises.has(normalized)) {
            return productLookupPromises.get(normalized);
          }
          const promise = (async () => {
            const response = await fetch(
              `${apiBaseUrl}/products?search=${encodeURIComponent(normalized)}&limit=8`,
              { headers: buildAuthHeaders() }
            );
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
              if (response.status === 401) {
                handleAuthError();
              }
              throw new Error(payload?.message || `Falha ao consultar produtos (status ${response.status}).`);
            }
            const products = Array.isArray(payload?.products)
              ? payload.products
              : Array.isArray(payload)
              ? payload
              : [];
            const match =
              products.find((product) => getProductBarcodeFromRecord(product) === normalized) || null;
            productLookupCache.set(normalized, match);
            return match;
          })();
          productLookupPromises.set(normalized, promise);
          try {
            return await promise;
          } finally {
            productLookupPromises.delete(normalized);
          }
        };

        const findProductMatchForCandidates = async (candidates) => {
          if (!Array.isArray(candidates) || !candidates.length) return null;
          for (const candidate of candidates) {
            const product = await findProductByBarcode(candidate);
            if (product) return product;
          }
          return null;
        };

        const validateImportedProducts = async (nfeData) => {
          if (!nfeData) return;
          const items = Array.isArray(nfeData.items) ? nfeData.items : [];
          const sequence = ++productValidationSequence;

          if (!items.length) {
            renderImportedProducts([]);
            return;
          }

          const itemsWithBarcode = items.filter(
            (item) => Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length
          );
          if (itemsWithBarcode.length) {
            itemsWithBarcode.forEach((item) => {
              item.validationStatus = 'checking';
            });
          }

          renderImportedProducts(items);

          let hadError = false;

          for (const item of itemsWithBarcode) {
            if (sequence !== productValidationSequence) {
              return;
            }
            try {
              const product = await findProductMatchForCandidates(item.barcodeCandidates);
              if (sequence !== productValidationSequence) {
                return;
              }
              if (product) {
                item.matchedProduct = product;
                item.validationStatus = 'matched';
              } else {
                item.matchedProduct = null;
                item.validationStatus = 'not-found';
              }
            } catch (error) {
              console.error('Erro ao validar produto pelo código de barras:', error);
              item.validationStatus = 'error';
              hadError = true;
            }
          }

          if (sequence !== productValidationSequence) {
            return;
          }

          renderImportedProducts(items);

          if (hadError) {
            notify(
              'Alguns produtos não puderam ser validados pelo código de barras. Tente novamente em instantes.',
              'error'
            );
          }
        };

        const updateSummaryFromData = (data) => {
          if (!data) {
            setText(importSummaryEmitenteName, 'Informe a chave ou importe o XML');
            setText(importSummaryEmitenteDocument, 'Documento não identificado');
            setText(importSummaryAccessKey, '------------------------------');
            setText(importSummaryAccessKeyDetails, 'DV -- · Ambiente não identificado');
            setText(importSummaryProtocol, 'Protocolo não informado');
            setText(importSummaryProtocolReceived, 'Recebimento não disponível');
            setText(importSummarySupplierName, 'Fornecedor não localizado');
            setText(importSummarySupplierDocument, 'Documento não disponível');
            setText(importSummaryTotal, 'R$ 0,00');
            setText(importSummaryTotalStatus, 'Aguardando importação do XML');
            setText(importSummaryDestName, 'Destinatário não identificado');
            setText(importSummaryDestDocument, 'Documento não disponível');
            ['nf-number', 'nf-serie', 'nf-emissao', 'nf-entrada', 'cfop', 'natureza', 'modalidade-frete', 'indicador-ie'].forEach(
              (key) => setSummaryInput(key, '')
            );
            if (importXmlNumber) {
              importXmlNumber.textContent = 'XML não importado';
            }
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'Aguardando validação fiscal';
            }
            applyValidationStyles('info');
            if (totalAmountDisplay) {
              totalAmountDisplay.textContent = 'R$ 0,00';
            }
            productValidationSequence += 1;
            renderImportedProducts([]);
            return;
          }

          const supplierDoc = composeDocumentLine(data.emit?.document, data.emit?.stateRegistration);
          const destDoc = composeDocumentLine(data.dest?.document, data.dest?.stateRegistration);

          setText(importSummaryEmitenteName, data.emit?.name || 'Emitente não identificado');
          setText(importSummaryEmitenteDocument, supplierDoc || 'Documento não identificado');

          if (data.accessKey) {
            setText(importSummaryAccessKey, data.accessKey);
            setText(importSummaryAccessKeyDetails, `DV ${data.accessKey.slice(-1)} · ${mapEnvironment(data.ambient)}`);
            if (importXmlNumber) {
              importXmlNumber.textContent = `XML nº ${data.accessKey}`;
            }
          } else {
            setText(importSummaryAccessKey, '------------------------------');
            setText(importSummaryAccessKeyDetails, 'DV -- · Ambiente não identificado');
            if (importXmlNumber) {
              importXmlNumber.textContent = 'XML importado';
            }
          }

          const protocolNumber = data.protocol?.number || '';
          if (protocolNumber) {
            setText(importSummaryProtocol, protocolNumber);
            const received = normalizeDate(data.protocol?.receivedAt);
            const receivedText = received.displayDateTime || received.display || received.dateInput || '';
            setText(
              importSummaryProtocolReceived,
              receivedText ? `Recebido em ${receivedText}` : 'Recebimento registrado pela SEFAZ'
            );
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'XML autorizado na SEFAZ';
            }
            applyValidationStyles('success');
          } else {
            setText(importSummaryProtocol, 'Protocolo não informado');
            setText(importSummaryProtocolReceived, 'Recebimento não disponível');
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'XML importado (aguardando protocolo)';
            }
            applyValidationStyles('warning');
          }

          setText(importSummarySupplierName, data.emit?.name || 'Fornecedor não localizado');
          setText(importSummarySupplierDocument, supplierDoc || 'Documento não disponível');

          const totalFormatted = formatCurrencyBRL(data.totals?.totalValue);
          setText(importSummaryTotal, totalFormatted);
          setText(importSummaryTotalStatus, 'Valor informado pelo XML autorizado');
          if (totalAmountDisplay) {
            totalAmountDisplay.textContent = totalFormatted;
          }

          setText(importSummaryDestName, data.dest?.name || 'Destinatário não identificado');
          setText(importSummaryDestDocument, destDoc || 'Documento não disponível');

          const emission = normalizeDate(data.ide?.emissionDate);
          const entry = normalizeDate(data.ide?.entryDate);

          setSummaryInput('nf-number', data.ide?.number || '');
          setSummaryInput('nf-serie', data.ide?.serie || '');
          setSummaryInput('nf-emissao', emission.display || emission.dateInput || '');
          setSummaryInput('nf-entrada', entry.display || entry.dateInput || '');
          setSummaryInput('cfop', data.ide?.cfop || '');
          setSummaryInput('natureza', data.ide?.natOp || '');
          setSummaryInput('modalidade-frete', mapFrete(data.ide?.freightMode));
          setSummaryInput('indicador-ie', formatIndIe(data.dest?.indIEDest));

          const items = Array.isArray(data.items) ? data.items : [];
          renderImportedProducts(items);
        };

        const fillMainFormFromNfeData = (data) => {
          if (!data) return;
          if (nfeNumberInput && data.ide?.number) nfeNumberInput.value = data.ide.number;
          if (nfeSeriesInput) nfeSeriesInput.value = data.ide?.serie || '';
          if (nfeProtocolInput) nfeProtocolInput.value = data.protocol?.number || '';
          if (nfeReferenceInput) nfeReferenceInput.value = data.ide?.natOp || '';
          const emission = normalizeDate(data.ide?.emissionDate);
          if (issueDateInput) issueDateInput.value = emission.dateInput || '';
          const entry = normalizeDate(data.ide?.entryDate);
          if (entryDateInput) entryDateInput.value = entry.dateInput || '';
          if (nfeModelSelect && data.ide?.model) setSelectValue(nfeModelSelect, data.ide.model);
          if (nfeTypeSelect) setSelectValue(nfeTypeSelect, mapModelToType(data.ide?.model));
          if (accessKeyInput && data.accessKey) accessKeyInput.value = data.accessKey;
          if (importAccessKeyInput && data.accessKey) importAccessKeyInput.value = data.accessKey;
          if (companySelect && data.dest?.document) {
            const companyDigits = digitsOnly(data.dest.document);
            const matchedCompany = Array.from(companySelect.options || []).find((option) => {
              const optionDigits = digitsOnly(`${option.value}${option.textContent || ''}`);
              return optionDigits.includes(companyDigits) || optionDigits === companyDigits;
            });
            if (matchedCompany) {
              companySelect.value = matchedCompany.value;
              companySelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        };

        const handleSupplierSelection = async (supplier) => {
          setSupplierSummary(supplier);
          lastSupplierData = supplier || null;
          if (!supplier || !supplier.document) {
            updateSupplierStatusCard(
              'warning',
              'Documento do emitente não encontrado no XML.',
              'Revise o arquivo para garantir que os dados do fornecedor estejam completos.'
            );
            return;
          }
          const documentDigits = digitsOnly(supplier.document);
          if (!documentDigits) {
            updateSupplierStatusCard(
              'warning',
              'Documento do emitente não encontrado no XML.',
              'Revise o arquivo para garantir que os dados do fornecedor estejam completos.'
            );
            return;
          }
          const formattedDocument = formatDocument(documentDigits);
          let matchedOption = supplierSelect ? findSupplierOptionByDocument(documentDigits) : null;

          await loadSuppliersFromApi();
          let registeredSupplier = supplierRegistry.byDocument.get(documentDigits) || null;

          if (!registeredSupplier && !matchedOption) {
            await loadSuppliersFromApi(true);
            registeredSupplier = supplierRegistry.byDocument.get(documentDigits) || null;
          }

          if (!matchedOption && registeredSupplier) {
            matchedOption = ensureSupplierOption(registeredSupplier, documentDigits);
          }

          if (matchedOption) {
            supplierSelect.value = matchedOption.value;
            supplierSelect.dispatchEvent(new Event('change', { bubbles: true }));
            const supplierName =
              registeredSupplier?.legalName ||
              registeredSupplier?.fantasyName ||
              matchedOption.dataset?.supplierName ||
              supplier.name ||
              formattedDocument;
            updateSupplierStatusCard(
              'success',
              `Fornecedor localizado: ${supplierName}`,
              `Aplicamos automaticamente o fornecedor cadastrado (${formattedDocument}).`
            );
            return;
          }
          const registerUrl = buildSupplierRegistrationUrl(supplier, lastNfeData);
          updateSupplierStatusCard(
            'warning',
            supplierRegistry.error
              ? `Não foi possível confirmar o cadastro do fornecedor (${formattedDocument}).`
              : `Fornecedor não cadastrado (${formattedDocument})`,
            supplierRegistry.error
              ? 'Tente novamente em instantes ou atualize a página para sincronizar a base de fornecedores.'
              : 'Abriremos o cadastro de fornecedores em nova aba com os dados importados do XML.',
            [
              {
                label: supplierRegistry.error ? 'Tentar novamente' : 'Cadastrar fornecedor',
                icon: supplierRegistry.error ? 'fas fa-sync' : 'fas fa-user-plus',
                variant: supplierRegistry.error ? 'secondary' : 'primary',
                action: () => {
                  if (supplierRegistry.error) {
                    loadSuppliersFromApi(true);
                  } else {
                    window.open(registerUrl, '_blank', 'noopener');
                  }
                },
              },
              !supplierRegistry.error
                ? null
                : {
                    label: 'Cadastrar fornecedor',
                    icon: 'fas fa-user-plus',
                    variant: 'primary',
                    action: () => {
                      window.open(registerUrl, '_blank', 'noopener');
                    },
                  },
            ].filter(Boolean)
          );
        };

        const parseNfeXml = (xmlText) => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, 'application/xml');
          if (xml.querySelector('parsererror')) {
            throw new Error('O arquivo XML está inválido ou corrompido.');
          }
          const infNFe = xml.getElementsByTagName('infNFe')[0];
          if (!infNFe) {
            throw new Error('Não foi possível localizar os dados principais da NF-e (infNFe).');
          }
          const getText = (context, tagName) => {
            if (!context) return '';
            const element = context.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
          };
          const ide = infNFe.getElementsByTagName('ide')[0];
          const emit = infNFe.getElementsByTagName('emit')[0];
          const dest = infNFe.getElementsByTagName('dest')[0];
          const total = infNFe.getElementsByTagName('ICMSTot')[0];
          const transp = infNFe.getElementsByTagName('transp')[0];
          const detElements = Array.from(infNFe.getElementsByTagName('det'));
          const prot = xml.getElementsByTagName('protNFe')[0];
          const infProt = prot ? prot.getElementsByTagName('infProt')[0] : null;

          const accessKey = (infNFe.getAttribute('Id') || infNFe.getAttribute('id') || '').replace(/^NFe/i, '');
          const emissionDate = getText(ide, 'dhEmi') || getText(ide, 'dEmi');
          const entryDate = getText(ide, 'dhSaiEnt') || getText(ide, 'dSaiEnt');
          const items = detElements.map((detElement, index) => {
            const prod = detElement.getElementsByTagName('prod')[0];
            const imposto = detElement.getElementsByTagName('imposto')[0];
            const icms = imposto ? imposto.getElementsByTagName('ICMS')[0] : null;
            const icmsNode = icms
              ? Array.from(icms.children || []).find((child) => child.nodeType === 1)
              : null;
            const ipi = imposto ? imposto.getElementsByTagName('IPI')[0] : null;
            const ipiNode = ipi
              ? ipi.getElementsByTagName('IPITrib')[0] ||
                ipi.getElementsByTagName('IPINT')[0] ||
                ipi
              : null;
            const pis = imposto ? imposto.getElementsByTagName('PIS')[0] : null;
            const pisNode = pis
              ? Array.from(pis.children || []).find((child) => child.nodeType === 1)
              : null;
            const cofins = imposto ? imposto.getElementsByTagName('COFINS')[0] : null;
            const cofinsNode = cofins
              ? Array.from(cofins.children || []).find((child) => child.nodeType === 1)
              : null;

            const supplierCode = getText(prod, 'cProd');
            const description = getText(prod, 'xProd');
            const unit = getText(prod, 'uCom');
            const quantityRaw = parseNumber(getText(prod, 'qCom'));
            const quantity = Number.isFinite(quantityRaw) ? quantityRaw : 0;
            const unitPriceRaw = parseNumber(getText(prod, 'vUnCom'));
            const unitPrice = Number.isFinite(unitPriceRaw) ? unitPriceRaw : 0;
            const discountRaw = parseNumber(getText(prod, 'vDesc'));
            const discount = Number.isFinite(discountRaw) ? discountRaw : 0;
            const totalRaw = parseNumber(getText(prod, 'vProd'));
            const total = Number.isFinite(totalRaw) ? totalRaw : quantity * unitPrice;
            const ncm = getText(prod, 'NCM');
            const cfopItem = getText(prod, 'CFOP');
            const ean = getText(prod, 'cEAN');
            const eanTrib = getText(prod, 'cEANTrib');
            const barcodeCandidates = Array.from(new Set([normalizeGtin(ean), normalizeGtin(eanTrib)].filter(Boolean)));
            const barcodeDisplay = formatGtinDisplay(ean || eanTrib);
            const qTribRaw = parseNumber(getText(prod, 'qTrib'));
            const qTrib = Number.isFinite(qTribRaw) ? qTribRaw : quantity;
            const conversion = Number.isFinite(qTrib) && qTrib
              ? quantity / qTrib
              : 1;
            const freightRaw = parseNumber(getText(prod, 'vFrete'));
            const freight = Number.isFinite(freightRaw) ? freightRaw : 0;
            const insuranceRaw = parseNumber(getText(prod, 'vSeg'));
            const insurance = Number.isFinite(insuranceRaw) ? insuranceRaw : 0;
            const otherRaw = parseNumber(getText(prod, 'vOutro'));
            const other = (Number.isFinite(otherRaw) ? otherRaw : 0) + (Number.isFinite(insurance) ? insurance : 0);

            const icmsCst = getText(icmsNode, 'CST') || getText(icmsNode, 'CSOSN') || '';
            const icmsRateRaw = parseNumber(getText(icmsNode, 'pICMS'));
            const icmsRate = Number.isFinite(icmsRateRaw) ? icmsRateRaw : 0;
            const icmsBaseRaw = parseNumber(getText(icmsNode, 'vBC'));
            const icmsBase = Number.isFinite(icmsBaseRaw) ? icmsBaseRaw : 0;
            const icmsValueRaw = parseNumber(getText(icmsNode, 'vICMS'));
            const icmsValue = Number.isFinite(icmsValueRaw) ? icmsValueRaw : 0;
            const ivaRaw = parseNumber(getText(icmsNode, 'pMVAST'));
            const iva = Number.isFinite(ivaRaw) ? ivaRaw : 0;
            const icmsStRateRaw = parseNumber(getText(icmsNode, 'pICMSST'));
            const icmsStRate = Number.isFinite(icmsStRateRaw) ? icmsStRateRaw : 0;
            const icmsStValueRaw = parseNumber(getText(icmsNode, 'vICMSST'));
            const icmsStValue = Number.isFinite(icmsStValueRaw) ? icmsStValueRaw : 0;

            const ipiRateRaw = parseNumber(getText(ipiNode, 'pIPI'));
            const ipiRate = Number.isFinite(ipiRateRaw) ? ipiRateRaw : 0;
            const ipiBaseRaw = parseNumber(getText(ipiNode, 'vBC'));
            const ipiBase = Number.isFinite(ipiBaseRaw) ? ipiBaseRaw : 0;
            const ipiValueRaw = parseNumber(getText(ipiNode, 'vIPI'));
            const ipiValue = Number.isFinite(ipiValueRaw) ? ipiValueRaw : 0;
            const ipiCst = getText(ipiNode, 'CST') || getText(ipi, 'CST') || '';

            const pisRateRaw = parseNumber(getText(pisNode, 'pPIS'));
            const pisRate = Number.isFinite(pisRateRaw) ? pisRateRaw : 0;
            const pisBaseRaw = parseNumber(getText(pisNode, 'vBC'));
            const pisBase = Number.isFinite(pisBaseRaw) ? pisBaseRaw : 0;
            const pisValueRaw = parseNumber(getText(pisNode, 'vPIS'));
            const pisValue = Number.isFinite(pisValueRaw) ? pisValueRaw : 0;

            const cofinsRateRaw = parseNumber(getText(cofinsNode, 'pCOFINS'));
            const cofinsRate = Number.isFinite(cofinsRateRaw) ? cofinsRateRaw : 0;
            const cofinsBaseRaw = parseNumber(getText(cofinsNode, 'vBC'));
            const cofinsBase = Number.isFinite(cofinsBaseRaw) ? cofinsBaseRaw : 0;
            const cofinsValueRaw = parseNumber(getText(cofinsNode, 'vCOFINS'));
            const cofinsValue = Number.isFinite(cofinsValueRaw) ? cofinsValueRaw : 0;

            return {
              index,
              nItem: detElement.getAttribute('nItem') || String(index + 1),
              supplierCode,
              description,
              unit,
              quantity,
              unitPrice,
              discount,
              total,
              ncm,
              cfop: cfopItem,
              cst: icmsCst,
              icmsRate,
              icmsBase,
              icmsValue,
              iva,
              icmsStRate,
              icmsStValue,
              ipiRate,
              ipiBase,
              ipiValue,
              ipiCst,
              pisRate,
              pisBase,
              pisValue,
              cofinsRate,
              cofinsBase,
              cofinsValue,
              freight,
              other,
              barcodeDisplay,
              barcodeCandidates,
              unitTrib: getText(prod, 'uTrib'),
              qTrib,
              conversion: Number.isFinite(conversion) ? conversion : 1,
              validationStatus: barcodeCandidates.length ? 'pending' : 'no-barcode',
              matchedProduct: null,
            };
          });
          const cfop = items.find((item) => item.cfop)?.cfop || '';
          const addressFrom = (element) => {
            if (!element) return {};
            return {
              street: getText(element, 'xLgr'),
              number: getText(element, 'nro'),
              complement: getText(element, 'xCpl'),
              neighborhood: getText(element, 'xBairro'),
              city: getText(element, 'xMun'),
              state: getText(element, 'UF'),
              cep: getText(element, 'CEP'),
              country: getText(element, 'xPais') || 'Brasil',
            };
          };

          return {
            accessKey,
            ambient: getText(ide, 'tpAmb'),
            ide: {
              number: getText(ide, 'nNF'),
              serie: getText(ide, 'serie'),
              emissionDate,
              entryDate,
              natOp: getText(ide, 'natOp'),
              model: getText(ide, 'mod'),
              tpNF: getText(ide, 'tpNF'),
              cfop,
              freightMode: getText(transp, 'modFrete'),
            },
            emit: {
              name: getText(emit, 'xNome'),
              fantasyName: getText(emit, 'xFant'),
              document: getText(emit, 'CNPJ') || getText(emit, 'CPF'),
              stateRegistration: getText(emit, 'IE'),
              email: getText(emit, 'email'),
              phone: getText(emit, 'fone'),
              address: addressFrom(emit?.getElementsByTagName('enderEmit')[0]),
            },
            dest: {
              name: getText(dest, 'xNome') || getText(dest, 'xFant'),
              document: getText(dest, 'CNPJ') || getText(dest, 'CPF'),
              stateRegistration: getText(dest, 'IE'),
              indIEDest: getText(dest, 'indIEDest'),
              email: getText(dest, 'email'),
              phone: getText(dest, 'fone'),
              address: addressFrom(dest?.getElementsByTagName('enderDest')[0]),
            },
            totals: {
              totalValue: getText(total, 'vNF'),
            },
            protocol: {
              number: getText(infProt, 'nProt'),
              receivedAt: getText(infProt, 'dhRecbto'),
              status: getText(infProt, 'cStat'),
            },
            items,
          };
        };

        const processXmlFile = (file) => {
          if (!file) return;
          clearStatusMessages();
          const extension = file.name.split('.').pop()?.toLowerCase();
          if (extension !== 'xml') {
            showFileFeedback('Selecione um arquivo XML autorizado pela SEFAZ (extensão .xml).', 'error');
            return;
          }
          showFileFeedback(`Lendo o arquivo ${file.name}...`, 'info');
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              const result =
                typeof reader.result === 'string'
                  ? reader.result
                  : typeof TextDecoder !== 'undefined'
                  ? new TextDecoder('utf-8').decode(reader.result)
                  : '';
              if (!result) {
                throw new Error('Não foi possível interpretar o conteúdo do XML informado.');
              }
              const parsed = parseNfeXml(result);
              lastNfeData = parsed;
              fillMainFormFromNfeData(parsed);
              updateSummaryFromData(parsed);
              showFileFeedback('Validando fornecedor importado...', 'info');
              await handleSupplierSelection(parsed.emit);
              showFileFeedback('Validando produtos pelo código de barras...', 'info');
              await validateImportedProducts(parsed);

              const nfNumberText = parsed.ide?.number ? `NF ${parsed.ide.number}` : 'NF-e';
              const emitterText = parsed.emit?.name || 'Emitente não identificado';
              const baseMessage = `XML importado com sucesso. ${nfNumberText} - ${emitterText}.`;
              const items = Array.isArray(parsed.items) ? parsed.items : [];
              const errorCount = items.filter((item) => item.validationStatus === 'error').length;
              const unmatchedCount = items.filter((item) => item.validationStatus === 'not-found').length;

              if (errorCount > 0) {
                const suffix = errorCount === 1 ? '' : 's';
                showFileFeedback(
                  `${baseMessage} Não foi possível validar ${errorCount} item${suffix} devido a uma falha na consulta.`,
                  'warning'
                );
              } else if (unmatchedCount > 0) {
                const suffix = unmatchedCount === 1 ? '' : 's';
                showFileFeedback(
                  `${baseMessage} ${unmatchedCount} produto${suffix} precisa${suffix ? 'm' : ''} ser cadastrado pelo código de barras.`,
                  'warning'
                );
              } else {
                showFileFeedback(baseMessage, 'success');
              }
            } catch (error) {
              console.error('Erro ao processar XML da NF-e:', error);
              showFileFeedback(error.message || 'Não foi possível processar o XML informado.', 'error');
            }
          };
          reader.onerror = () => {
            console.error('Erro ao ler o arquivo XML selecionado.', reader.error);
            showFileFeedback('Não foi possível ler o arquivo XML selecionado.', 'error');
          };
          reader.readAsText(file);
        };

        const focusableSelectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';

        function trapFocus(event) {
          if (!importModal || importModal.classList.contains('hidden')) return;
          if (event.key !== 'Tab') return;

          const focusableElements = importModalCard ? Array.from(importModalCard.querySelectorAll(focusableSelectors)).filter((element) => element.offsetParent !== null) : [];
          if (focusableElements.length === 0) return;

          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          if (event.shiftKey && document.activeElement === firstElement) {
            event.preventDefault();
            lastElement.focus();
          } else if (!event.shiftKey && document.activeElement === lastElement) {
            event.preventDefault();
            firstElement.focus();
          }
        }

        function openImportModal() {
          previouslyFocusedElement = document.activeElement;
          importModal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');

          if (importModalCard) {
            importModalCard.classList.add('opacity-0', 'scale-95');
            requestAnimationFrame(() => {
              importModalCard.classList.remove('opacity-0', 'scale-95');
              importModalCard.classList.add('opacity-100', 'scale-100');
            });

            const focusableElements = importModalCard.querySelectorAll(focusableSelectors);
            if (focusableElements.length) {
              focusableElements[0].focus();
            }
          }

          document.addEventListener('keydown', trapFocus);
        }

        function closeImportModal() {
          if (importModalCard) {
            importModalCard.classList.remove('opacity-100', 'scale-100');
            importModalCard.classList.add('opacity-0', 'scale-95');
          }

          document.body.classList.remove('overflow-hidden');
          document.removeEventListener('keydown', trapFocus);

          setTimeout(() => {
            importModal.classList.add('hidden');
            if (previouslyFocusedElement && typeof previouslyFocusedElement.focus === 'function') {
              previouslyFocusedElement.focus();
            }
          }, 180);
        }

        function activateImportTab(tabId) {
          importTabButtons.forEach((button) => {
            const isActive = button.dataset.importTab === tabId;
            button.classList.toggle('active', isActive);
            button.classList.toggle('bg-primary/10', isActive);
            button.classList.toggle('text-primary', isActive);
            button.classList.toggle('border', true);
            button.classList.toggle('border-transparent', isActive);
            button.classList.toggle('border-gray-200', !isActive);
            button.classList.toggle('text-gray-600', !isActive);
            button.classList.add('inline-flex', 'items-center', 'gap-2', 'rounded-lg', 'px-3', 'py-2', 'text-xs', 'font-semibold', 'transition');
          });

          importTabPanels.forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.importTabPanel !== tabId);
          });
        }

        function updateImportMode() {
          const selectedRadio = importModal.querySelector('input[name="import-mode"]:checked');
          const selectedValue = selectedRadio ? selectedRadio.value : null;

          importModePanels.forEach((panel) => {
            const isActive = panel.dataset.importModePanel === selectedValue;
            panel.classList.toggle('hidden', !isActive);
          });

          clearStatusMessages();

          if (importFileInput) {
            importFileInput.value = '';
          }
        }

        openImportModalButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            openImportModal();
            activateImportTab('xml');
            updateImportMode();
          });
        });

        closeImportModalButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            closeImportModal();
          });
        });

        importModal.addEventListener('click', (event) => {
          const target = event.target;
          if (target instanceof Element && target.hasAttribute('data-close-import-modal')) {
            closeImportModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !importModal.classList.contains('hidden')) {
            closeImportModal();
          }
        });

        importTabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            activateImportTab(button.dataset.importTab);
          });
        });

        importModeRadios.forEach((radio) => {
          radio.addEventListener('change', updateImportMode);
        });

        if (importFilePanel && importFileInput) {
          const toggleHover = (isActive) => {
            importFilePanel.classList.toggle('border-primary/60', isActive);
            importFilePanel.classList.toggle('bg-primary/5', isActive);
          };

          ['dragenter', 'dragover'].forEach((eventName) => {
            importFilePanel.addEventListener(eventName, (event) => {
              event.preventDefault();
              toggleHover(true);
            });
          });

          ['dragleave', 'dragend'].forEach((eventName) => {
            importFilePanel.addEventListener(eventName, (event) => {
              event.preventDefault();
              toggleHover(false);
            });
          });

          importFilePanel.addEventListener('drop', (event) => {
            event.preventDefault();
            toggleHover(false);
            if (!event.dataTransfer) return;
            const [file] = event.dataTransfer.files;
            if (file) {
              importFileInput.files = event.dataTransfer.files;
              processXmlFile(file);
            } else {
              clearStatusMessages();
            }
          });

          importFileInput.addEventListener('change', () => {
            const file = importFileInput.files && importFileInput.files[0];
            if (file) {
              processXmlFile(file);
            } else {
              clearStatusMessages();
            }
          });
        }

        indexExistingSupplierOptions();
        loadSuppliersFromApi().catch(() => {});

        window.addEventListener('focus', () => {
          const now = Date.now();
          if (now - supplierRegistry.lastLoadedAt > 15000) {
            loadSuppliersFromApi(true).catch(() => {});
          }
        });

        updateSummaryFromData(null);
        setSupplierSummary(null);
        applyValidationStyles('info');
        activateImportTab('pending');
        updateImportMode();
      }
    });
  </script>
</body>
</html>
