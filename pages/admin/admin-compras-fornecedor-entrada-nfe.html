<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Entrada de NF-e - E o Bicho</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="../../src/output.css">
</head>
<body class="bg-gray-100">
  <div id="admin-header-placeholder"></div>

  <main class="container mx-auto px-4 pt-1 pb-8 min-h-screen">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      <aside class="md:col-span-4">
        <div id="admin-sidebar-placeholder"></div>
      </aside>

      <div class="md:col-span-4 space-y-6">
        <header class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="space-y-2">
            <div class="flex items-center gap-2 text-sm text-gray-500">
              <span class="inline-flex items-center gap-1 rounded-full bg-primary/10 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-primary">
                <i class="fas fa-shopping-basket"></i>
                Compras
              </span>
              <i class="fas fa-angle-right text-xs"></i>
              <span class="font-medium text-gray-600">Fornecedores</span>
              <i class="fas fa-angle-right text-xs"></i>
              <span class="font-semibold text-gray-800">Entrada de NF-e</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">Entrada de NF-e</h1>
              <p class="text-sm text-gray-600">Cadastre entradas modelo 55 com dados exigidos pelo Manual de Orientação do Contribuinte 4.0 e notas técnicas vigentes para NFC-e, NF-e e NFSe.</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button type="button" data-open-import-modal class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
              <i class="fas fa-file-upload"></i>
              Importar XML
            </button>
            <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
              <i class="fas fa-barcode"></i>
              Consultar SEFAZ
            </button>
          </div>
        </header>

        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
          <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-gray-800">Cabeçalho da Nota</h2>
              <p class="text-sm text-gray-500">Preencha o identificador da nota, dados do fornecedor e referência numérica conforme layout nacional da NF-e/NFC-e.</p>
            </div>
            <div class="rounded-lg border border-emerald-100 bg-emerald-50 px-4 py-2 text-right">
              <span class="text-xs font-medium text-emerald-700 block">Total da Nota</span>
              <span class="text-xl font-bold text-emerald-900" data-nfe-total>R$ 0,00</span>
              <p class="text-[11px] text-emerald-700">Somatório automático dos itens</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label for="nfe-code" class="block text-sm font-medium text-gray-700 mb-1">Código</label>
              <div class="relative">
                <input type="text" id="nfe-code" class="w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500" value="Gerado automaticamente" readonly>
                <span class="absolute inset-y-0 right-3 flex items-center text-gray-400 text-xs">AUTO</span>
              </div>
            </div>
            <div>
              <label for="nfe-number" class="block text-sm font-medium text-gray-700 mb-1">NF* (número da nota)</label>
              <input type="text" id="nfe-number" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="10245" required>
            </div>
            <div>
              <label for="nfe-supplier" class="block text-sm font-medium text-gray-700 mb-1">Fornecedor*</label>
              <select id="nfe-supplier" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                <option value="">Selecione o fornecedor</option>
                <option value="30090856000160">30290856000160 - Distribuidora Nacional de Produtos Veterinários Ltda</option>
                <option value="06117473000150">06117473000150 - MSD Saúde Animal Comércio de Produtos Veterinários Ltda</option>
                <option value="07404231000110">07404231000110 - Ourofino Saúde Animal Ltda</option>
              </select>
            </div>
            <div>
              <label for="nfe-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
              <select id="nfe-type" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                <option value="NF" selected>NF</option>
                <option value="NFCe">NFC-e</option>
                <option value="NFSe">NFS-e</option>
              </select>
            </div>
            <div>
              <label for="nfe-series" class="block text-sm font-medium text-gray-700 mb-1">Série</label>
              <input type="text" id="nfe-series" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1">
            </div>
            <div>
              <label for="nfe-protocol" class="block text-sm font-medium text-gray-700 mb-1">Protocolo SEFAZ</label>
              <input type="text" id="nfe-protocol" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240784593211000160550010004273341431819234">
              <p class="mt-1 text-xs text-gray-500">Número conforme retorno da autorização na SEFAZ.</p>
            </div>
            <div class="lg:col-span-2">
              <label for="nfe-reference" class="block text-sm font-medium text-gray-700 mb-1">Referência Fiscal</label>
              <input type="text" id="nfe-reference" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="NF-e emitida pela SEFAZ/SP em ambiente de produção">
            </div>
          </div>
        </section>

        <section class="bg-white rounded-xl shadow-sm border border-gray-100">
          <nav class="flex flex-wrap gap-2 border-b border-gray-100 px-6 pt-6">
            <button type="button" class="tab-button active" data-tab="dados">Dados da Nota</button>
            <button type="button" class="tab-button" data-tab="totais">Totais da Nota</button>
            <button type="button" class="tab-button" data-tab="observacoes">Obs / Outras Informações</button>
            <button type="button" class="tab-button" data-tab="produtos">Produtos</button>
            <button type="button" class="tab-button" data-tab="transportadora">Transportadora</button>
            <button type="button" class="tab-button" data-tab="duplicatas">Duplicatas</button>
            <button type="button" class="tab-button" data-tab="ajustes">Débitos e Créditos</button>
            <button type="button" class="tab-button" data-tab="documentos">Documentos Vinculados</button>
          </nav>

          <div class="p-6 space-y-6">
            <div class="tab-panel" data-tab-panel="dados">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="issue-date" class="block text-sm font-medium text-gray-700 mb-1">Data Emissão*</label>
                  <input type="date" id="issue-date" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                </div>
                <div>
                  <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Empresa*</label>
                  <select id="company" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="vila-bicho">VILA E O BICHO LTDA - CNPJ 11.222.333/0001-44</option>
                    <option value="vilabicho-filial">VILA E O BICHO VAREJO LTDA - CNPJ 33.444.555/0001-66</option>
                  </select>
                </div>
                <div>
                  <label for="nfe-model" class="block text-sm font-medium text-gray-700 mb-1">Modelo da Nota Fiscal*</label>
                  <select id="nfe-model" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="55" selected>55 – Nota Fiscal Eletrônica (NF-e)</option>
                    <option value="65">65 – Nota Fiscal de Consumidor Eletrônica (NFC-e)</option>
                    <option value="57">57 – Conhecimento de Transporte Eletrônico (CT-e)</option>
                    <option value="nfs-e">NFS-e – Nota Fiscal de Serviços Eletrônica</option>
                  </select>
                </div>
                <div>
                  <label for="access-key" class="block text-sm font-medium text-gray-700 mb-1">Chave da NFe (44 dígitos)</label>
                  <input type="text" id="access-key" maxlength="44" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240730290856000160550010000100011999999999">
                  <p class="mt-1 text-xs text-gray-500">Composição: cUF + AAMM + CNPJ + modelo + série + número + tpEmis + cNF + DV.</p>
                </div>
                <div>
                  <label for="entry-date" class="block text-sm font-medium text-gray-700 mb-1">Data Entrada*</label>
                  <input type="date" id="entry-date" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                </div>
                <div>
                  <label for="deposit" class="block text-sm font-medium text-gray-700 mb-1">Depósito*</label>
                  <select id="deposit" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="loja-vila-isabel">Loja Vila Isabel</option>
                    <option value="cd-niteroi">Centro de Distribuição Niterói</option>
                    <option value="cd-jacarepagua">CD Jacarepaguá</option>
                  </select>
                </div>
                <div>
                  <label for="entry-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Entrada*</label>
                  <select id="entry-type" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="revenda">Compra para Revenda</option>
                    <option value="industrializacao">Industrialização</option>
                    <option value="consumo">Uso e Consumo</option>
                    <option value="imobilizado">Ativo Imobilizado</option>
                  </select>
                </div>
                <div>
                  <label for="natureza-operacao" class="block text-sm font-medium text-gray-700 mb-1">Natureza da Operação (NatOp)</label>
                  <input type="text" id="natureza-operacao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.102 - Compra para comercialização">
                </div>
                <div>
                  <label for="cfop" class="block text-sm font-medium text-gray-700 mb-1">CFOP padrão da entrada</label>
                  <input type="text" id="cfop" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.102">
                </div>
                <div>
                  <label for="finalidade" class="block text-sm font-medium text-gray-700 mb-1">Finalidade da NFe</label>
                  <select id="finalidade" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="normal" selected>Normal</option>
                    <option value="devolucao">Devolução</option>
                    <option value="ajuste">Ajuste</option>
                  </select>
                </div>
                <div>
                  <label for="indicador-presenca" class="block text-sm font-medium text-gray-700 mb-1">Indicador de Presença (indPres)</label>
                  <select id="indicador-presenca" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="0">0 – Não se aplica (NF-e)</option>
                    <option value="1">1 – Operação presencial</option>
                    <option value="2">2 – Internet</option>
                    <option value="3">3 – Teleatendimento</option>
                    <option value="4">4 – Entrega em domicílio</option>
                    <option value="5">5 – Operação presencial fora do estabelecimento</option>
                    <option value="9">9 – Operação não presencial, outros</option>
                  </select>
                </div>
                <div>
                  <label for="tipo-emissao" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Emissão (tpEmis)</label>
                  <select id="tipo-emissao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="1" selected>1 – Emissão normal</option>
                    <option value="2">2 – Contingência FS-IA</option>
                    <option value="3">3 – Contingência SCAN</option>
                    <option value="4">4 – Contingência DPEC</option>
                    <option value="5">5 – Contingência FS-DA</option>
                    <option value="6">6 – Contingência SVC-AN</option>
                    <option value="7">7 – Contingência SVC-RS</option>
                    <option value="9">9 – Contingência off-line da NFC-e</option>
                  </select>
                </div>
              </div>

              <div class="mt-6 border-t border-gray-100 pt-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-4">Dados do Fornecedor</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label for="supplier-cnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ / CPF</label>
                    <input type="text" id="supplier-cnpj" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30.290.856/0001-60">
                  </div>
                  <div>
                    <label for="supplier-ie" class="block text-sm font-medium text-gray-700 mb-1">Inscrição Estadual</label>
                    <input type="text" id="supplier-ie" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="244/0178792">
                  </div>
                  <div>
                    <label for="supplier-uf" class="block text-sm font-medium text-gray-700 mb-1">UF</label>
                    <select id="supplier-uf" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                      <option value="">Selecione</option>
                      <option value="SP">SP - São Paulo</option>
                      <option value="RJ">RJ - Rio de Janeiro</option>
                      <option value="MG">MG - Minas Gerais</option>
                      <option value="RS">RS - Rio Grande do Sul</option>
                      <option value="PR">PR - Paraná</option>
                      <option value="SC">SC - Santa Catarina</option>
                      <option value="BA">BA - Bahia</option>
                      <option value="PE">PE - Pernambuco</option>
                      <option value="CE">CE - Ceará</option>
                      <option value="DF">DF - Distrito Federal</option>
                    </select>
                  </div>
                  <div>
                    <label for="supplier-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail fiscal</label>
                    <input type="email" id="supplier-email" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="nfe@distribuidora.com.br">
                  </div>
                  <div class="md:col-span-2 lg:col-span-4">
                    <label for="supplier-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço completo</label>
                    <input type="text" id="supplier-address" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Av. Paulista, 1800 - Bela Vista, São Paulo - SP, 01310-200">
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="totais">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div>
                    <label for="valor-produtos" class="block text-sm font-medium text-gray-700 mb-1">Valor Produtos (R$)</label>
                    <input type="number" step="0.01" id="valor-produtos" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="14000.00">
                  </div>
                  <div>
                    <label for="base-icms" class="block text-sm font-medium text-gray-700 mb-1">Base ICMS (R$)</label>
                    <input type="number" step="0.01" id="base-icms" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-icms" class="block text-sm font-medium text-gray-700 mb-1">Valor ICMS (R$)</label>
                    <input type="number" step="0.01" id="valor-icms" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="icms-st" class="block text-sm font-medium text-gray-700 mb-1">ICMS Subst. (R$)</label>
                    <input type="number" step="0.01" id="icms-st" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-fcp-st" class="block text-sm font-medium text-gray-700 mb-1">Valor FCP ST (R$)</label>
                    <input type="number" step="0.01" id="valor-fcp-st" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="total-servicos" class="block text-sm font-medium text-gray-700 mb-1">Total Serviços (R$)</label>
                    <input type="number" step="0.01" id="total-servicos" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-ajuste-esquerda" class="block text-sm font-medium text-gray-700 mb-1">Valor do Ajuste (R$)</label>
                    <input type="number" step="0.01" id="valor-ajuste-esquerda" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                </div>

                <div class="space-y-4">
                  <div>
                    <label for="desconto" class="block text-sm font-medium text-gray-700 mb-1">Desconto (R$)</label>
                    <input type="number" step="0.01" id="desconto" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="outras-despesas" class="block text-sm font-medium text-gray-700 mb-1">Outras Despesas (R$)</label>
                    <input type="number" step="0.01" id="outras-despesas" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-frete" class="block text-sm font-medium text-gray-700 mb-1">Valor Frete (R$)</label>
                    <input type="number" step="0.01" id="valor-frete" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-ipi" class="block text-sm font-medium text-gray-700 mb-1">Valor IPI (R$)</label>
                    <input type="number" step="0.01" id="valor-ipi" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="desconto-unitario" class="block text-sm font-medium text-gray-700 mb-1">Desconto Unitário (R$)</label>
                    <input type="number" step="0.01" id="desconto-unitario" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-seguro" class="block text-sm font-medium text-gray-700 mb-1">Valor Seguro (R$)</label>
                    <input type="number" step="0.01" id="valor-seguro" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                  </div>
                  <div>
                    <label for="valor-dolar" class="block text-sm font-medium text-gray-700 mb-1">Valor da NF em Dólar</label>
                    <input type="number" step="0.01" id="valor-dolar" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="2974.55">
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="observacoes">
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Pagar Frete
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Não Alterar Estoque
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Valor Seguro
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Não escriturar o valor de ICMS
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="condicao-pagamento" class="block text-sm font-medium text-gray-700 mb-1">Condição de Pagamento</label>
                    <input type="text" id="condicao-pagamento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30/60/90 dias">
                  </div>
                  <div>
                    <label for="cliente-retorno" class="block text-sm font-medium text-gray-700 mb-1">Cliente para retorno parcial (F2)</label>
                    <input type="text" id="cliente-retorno" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Pesquisar cliente">
                  </div>
                  <div>
                    <label for="centro-custo" class="block text-sm font-medium text-gray-700 mb-1">Centro de Custo (F2)</label>
                    <input type="text" id="centro-custo" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="01.02.03 - Comercial">
                  </div>
                  <div>
                    <label for="forma-pagamento" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                    <input type="text" id="forma-pagamento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="À Vista">
                  </div>
                </div>

                <div>
                  <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">Observação</label>
                  <textarea id="observacao" rows="4" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Informações complementares sobre a operação."></textarea>
                </div>
                <div>
                  <label for="informacoes-complementares" class="block text-sm font-medium text-gray-700 mb-1">Informações Complementares ao Fisco/Contribuinte</label>
                  <textarea id="informacoes-complementares" rows="3" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Referência à legislação municipal ou mensagens obrigatórias da SEFAZ."></textarea>
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="produtos">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-sm font-semibold text-gray-700">Itens da nota</h3>
                <div class="flex flex-wrap gap-2">
                  <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-plus-circle"></i>
                    Adicionar Produto
                  </button>
                  <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-exchange-alt"></i>
                    Alterar Fornecedor por Produto
                  </button>
                </div>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Item</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Não escriturar o valor de ICMS</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Código</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold text-gray-700">Descrição</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Qtde.</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Multiplicador/Divisor</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Estoque de entrada</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Custo calculado (R$)</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Unitário (R$)</th>
                      <th scope="col" class="px-4 py-3 text-right font-semibold text-gray-700">Desc (%)</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white" data-nfe-products-body>
                    <tr class="hidden" data-nfe-products-empty>
                      <td class="px-4 py-3 text-center text-gray-500" colspan="10">
                        Nenhum produto importado do XML.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="transportadora">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="transportadora-cnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                  <input type="text" id="transportadora-cnpj" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="12.345.678/0001-99">
                </div>
                <div>
                  <label for="transportadora-ie" class="block text-sm font-medium text-gray-700 mb-1">IE – Transportadora</label>
                  <input type="text" id="transportadora-ie" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="111.222.333.444">
                </div>
                <div>
                  <label for="transportadora-uf" class="block text-sm font-medium text-gray-700 mb-1">UF – Transportadora</label>
                  <select id="transportadora-uf" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="">Selecione</option>
                    <option value="SP">SP - São Paulo</option>
                    <option value="RJ">RJ - Rio de Janeiro</option>
                    <option value="MG">MG - Minas Gerais</option>
                    <option value="ES">ES - Espírito Santo</option>
                  </select>
                </div>
                <div>
                  <label for="transportadora-placa" class="block text-sm font-medium text-gray-700 mb-1">Placa – Transportadora</label>
                  <input type="text" id="transportadora-placa" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="RIO1A23">
                </div>
                <div>
                  <label for="transportadora-uf-placa" class="block text-sm font-medium text-gray-700 mb-1">UF Placa – Transportadora</label>
                  <select id="transportadora-uf-placa" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="">Selecione</option>
                    <option value="SP">SP</option>
                    <option value="RJ">RJ</option>
                    <option value="MG">MG</option>
                    <option value="ES">ES</option>
                  </select>
                </div>
                <div>
                  <label for="peso-bruto" class="block text-sm font-medium text-gray-700 mb-1">Peso Bruto</label>
                  <input type="number" step="0.001" id="peso-bruto" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="185.750">
                </div>
                <div>
                  <label for="peso-liquido" class="block text-sm font-medium text-gray-700 mb-1">Peso Líquido</label>
                  <input type="number" step="0.001" id="peso-liquido" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="172.300">
                </div>
                <div>
                  <label for="modalidade-frete" class="block text-sm font-medium text-gray-700 mb-1">Modalidade do Frete (modFrete)</label>
                  <select id="modalidade-frete" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="0" selected>0 – Por conta do emitente</option>
                    <option value="1">1 – Por conta do destinatário/remetente</option>
                    <option value="2">2 – Por conta de terceiros</option>
                    <option value="3">3 – Transporte próprio por conta do remetente</option>
                    <option value="4">4 – Transporte próprio por conta do destinatário</option>
                    <option value="9">9 – Sem frete</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label for="transportadora-razao" class="block text-sm font-medium text-gray-700 mb-1">Razão Social / Nome</label>
                  <input type="text" id="transportadora-razao" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Transportes RodoVia Ltda">
                </div>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="duplicatas">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="conta-contabil" class="block text-sm font-medium text-gray-700 mb-1">Conta Contábil (F2)*</label>
                  <input type="text" id="conta-contabil" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="1.1.3.01 - Fornecedores Nacionais" required>
                </div>
                <div>
                  <label for="forma-pagamento-duplicata" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                  <select id="forma-pagamento-duplicata" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="boleto">Boleto</option>
                    <option value="transferencia">Transferência</option>
                    <option value="pix">PIX</option>
                    <option value="dinheiro">Dinheiro</option>
                  </select>
                </div>
                <div>
                  <label for="conta-corrente" class="block text-sm font-medium text-gray-700 mb-1">Conta Corrente* </label>
                  <select id="conta-corrente" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" required>
                    <option value="">Selecione</option>
                    <option value="001-12345-6">Banco do Brasil 001 - Ag. 1234 - C/C 56789-0</option>
                    <option value="104-98765-4">Caixa 104 - Ag. 2222 - C/C 33333-3</option>
                  </select>
                </div>
                <div>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 mt-7">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Considerar Inativos
                  </label>
                </div>
                <div>
                  <label for="duplicata-data-emissao" class="block text-sm font-medium text-gray-700 mb-1">Data Emissão</label>
                  <input type="date" id="duplicata-data-emissao" class="w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500" value="2024-07-05" readonly>
                </div>
                <div>
                  <label for="numero-doc-bancario" class="block text-sm font-medium text-gray-700 mb-1">Nº Doc. Bancário</label>
                  <input type="text" id="numero-doc-bancario" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="0001234567">
                </div>
                <div>
                  <label for="parcelas" class="block text-sm font-medium text-gray-700 mb-1">Parcelas*</label>
                  <input type="number" id="parcelas" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" min="1" value="3" required>
                </div>
                <div>
                  <label for="dias-vencimento" class="block text-sm font-medium text-gray-700 mb-1">Dias Vencimento Inicial</label>
                  <input type="number" id="dias-vencimento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30">
                </div>
                <div>
                  <label for="vencimento-inicial" class="block text-sm font-medium text-gray-700 mb-1">Vencimento Inicial</label>
                  <input type="date" id="vencimento-inicial" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="tipo-dias" class="block text-sm font-medium text-gray-700 mb-1">Tipo dias</label>
                  <select id="tipo-dias" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="dias" selected>Nº de dias</option>
                    <option value="data">Data fixa</option>
                  </select>
                </div>
                <div>
                  <label for="dias" class="block text-sm font-medium text-gray-700 mb-1">Dias</label>
                  <input type="number" id="dias" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="30">
                </div>
                <div>
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 mt-7">
                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary/30">
                    Previsão
                  </label>
                </div>
              </div>

              <div class="mt-6 flex flex-wrap items-center gap-3">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-calculator"></i>
                  Gerar
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Parcela</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Dias</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Vencimento Inicial</th>
                      <th class="px-4 py-3 text-right font-semibold text-gray-700">Valor (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Observação</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Conta Contábil</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Código Conta Contábil</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Conta Corrente</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white" data-nfe-duplicatas-body>
                    <tr class="hidden" data-nfe-duplicatas-empty>
                      <td class="px-4 py-3 text-center text-gray-500" colspan="8">
                        Nenhuma duplicata foi informada no XML.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="ajustes">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="origem" class="block text-sm font-medium text-gray-700 mb-1">Origem</label>
                  <select id="origem" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <option value="nacional" selected>Nacional</option>
                    <option value="importada-direta">Importada - Adquirida no exterior</option>
                    <option value="importada-interna">Importada - Adquirida no mercado interno</option>
                  </select>
                </div>
                <div>
                  <label for="cst" class="block text-sm font-medium text-gray-700 mb-1">CST</label>
                  <input type="text" id="cst" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="090">
                </div>
                <div>
                  <label for="base-calculo" class="block text-sm font-medium text-gray-700 mb-1">Base de Cálculo (R$)</label>
                  <input type="number" step="0.01" id="base-calculo" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="aliquota" class="block text-sm font-medium text-gray-700 mb-1">Alíquota (%)</label>
                  <input type="number" step="0.01" id="aliquota" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="valor-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Valor do Ajuste (R$)</label>
                  <input type="number" step="0.01" id="valor-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                  <label for="motivo-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                  <input type="text" id="motivo-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="Táxi">
                </div>
                <div>
                  <label for="codigo-ajuste" class="block text-sm font-medium text-gray-700 mb-1">Código do Ajuste (F2)</label>
                  <input type="text" id="codigo-ajuste" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="RJ090000">
                </div>
              </div>

              <div class="mt-6 flex flex-wrap gap-3">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-plus"></i>
                  Adicionar
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-eraser"></i>
                  Limpar
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Origem</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">CST</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Base de Cálculo (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Alíquota (%)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Valor do Ajuste (R$)</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Motivo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Código do Ajuste</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
                    <tr>
                      <td class="px-4 py-3 text-gray-600">Nacional</td>
                      <td class="px-4 py-3 text-gray-600">090</td>
                      <td class="px-4 py-3 text-gray-600">R$ 1.500,00</td>
                      <td class="px-4 py-3 text-gray-600">18%</td>
                      <td class="px-4 py-3 text-gray-600">R$ 270,00</td>
                      <td class="px-4 py-3 text-gray-600">Táxi</td>
                      <td class="px-4 py-3 text-gray-600">RJ090000</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-panel hidden" data-tab-panel="documentos">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-sm font-semibold text-gray-700">Documentos vinculados</h3>
                <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-primary/90 transition">
                  <i class="fas fa-link"></i>
                  Adicionar NF
                </button>
              </div>

              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Modelo</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Número da Nota</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Chave de Acesso</th>
                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Data Emissão</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white" data-nfe-documents-body>
                    <tr class="hidden" data-nfe-documents-empty>
                      <td class="px-4 py-3 text-center text-gray-500" colspan="5">
                        Nenhum documento vinculado pelo XML.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <button type="button" data-open-import-modal class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-file-import"></i>
                  Importar XML
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-eye"></i>
                  Visualizar Lotes
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-tags"></i>
                  Alterar Preços
                </button>
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50 transition">
                  <i class="fas fa-clipboard-list"></i>
                  Pedidos
                </button>
              </div>

              <div class="mt-4 flex flex-wrap gap-2 text-xs text-gray-500">
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-file-excel"></i>
                  Excel
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-file-pdf"></i>
                  PDF
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-table"></i>
                  Layout
                </button>
                <button type="button" class="inline-flex items-center gap-1 rounded border border-gray-200 px-2.5 py-1 font-medium hover:bg-gray-50">
                  <i class="fas fa-expand"></i>
                  Tela Cheia
                </button>
              </div>
            </div>
          </div>
        </section>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
          <h2 class="text-lg font-semibold text-gray-800">Referências oficiais</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Portal Nacional da NF-e</h3>
              <p class="mt-2 text-sm text-gray-600">Consulta autorizada e download de esquemas para NF-e, NFC-e e eventos vinculados.</p>
              <a href="https://www.nfe.fazenda.gov.br/portal" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Acessar portal
              </a>
            </article>
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Manual de Orientação do Contribuinte 4.0</h3>
              <p class="mt-2 text-sm text-gray-600">Layout nacional de NF-e (modelo 55) e NFC-e (modelo 65) atualizado com NT 2023.</p>
              <a href="https://www.nfe.fazenda.gov.br/portal/exibirArquivo.aspx?conteudo=j6Nz6xH3O9E=" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Baixar MOC
              </a>
            </article>
            <article class="rounded-lg border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Portal de NFSe Nacional</h3>
              <p class="mt-2 text-sm text-gray-600">Documentação oficial da ABRASF e padrão nacional de serviços eletrônicos.</p>
              <a href="https://www.gov.br/nfse/pt-br" target="_blank" rel="noopener" class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                <i class="fas fa-external-link-alt"></i>
                Consultar NFSe</a>
            </article>
          </div>
        </div>

        <div class="flex flex-col gap-3 md:flex-row md:justify-end">
          <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
            <i class="fas fa-file-archive"></i>
            Salvar rascunho
          </button>
          <button type="button" data-clear-import class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
            <i class="fas fa-eraser"></i>
            Limpar
          </button>
          <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 transition">
            <i class="fas fa-save"></i>
            Registrar entrada da NF-e
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="import-xml-modal" class="fixed inset-0 z-[999] hidden">
    <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" data-close-import-modal></div>
    <div class="relative mx-auto flex min-h-full w-full items-start justify-center px-3 py-6 sm:items-center">
      <div data-import-modal-card class="relative flex w-full max-w-[1352px] transform-gpu flex-col overflow-hidden rounded-2xl bg-white shadow-2xl opacity-0 transition-all duration-200 ease-out scale-95 max-h-[90vh] min-h-0 text-[12px] leading-[1.35]">
        <header class="flex flex-col gap-2.5 border-b border-gray-100 px-4 py-3 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <span class="inline-flex items-center gap-1.5 rounded-full bg-primary/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-primary">
              <i class="fas fa-file-import"></i>
              Importação de NF-e
            </span>
            <h2 class="mt-1.5 text-lg font-semibold text-gray-900">Importar XML autorizado na SEFAZ</h2>
            <p class="mt-1 max-w-3xl text-[11px] text-gray-600">Utilize um XML emitido conforme o Manual de Orientação do Contribuinte 4.0 ou informe a chave de acesso válida (44 dígitos) para recuperar automaticamente dados oficiais da NF-e, NFC-e ou NFS-e.</p>
          </div>
          <button type="button" data-close-import-modal class="inline-flex items-center justify-center rounded-full border border-gray-200 p-1.5 text-gray-500 transition hover:bg-gray-50 hover:text-gray-700">
            <span class="sr-only">Fechar modal</span>
            <i class="fas fa-times"></i>
          </button>
        </header>

        <nav class="flex flex-wrap gap-2 border-b border-gray-100 px-4 pt-2.5">
          <button type="button" data-import-tab="pending" class="import-tab-button active">Notas Pendentes</button>
          <button type="button" data-import-tab="xml" class="import-tab-button">Importar XML</button>
        </nav>

        <div class="flex-1 overflow-y-auto px-4 py-4">
          <div data-import-tab-panel="pending" class="space-y-3.5">
            <div class="grid grid-cols-1 gap-3 lg:grid-cols-2">
              <article class="rounded-xl border border-amber-200 bg-amber-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-amber-900">NF-e 35240730290856000160550010000100011999999999</h3>
                    <p class="text-[10px] text-amber-800">Autorizada em 02/07/2024 · SEFAZ/SP · Distribuidora Nacional de Produtos Veterinários Ltda</p>
                  </div>
                  <span class="rounded-full bg-amber-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-amber-700">Pendência</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-amber-900">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 15.487,32</dd>
                  </div>
                  <div>
                    <dt class="font-medium">CFOP predominante</dt>
                    <dd>1.102 · Compra para comercialização</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Modelo</dt>
                    <dd>55 – NF-e</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Origem</dt>
                    <dd>Portal Nacional da NF-e</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg bg-primary px-2.5 py-1.5 text-[10px] font-semibold text-white shadow-sm transition hover:bg-primary/90">
                    <i class="fas fa-download"></i>
                    Baixar XML autorizado
                  </button>
                  <span class="text-[9px] text-amber-700">Baseado em XML de exemplo oficial SEFAZ/SP.</span>
                </div>
              </article>

              <article class="rounded-xl border border-sky-200 bg-sky-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-sky-900">NFC-e 41230676107918000173550010012345678901234567</h3>
                    <p class="text-[10px] text-sky-800">Autorizada em 18/06/2024 · SEFAZ/PR · Contingência NFC-e homologação</p>
                  </div>
                  <span class="rounded-full bg-sky-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-sky-700">Pendente</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-sky-900">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 289,40</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Destinatário</dt>
                    <dd>Consumidor final</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Modelo</dt>
                    <dd>65 – NFC-e</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Prazo</dt>
                    <dd>Pagamento imediato</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-sky-200 px-2.5 py-1.5 text-[10px] font-semibold text-sky-800 transition hover:bg-sky-100">
                    <i class="fas fa-eye"></i>
                    Visualizar DANFE NFC-e
                  </button>
                  <span class="text-[9px] text-sky-700">Com base em arquivo de contingência SEFAZ/PR.</span>
                </div>
              </article>

              <article class="lg:col-span-2 rounded-xl border border-emerald-200 bg-emerald-50/60 p-3.5">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-0.5">
                    <h3 class="text-[12px] font-semibold text-emerald-900">NFS-e padrão nacional · Exemplo ABRASF</h3>
                    <p class="text-[10px] text-emerald-800">Competência 06/2024 · Prefeitura do Rio de Janeiro · RPS 23145</p>
                  </div>
                  <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-emerald-700">Pendente</span>
                </div>
                <dl class="mt-2.5 grid grid-cols-2 gap-2 text-[10px] text-emerald-900 sm:grid-cols-4">
                  <div>
                    <dt class="font-medium">Valor total</dt>
                    <dd class="text-[12px] font-semibold">R$ 1.250,00</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Alíquota ISS</dt>
                    <dd>3,00%</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Natureza</dt>
                    <dd>Código LC 116 · Serviços veterinários</dd>
                  </div>
                  <div>
                    <dt class="font-medium">Município</dt>
                    <dd>Rio de Janeiro/RJ</dd>
                  </div>
                </dl>
                <div class="mt-2.5 flex flex-wrap items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-emerald-200 px-2.5 py-1.5 text-[10px] font-semibold text-emerald-800 transition hover:bg-emerald-100">
                    <i class="fas fa-eye"></i>
                    Visualizar RPS
                  </button>
                  <span class="text-[9px] text-emerald-700">Layout Simpliss/ABRASF 2.03 em ambiente oficial.</span>
                </div>
              </article>
            </div>

            <div class="rounded-xl border border-dashed border-gray-200 bg-gray-50 p-3 text-[10px] text-gray-600">
              <h4 class="text-xs font-semibold text-gray-800">Fluxo resumido</h4>
              <ul class="mt-1.5 space-y-1">
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Consulta portal nacional NF-e/NFC-e ou NFSe Nacional.</span>
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Validação XML conforme MOC 4.0, NT 2023.004 e padrão ABRASF.</span>
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-[9px] text-primary mt-0.5"></i>
                  <span>Itens e tributos são conciliados antes da escrituração.</span>
                </li>
              </ul>
            </div>
          </div>

          <div data-import-tab-panel="xml" class="hidden space-y-3.5">
            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Selecione como deseja importar</h3>
                  <p class="text-[11px] text-gray-600">Utilize uma chave de acesso autorizada, ou faça upload de um XML oficial baixado no Portal Nacional.</p>
                </div>
                <div class="flex flex-col gap-0.5 text-[10px] text-gray-600 sm:flex-row sm:items-center">
                  <span class="inline-flex items-center gap-1 text-primary">
                    <i class="fas fa-shield-check text-[11px]"></i>
                    Validação XSD oficial
                  </span>
                  <span class="inline-flex items-center gap-1 text-emerald-600">
                    <i class="fas fa-file-code text-[11px]"></i>
                    NF-e 4.0 · NFC-e 4.0 · NFS-e ABRASF
                  </span>
                </div>
              </header>
              <div class="grid grid-cols-1 gap-2.5 p-3.5 lg:grid-cols-3">
                <div class="space-y-1.5">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Tipo de importação</label>
                  <div class="grid grid-cols-2 gap-1.5 text-[10px] font-medium text-gray-600">
                    <label class="inline-flex items-center gap-2 rounded-lg border border-primary/40 bg-primary/10 px-2.5 py-1.5">
                      <input type="radio" name="import-mode" value="access-key" class="h-3 w-3 text-primary focus:ring-primary/40" checked>
                      Chave de acesso
                    </label>
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="radio" name="import-mode" value="file" class="h-3 w-3 text-primary focus:ring-primary/40">
                      Arquivo XML
                    </label>
                  </div>
                </div>
                <div class="space-y-1.5" data-import-mode-panel="access-key">
                  <label for="import-access-key" class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Informe a chave</label>
                  <div class="flex gap-1.5">
                    <input type="text" id="import-access-key" maxlength="44" class="w-full rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] focus:border-primary focus:ring-2 focus:ring-primary/20" placeholder="35240730290856000160550010000100011999999999">
                    <button type="button" class="inline-flex items-center gap-1.5 rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-white shadow-sm transition hover:bg-primary/90">
                      <i class="fas fa-search"></i>
                      Consultar portal
                    </button>
                  </div>
                  <p class="text-[9px] text-gray-500">Consulta automática ao Portal Nacional da NF-e/NFC-e ou NFSe Nacional.</p>
                </div>
                <div class="space-y-1.5 hidden" data-import-mode-panel="file">
                  <label for="import-file-input" class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Envie o XML</label>
                  <label for="import-file-input" class="flex cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 px-3 py-5 text-center text-[10px] text-gray-500 transition hover:border-primary hover:text-primary">
                    <i class="fas fa-cloud-upload-alt text-lg"></i>
                    <span>Selecione ou arraste o arquivo XML autorizado</span>
                    <input id="import-file-input" type="file" accept=".xml" class="hidden">
                  </label>
                  <p class="text-[9px] text-gray-500">Validação com esquemas oficiais (XSD) e regras de negócio SEFAZ.</p>
                </div>
                <div class="space-y-1.5">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Ações rápidas</label>
                  <div class="grid grid-cols-1 gap-1.5 text-[10px] font-medium text-gray-600 sm:grid-cols-2">
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="checkbox" class="h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40" checked>
                      Importar automaticamente produtos novos
                    </label>
                    <label class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-2.5 py-1.5 transition hover:border-primary/40 hover:text-primary">
                      <input type="checkbox" class="h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40" checked>
                      Atualizar preços de compra existentes
                    </label>
                  </div>
                </div>
                <div class="lg:col-span-3 grid grid-cols-1 gap-1.5 pt-1 md:grid-cols-2 xl:grid-cols-3" data-import-supplier-insights>
                  <div data-file-feedback class="hidden h-full rounded-lg border px-3 py-2 text-[10px] font-medium leading-snug"></div>
                  <div data-import-supplier-status class="hidden h-full rounded-lg border px-3 py-2 text-[10px] text-gray-600 space-y-1.5 sm:space-y-0">
                    <div class="flex items-start gap-1.5">
                      <i data-supplier-status-icon class="fas fa-circle-info mt-0.5 text-[12px]"></i>
                      <div class="space-y-0.5">
                        <p data-supplier-message class="text-[11px] font-semibold text-gray-700 leading-snug"></p>
                        <p data-supplier-description class="text-[10px] text-gray-600 leading-snug"></p>
                      </div>
                    </div>
                    <div data-supplier-actions class="flex flex-wrap gap-1.5 sm:mt-0"></div>
                  </div>
                  <div data-import-supplier-summary class="hidden h-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-[10px] text-gray-600 space-y-1.5">
                    <p data-supplier-summary-name class="text-[11px] font-semibold text-gray-700 leading-snug"></p>
                    <dl class="grid grid-cols-1 gap-1 sm:grid-cols-2 sm:gap-y-1.5">
                      <div>
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Documento</dt>
                        <dd data-supplier-summary-document class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div>
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Inscrição Estadual</dt>
                        <dd data-supplier-summary-ie class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div class="sm:col-span-2">
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Endereço</dt>
                        <dd data-supplier-summary-address class="text-gray-700 leading-snug"></dd>
                      </div>
                      <div class="sm:col-span-2">
                        <dt class="text-[9px] font-semibold uppercase tracking-wide text-gray-500">Contato</dt>
                        <dd data-supplier-summary-contact class="text-gray-700 leading-snug"></dd>
                      </div>
                    </dl>
                  </div>
                </div>
              </div>
            </section>

            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Dados da nota fiscal</h3>
                  <p class="text-[11px] text-gray-600">Resumo preenchido automaticamente conforme leiaute nacional 4.0 da NF-e.</p>
                </div>
                <div class="text-right text-[10px] text-gray-500">
                  <span class="block font-semibold text-gray-700">MOC 4.0</span>
                  <span>NT 2023.003 · NT 2023.004</span>
                </div>
              </header>
              <div class="grid grid-cols-1 gap-2.5 p-3.5 text-[10px] text-gray-600 lg:grid-cols-4">
                <div class="lg:col-span-2">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Emitente</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-emitente-nome>Informe a chave ou importe o XML</p>
                    <p data-import-emitente-document>Documento não identificado</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Chave de acesso</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-mono text-[12px] text-gray-700" data-import-access-key>------------------------------</p>
                    <p data-import-access-key-details>DV -- · Ambiente não identificado</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Protocolo</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p data-import-protocol>Protocolo não informado</p>
                    <p data-import-protocol-received>Recebimento não disponível</p>
                  </div>
                </div>
                <div class="lg:col-span-4 grid grid-cols-1 gap-2.5 sm:grid-cols-2 xl:grid-cols-4">
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">NF</span>
                    <input type="text" data-import-summary-field="nf-number" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Série</span>
                    <input type="text" data-import-summary-field="nf-serie" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Emissão</span>
                    <input type="text" data-import-summary-field="nf-emissao" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Entrada</span>
                    <input type="text" data-import-summary-field="nf-entrada" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                </div>
                <div class="lg:col-span-2">
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Fornecedor</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-supplier-name>Fornecedor não localizado</p>
                    <p data-import-supplier-document>Documento não disponível</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Valor total</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-right text-gray-700">
                    <p class="text-sm font-semibold" data-import-total>R$ 0,00</p>
                    <p class="text-[10px] text-emerald-600" data-import-total-status>Aguardando importação do XML</p>
                  </div>
                </div>
                <div>
                  <label class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Destinatário</label>
                  <div class="mt-1 rounded-lg border border-gray-200 bg-white px-3 py-1.5">
                    <p class="font-semibold text-gray-700" data-import-destinatario-nome>Destinatário não identificado</p>
                    <p data-import-destinatario-document>Documento não disponível</p>
                  </div>
                </div>
                <div class="lg:col-span-4 grid grid-cols-1 gap-2.5 sm:grid-cols-2 xl:grid-cols-4">
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">CFOP predominante</span>
                    <input type="text" data-import-summary-field="cfop" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Natureza da operação</span>
                    <input type="text" data-import-summary-field="natureza" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Modalidade frete</span>
                    <input type="text" data-import-summary-field="modalidade-frete" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                  <label class="space-y-1">
                    <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Indicador IE destinatário</span>
                    <input type="text" data-import-summary-field="indicador-ie" class="rounded-lg border border-gray-200 px-3 py-1.5 text-[12px] text-gray-700" value="" readonly>
                  </label>
                </div>
              </div>
            </section>

            <section class="rounded-xl border border-gray-200">
              <header class="flex flex-col gap-2.5 border-b border-gray-100 bg-gray-50 px-4 py-2.5 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                  <h3 class="text-[12px] font-semibold text-gray-900">Produtos importados</h3>
                  <p class="text-[11px] text-gray-600">Itens conforme o XML, com tributos ICMS, ST, IPI, PIS e COFINS.</p>
                </div>
                <div class="flex flex-wrap items-center gap-1.5 text-[10px] text-gray-500">
                  <span class="inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-0.5" data-import-xml-label>
                    <i class="fas fa-layer-group text-[11px]"></i>
                    <span data-import-xml-number>XML não importado</span>
                  </span>
                  <button
                    type="button"
                    class="inline-flex items-center gap-1 rounded-full border border-primary px-2 py-0.5 text-[10px] font-semibold text-primary transition hover:bg-primary/10 focus:outline-none focus:ring-2 focus:ring-primary/30 disabled:cursor-not-allowed disabled:opacity-60"
                    data-refresh-import-products
                  >
                    <i class="fas fa-rotate-right text-[11px]" data-refresh-import-products-icon></i>
                    Atualizar lista
                  </button>
                  <span class="inline-flex items-center gap-1 rounded-full border border-sky-200 bg-sky-50 px-2 py-0.5 text-sky-700" data-import-xml-validation>
                    <i class="fas fa-circle-info text-[11px]" data-import-xml-validation-icon></i>
                    <span data-import-xml-validation-text>Aguardando validação fiscal</span>
                  </span>
                </div>
              </header>
              <div class="overflow-x-auto">
                <table class="min-w-full table-auto divide-y divide-gray-200 text-[10px]" data-import-products-table>
                  <thead class="bg-gray-50 text-[9px] uppercase tracking-wide text-gray-500" data-import-products-head></thead>
                  <tbody class="divide-y divide-gray-200 bg-white" data-import-products-body></tbody>
                </table>
              </div>
            </section>
          </div>
          <footer class="flex flex-col gap-3 border-t border-gray-100 bg-gray-50 px-5 py-3 sm:flex-row sm:items-center sm:justify-end">
            <div class="flex w-full flex-col-reverse gap-2 sm:w-auto sm:flex-row sm:items-center">
              <button type="button" data-close-import-modal class="inline-flex items-center justify-center gap-1.5 rounded-lg border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-100">Cancelar</button>
              <button
                type="button"
                class="inline-flex items-center justify-center gap-1.5 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary/90"
                data-confirm-import
              >
                <i class="fas fa-file-import"></i>
                Importar
              </button>
            </div>
          </footer>
      </div>
    </div>
  </div>

  <div
    id="product-link-modal"
    class="fixed inset-0 z-[1050] hidden"
    aria-hidden="true"
  >
    <div
      class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"
      data-close-product-link-modal
      aria-label="Fechar seleção de produto"
    ></div>
    <div class="relative mx-auto flex min-h-full w-full items-center justify-center px-3 py-6">
      <div
        class="relative w-full max-w-xl transform-gpu overflow-hidden rounded-2xl bg-white shadow-xl transition-all duration-200 ease-out"
        data-product-link-card
      >
        <header class="flex items-start justify-between gap-3 border-b border-gray-100 px-5 py-4">
          <div class="space-y-1">
            <h3 class="text-lg font-semibold text-gray-900">Selecionar produto cadastrado</h3>
            <p class="text-[11px] text-gray-600">
              Escolha um produto existente para vincular ao item informado pelo fornecedor.
            </p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-gray-200 p-2 text-gray-500 transition hover:bg-gray-50 hover:text-gray-700"
            data-close-product-link-modal
            aria-label="Fechar seleção de produto"
          >
            <i class="fas fa-times"></i>
          </button>
        </header>
        <div class="space-y-4 px-5 py-4">
          <div class="space-y-2 rounded-xl border border-gray-100 bg-gray-50 px-4 py-3">
            <div class="space-y-1">
              <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Produto do fornecedor</span>
              <p class="text-[12px] font-semibold text-gray-800" data-product-link-item>—</p>
            </div>
            <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
              <div>
                <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Código no fornecedor</span>
                <p class="text-[11px] text-gray-700" data-product-link-code>—</p>
              </div>
              <div>
                <span class="text-[10px] font-semibold uppercase tracking-wide text-gray-500">Fornecedor ativo</span>
                <p class="text-[11px] text-gray-700" data-product-link-supplier>—</p>
              </div>
            </div>
          </div>
          <form class="flex flex-col gap-2 sm:flex-row sm:items-end" data-product-link-form>
            <div class="flex-1">
              <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-gray-600" for="product-link-search">
                Buscar produto cadastrado
              </label>
              <input
                id="product-link-search"
                type="search"
                placeholder="Digite código interno, nome ou GTIN"
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-700 placeholder:text-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
                data-product-link-search
                autocomplete="off"
              />
            </div>
            <button
              type="submit"
              class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/30"
            >
              <i class="fas fa-search"></i>
              Buscar
            </button>
          </form>
          <div class="space-y-2" data-product-link-results-wrapper>
            <div
              class="flex items-center gap-2 rounded-lg border border-sky-100 bg-sky-50 px-3 py-2 text-[11px] text-sky-700 hidden"
              data-product-link-loading
            >
              <i class="fas fa-circle-notch fa-spin text-sky-600"></i>
              <span data-product-link-loading-text>Buscando produtos cadastrados...</span>
            </div>
            <p class="hidden text-[11px] font-medium text-rose-600" data-product-link-error>
              Não foi possível buscar os produtos cadastrados. Tente novamente.
            </p>
            <p class="hidden text-[11px] text-gray-600" data-product-link-empty>
              Informe ao menos três caracteres para localizar um produto cadastrado.
            </p>
            <ul
              class="max-h-64 space-y-2 overflow-y-auto pr-1 text-sm"
              data-product-link-results
            ></ul>
          </div>
        </div>
        <footer class="flex justify-end gap-2 border-t border-gray-100 bg-gray-50 px-5 py-3">
          <button
            type="button"
            class="inline-flex items-center justify-center gap-1.5 rounded-lg border border-gray-200 px-3 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-100"
            data-close-product-link-modal
          >
            Cancelar
          </button>
        </footer>
      </div>
    </div>
  </div>

  <div
    id="product-registration-iframe-modal"
    class="fixed inset-0 z-[1000] hidden"
    aria-hidden="true"
  >
    <div
      class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm"
      data-close-product-modal
      aria-label="Fechar cadastro de produto"
    ></div>
    <div class="relative mx-auto flex min-h-full w-full items-start justify-center px-3 py-6 sm:items-center">
      <div
        class="relative flex w-full max-w-[1352px] transform-gpu flex-col overflow-hidden rounded-2xl bg-white shadow-2xl transition-all duration-200 ease-out max-h-[90vh] min-h-0 text-[12px] leading-[1.35]"
        data-product-frame-shell
      >
        <header class="flex flex-col gap-2 border-b border-gray-100 px-5 py-4 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-1">
            <span
              data-product-modal-subtitle
              class="hidden text-[11px] font-semibold uppercase tracking-wide text-primary"
            ></span>
            <h3
              data-product-modal-title
              class="text-lg font-semibold text-gray-900"
            >
              Cadastro de produto
            </h3>
            <p
              data-product-modal-helper
              class="text-[11px] text-gray-600"
            >
              Os dados do XML autorizado foram enviados automaticamente. Revise e complete as informações antes de salvar.
            </p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-gray-200 p-2 text-gray-500 transition hover:bg-gray-50 hover:text-gray-700"
            data-close-product-modal
            aria-label="Fechar cadastro de produto"
          >
            <i class="fas fa-times"></i>
          </button>
        </header>
        <div class="flex-1 overflow-hidden">
          <div
            data-product-frame-loading
            class="flex h-full flex-col items-center justify-center gap-3 bg-gray-50 text-center text-[12px] text-gray-600"
          >
            <i class="fas fa-circle-notch fa-spin text-lg text-primary"></i>
            <p>
              Carregando cadastro de produto...
              <span class="block text-[11px] text-gray-500">Isso pode levar alguns instantes.</span>
            </p>
          </div>
          <iframe
            data-product-frame
            title="Cadastro de produto"
            class="hidden h-full w-full border-0"
            allow="clipboard-write"
          ></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="admin-footer-placeholder"></div>

  <script>var basePath = '../../';</script>
  <script src="../../scripts/core/config.js"></script>
  <script src="../../scripts/core/ui.js"></script>
  <script src="../../scripts/core/main.js"></script>
  <script src="../../scripts/admin/admin.js"></script>
  <script src="/scripts/common/modal-bridge.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabPanels = document.querySelectorAll('.tab-panel');

      function activateTab(tabId) {
        tabButtons.forEach((button) => {
          const isActive = button.dataset.tab === tabId;
          button.classList.toggle('active', isActive);
          button.classList.toggle('bg-primary/10', isActive);
          button.classList.toggle('text-primary', isActive);
          button.classList.toggle('border', true);
          button.classList.toggle('border-transparent', isActive);
          button.classList.toggle('border-gray-200', !isActive);
          button.classList.toggle('text-gray-600', !isActive);
        });

        tabPanels.forEach((panel) => {
          panel.classList.toggle('hidden', panel.dataset.tabPanel !== tabId);
        });
      }

      tabButtons.forEach((button) => {
        button.classList.add('inline-flex', 'items-center', 'gap-2', 'rounded-lg', 'px-3', 'py-2', 'text-xs', 'font-semibold', 'transition');
        if (!button.classList.contains('active')) {
          button.classList.add('text-gray-600', 'border', 'border-gray-200');
        } else {
          button.classList.add('bg-primary/10', 'text-primary', 'border', 'border-transparent');
        }

        button.addEventListener('click', () => {
          activateTab(button.dataset.tab);
        });
      });

      const importModal = document.getElementById('import-xml-modal');
      if (importModal) {
        const importModalCard = importModal.querySelector('[data-import-modal-card]');
        const openImportModalButtons = document.querySelectorAll('[data-open-import-modal]');
        const closeImportModalButtons = importModal.querySelectorAll('[data-close-import-modal]');
        const importTabButtons = importModal.querySelectorAll('.import-tab-button');
        const importTabPanels = importModal.querySelectorAll('[data-import-tab-panel]');
        const importModeRadios = importModal.querySelectorAll('input[name="import-mode"]');
        const importModePanels = importModal.querySelectorAll('[data-import-mode-panel]');
        const importFilePanel = importModal.querySelector('[data-import-mode-panel="file"]');
        const importFileInput = document.getElementById('import-file-input');
        const importFileFeedback = importModal.querySelector('[data-file-feedback]');
        const importSupplierStatus = importModal.querySelector('[data-import-supplier-status]');
        const importSupplierMessage = importSupplierStatus ? importSupplierStatus.querySelector('[data-supplier-message]') : null;
        const importSupplierDescription = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-description]')
          : null;
        const importSupplierActions = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-actions]')
          : null;
        const importSupplierIcon = importSupplierStatus
          ? importSupplierStatus.querySelector('[data-supplier-status-icon]')
          : null;
        const importSupplierSummary = importModal.querySelector('[data-import-supplier-summary]');
        const importSupplierSummaryName = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-name]')
          : null;
        const importSupplierSummaryDocument = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-document]')
          : null;
        const importSupplierSummaryIe = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-ie]')
          : null;
        const importSupplierSummaryAddress = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-address]')
          : null;
        const importSupplierSummaryContact = importSupplierSummary
          ? importSupplierSummary.querySelector('[data-supplier-summary-contact]')
          : null;
        const importSummaryEmitenteName = importModal.querySelector('[data-import-emitente-nome]');
        const importSummaryEmitenteDocument = importModal.querySelector('[data-import-emitente-document]');
        const importSummaryAccessKey = importModal.querySelector('[data-import-access-key]');
        const importSummaryAccessKeyDetails = importModal.querySelector('[data-import-access-key-details]');
        const importSummaryProtocol = importModal.querySelector('[data-import-protocol]');
        const importSummaryProtocolReceived = importModal.querySelector('[data-import-protocol-received]');
        const importSummarySupplierName = importModal.querySelector('[data-import-supplier-name]');
        const importSummarySupplierDocument = importModal.querySelector('[data-import-supplier-document]');
        const importSummaryTotal = importModal.querySelector('[data-import-total]');
        const importSummaryTotalStatus = importModal.querySelector('[data-import-total-status]');
        const importSummaryDestName = importModal.querySelector('[data-import-destinatario-nome]');
        const importSummaryDestDocument = importModal.querySelector('[data-import-destinatario-document]');
        const importXmlLabelWrapper = importModal.querySelector('[data-import-xml-label]');
        const importXmlNumber = importModal.querySelector('[data-import-xml-number]');
        const importXmlValidationBadge = importModal.querySelector('[data-import-xml-validation]');
        const importXmlValidationText = importModal.querySelector('[data-import-xml-validation-text]');
        const importXmlValidationIcon = importModal.querySelector('[data-import-xml-validation-icon]');
        const refreshImportedProductsButton = importModal.querySelector('[data-refresh-import-products]');
        const refreshImportedProductsIcon = refreshImportedProductsButton
          ? refreshImportedProductsButton.querySelector('[data-refresh-import-products-icon]')
          : null;
        const importProductsTableHead = importModal.querySelector('[data-import-products-head]');
        const importProductsTableBody = importModal.querySelector('[data-import-products-body]');
        const importSummaryFields = Array.from(importModal.querySelectorAll('[data-import-summary-field]')).reduce(
          (accumulator, element) => {
            accumulator[element.dataset.importSummaryField] = element;
            return accumulator;
          },
          {}
        );
        const productLinkModal = document.getElementById('product-link-modal');
        const productLinkCard = productLinkModal?.querySelector('[data-product-link-card]') || null;
        const productLinkForm = productLinkModal?.querySelector('[data-product-link-form]') || null;
        const productLinkSearchInput = productLinkModal?.querySelector('[data-product-link-search]') || null;
        const productLinkResults = productLinkModal?.querySelector('[data-product-link-results]') || null;
        const productLinkResultsWrapper = productLinkModal?.querySelector('[data-product-link-results-wrapper]') || null;
        const productLinkLoading = productLinkModal?.querySelector('[data-product-link-loading]') || null;
        const productLinkLoadingText = productLinkModal?.querySelector('[data-product-link-loading-text]') || null;
        const productLinkError = productLinkModal?.querySelector('[data-product-link-error]') || null;
        const productLinkEmpty = productLinkModal?.querySelector('[data-product-link-empty]') || null;
        const productLinkSupplierLabel = productLinkModal?.querySelector('[data-product-link-supplier]') || null;
        const productLinkItemLabel = productLinkModal?.querySelector('[data-product-link-item]') || null;
        const productLinkCodeLabel = productLinkModal?.querySelector('[data-product-link-code]') || null;
        const productLinkCloseTriggers = productLinkModal
          ? productLinkModal.querySelectorAll('[data-close-product-link-modal]')
          : [];
        const productIframeModal = document.getElementById('product-registration-iframe-modal');
        const productIframe = productIframeModal?.querySelector('[data-product-frame]') || null;
        const productIframeLoading =
          productIframeModal?.querySelector('[data-product-frame-loading]') || null;
        const productIframeShell =
          productIframeModal?.querySelector('[data-product-frame-shell]') || null;
        const productIframeTitle = productIframeModal?.querySelector('[data-product-modal-title]') || null;
        const productIframeSubtitle = productIframeModal?.querySelector('[data-product-modal-subtitle]') || null;
        const productIframeHelper = productIframeModal?.querySelector('[data-product-modal-helper]') || null;
        const productIframeCloseTriggers = productIframeModal
          ? productIframeModal.querySelectorAll('[data-close-product-modal]')
          : [];
        const supplierSelect = document.getElementById('nfe-supplier');
        const companySelect = document.getElementById('company');
        const nfeNumberInput = document.getElementById('nfe-number');
        const nfeSeriesInput = document.getElementById('nfe-series');
        const nfeProtocolInput = document.getElementById('nfe-protocol');
        const nfeReferenceInput = document.getElementById('nfe-reference');
        const issueDateInput = document.getElementById('issue-date');
        const entryDateInput = document.getElementById('entry-date');
        const nfeModelSelect = document.getElementById('nfe-model');
        const nfeTypeSelect = document.getElementById('nfe-type');
        const tipoEmissaoSelect = document.getElementById('tipo-emissao');
        const finalidadeSelect = document.getElementById('finalidade');
        const indicadorPresencaSelect = document.getElementById('indicador-presenca');
        const depositSelect = document.getElementById('deposit');
        const importAccessKeyInput = document.getElementById('import-access-key');
        const accessKeyInput = document.getElementById('access-key');
        const totalAmountDisplay = document.querySelector('[data-nfe-total]');
        const supplierCnpjInput = document.getElementById('supplier-cnpj');
        const supplierIeInput = document.getElementById('supplier-ie');
        const supplierUfSelect = document.getElementById('supplier-uf');
        const supplierEmailInput = document.getElementById('supplier-email');
        const supplierAddressInput = document.getElementById('supplier-address');
        const transportCnpjInput = document.getElementById('transportadora-cnpj');
        const transportIeInput = document.getElementById('transportadora-ie');
        const transportUfSelect = document.getElementById('transportadora-uf');
        const transportPlateInput = document.getElementById('transportadora-placa');
        const transportPlateUfSelect = document.getElementById('transportadora-uf-placa');
        const transportNameInput = document.getElementById('transportadora-razao');
        const weightGrossInput = document.getElementById('peso-bruto');
        const weightNetInput = document.getElementById('peso-liquido');
        const freightModeSelect = document.getElementById('modalidade-frete');
        const totalsProductsInput = document.getElementById('valor-produtos');
        const totalsIcmsBaseInput = document.getElementById('base-icms');
        const totalsIcmsValueInput = document.getElementById('valor-icms');
        const totalsIcmsStInput = document.getElementById('icms-st');
        const totalsFcpStInput = document.getElementById('valor-fcp-st');
        const totalsServicesInput = document.getElementById('total-servicos');
        const totalsAdjustmentInput = document.getElementById('valor-ajuste-esquerda');
        const totalsDiscountInput = document.getElementById('desconto');
        const totalsOtherInput = document.getElementById('outras-despesas');
        const totalsFreightInput = document.getElementById('valor-frete');
        const totalsIpiInput = document.getElementById('valor-ipi');
        const totalsUnitDiscountInput = document.getElementById('desconto-unitario');
        const totalsInsuranceInput = document.getElementById('valor-seguro');
        const totalsDollarInput = document.getElementById('valor-dolar');
        const duplicataEmissionInput = document.getElementById('duplicata-data-emissao');
        const duplicataCountInput = document.getElementById('parcelas');
        const duplicataFirstDueInput = document.getElementById('vencimento-inicial');
        const duplicataDaysInput = document.getElementById('dias');
        const duplicataInitialDaysInput = document.getElementById('dias-vencimento');
        const duplicataDaysTypeSelect = document.getElementById('tipo-dias');
        const bankAccountSelect = document.getElementById('conta-corrente');
        const accountingAccountInput = document.getElementById('conta-contabil');
        const paymentConditionInput = document.getElementById('condicao-pagamento');
        const paymentFormInput = document.getElementById('forma-pagamento');
        const observationInput = document.getElementById('observacao');
        const complementaryInfoInput = document.getElementById('informacoes-complementares');
        const clearImportButton = document.querySelector('[data-clear-import]');
        const documentsTableBody = document.querySelector('[data-nfe-documents-body]');
        const documentsEmptyRow = document.querySelector('[data-nfe-documents-empty]');
        const mainProductsTableBody = document.querySelector('[data-nfe-products-body]');
        const mainProductsEmptyRow = document.querySelector('[data-nfe-products-empty]');
        const duplicatasTableBody = document.querySelector('[data-nfe-duplicatas-body]');
        const duplicatasEmptyRow = document.querySelector('[data-nfe-duplicatas-empty]');
        const MODAL_FOCUSABLE_SELECTORS =
          'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
        let previouslyFocusedElement = null;
        let productModalPreviousFocus = null;
        let productLinkPreviousFocus = null;
        let productLinkActiveItem = null;
        let productLinkSearchAbortController = null;
        let productLinkIsLinking = false;
        const apiBaseUrl =
          typeof API_CONFIG !== 'undefined' && API_CONFIG?.BASE_URL
            ? API_CONFIG.BASE_URL.replace(/\/+$/, '')
            : '/api';
        const suppliersEndpoint = `${apiBaseUrl}/suppliers`;
        const bankAccountsEndpoint = `${apiBaseUrl}/bank-accounts`;

        const notify = (message, type = 'info') => {
          if (typeof window.showToast === 'function') {
            window.showToast(message, type);
          } else if (type === 'error') {
            console.error(message);
          } else {
            console.log(message);
          }
        };

        const handleAuthError = () => {
          notify('Sessão expirada. Faça login novamente para continuar.', 'error');
        };

        const getToken = () => {
          try {
            const raw = localStorage.getItem('loggedInUser');
            if (!raw) return '';
            const parsed = JSON.parse(raw);
            return parsed?.token || '';
          } catch (error) {
            console.warn('Não foi possível recuperar o token de autenticação.', error);
            return '';
          }
        };

        const buildAuthHeaders = () => {
          const headers = new Headers({ Accept: 'application/json' });
          const token = getToken();
          if (token) {
            headers.set('Authorization', `Bearer ${token}`);
          }
          return headers;
        };

        const supplierRegistry = {
          loaded: false,
          loadingPromise: null,
          byDocument: new Map(),
          lastLoadedAt: 0,
          error: null,
        };

        const bankAccountsRegistry = {
          cache: new Map(),
          loading: new Map(),
          index: new Map(),
          lastLoadedAt: 0,
          error: null,
        };

        let lastSupplierData = null;
        let lastSupplierRecord = null;
        let lastNfeData = null;
        let pendingBankAccountId = '';
        const PRODUCT_DRAFT_STORAGE_KEY = 'nfeImportProductDraft';
        const productLookupCache = new Map();
        const productLookupPromises = new Map();
        const supplierReferenceLookupCache = new Map();
        const supplierReferenceLookupPromises = new Map();
        let productValidationSequence = 0;
        const productSupplierLinkCache = new Set();
        const productSupplierLinkPromises = new Map();
        let supplierLinkErrorNotified = false;
        let isRefreshingImportedProducts = false;

        const STATUS_CLASS_MAP = {
          success: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-800'],
          warning: ['border-amber-200', 'bg-amber-50', 'text-amber-800'],
          error: ['border-rose-200', 'bg-rose-50', 'text-rose-800'],
          info: ['border-sky-200', 'bg-sky-50', 'text-sky-800'],
        };

        const STATUS_ICONS = {
          success: 'fas fa-circle-check',
          warning: 'fas fa-triangle-exclamation',
          error: 'fas fa-circle-exclamation',
          info: 'fas fa-circle-info',
        };

        const VALIDATION_BADGE_STYLES = {
          success: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700'],
          warning: ['border-amber-200', 'bg-amber-50', 'text-amber-700'],
          error: ['border-rose-200', 'bg-rose-50', 'text-rose-700'],
          info: ['border-sky-200', 'bg-sky-50', 'text-sky-700'],
        };

        const VALIDATION_ICONS = {
          success: 'fas fa-check',
          warning: 'fas fa-triangle-exclamation',
          error: 'fas fa-circle-exclamation',
          info: 'fas fa-circle-info',
        };

        const ALL_STATUS_CLASSES = Array.from(new Set(Object.values(STATUS_CLASS_MAP).flat()));
        const ALL_VALIDATION_CLASSES = Array.from(new Set(Object.values(VALIDATION_BADGE_STYLES).flat()));

        const SUPPLIER_ACTION_VARIANTS = {
          primary: [
            'border-primary',
            'bg-primary',
            'text-white',
            'hover:bg-primary/90',
            'focus:ring-primary/40',
          ],
          secondary: [
            'border-gray-200',
            'text-gray-700',
            'hover:border-primary/40',
            'hover:text-primary',
            'focus:ring-primary/20',
          ],
        };

        const SUPPLIER_STATUS_LAYOUT_CLASSES = [
          'flex',
          'flex-col',
          'sm:flex',
          'sm:flex-row',
          'sm:items-start',
          'sm:justify-between',
          'sm:gap-3',
        ];

        const toggleSupplierStatusLayout = (isActive) => {
          if (!importSupplierStatus) return;
          if (isActive) {
            importSupplierStatus.classList.add(...SUPPLIER_STATUS_LAYOUT_CLASSES);
          } else {
            importSupplierStatus.classList.remove(...SUPPLIER_STATUS_LAYOUT_CLASSES);
          }
        };

        const digitsOnly = (value) => String(value ?? '').replace(/\D+/g, '');

        const resetProductLookupCaches = () => {
          productLookupCache.clear();
          productLookupPromises.clear();
          supplierReferenceLookupCache.clear();
          supplierReferenceLookupPromises.clear();
        };

        const setRefreshImportedProductsButtonState = (isLoading) => {
          if (!refreshImportedProductsButton) return;
          const shouldDisable = Boolean(isLoading);
          refreshImportedProductsButton.disabled = shouldDisable;
          refreshImportedProductsButton.classList.toggle('opacity-60', shouldDisable);
          refreshImportedProductsButton.classList.toggle('cursor-not-allowed', shouldDisable);
          if (shouldDisable) {
            refreshImportedProductsButton.setAttribute('aria-busy', 'true');
          } else {
            refreshImportedProductsButton.removeAttribute('aria-busy');
          }
          if (refreshImportedProductsIcon) {
            refreshImportedProductsIcon.classList.toggle('fa-spin', shouldDisable);
          }
        };

        const refreshImportedProductsList = async () => {
          if (isRefreshingImportedProducts) {
            return;
          }
          const hasItems = Array.isArray(lastNfeData?.items) && lastNfeData.items.length > 0;
          if (!hasItems) {
            notify('Importe um XML autorizado para atualizar a lista de produtos.', 'warning');
            return;
          }

          isRefreshingImportedProducts = true;
          setRefreshImportedProductsButtonState(true);

          const itemsBeforeRefresh = Array.isArray(lastNfeData.items) ? lastNfeData.items : [];
          const previousUnmatchedCount = itemsBeforeRefresh.filter(
            (item) => item?.validationStatus === 'not-found'
          ).length;

          try {
            resetProductLookupCaches();
            await validateImportedProducts(lastNfeData);

            const updatedItems = Array.isArray(lastNfeData?.items) ? lastNfeData.items : [];
            const currentUnmatchedCount = updatedItems.filter(
              (item) => item?.validationStatus === 'not-found'
            ).length;

            const successMessage =
              currentUnmatchedCount < previousUnmatchedCount
                ? 'Lista atualizada e novos produtos foram vinculados.'
                : 'Lista de produtos importados atualizada.';
            notify(successMessage, 'success');
          } catch (error) {
            console.error('Erro ao atualizar a lista de produtos importados:', error);
            notify('Não foi possível atualizar a lista de produtos importados. Tente novamente.', 'error');
          } finally {
            setRefreshImportedProductsButtonState(false);
            isRefreshingImportedProducts = false;
          }
        };

        const normalizeBarcodeForComparison = (value) => {
          const digits = digitsOnly(value);
          if (!digits) return '';
          if (/^0+$/.test(digits)) return '';
          return digits;
        };

        const normalizeGtin = (value) => normalizeBarcodeForComparison(value);

        const formatGtinDisplay = (value) => {
          const raw = String(value ?? '').trim();
          if (!raw) return 'SEM GTIN';
          if (/sem\s*gtin/i.test(raw)) return 'SEM GTIN';
          const digits = digitsOnly(raw);
          if (!digits || /^0+$/.test(digits)) return 'SEM GTIN';
          return raw;
        };

        const parseNumber = (value) => {
          if (value === null || typeof value === 'undefined') return null;
          const raw = String(value).trim();
          if (!raw) return null;
          const normalized = raw.replace(',', '.');
          const numeric = Number.parseFloat(normalized);
          return Number.isFinite(numeric) ? numeric : null;
        };

        const formatDecimal = (value, options = {}) => {
          const { minimumFractionDigits = 3, maximumFractionDigits = minimumFractionDigits } = options;
          const numericValue = Number.isFinite(value) ? value : parseNumber(value);
          const finalValue = Number.isFinite(numericValue) ? numericValue : 0;
          return finalValue.toLocaleString('pt-BR', {
            minimumFractionDigits,
            maximumFractionDigits,
          });
        };

        const formatQuantity = (value) => formatDecimal(value, { minimumFractionDigits: 3, maximumFractionDigits: 3 });

        const formatMoneyValue = (value) => formatDecimal(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const formatPercentValue = (value) => formatDecimal(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const toNumeric = (value) => (Number.isFinite(value) ? value : parseNumber(value));

        const sumFiniteValues = (values) =>
          values.reduce(
            (accumulator, current) =>
              Number.isFinite(current) ? accumulator + current : accumulator,
            0
          );

        const calculateEntryStockQuantity = (item) => {
          if (!item || typeof item !== 'object') return null;

          const quantityValue = toNumeric(item.quantity);
          let conversionFactor = toNumeric(item.conversion);

          if (!Number.isFinite(conversionFactor)) {
            const multiplierValue = toNumeric(item.conversionMultiplier);
            const dividerValue = toNumeric(item.conversionDivider);

            if (Number.isFinite(multiplierValue) && Number.isFinite(dividerValue) && dividerValue !== 0) {
              conversionFactor = multiplierValue / dividerValue;
            } else if (Number.isFinite(multiplierValue)) {
              conversionFactor = multiplierValue;
            } else if (Number.isFinite(dividerValue) && dividerValue !== 0) {
              conversionFactor = 1 / dividerValue;
            }
          }

          if (Number.isFinite(quantityValue) && Number.isFinite(conversionFactor)) {
            return quantityValue * conversionFactor;
          }

          const qTribValue = toNumeric(item.qTrib);
          if (Number.isFinite(qTribValue)) {
            return qTribValue;
          }

          return Number.isFinite(quantityValue) ? quantityValue : null;
        };

        const ensureItemCostWithTaxes = (item) => {
          if (!item || typeof item !== 'object') return item;

          const quantityValue = toNumeric(item.quantity);
          const unitPriceValue = toNumeric(item.unitPrice);
          const totalValue = toNumeric(item.total);
          const discountValueRaw = toNumeric(item.discount);

          const grossAmount = Number.isFinite(quantityValue) && Number.isFinite(unitPriceValue)
            ? quantityValue * unitPriceValue
            : Number.isFinite(totalValue)
            ? totalValue
            : null;

          const baseTotal = Number.isFinite(totalValue)
            ? totalValue
            : Number.isFinite(grossAmount)
            ? grossAmount
            : null;

          let discountValue = Number.isFinite(discountValueRaw) ? Math.max(discountValueRaw, 0) : 0;
          if (Number.isFinite(baseTotal)) {
            discountValue = Math.min(discountValue, Math.max(baseTotal, 0));
          }

          if (Number.isFinite(grossAmount) && grossAmount > 0) {
            item.discountPercent = Number.isFinite(discountValue)
              ? (discountValue / grossAmount) * 100
              : 0;
          } else if (!Number.isFinite(discountValue) || discountValue <= 0) {
            item.discountPercent = 0;
          }

          const netBaseTotal = Number.isFinite(baseTotal)
            ? Math.max(baseTotal - (Number.isFinite(discountValue) ? discountValue : 0), 0)
            : null;

          const taxesTotal = sumFiniteValues([
            toNumeric(item.icmsStValue),
            toNumeric(item.ipiValue),
            toNumeric(item.iiValue),
            toNumeric(item.fcpValue),
            toNumeric(item.fcpStValue),
            toNumeric(item.fcpStRetainedValue),
          ]);

          const additionalsTotal = sumFiniteValues([toNumeric(item.freight), toNumeric(item.other)]);
          const totalWithTaxes =
            (Number.isFinite(netBaseTotal) ? netBaseTotal : 0) + taxesTotal + additionalsTotal;

          const entryStockQuantity = calculateEntryStockQuantity(item);
          const effectiveQuantity =
            Number.isFinite(entryStockQuantity) && entryStockQuantity > 0
              ? entryStockQuantity
              : Number.isFinite(quantityValue) && quantityValue > 0
              ? quantityValue
              : null;

          const unitCostWithTaxes =
            Number.isFinite(effectiveQuantity) && effectiveQuantity > 0
              ? totalWithTaxes / effectiveQuantity
              : null;

          item.discount = Number.isFinite(discountValue) ? discountValue : 0;
          item.entryStockQuantity =
            Number.isFinite(entryStockQuantity) && entryStockQuantity >= 0 ? entryStockQuantity : null;
          item.netProductValue =
            Number.isFinite(netBaseTotal) && netBaseTotal >= 0 ? netBaseTotal : null;
          item.taxesTotal = taxesTotal;
          item.additionalsTotal = additionalsTotal;
          item.totalWithTaxes =
            Number.isFinite(netBaseTotal) || taxesTotal || additionalsTotal ? totalWithTaxes : null;
          item.unitCostWithTaxes =
            Number.isFinite(unitCostWithTaxes) && unitCostWithTaxes >= 0 ? unitCostWithTaxes : null;

          return item;
        };

        const alignItemsWithTotals = (items, totals) => {
          if (!Array.isArray(items) || !items.length) return;

          const distributionEntries = items.map((item) => {
            const candidates = [
              toNumeric(item.netProductValue),
              toNumeric(item.total),
              toNumeric(item.entryStockQuantity),
              toNumeric(item.quantity),
            ];
            const base = candidates.find((value) => Number.isFinite(value) && value > 0) || 1;
            return { item, base };
          });

          const distributeByBase = (amount, applyShare) => {
            if (!Number.isFinite(amount) || !items.length || Math.abs(amount) <= 0.00001) {
              return;
            }

            const totalBase = distributionEntries.reduce(
              (accumulator, entry) =>
                accumulator + (Number.isFinite(entry.base) && entry.base > 0 ? entry.base : 0),
              0
            );

            let allocated = 0;
            distributionEntries.forEach((entry, index) => {
              const ratio =
                totalBase > 0
                  ? entry.base / totalBase
                  : 1 / distributionEntries.length;
              let share = amount * ratio;
              if (index === distributionEntries.length - 1) {
                share = amount - allocated;
              } else {
                allocated += share;
              }
              applyShare(entry.item, share);
            });
          };

          const setFieldValue = (item, field, value) => {
            const sanitized = Math.abs(value) <= 0.000001 ? 0 : value;
            item[field] = sanitized;
          };

          const addToField = (item, field, delta) => {
            const current = toNumeric(item[field]);
            const next = (Number.isFinite(current) ? current : 0) + delta;
            setFieldValue(item, field, next);
          };

          const adjustNonNegativeField = (field, targetValue) => {
            if (!Number.isFinite(targetValue)) return;
            const sanitizedTarget = targetValue > 0 ? targetValue : 0;
            const currentSum = sumFiniteValues(
              items.map((item) => {
                const value = toNumeric(item[field]);
                return Number.isFinite(value) && value > 0 ? value : 0;
              })
            );

            if (currentSum > 0) {
              const ratio = sanitizedTarget / currentSum;
              items.forEach((item) => {
                const value = toNumeric(item[field]);
                const current = Number.isFinite(value) && value > 0 ? value : 0;
                setFieldValue(item, field, current * ratio);
              });
            } else if (sanitizedTarget > 0) {
              distributeByBase(sanitizedTarget, (item, share) => addToField(item, field, share));
            } else {
              items.forEach((item) => {
                if (item[field]) {
                  setFieldValue(item, field, 0);
                }
              });
            }
          };

          const totalsNormalized = {
            discount: toNumeric(totals?.discount),
            freight: toNumeric(totals?.freight),
            other: toNumeric(totals?.other),
            insurance: toNumeric(totals?.insurance),
            ipi: toNumeric(totals?.ipi),
            icmsSt: toNumeric(totals?.icmsSt),
            fcp: toNumeric(totals?.fcp),
            fcpSt: toNumeric(totals?.fcpSt),
            fcpStRet: toNumeric(totals?.fcpStRet),
            ii: toNumeric(totals?.ii),
            totalValue: toNumeric(totals?.totalValue),
          };

          const discountTarget = Number.isFinite(totalsNormalized.discount)
            ? Math.max(totalsNormalized.discount, 0)
            : null;
          if (discountTarget !== null) {
            const currentDiscountSum = sumFiniteValues(
              items.map((item) => {
                const value = toNumeric(item.discount);
                return Number.isFinite(value) && value > 0 ? value : 0;
              })
            );

            if (currentDiscountSum > 0) {
              const ratio = discountTarget / currentDiscountSum;
              items.forEach((item) => {
                const value = toNumeric(item.discount);
                const current = Number.isFinite(value) && value > 0 ? value : 0;
                setFieldValue(item, 'discount', current * ratio);
              });
            } else if (discountTarget > 0) {
              distributeByBase(discountTarget, (item, share) => addToField(item, 'discount', share));
            } else {
              items.forEach((item) => {
                if (item.discount) {
                  setFieldValue(item, 'discount', 0);
                }
              });
            }
          }

          adjustNonNegativeField('freight', totalsNormalized.freight);

          const targetOther =
            (Number.isFinite(totalsNormalized.other) ? totalsNormalized.other : 0) +
            (Number.isFinite(totalsNormalized.insurance) ? totalsNormalized.insurance : 0);
          const currentOther = sumFiniteValues(items.map((item) => toNumeric(item.other)));
          distributeByBase(targetOther - currentOther, (item, share) => addToField(item, 'other', share));

          adjustNonNegativeField('ipiValue', totalsNormalized.ipi);
          adjustNonNegativeField('icmsStValue', totalsNormalized.icmsSt);
          adjustNonNegativeField('fcpValue', totalsNormalized.fcp);
          adjustNonNegativeField('fcpStValue', totalsNormalized.fcpSt);
          adjustNonNegativeField('fcpStRetainedValue', totalsNormalized.fcpStRet);
          adjustNonNegativeField('iiValue', totalsNormalized.ii);

          items.forEach((item) => ensureItemCostWithTaxes(item));

          if (Number.isFinite(totalsNormalized.totalValue)) {
            let aggregatedTotal = sumFiniteValues(
              items.map((item) => toNumeric(item.totalWithTaxes))
            );
            let remainder = totalsNormalized.totalValue - aggregatedTotal;

            if (Math.abs(remainder) > 0.05) {
              distributeByBase(remainder, (item, share) => addToField(item, 'other', share));
              items.forEach((item) => ensureItemCostWithTaxes(item));
              aggregatedTotal = sumFiniteValues(items.map((item) => toNumeric(item.totalWithTaxes)));
              remainder = totalsNormalized.totalValue - aggregatedTotal;
            }

            if (Math.abs(remainder) > 0.0005) {
              const lastItem = items[items.length - 1];
              if (lastItem) {
                addToField(lastItem, 'other', remainder);
                ensureItemCostWithTaxes(lastItem);
              }
            }
          }
        };

        const INTERNAL_CODE_PREFIX = 'SKU-';

        const normalizeSupplierProductCode = (value) => {
          if (value === null || value === undefined) return '';
          if (typeof value === 'string') return value.trim();
          if (typeof value === 'number' && Number.isFinite(value)) return String(value);
          return String(value).trim();
        };

        const canonicalSupplierProductCode = (value) =>
          normalizeSupplierProductCode(value).toUpperCase();

        const canonicalSupplierName = (value) => {
          if (typeof value === 'string') {
            const normalized = value
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/\s+/g, ' ')
              .trim();
            return normalized ? normalized.toUpperCase() : '';
          }
          if (typeof value === 'number' && Number.isFinite(value)) {
            return String(value).toUpperCase();
          }
          return '';
        };

        const resolveActiveSupplierInfo = (nfeData) => {
          const result = { name: '', document: '' };
          const pickName = (...values) => values.find((entry) => typeof entry === 'string' && entry.trim());

          if (lastSupplierRecord) {
            result.name =
              pickName(
                lastSupplierRecord.legalName,
                lastSupplierRecord.fantasyName,
                lastSupplierRecord.name,
                lastSupplierRecord.razaoSocial
              ) || '';
            result.document = digitsOnly(lastSupplierRecord.cnpj || lastSupplierRecord.document || '');
          }

          const xmlSource = lastSupplierData || nfeData?.emit || null;
          if (!result.name && xmlSource) {
            result.name =
              pickName(xmlSource.name, xmlSource.fantasyName, xmlSource.legalName, xmlSource.razaoSocial) || '';
          }
          if (!result.document && xmlSource) {
            result.document = digitsOnly(xmlSource.document);
          }

          if (
            !result.name &&
            supplierSelect &&
            supplierSelect.selectedOptions &&
            supplierSelect.selectedOptions.length
          ) {
            const option = supplierSelect.selectedOptions[0];
            const optionName =
              (option.dataset && option.dataset.supplierName) || option.textContent || '';
            if (optionName) {
              result.name = optionName.trim();
            }
            if (!result.document && option.dataset && option.dataset.supplierDocument) {
              result.document = digitsOnly(option.dataset.supplierDocument);
            }
          }

          return result;
        };

        const resolveSupplierAccountingAccount = () => {
          const account = lastSupplierRecord?.otherInfo?.accountingAccount;
          if (account && (account.code || account.name)) {
            return {
              id: account._id || null,
              code: account.code || '',
              name: account.name || '',
            };
          }
          return null;
        };

        const formatAccountingAccountValue = (account) => {
          if (!account) return '';
          if (account.code && account.name) {
            return `${account.code} - ${account.name}`;
          }
          return account.code || account.name || '';
        };

        const setBankAccountPlaceholder = (message, { disabled = true } = {}) => {
          if (!bankAccountSelect) return;
          bankAccountSelect.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.textContent = message;
          bankAccountSelect.appendChild(option);
          bankAccountSelect.disabled = Boolean(disabled);
        };

        const registerBankAccounts = (accounts = []) => {
          if (!Array.isArray(accounts)) return [];
          accounts.forEach((account) => {
            if (!account || !account._id) return;
            bankAccountsRegistry.index.set(String(account._id), account);
          });
          return accounts;
        };

        const buildBankAccountLabel = (account) => {
          if (!account || typeof account !== 'object') return 'Conta corrente';

          const normalize = (value) => (typeof value === 'string' ? value.trim() : '');
          const alias = normalize(account.alias);
          const bankName = normalize(account.bankName);
          const bankCode = normalize(account.bankCode);
          const agency = normalize(account.agency);
          const accountNumber = normalize(account.accountNumber);
          const accountDigit = normalize(account.accountDigit);

          const numberDisplay = accountNumber
            ? `${accountNumber}${accountDigit ? `-${accountDigit}` : ''}`
            : '';

          const parts = [];
          if (alias) parts.push(alias);

          const bankParts = [];
          if (bankCode) bankParts.push(`Banco ${bankCode}`);
          if (bankName) bankParts.push(bankName);
          if (bankParts.length) {
            parts.push(bankParts.join(' · '));
          }

          const accountParts = [];
          if (agency) accountParts.push(`Ag. ${agency}`);
          if (numberDisplay) accountParts.push(`C/C ${numberDisplay}`);
          if (accountParts.length) {
            parts.push(accountParts.join(' · '));
          }

          return parts.join(' • ') || bankName || bankCode || alias || 'Conta corrente';
        };

        const setBankAccountOptions = (accounts = [], { placeholder = null } = {}) => {
          if (!bankAccountSelect) return;

          bankAccountSelect.innerHTML = '';
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent =
            placeholder ||
            (Array.isArray(accounts) && accounts.length
              ? 'Selecione a conta corrente'
              : 'Nenhuma conta corrente cadastrada');
          bankAccountSelect.appendChild(defaultOption);

          if (Array.isArray(accounts)) {
            accounts.forEach((account) => {
              if (!account || !account._id) return;
              const option = document.createElement('option');
              option.value = String(account._id);
              option.textContent = buildBankAccountLabel(account);
              bankAccountSelect.appendChild(option);
            });
          }

          bankAccountSelect.disabled = !accounts || !accounts.length;
        };

        const setBankAccountSelectValue = (value) => {
          if (!bankAccountSelect) return false;
          const normalized = value ? String(value) : '';
          if (!normalized) {
            bankAccountSelect.value = '';
            return true;
          }
          const options = Array.from(bankAccountSelect.options || []);
          const match = options.find((option) => option.value === normalized);
          if (match) {
            bankAccountSelect.value = normalized;
            return true;
          }
          return false;
        };

        const findBankAccountById = (id) => {
          if (!id) return null;
          const normalized = String(id);
          return bankAccountsRegistry.index.get(normalized) || null;
        };

        const resolveSelectedBankAccount = (data = null) => {
          const directSelection = bankAccountSelect ? bankAccountSelect.value : '';
          if (directSelection) {
            return findBankAccountById(directSelection);
          }
          const fallbackId = data?.selectedBankAccountId || pendingBankAccountId || '';
          if (fallbackId) {
            return findBankAccountById(fallbackId);
          }
          return null;
        };

        const loadBankAccountsForCompany = async (companyId = '') => {
          if (!bankAccountsEndpoint) return [];
          const cacheKey = companyId ? String(companyId) : '__all__';

          if (bankAccountsRegistry.cache.has(cacheKey)) {
            const cached = bankAccountsRegistry.cache.get(cacheKey) || [];
            registerBankAccounts(cached);
            return cached;
          }

          if (bankAccountsRegistry.loading.has(cacheKey)) {
            try {
              await bankAccountsRegistry.loading.get(cacheKey);
            } catch (error) {
              console.error('Falha anterior ao carregar contas correntes:', error);
            }
            const cached = bankAccountsRegistry.cache.get(cacheKey) || [];
            registerBankAccounts(cached);
            return cached;
          }

          const query = companyId ? `?company=${encodeURIComponent(companyId)}` : '';
          const requestPromise = (async () => {
            bankAccountsRegistry.error = null;
            try {
              const response = await fetch(`${bankAccountsEndpoint}${query}`, {
                headers: buildAuthHeaders(),
              });

              let payload = null;
              try {
                payload = await response.json();
              } catch (error) {
                payload = null;
              }

              if (response.status === 401 || response.status === 403) {
                handleAuthError();
              }

              if (!response.ok) {
                const message =
                  (payload && (payload.message || payload.error)) ||
                  'Não foi possível carregar as contas correntes.';
                const error = new Error(message);
                error.status = response.status;
                throw error;
              }

              const accounts = Array.isArray(payload?.accounts) ? payload.accounts : [];
              registerBankAccounts(accounts);
              bankAccountsRegistry.cache.set(cacheKey, accounts);
              bankAccountsRegistry.lastLoadedAt = Date.now();
              return accounts;
            } catch (error) {
              bankAccountsRegistry.error = error;
              throw error;
            }
          })();

          bankAccountsRegistry.loading.set(cacheKey, requestPromise);

          try {
            return await requestPromise;
          } finally {
            bankAccountsRegistry.loading.delete(cacheKey);
          }
        };

        const syncBankAccountWithDuplicates = () => {
          if (!lastNfeData) return;
          const duplicates = Array.isArray(lastNfeData.duplicates) ? lastNfeData.duplicates : [];
          const selectedId = bankAccountSelect ? bankAccountSelect.value : '';
          const normalizedSelected = selectedId ? String(selectedId) : '';
          lastNfeData.selectedBankAccountId = normalizedSelected || pendingBankAccountId || '';

          if (!duplicates.length) return;

          duplicates.forEach((duplicate) => {
            if (!duplicate || typeof duplicate !== 'object') return;
            duplicate.bankAccount = normalizedSelected || null;
          });

          renderDuplicatasFromNfe(duplicates, lastNfeData);
        };

        const refreshBankAccountOptions = async ({ preserveSelection = true } = {}) => {
          if (!bankAccountSelect) return;

          const companyId = companySelect ? companySelect.value : '';
          if (!companyId) {
            pendingBankAccountId = '';
            setBankAccountPlaceholder('Selecione uma empresa para listar as contas correntes');
            if (lastNfeData && Array.isArray(lastNfeData.duplicates)) {
              lastNfeData.duplicates.forEach((duplicate) => {
                if (!duplicate || typeof duplicate !== 'object') return;
                duplicate.bankAccount = null;
              });
              lastNfeData.selectedBankAccountId = '';
              renderDuplicatasFromNfe(lastNfeData.duplicates, lastNfeData);
            }
            return;
          }

          setBankAccountPlaceholder('Carregando contas correntes...', { disabled: true });

          try {
            const accounts = await loadBankAccountsForCompany(companyId);
            setBankAccountOptions(accounts);

            let desiredValue = '';
            if (preserveSelection && lastNfeData && lastNfeData.selectedBankAccountId) {
              desiredValue = String(lastNfeData.selectedBankAccountId);
            }
            if (!desiredValue && pendingBankAccountId) {
              desiredValue = pendingBankAccountId;
            }

            if (desiredValue) {
              const applied = setBankAccountSelectValue(desiredValue);
              if (!applied) {
                pendingBankAccountId = desiredValue;
                bankAccountSelect.value = '';
              } else if (pendingBankAccountId === desiredValue) {
                pendingBankAccountId = '';
              }
            } else {
              pendingBankAccountId = '';
              bankAccountSelect.value = '';
            }
          } catch (error) {
            console.error('Erro ao carregar contas correntes:', error);
            notify(
              error?.message || 'Não foi possível carregar as contas correntes da empresa selecionada.',
              'error'
            );
            setBankAccountPlaceholder('Erro ao carregar contas correntes');
            pendingBankAccountId = '';
          }

          bankAccountSelect.disabled = bankAccountSelect.options.length <= 1;
          syncBankAccountWithDuplicates();
        };

        const normalizeSupplierCalcType = (value) => {
          if (typeof value !== 'string') return '';
          return value
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .trim()
            .toLowerCase();
        };

        const canonicalSupplierCalcType = (value) => {
          const normalized = normalizeSupplierCalcType(value);
          if (!normalized) return '';
          if (normalized.startsWith('multi') || normalized === 'x') {
            return 'multiply';
          }
          if (normalized.startsWith('div')) {
            return 'divide';
          }
          return '';
        };

        const parseSupplierCalcValue = (rawValue) => {
          if (Number.isFinite(rawValue)) {
            return rawValue > 0 ? rawValue : null;
          }
          const numeric = parseNumber(rawValue);
          return Number.isFinite(numeric) && numeric > 0 ? numeric : null;
        };

        const getBaseConversionFactor = (item) => {
          if (!item) return 1;
          const original = Number.isFinite(item?.originalConversionFactor)
            ? item.originalConversionFactor
            : parseNumber(item?.originalConversionFactor);
          if (Number.isFinite(original) && original > 0) {
            return original;
          }
          const multiplier = Number.isFinite(item?.conversionMultiplier)
            ? item.conversionMultiplier
            : parseNumber(item?.conversionMultiplier);
          const divider = Number.isFinite(item?.conversionDivider)
            ? item.conversionDivider
            : parseNumber(item?.conversionDivider);
          if (Number.isFinite(multiplier) && Number.isFinite(divider) && divider > 0) {
            return multiplier / divider;
          }
          const conversion = Number.isFinite(item?.conversion) ? item.conversion : parseNumber(item?.conversion);
          if (Number.isFinite(conversion) && conversion > 0) {
            return conversion;
          }
          return 1;
        };

        const findSupplierEntryForProduct = (product, item, nfeData) => {
          if (!product) return null;
          const suppliers = Array.isArray(product?.fornecedores) ? product.fornecedores : [];
          if (!suppliers.length) return null;

          const supplierInfo = resolveActiveSupplierInfo(nfeData);
          const normalizedSupplierName = canonicalSupplierName(supplierInfo.name);
          const itemSupplierCode = canonicalSupplierProductCode(item?.supplierCode);

          let candidates = suppliers;

          if (itemSupplierCode) {
            const codeMatches = suppliers.filter(
              (entry) => canonicalSupplierProductCode(entry?.codigoProduto) === itemSupplierCode
            );
            if (codeMatches.length) {
              candidates = codeMatches;
            }
          }

          if (normalizedSupplierName) {
            const nameMatches = candidates.filter(
              (entry) => canonicalSupplierName(entry?.fornecedor) === normalizedSupplierName
            );
            if (nameMatches.length) {
              candidates = nameMatches;
            }
          }

          const hasValidCalc = (entry) =>
            Boolean(canonicalSupplierCalcType(entry?.tipoCalculo)) && parseSupplierCalcValue(entry?.valorCalculo) !== null;

          const prioritized = candidates.filter(hasValidCalc);
          if (prioritized.length) {
            return prioritized[0];
          }

          const fallbackWithCalc = suppliers.filter(hasValidCalc);
          if (fallbackWithCalc.length) {
            return fallbackWithCalc[0];
          }

          return candidates[0] || suppliers[0] || null;
        };

        const applySupplierConversionFromProduct = (item, product, nfeData) => {
          if (!item || !product) return false;
          if (item.manualConversionOverride) return false;

          const supplierEntry = findSupplierEntryForProduct(product, item, nfeData);
          if (!supplierEntry) {
            item.supplierAppliedConversion = null;
            return false;
          }

          const calcType = canonicalSupplierCalcType(supplierEntry?.tipoCalculo);
          const calcValue = parseSupplierCalcValue(supplierEntry?.valorCalculo);
          if (!calcType || calcValue === null) {
            item.supplierAppliedConversion = null;
            item.manualConversionOverride = false;
            return false;
          }

          let baseFactor = getBaseConversionFactor(item);
          if (!Number.isFinite(baseFactor) || baseFactor <= 0) {
            baseFactor = 1;
          }

          let adjustedFactor = baseFactor;
          if (calcType === 'multiply') {
            adjustedFactor = baseFactor * calcValue;
          } else if (calcType === 'divide') {
            adjustedFactor = baseFactor / calcValue;
          }

          if (!Number.isFinite(adjustedFactor) || adjustedFactor <= 0) {
            item.supplierAppliedConversion = null;
            item.manualConversionOverride = false;
            return false;
          }

          const currentFactor = Number.isFinite(item?.conversion) ? item.conversion : parseNumber(item?.conversion);
          const alreadyApplied =
            item?.supplierAppliedConversion &&
            Number.isFinite(item.supplierAppliedConversion?.factor) &&
            Math.abs(item.supplierAppliedConversion.factor - adjustedFactor) <= 0.0005 &&
            item.supplierAppliedConversion.type === calcType &&
            item.supplierAppliedConversion.value === calcValue;

          if (alreadyApplied && Number.isFinite(currentFactor)) {
            item.manualConversionOverride = false;
            return false;
          }

          item.conversion = adjustedFactor;
          item.conversionMultiplier = adjustedFactor;
          item.conversionDivider = 1;
          item.supplierAppliedConversion = {
            type: calcType,
            value: calcValue,
            factor: adjustedFactor,
            supplierCode: canonicalSupplierProductCode(supplierEntry?.codigoProduto),
            supplierName: supplierEntry?.fornecedor || '',
            baseFactor,
          };
          item.manualConversionOverride = false;
          return true;
        };

        const ensureProductSupplierLink = (product, item, nfeData) => {
          const productId = product?._id || product?.id;
          const normalizedCode = canonicalSupplierProductCode(item?.supplierCode);
          if (!productId || !normalizedCode) {
            return null;
          }

          const supplierInfo = resolveActiveSupplierInfo(nfeData);
          const supplierName = typeof supplierInfo.name === 'string' ? supplierInfo.name.trim() : '';
          const normalizedSupplierName = canonicalSupplierName(supplierName);
          const supplierDocumentDigits = digitsOnly(supplierInfo.document);
          if (!normalizedSupplierName) {
            return null;
          }

          const cacheKeySegments = [String(productId).trim(), normalizedCode];
          if (supplierDocumentDigits) {
            cacheKeySegments.splice(1, 0, `DOC:${supplierDocumentDigits}`);
          } else if (normalizedSupplierName) {
            cacheKeySegments.splice(1, 0, `NAME:${normalizedSupplierName}`);
          }
          const cacheKey = cacheKeySegments.join('::');
          if (productSupplierLinkCache.has(cacheKey)) {
            return null;
          }
          if (productSupplierLinkPromises.has(cacheKey)) {
            return productSupplierLinkPromises.get(cacheKey);
          }

          const currentLinks = Array.isArray(product?.fornecedores) ? product.fornecedores : [];
          const alreadyLinked = currentLinks.some((entry) => {
            if (canonicalSupplierProductCode(entry?.codigoProduto) !== normalizedCode) {
              return false;
            }
            const entryDocumentDigits = digitsOnly(entry?.documentoFornecedor);
            const entrySupplierName = canonicalSupplierName(entry?.fornecedor);
            if (supplierDocumentDigits && entryDocumentDigits) {
              return entryDocumentDigits === supplierDocumentDigits;
            }
            return entrySupplierName === normalizedSupplierName;
          });
          if (alreadyLinked) {
            productSupplierLinkCache.add(cacheKey);
            return null;
          }

          if (!supplierName) {
            return null;
          }

          const payload = {
            fornecedor: supplierName,
            nomeProdutoFornecedor: item?.description || '',
            codigoProduto: item?.supplierCode || '',
            unidadeEntrada: item?.unit || item?.unitTrib || '',
            documentoFornecedor: supplierDocumentDigits,
          };

          const headers = buildAuthHeaders();
          headers.set('Content-Type', 'application/json');

          const requestPromise = (async () => {
            const response = await fetch(`${apiBaseUrl}/products/${productId}/suppliers/link`, {
              method: 'POST',
              headers,
              body: JSON.stringify(payload),
            });
            const result = await response.json().catch(() => ({}));
            if (!response.ok) {
              const message =
                result?.message ||
                `Falha ao vincular produto ao fornecedor (status ${response.status}).`;
              throw new Error(message);
            }

            if (Array.isArray(result?.fornecedores)) {
              product.fornecedores = result.fornecedores;
            } else if (result?.fornecedor) {
              const updatedList = Array.isArray(product.fornecedores)
                ? [...product.fornecedores, result.fornecedor]
                : [result.fornecedor];
              product.fornecedores = updatedList;
            }

            productSupplierLinkCache.add(cacheKey);
            return result;
          })()
            .catch((error) => {
              throw error;
            })
            .finally(() => {
              productSupplierLinkPromises.delete(cacheKey);
            });

          productSupplierLinkPromises.set(cacheKey, requestPromise);
          return requestPromise;
        };

        const normalizeInternalCode = (value) => {
          if (typeof value === 'number' && Number.isFinite(value)) {
            return String(value);
          }
          if (typeof value === 'string') {
            return value.trim();
          }
          return '';
        };

        const buildTemporaryInternalCode = (index = 0) => {
          const sequence = Number.isFinite(index) ? index + 1 : 1;
          return `${INTERNAL_CODE_PREFIX}${String(sequence).padStart(5, '0')}`;
        };

        const ensureUniqueInternalCodes = (items) => {
          if (!Array.isArray(items) || !items.length) return;

          const usedCodes = new Set();

          items.forEach((item) => {
            const matchedCode = normalizeInternalCode(getProductCodeFromRecord(item?.matchedProduct));
            if (matchedCode) {
              item.internalCode = matchedCode;
            }
          });

          items.forEach((item, index) => {
            const baseCode = normalizeInternalCode(item.internalCode) || buildTemporaryInternalCode(item.index ?? index);
            let candidate = baseCode;
            let attempt = 1;

            while (usedCodes.has(candidate)) {
              attempt += 1;
              candidate = `${baseCode}-${String(attempt).padStart(2, '0')}`;
            }

            item.internalCode = candidate;
            usedCodes.add(candidate);
          });
        };

        const getProductCodeFromRecord = (product) =>
          product?.codigoInterno ||
          product?.cod ||
          product?.codigo ||
          product?.codInterno ||
          product?.codigoReferencia ||
          product?.sku ||
          product?.id ||
          '';

        const PRODUCT_BARCODE_FIELDS = [
          'codigoBarras',
          'codigoDeBarras',
          'barras',
          'ean',
          'eanTrib',
          'codbarras',
          'barcode',
          'codigo_barras',
        ];

        const getProductBarcodeFromRecord = (product) => {
          if (!product || typeof product !== 'object') return '';
          for (const field of PRODUCT_BARCODE_FIELDS) {
            const normalized = normalizeBarcodeForComparison(product[field]);
            if (normalized) return normalized;
          }
          if (Array.isArray(product.variacoes)) {
            for (const variation of product.variacoes) {
              const normalized = normalizeBarcodeForComparison(
                variation?.codigoBarras || variation?.barcode || variation?.ean
              );
              if (normalized) return normalized;
            }
          }
          return '';
        };

        const getOptionDocument = (option) => {
          if (!option) return '';
          const existingDataset = option.dataset?.supplierDocument;
          if (existingDataset) {
            return existingDataset;
          }
          const digits = digitsOnly(`${option.value}${option.textContent || ''}`);
          if (digits && option.dataset) {
            option.dataset.supplierDocument = digits;
          }
          return digits;
        };

        const formatDocumentForOption = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 14) {
            return digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
          }
          if (digits.length === 11) {
            return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
          }
          return digits;
        };

        const buildSupplierOptionLabel = (supplier, documentDigits) => {
          const formattedDocument = formatDocumentForOption(documentDigits);
          const name =
            supplier?.legalName ||
            supplier?.fantasyName ||
            supplier?.name ||
            formattedDocument;
          const codeValue = supplier?.code ?? supplier?.codeNumber;
          let codeText = '';
          if (typeof codeValue === 'number' && Number.isFinite(codeValue)) {
            codeText = `Código ${String(codeValue).padStart(4, '0')}`;
          } else if (typeof codeValue === 'string' && codeValue.trim()) {
            codeText = `Código ${codeValue.trim()}`;
          }
          return [formattedDocument, name, codeText].filter(Boolean).join(' · ');
        };

        const findSupplierOptionByDocument = (documentDigits) => {
          if (!supplierSelect || !documentDigits) return null;
          return (
            Array.from(supplierSelect.options || []).find(
              (option) => getOptionDocument(option) === documentDigits
            ) || null
          );
        };

        const ensureSupplierOption = (supplier, documentDigits) => {
          if (!supplierSelect || !documentDigits) return null;
          const existingOption = findSupplierOptionByDocument(documentDigits);
          const option = existingOption || document.createElement('option');
          const optionValue = supplier?._id || documentDigits;
          option.value = optionValue;
          option.textContent = buildSupplierOptionLabel(supplier, documentDigits);
          option.dataset.supplierDocument = documentDigits;
          if (supplier?._id) {
            option.dataset.supplierId = supplier._id;
          }
          option.dataset.supplierName =
            supplier?.legalName || supplier?.fantasyName || supplier?.name || '';
          if (!existingOption) {
            supplierSelect.appendChild(option);
          }
          return option;
        };

        const registerSupplierRecord = (supplier) => {
          if (!supplier) return null;
          const documentDigits = digitsOnly(supplier.cnpj || supplier.document);
          if (!documentDigits) return null;
          supplierRegistry.byDocument.set(documentDigits, supplier);
          return ensureSupplierOption(supplier, documentDigits);
        };

        const indexExistingSupplierOptions = () => {
          if (!supplierSelect) return;
          Array.from(supplierSelect.options || []).forEach((option) => {
            const digits = getOptionDocument(option);
            if (!digits) return;
            option.dataset.supplierDocument = digits;
          });
        };

        const loadSuppliersFromApi = async (forceReload = false) => {
          if (!suppliersEndpoint) return supplierRegistry.byDocument;
          if (forceReload) {
            supplierRegistry.loaded = false;
          }
          if (supplierRegistry.loaded && !forceReload) {
            return supplierRegistry.byDocument;
          }
          if (supplierRegistry.loadingPromise) {
            try {
              await supplierRegistry.loadingPromise;
            } catch (_) {
              // Ignorar erros anteriores, o estado já foi atualizado
            }
            return supplierRegistry.byDocument;
          }
          supplierRegistry.loadingPromise = (async () => {
            try {
              supplierRegistry.error = null;
              const response = await fetch(suppliersEndpoint, {
                headers: buildAuthHeaders(),
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) {
                if (response.status === 401) {
                  handleAuthError();
                }
                throw new Error(data?.message || `Falha ao consultar fornecedores (status ${response.status})`);
              }
              const suppliers = Array.isArray(data?.suppliers) ? data.suppliers : [];
              supplierRegistry.byDocument.clear();
              suppliers.forEach((entry) => {
                registerSupplierRecord(entry);
              });
              supplierRegistry.loaded = true;
              supplierRegistry.lastLoadedAt = Date.now();
            } catch (error) {
              supplierRegistry.error = error;
              supplierRegistry.loaded = false;
              console.error('Erro ao carregar fornecedores cadastrados:', error);
            } finally {
              supplierRegistry.loadingPromise = null;
            }
          })();
          try {
            await supplierRegistry.loadingPromise;
          } catch (_) {
            // Erro já tratado no bloco acima
          }
          return supplierRegistry.byDocument;
        };

        const setText = (element, value, fallback = '') => {
          if (!element) return;
          element.textContent = value || fallback;
        };

        const setInputValue = (element, value) => {
          if (!element) return;
          element.value = value ?? '';
        };

        const setSummaryInput = (key, value) => {
          const element = importSummaryFields[key];
          if (!element) return;
          element.value = value ?? '';
        };

        const formatDocument = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 14) {
            return `CNPJ ${digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5')}`;
          }
          if (digits.length === 11) {
            return `CPF ${digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}`;
          }
          return digits || value || '';
        };

        const composeDocumentLine = (documentValue, stateRegistration) => {
          const documentText = formatDocument(documentValue);
          if (documentText && stateRegistration) {
            return `${documentText} · IE ${stateRegistration}`;
          }
          if (documentText) return documentText;
          if (stateRegistration) return `IE ${stateRegistration}`;
          return '';
        };

        const formatCep = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 8) {
            return digits.replace(/(\d{5})(\d{3})/, '$1-$2');
          }
          return digits || '';
        };

        const formatPhone = (value) => {
          const digits = digitsOnly(value);
          if (digits.length === 11) {
            return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
          }
          if (digits.length === 10) {
            return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
          }
          return digits || '';
        };

        const formatCurrencyBRL = (value) => {
          const numeric = Number.parseFloat(String(value || '').replace(',', '.'));
          if (Number.isFinite(numeric)) {
            return numeric.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          }
          return 'R$ 0,00';
        };

        const PAYMENT_METHOD_DESCRIPTIONS = {
          '01': 'Dinheiro',
          '02': 'Cheque',
          '03': 'Cartão de Crédito',
          '04': 'Cartão de Débito',
          '05': 'Crédito Loja',
          '10': 'Vale Alimentação',
          '11': 'Vale Refeição',
          '12': 'Vale Presente',
          '13': 'Vale Combustível',
          '14': 'Duplicata Mercantil',
          '15': 'Boleto Bancário',
          '16': 'Depósito Bancário',
          '17': 'Pagamento Instantâneo (PIX)',
          '18': 'Transferência bancária',
          '19': 'Programa de Fidelidade',
          '90': 'Sem pagamento',
          '99': 'Outros',
        };

        const describePaymentMethod = (code) => {
          if (!code && code !== 0) return '';
          const normalized = String(code).trim();
          if (!normalized) return '';
          const padded = normalized.length === 1 ? `0${normalized}` : normalized;
          return (
            PAYMENT_METHOD_DESCRIPTIONS[padded] ||
            PAYMENT_METHOD_DESCRIPTIONS[normalized] ||
            normalized
          );
        };

        const formatAddressLine = (address = {}) => {
          if (!address || typeof address !== 'object') return '';
          const parts = [];
          const streetParts = [];
          if (address.street) streetParts.push(address.street);
          if (address.number) streetParts.push(address.number);
          const streetLine = streetParts.join(', ');
          if (streetLine) parts.push(streetLine);
          if (address.complement) parts.push(address.complement);
          if (address.neighborhood) parts.push(address.neighborhood);
          const cityState = [address.city, address.state].filter(Boolean).join(' - ');
          if (cityState) parts.push(cityState);
          const cep = formatCep(address.cep);
          if (cep) parts.push(`CEP ${cep}`);
          if (address.country) parts.push(address.country);
          return parts.join(' · ');
        };

        const buildContactLine = (entity = {}) => {
          const parts = [];
          if (entity.email) parts.push(entity.email);
          const phone = formatPhone(entity.phone);
          if (phone) parts.push(phone);
          const mobile = formatPhone(entity.mobile);
          if (mobile && mobile !== phone) parts.push(mobile);
          return parts.length ? parts.join(' · ') : '';
        };

        const mapEnvironment = (value) => {
          if (value === '1') return 'Ambiente produção';
          if (value === '2') return 'Ambiente homologação';
          return 'Ambiente não identificado';
        };

        const mapFrete = (value) => {
          const map = {
            '0': '0 - Contratação do frete por conta do remetente (CIF)',
            '1': '1 - Contratação do frete por conta do destinatário/remetente (FOB)',
            '2': '2 - Contratação do frete por conta de terceiros',
            '3': '3 - Transporte próprio por conta do remetente',
            '4': '4 - Transporte próprio por conta do destinatário',
            '9': '9 - Sem frete',
          };
          return map[value] || value || '';
        };

        const formatIndIe = (value) => {
          const map = {
            '1': '1 - Contribuinte ICMS',
            '2': '2 - Contribuinte isento',
            '9': '9 - Não contribuinte ICMS',
          };
          return map[value] || value || '';
        };

        const mapModelToType = (model) => {
          if (model === '65') return 'NFCe';
          if (model === '55') return 'NF';
          return 'NF';
        };

        const MS_PER_DAY = 24 * 60 * 60 * 1000;

        const computeDateDiffInDays = (startInput, endInput) => {
          if (!startInput || !endInput) return null;
          const startDate = new Date(`${startInput}T00:00:00`);
          const endDate = new Date(`${endInput}T00:00:00`);
          if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
            return null;
          }
          return Math.round((endDate.getTime() - startDate.getTime()) / MS_PER_DAY);
        };

        const addDaysToDateInput = (baseInput, daysToAdd) => {
          if (!baseInput || !Number.isFinite(daysToAdd)) return '';
          const baseDate = new Date(`${baseInput}T00:00:00`);
          if (Number.isNaN(baseDate.getTime())) {
            return '';
          }
          const adjusted = new Date(baseDate.getTime());
          adjusted.setDate(adjusted.getDate() + daysToAdd);
          return adjusted.toISOString().slice(0, 10);
        };

        const normalizeDate = (value) => {
          if (!value) {
            return { dateInput: '', display: '', displayDateTime: '' };
          }
          let date = null;
          if (value.includes('T')) {
            date = new Date(value);
          } else if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            date = new Date(`${value}T00:00:00`);
          } else if (/^\d{8}$/.test(value)) {
            const formatted = `${value.slice(0, 4)}-${value.slice(4, 6)}-${value.slice(6, 8)}`;
            date = new Date(`${formatted}T00:00:00`);
          }
          if (date && !Number.isNaN(date.getTime())) {
            return {
              dateInput: date.toISOString().slice(0, 10),
              display: date.toLocaleDateString('pt-BR'),
              displayDateTime: date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
            };
          }
          return { dateInput: '', display: value, displayDateTime: value };
        };

        const setSelectValue = (select, value) => {
          if (!select || typeof value === 'undefined' || value === null) return;
          const option = Array.from(select.options || []).find((item) => item.value === value);
          if (option) {
            select.value = option.value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
          }
        };

        const resetSelectValue = (select, defaultValue = '') => {
          if (!select) return;
          const options = Array.from(select.options || []);
          if (typeof defaultValue !== 'undefined' && defaultValue !== null) {
            const hasMatch = options.some((option) => option.value === defaultValue);
            if (hasMatch || defaultValue === '') {
              select.value = defaultValue;
            } else if (options.length) {
              select.selectedIndex = 0;
            } else {
              select.value = '';
            }
          } else if (options.length) {
            select.selectedIndex = 0;
          } else {
            select.value = '';
          }
          select.dispatchEvent(new Event('change', { bubbles: true }));
        };

        const clearStatusClasses = (element, classes) => {
          if (!element) return;
          const targetClasses = classes && classes.length ? classes : ALL_STATUS_CLASSES;
          if (targetClasses.length) {
            element.classList.remove(...targetClasses);
          }
        };

        const applyStatusClasses = (element, type = 'info') => {
          if (!element) return;
          clearStatusClasses(element, ALL_STATUS_CLASSES);
          const classes = STATUS_CLASS_MAP[type] || STATUS_CLASS_MAP.info;
          element.classList.add(...classes);
        };

        const applyValidationStyles = (type = 'info') => {
          if (!importXmlValidationBadge) return;
          importXmlValidationBadge.classList.remove(...ALL_VALIDATION_CLASSES);
          importXmlValidationBadge.classList.add(...(VALIDATION_BADGE_STYLES[type] || VALIDATION_BADGE_STYLES.info));
          if (importXmlValidationIcon) {
            importXmlValidationIcon.className = `${VALIDATION_ICONS[type] || VALIDATION_ICONS.info} text-[11px]`;
          }
        };

        const clearStatusMessages = () => {
          if (importFileFeedback) {
            importFileFeedback.classList.add('hidden');
            importFileFeedback.textContent = '';
            clearStatusClasses(importFileFeedback, ALL_STATUS_CLASSES);
          }
          if (importSupplierStatus) {
            importSupplierStatus.classList.add('hidden');
            toggleSupplierStatusLayout(false);
            if (importSupplierMessage) importSupplierMessage.textContent = '';
            if (importSupplierDescription) {
              importSupplierDescription.textContent = '';
              importSupplierDescription.classList.remove('hidden');
            }
            if (importSupplierActions) {
              importSupplierActions.innerHTML = '';
              importSupplierActions.classList.add('hidden');
            }
            if (importSupplierIcon) {
              importSupplierIcon.className = 'fas fa-circle-info mt-0.5 text-[12px]';
            }
            clearStatusClasses(importSupplierStatus, ALL_STATUS_CLASSES);
          }
        };

        const showFileFeedback = (message, type = 'info') => {
          if (!importFileFeedback) return;
          importFileFeedback.textContent = message;
          importFileFeedback.classList.remove('hidden');
          applyStatusClasses(importFileFeedback, type);
        };

        const setSupplierSummary = (supplier) => {
          if (!importSupplierSummary) return;
          if (!supplier || (!supplier.name && !supplier.document)) {
            importSupplierSummary.classList.add('hidden');
            if (importSupplierSummaryName) importSupplierSummaryName.textContent = '';
            if (importSupplierSummaryDocument) importSupplierSummaryDocument.textContent = '';
            if (importSupplierSummaryIe) importSupplierSummaryIe.textContent = '';
            if (importSupplierSummaryAddress) importSupplierSummaryAddress.textContent = '';
            if (importSupplierSummaryContact) importSupplierSummaryContact.textContent = '';
            return;
          }
          importSupplierSummary.classList.remove('hidden');
          if (importSupplierSummaryName) {
            importSupplierSummaryName.textContent = supplier.name || 'Emitente não identificado';
          }
          if (importSupplierSummaryDocument) {
            importSupplierSummaryDocument.textContent = formatDocument(supplier.document) || 'Documento não informado';
          }
          if (importSupplierSummaryIe) {
            importSupplierSummaryIe.textContent = supplier.stateRegistration || 'IE não informada';
          }
          if (importSupplierSummaryAddress) {
            importSupplierSummaryAddress.textContent =
              formatAddressLine(supplier.address) || 'Endereço não informado';
          }
          if (importSupplierSummaryContact) {
            importSupplierSummaryContact.textContent = buildContactLine(supplier) || 'Contato não informado';
          }
        };

        const updateSupplierStatusCard = (type = 'info', message = '', description = '', actions = []) => {
          if (!importSupplierStatus) return;

          const hasMessage = Boolean(message);
          const hasDescription = Boolean(description);
          const hasActions = Array.isArray(actions) && actions.length > 0;

          if (!hasMessage && !hasDescription && !hasActions) {
            importSupplierStatus.classList.add('hidden');
            toggleSupplierStatusLayout(false);
            if (importSupplierMessage) importSupplierMessage.textContent = '';
            if (importSupplierDescription) {
              importSupplierDescription.textContent = '';
              importSupplierDescription.classList.add('hidden');
            }
            if (importSupplierActions) {
              importSupplierActions.innerHTML = '';
              importSupplierActions.classList.add('hidden');
            }
            if (importSupplierIcon) {
              importSupplierIcon.className = 'fas fa-circle-info mt-0.5 text-[12px]';
            }
            clearStatusClasses(importSupplierStatus, ALL_STATUS_CLASSES);
            return;
          }

          toggleSupplierStatusLayout(true);
          importSupplierStatus.classList.remove('hidden');
          applyStatusClasses(importSupplierStatus, type);

          if (importSupplierIcon) {
            const iconClass = STATUS_ICONS[type] || STATUS_ICONS.info;
            importSupplierIcon.className = `${iconClass} mt-0.5 text-[12px]`;
          }

          if (importSupplierMessage) {
            importSupplierMessage.textContent = message || '';
          }

          if (importSupplierDescription) {
            if (hasDescription) {
              importSupplierDescription.textContent = description;
              importSupplierDescription.classList.remove('hidden');
            } else {
              importSupplierDescription.textContent = '';
              importSupplierDescription.classList.add('hidden');
            }
          }

          if (!importSupplierActions) return;

          importSupplierActions.innerHTML = '';
          if (hasActions) {
            importSupplierActions.classList.remove('hidden');
            actions.forEach((actionConfig) => {
              if (!actionConfig || !actionConfig.label) return;
              const button = document.createElement('button');
              button.type = 'button';
              button.classList.add(
                'inline-flex',
                'items-center',
                'gap-1.5',
                'rounded-lg',
                'border',
                'px-2.5',
                'py-1',
                'text-[9.5px]',
                'font-semibold',
                'leading-tight',
                'transition',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-1'
              );
              const variantClasses = SUPPLIER_ACTION_VARIANTS[actionConfig.variant] || SUPPLIER_ACTION_VARIANTS.secondary;
              button.classList.add(...variantClasses);
              if (actionConfig.icon) {
                const icon = document.createElement('i');
                icon.className = `${actionConfig.icon} text-[11px]`;
                button.appendChild(icon);
              }
              const label = document.createElement('span');
              label.textContent = actionConfig.label;
              button.appendChild(label);
              if (typeof actionConfig.action === 'function') {
                button.addEventListener('click', actionConfig.action);
              }
              importSupplierActions.appendChild(button);
            });
          } else {
            importSupplierActions.classList.add('hidden');
          }
        };

        const buildSupplierRegistrationUrl = (supplier, nfeData) => {
          const url = new URL('admin-compras-fornecedor-cadastro.html', window.location.href);
          const params = new URLSearchParams();
          const documentDigits = digitsOnly(supplier?.document);
          if (documentDigits) {
            params.set('supplierCnpj', documentDigits);
            params.set('supplierType', documentDigits.length === 11 ? 'fisico' : 'juridico');
          }
          if (supplier?.name) params.set('supplierRazaoSocial', supplier.name);
          if (supplier?.fantasyName) params.set('supplierNomeFantasia', supplier.fantasyName);
          if (supplier?.stateRegistration) params.set('supplierIe', supplier.stateRegistration);
          if (supplier?.email) params.set('supplierEmail', supplier.email);
          if (supplier?.phone) params.set('supplierTelefone', digitsOnly(supplier.phone));
          if (supplier?.address?.cep) params.set('supplierCEP', digitsOnly(supplier.address.cep));
          if (supplier?.address?.street) params.set('supplierLogradouro', supplier.address.street);
          if (supplier?.address?.number) params.set('supplierNumero', supplier.address.number);
          if (supplier?.address?.complement) params.set('supplierComplemento', supplier.address.complement);
          if (supplier?.address?.neighborhood) params.set('supplierBairro', supplier.address.neighborhood);
          if (supplier?.address?.city) params.set('supplierCidade', supplier.address.city);
          if (supplier?.address?.state) params.set('supplierUF', supplier.address.state);
          if (supplier?.address?.country) params.set('supplierPais', supplier.address.country);
          if (nfeData?.accessKey) params.set('supplierObservacao', `Origem: XML NF-e ${nfeData.accessKey}`);
          params.set('from', 'nfe-import');
          url.search = params.toString();
          return url.toString();
        };

        const persistProductDraft = (item, nfeData) => {
          if (!item || typeof sessionStorage === 'undefined') return;
          try {
            const supplierSource = lastSupplierData || nfeData?.emit || null;
            const supplierName =
              supplierSource?.name ||
              supplierSource?.fantasyName ||
              supplierSource?.legalName ||
              supplierSource?.razaoSocial ||
              '';
            const supplierPayload = supplierSource
              ? {
                  name: supplierName,
                  fantasyName: supplierSource?.fantasyName || '',
                  document: supplierSource?.document ? digitsOnly(supplierSource.document) : '',
                  stateRegistration: supplierSource?.stateRegistration || '',
                  email: supplierSource?.email || '',
                  phone: supplierSource?.phone || '',
                  address: supplierSource?.address || null,
                }
              : null;
            const payload = {
              item,
              accessKey: nfeData?.accessKey || '',
              generatedAt: new Date().toISOString(),
              supplier: supplierPayload,
              nfe: {
                number: nfeData?.ide?.number || '',
                serie: nfeData?.ide?.serie || '',
                emissionDate: nfeData?.ide?.emissionDate || '',
              },
            };
            sessionStorage.setItem(PRODUCT_DRAFT_STORAGE_KEY, JSON.stringify(payload));
          } catch (error) {
            console.warn('Não foi possível preparar o rascunho de cadastro do produto importado.', error);
          }
        };

        const buildProductRegistrationUrl = (item, nfeData) => {
          const url = new URL('admin-produtos.html', window.location.href);
          url.searchParams.set('from', 'nfe-import');
          if (nfeData?.accessKey) {
            url.searchParams.set('nfe', nfeData.accessKey);
          }
          const barcode = Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length
            ? item.barcodeCandidates[0]
            : '';
          if (barcode) {
            url.searchParams.set('barcode', barcode);
          }
          return url.toString();
        };

        const buildExistingProductEditUrl = (item, nfeData) => {
          const productId = getProductIdFromRecord(item?.matchedProduct);
          if (!productId) return null;
          const url = new URL('admin-produtos.html', window.location.href);
          url.searchParams.set('id', productId);
          if (nfeData?.accessKey) {
            url.searchParams.set('nfe', nfeData.accessKey);
          }
          const barcode = Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length
            ? item.barcodeCandidates[0]
            : '';
          if (barcode) {
            url.searchParams.set('barcode', barcode);
          }
          return url.toString();
        };

        const isImportModalOpen = () => Boolean(importModal && !importModal.classList.contains('hidden'));

        const updateProductIframeHeader = (item, nfeData) => {
          if (productIframeTitle) {
            const rawTitle = typeof item?.description === 'string' ? item.description.trim() : '';
            const normalizedTitle = rawTitle || 'Cadastro de produto';
            productIframeTitle.textContent = normalizedTitle.length > 140
              ? `${normalizedTitle.slice(0, 137)}...`
              : normalizedTitle;
          }

          if (productIframeSubtitle) {
            const parts = [];
            if (nfeData?.ide?.number) parts.push(`NF-e ${nfeData.ide.number}`);
            if (nfeData?.ide?.serie) parts.push(`Série ${nfeData.ide.serie}`);
            const supplierName =
              lastSupplierData?.fantasyName ||
              lastSupplierData?.name ||
              lastSupplierData?.legalName ||
              nfeData?.emit?.fantasyName ||
              nfeData?.emit?.name ||
              '';
            if (supplierName) parts.push(supplierName);
            const subtitle = parts.join(' · ');
            productIframeSubtitle.textContent = subtitle;
            productIframeSubtitle.classList.toggle('hidden', subtitle.length === 0);
          }

          if (productIframeHelper) {
            const baseMessage =
              'Os dados do XML autorizado foram enviados automaticamente. Revise e complete as informações antes de salvar.';
            const accessKeyNote = nfeData?.accessKey ? ` Chave de acesso ${nfeData.accessKey}.` : '';
            productIframeHelper.textContent = `${baseMessage}${accessKeyNote}`;
          }
        };

        const clearProductModalHeight = () => {
          if (!productIframeShell) return;
          productIframeShell.style.removeProperty('min-height');
          productIframeShell.style.removeProperty('height');
          productIframeShell.style.removeProperty('max-height');
        };

        const syncProductModalHeight = () => {
          if (!productIframeShell || !productIframeModal) return;
          if (productIframeModal.classList.contains('hidden')) {
            clearProductModalHeight();
            return;
          }

          const importModalCard = importModal?.querySelector('[data-import-modal-card]') || null;
          if (!importModalCard) {
            clearProductModalHeight();
            return;
          }

          const { height } = importModalCard.getBoundingClientRect();
          if (!Number.isFinite(height) || height <= 0) {
            clearProductModalHeight();
            return;
          }

          const viewportLimit = Number.isFinite(window.innerHeight)
            ? Math.max(0, window.innerHeight * 0.9)
            : height;
          const targetHeight = Math.max(0, Math.min(height, viewportLimit));

          if (targetHeight === 0) {
            clearProductModalHeight();
            return;
          }

          const heightValue = `${targetHeight}px`;
          productIframeShell.style.minHeight = heightValue;
          productIframeShell.style.height = heightValue;
          productIframeShell.style.maxHeight = heightValue;
        };

        let productModalHeightSyncBound = false;
        let productModalHeightObserver = null;

        const ensureProductModalHeightSync = () => {
          syncProductModalHeight();
          if (productModalHeightSyncBound) return;
          window.addEventListener('resize', syncProductModalHeight);
          productModalHeightSyncBound = true;
          if (typeof ResizeObserver === 'function') {
            const importModalCard = importModal?.querySelector('[data-import-modal-card]') || null;
            if (importModalCard) {
              productModalHeightObserver = new ResizeObserver(() => {
                syncProductModalHeight();
              });
              productModalHeightObserver.observe(importModalCard);
            }
          }
        };

        const teardownProductModalHeightSync = () => {
          if (productModalHeightSyncBound) {
            window.removeEventListener('resize', syncProductModalHeight);
            productModalHeightSyncBound = false;
          }
          if (productModalHeightObserver) {
            try {
              productModalHeightObserver.disconnect();
            } catch (observerError) {
              console.debug('Não foi possível desconectar o observador de altura do modal.', observerError);
            }
            productModalHeightObserver = null;
          }
          clearProductModalHeight();
        };

        const resetProductIframeModal = () => {
          if (productIframeLoading) {
            productIframeLoading.classList.remove('hidden');
          }
          if (productIframe) {
            productIframe.classList.add('hidden');
            try {
              productIframe.src = 'about:blank';
            } catch (iframeResetError) {
              console.debug('Não foi possível redefinir o iframe do produto.', iframeResetError);
            }
          }
          clearProductModalHeight();
        };

        const closeProductIframeModal = () => {
          if (!productIframeModal) return;
          resetProductIframeModal();
          teardownProductModalHeightSync();
          productIframeModal.classList.add('hidden');
          productIframeModal.removeAttribute('data-modal-open');
          if (!isImportModalOpen()) {
            document.body.classList.remove('overflow-hidden');
          }
          if (productModalPreviousFocus && typeof productModalPreviousFocus.focus === 'function') {
            try {
              productModalPreviousFocus.focus();
            } catch (focusError) {
              console.debug('Não foi possível restaurar o foco após fechar o cadastro de produto.', focusError);
            }
          }
          productModalPreviousFocus = null;
        };

        const openProductIframeModal = (url, item, nfeData) => {
          if (!productIframeModal || !productIframe) {
            window.open(url, '_blank', 'noopener');
            return;
          }

          productModalPreviousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
          updateProductIframeHeader(item, nfeData);
          if (productIframeLoading) {
            productIframeLoading.classList.remove('hidden');
          }
          productIframe.classList.add('hidden');
          productIframeModal.classList.remove('hidden');
          productIframeModal.setAttribute('data-modal-open', 'true');
          document.body.classList.add('overflow-hidden');
          productIframe.src = url;
          ensureProductModalHeightSync();
          requestAnimationFrame(syncProductModalHeight);

          requestAnimationFrame(() => {
            if (!productIframeModal) return;
            const focusableElements = Array.from(
              productIframeModal.querySelectorAll(MODAL_FOCUSABLE_SELECTORS)
            ).filter((element) => element instanceof HTMLElement && element.offsetParent !== null);
            if (focusableElements.length > 0) {
              const firstElement = focusableElements[0];
              if (firstElement instanceof HTMLElement) {
                firstElement.focus();
              }
            }
          });
        };

        const openProductRegistration = (item) => {
          if (!item) return;
          persistProductDraft(item, lastNfeData);
          const url = buildProductRegistrationUrl(item, lastNfeData);
          openProductIframeModal(url, item, lastNfeData);
        };

        const openExistingProduct = (item) => {
          if (!item || !item.matchedProduct) {
            notify('Produto não disponível para edição no momento.', 'warning');
            return;
          }
          const url = buildExistingProductEditUrl(item, lastNfeData);
          if (!url) {
            notify('Não foi possível identificar o produto cadastrado para abrir no modal.', 'error');
            return;
          }
          openProductIframeModal(url, item, lastNfeData);
        };

        const isProductLinkModalOpen = () =>
          Boolean(productLinkModal && !productLinkModal.classList.contains('hidden'));

        const isProductIframeModalOpen = () =>
          Boolean(
            productIframeModal &&
              !productIframeModal.classList.contains('hidden') &&
              productIframeModal.hasAttribute('data-modal-open')
          );

        const hideProductLinkMessages = () => {
          if (productLinkError) {
            productLinkError.classList.add('hidden');
          }
          if (productLinkEmpty) {
            productLinkEmpty.classList.add('hidden');
          }
        };

        const setProductLinkLoading = (isLoading, message = 'Buscando produtos cadastrados...') => {
          if (productLinkLoading) {
            if (isLoading) {
              productLinkLoading.classList.remove('hidden');
              if (productLinkLoadingText) {
                productLinkLoadingText.textContent = message;
              }
            } else {
              productLinkLoading.classList.add('hidden');
            }
          }
          if (productLinkForm) {
            const controls = productLinkForm.querySelectorAll('input, button');
            controls.forEach((control) => {
              control.disabled = Boolean(isLoading);
            });
          }
        };

        const setProductLinkInteractivity = (isEnabled) => {
          if (!productLinkResults) return;
          productLinkResults.querySelectorAll('button').forEach((button) => {
            if (!(button instanceof HTMLButtonElement)) return;
            button.disabled = !isEnabled;
            button.classList.toggle('opacity-60', !isEnabled);
            button.classList.toggle('cursor-not-allowed', !isEnabled);
          });
        };

        const showProductLinkError = (message) => {
          hideProductLinkMessages();
          if (productLinkError) {
            productLinkError.textContent = message;
            productLinkError.classList.remove('hidden');
          } else {
            notify(message, 'error');
          }
        };

        const showProductLinkEmpty = (message) => {
          hideProductLinkMessages();
          if (productLinkEmpty) {
            productLinkEmpty.textContent = message;
            productLinkEmpty.classList.remove('hidden');
          }
        };

        const resetProductLinkModal = () => {
          if (productLinkSearchAbortController) {
            productLinkSearchAbortController.abort();
            productLinkSearchAbortController = null;
          }
          productLinkActiveItem = null;
          productLinkIsLinking = false;
          if (productLinkSearchInput) {
            productLinkSearchInput.value = '';
          }
          if (productLinkResults) {
            productLinkResults.innerHTML = '';
          }
          hideProductLinkMessages();
          showProductLinkEmpty('Informe ao menos três caracteres para localizar um produto cadastrado.');
          setProductLinkLoading(false);
          setProductLinkInteractivity(true);
        };

        const closeProductLinkModal = () => {
          if (!productLinkModal || productLinkModal.classList.contains('hidden')) return;
          resetProductLinkModal();
          productLinkModal.classList.add('hidden');
          productLinkModal.removeAttribute('data-modal-open');
          if (!isImportModalOpen() && !isProductIframeModalOpen()) {
            document.body.classList.remove('overflow-hidden');
          }
          if (productLinkPreviousFocus && typeof productLinkPreviousFocus.focus === 'function') {
            try {
              productLinkPreviousFocus.focus();
            } catch (focusError) {
              console.debug('Não foi possível restaurar o foco após fechar a seleção de produto.', focusError);
            }
          }
          productLinkPreviousFocus = null;
        };

        const renderProductLinkResults = (products = []) => {
          if (!productLinkResults) return;
          productLinkResults.innerHTML = '';
          if (!Array.isArray(products) || !products.length) {
            showProductLinkEmpty('Nenhum produto cadastrado encontrado para os termos informados.');
            return;
          }
          hideProductLinkMessages();
          const fragment = document.createDocumentFragment();
          products.forEach((product) => {
            const item = document.createElement('li');
            item.className = 'rounded-xl border border-gray-100 bg-white px-3 py-2 shadow-sm';

            const header = document.createElement('div');
            header.className = 'flex items-start justify-between gap-3';

            const infoWrapper = document.createElement('div');
            infoWrapper.className = 'space-y-1';

            const title = document.createElement('p');
            title.className = 'text-[13px] font-semibold text-gray-900';
            title.textContent = product?.nome || product?.name || 'Produto sem nome';
            infoWrapper.appendChild(title);

            const details = document.createElement('p');
            details.className = 'text-[11px] text-gray-600';
            const sku = normalizeInternalCode(getProductCodeFromRecord(product)) || '—';
            const barcode = formatGtinDisplay(getProductBarcodeFromRecord(product));
            details.textContent = `SKU: ${sku} · GTIN: ${barcode}`;
            infoWrapper.appendChild(details);

            header.appendChild(infoWrapper);

            const selectButton = createProductActionButton('Vincular', 'fas fa-link');
            selectButton.addEventListener('click', (event) => {
              event.preventDefault();
              handleProductLinkSelection(product);
            });
            header.appendChild(selectButton);

            item.appendChild(header);

            const footer = document.createElement('p');
            footer.className = 'mt-1 text-[10px] text-gray-500';
            const price = Number.isFinite(product?.precoVenda)
              ? formatMoneyValue(product.precoVenda)
              : '';
            footer.textContent = price ? `Preço de venda: R$ ${price}` : 'Sem preço informado';
            item.appendChild(footer);

            fragment.appendChild(item);
          });
          productLinkResults.appendChild(fragment);
        };

        const openProductLinkModal = (item) => {
          if (!productLinkModal) {
            notify('Seleção de produto indisponível no momento.', 'error');
            return;
          }
          if (!item) {
            notify('Item da nota fiscal não encontrado para vinculação.', 'error');
            return;
          }

          const supplierInfo = resolveActiveSupplierInfo(lastNfeData);
          if (!supplierInfo.name) {
            notify('Selecione o fornecedor da nota antes de vincular um produto.', 'warning');
            return;
          }

          const supplierCode = canonicalSupplierProductCode(item?.supplierCode);
          if (!supplierCode) {
            notify('O item do fornecedor não possui código para realizar o vínculo.', 'error');
            return;
          }

          resetProductLinkModal();
          productLinkPreviousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
          productLinkActiveItem = item;

          if (productLinkItemLabel) {
            productLinkItemLabel.textContent = item?.description || item?.matchedProduct?.nome || 'Item sem descrição';
          }
          if (productLinkCodeLabel) {
            productLinkCodeLabel.textContent = item?.supplierCode || '—';
          }
          if (productLinkSupplierLabel) {
            productLinkSupplierLabel.textContent = supplierInfo.name || '—';
          }

          if (productLinkSearchInput) {
            const defaultTerm = item?.supplierCode || item?.description || '';
            productLinkSearchInput.value = defaultTerm;
          }

          productLinkModal.classList.remove('hidden');
          productLinkModal.setAttribute('data-modal-open', 'true');
          document.body.classList.add('overflow-hidden');

          showProductLinkEmpty('Informe ao menos três caracteres para localizar um produto cadastrado.');
          setProductLinkLoading(false);
          setProductLinkInteractivity(true);

          requestAnimationFrame(() => {
            if (productLinkSearchInput) {
              productLinkSearchInput.focus();
              if (productLinkSearchInput.value && productLinkSearchInput.value.trim().length >= 3) {
                handleProductLinkSearch(productLinkSearchInput.value.trim());
              }
            }
          });
        };

        const handleProductLinkSearch = async (rawTerm) => {
          if (!productLinkModal || productLinkModal.classList.contains('hidden')) return;
          const term = String(rawTerm ?? '').trim();
          if (!term || term.length < 3) {
            if (productLinkResults) {
              productLinkResults.innerHTML = '';
            }
            showProductLinkEmpty('Informe ao menos três caracteres para localizar um produto cadastrado.');
            return;
          }

          if (productLinkSearchAbortController) {
            productLinkSearchAbortController.abort();
          }

          const abortController = new AbortController();
          productLinkSearchAbortController = abortController;

          setProductLinkLoading(true, 'Buscando produtos cadastrados...');
          hideProductLinkMessages();
          if (productLinkResults) {
            productLinkResults.innerHTML = '';
          }

          try {
            const response = await fetch(
              `${apiBaseUrl}/products?search=${encodeURIComponent(term)}&limit=10`,
              { headers: buildAuthHeaders(), signal: abortController.signal }
            );
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
              if (response.status === 401) {
                handleAuthError();
              }
              throw new Error(payload?.message || `Falha ao consultar produtos (status ${response.status}).`);
            }
            const products = Array.isArray(payload?.products)
              ? payload.products
              : Array.isArray(payload)
              ? payload
              : [];
            renderProductLinkResults(products);
          } catch (error) {
            if (error?.name === 'AbortError') {
              return;
            }
            console.error('Erro ao buscar produtos cadastrados para vínculo manual:', error);
            showProductLinkError('Não foi possível buscar os produtos cadastrados. Tente novamente.');
          } finally {
            if (productLinkSearchAbortController === abortController) {
              productLinkSearchAbortController = null;
            }
            setProductLinkLoading(false);
            setProductLinkInteractivity(true);
          }
        };

        const handleProductLinkSelection = async (product) => {
          if (!productLinkActiveItem) {
            notify('Nenhum item selecionado para vinculação.', 'error');
            return;
          }
          if (!product) {
            notify('Produto selecionado inválido.', 'error');
            return;
          }

          if (productLinkIsLinking) {
            return;
          }

          const supplierCode = canonicalSupplierProductCode(productLinkActiveItem?.supplierCode);
          if (!supplierCode) {
            notify('O item do fornecedor não possui código para realizar o vínculo.', 'error');
            return;
          }

          const productId = getProductIdFromRecord(product);
          if (!productId) {
            notify('Produto selecionado não possui identificador válido para vínculo.', 'error');
            return;
          }

          const supplierInfo = resolveActiveSupplierInfo(lastNfeData);
          if (!supplierInfo.name) {
            notify('Selecione o fornecedor da nota antes de vincular um produto.', 'warning');
            return;
          }

          productLinkIsLinking = true;
          setProductLinkLoading(true, 'Vinculando produto selecionado...');
          setProductLinkInteractivity(false);

          try {
            const linkPromise = ensureProductSupplierLink(product, productLinkActiveItem, lastNfeData);
            if (linkPromise && typeof linkPromise.then === 'function') {
              await linkPromise;
            }

            productLinkActiveItem.manualConversionOverride = false;
            productLinkActiveItem.matchedProduct = product;
            productLinkActiveItem.validationStatus = 'matched';
            applySupplierConversionFromProduct(productLinkActiveItem, product, lastNfeData);
            productLinkActiveItem.internalCode = normalizeInternalCode(
              getProductCodeFromRecord(product)
            );
            ensureUniqueInternalCodes(productTableOriginalItems);
            updateProductTableDisplay();
            notify('Produto vinculado ao fornecedor com sucesso.', 'success');
            closeProductLinkModal();
          } catch (error) {
            console.error('Erro ao vincular produto selecionado ao fornecedor:', error);
            notify(
              error?.message || 'Não foi possível vincular o produto selecionado ao fornecedor.',
              'error'
            );
            setProductLinkInteractivity(true);
          } finally {
            productLinkIsLinking = false;
            setProductLinkLoading(false);
          }
        };

        if (productIframe) {
          productIframe.addEventListener('load', () => {
            if (productIframeLoading) {
              productIframeLoading.classList.add('hidden');
            }
            productIframe.classList.remove('hidden');
            syncProductModalHeight();
          });
        }

        productIframeCloseTriggers.forEach((trigger) => {
          trigger.addEventListener('click', (event) => {
            event.preventDefault();
            closeProductIframeModal();
          });
        });

        if (productIframeModal) {
          productIframeModal.addEventListener('click', (event) => {
            const target = event.target;
            if (target instanceof Element && target.hasAttribute('data-close-product-modal')) {
              event.preventDefault();
              closeProductIframeModal();
            }
          });
        }

        const handleProductIframeKeydown = (event) => {
          if (!productIframeModal || productIframeModal.classList.contains('hidden')) return;
          if (event.key === 'Escape') {
            event.preventDefault();
            closeProductIframeModal();
            return;
          }
          if (event.key !== 'Tab') return;
          const focusableElements = Array.from(
            productIframeModal.querySelectorAll(MODAL_FOCUSABLE_SELECTORS)
          ).filter((element) => element instanceof HTMLElement && element.offsetParent !== null);
          if (!focusableElements.length) return;
          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];
          if (event.shiftKey && document.activeElement === firstElement) {
            event.preventDefault();
            lastElement.focus();
          } else if (!event.shiftKey && document.activeElement === lastElement) {
            event.preventDefault();
            firstElement.focus();
          }
        };

        document.addEventListener('keydown', handleProductIframeKeydown);

        productLinkCloseTriggers.forEach((trigger) => {
          trigger.addEventListener('click', (event) => {
            event.preventDefault();
            closeProductLinkModal();
          });
        });

        if (productLinkModal) {
          productLinkModal.addEventListener('click', (event) => {
            const target = event.target;
            if (target instanceof Element && target.hasAttribute('data-close-product-link-modal')) {
              event.preventDefault();
              closeProductLinkModal();
            }
          });
        }

        if (productLinkCard) {
          productLinkCard.addEventListener('click', (event) => {
            event.stopPropagation();
          });
        }

        if (productLinkForm) {
          productLinkForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const term = productLinkSearchInput ? productLinkSearchInput.value : '';
            handleProductLinkSearch(term);
          });
        }

        if (productLinkSearchInput) {
          productLinkSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              handleProductLinkSearch(productLinkSearchInput.value);
            }
          });
        }

        const handleProductLinkKeydown = (event) => {
          if (!isProductLinkModalOpen()) return;
          if (event.key === 'Escape') {
            event.preventDefault();
            closeProductLinkModal();
            return;
          }
          if (event.key !== 'Tab') return;
          if (!productLinkModal) return;
          const focusableElements = Array.from(
            productLinkModal.querySelectorAll(MODAL_FOCUSABLE_SELECTORS)
          ).filter((element) => element instanceof HTMLElement && element.offsetParent !== null);
          if (!focusableElements.length) return;
          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];
          if (event.shiftKey && document.activeElement === firstElement) {
            event.preventDefault();
            lastElement.focus();
          } else if (!event.shiftKey && document.activeElement === lastElement) {
            event.preventDefault();
            firstElement.focus();
          }
        };

        document.addEventListener('keydown', handleProductLinkKeydown);

        const getProductStatusLabel = (item) => {
          if (!item) return '';
          if (item.validationStatus === 'matched' && item.matchedProduct) return 'Cadastrado';
          if (item.validationStatus === 'pending' || item.validationStatus === 'checking') return 'Validando';
          if (item.validationStatus === 'error') return 'Erro';
          if (item.validationStatus === 'no-barcode') return 'Sem GTIN';
          if (!Array.isArray(item.barcodeCandidates) || item.barcodeCandidates.length === 0) return 'Sem GTIN';
          return 'Cadastrar';
        };

        const createStatusBadge = (classes, iconClass, text) => {
          const badge = document.createElement('span');
          badge.classList.add(
            'inline-flex',
            'items-center',
            'gap-1',
            'rounded-full',
            'border',
            'px-1.5',
            'py-0.5',
            'text-[9px]',
            'font-semibold',
            'whitespace-nowrap'
          );
          classes.forEach((cls) => badge.classList.add(cls));
          const icon = document.createElement('i');
          icon.className = `${iconClass} text-[10px]`;
          badge.appendChild(icon);
          const label = document.createElement('span');
          label.textContent = text;
          badge.appendChild(label);
          return badge;
        };

        const createProductActionButton = (label, iconClass = 'fas fa-plus') => {
          const button = document.createElement('button');
          button.type = 'button';
          button.classList.add(
            'inline-flex',
            'items-center',
            'gap-1',
            'rounded-full',
            'border',
            'border-primary/40',
            'bg-primary/10',
            'px-1.5',
            'py-0.5',
            'text-[9px]',
            'font-semibold',
            'text-primary',
            'hover:bg-primary/20',
            'focus:outline-none',
            'focus:ring-2',
            'focus:ring-primary/30',
            'whitespace-nowrap'
          );
          const icon = document.createElement('i');
          icon.className = iconClass;
          const labelSpan = document.createElement('span');
          labelSpan.textContent = label;
          button.append(icon, labelSpan);
          return button;
        };

        const buildStatusCell = (item) => {
          const cell = document.createElement('td');
          cell.className = 'px-2 py-1.5 bg-white sticky left-0 z-10 whitespace-nowrap';
          cell.dataset.validationStatus = item?.validationStatus || '';

          if (item?.validationStatus === 'matched' && item.matchedProduct) {
            cell.appendChild(
              createStatusBadge(
                ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700'],
                'fas fa-check',
                'Cadastrado'
              )
            );
            return cell;
          }

          if (item?.validationStatus === 'pending' || item?.validationStatus === 'checking') {
            cell.appendChild(
              createStatusBadge(
                ['border-sky-200', 'bg-sky-50', 'text-sky-700'],
                'fas fa-spinner fa-spin',
                'Validando'
              )
            );
            return cell;
          }

          if (item?.validationStatus === 'error') {
            cell.appendChild(
              createStatusBadge(
                ['border-rose-200', 'bg-rose-50', 'text-rose-700'],
                'fas fa-circle-exclamation',
                'Erro'
              )
            );
            return cell;
          }

          if (!Array.isArray(item?.barcodeCandidates) || item.barcodeCandidates.length === 0) {
            cell.appendChild(
              createStatusBadge(
                ['border-amber-200', 'bg-amber-50', 'text-amber-700'],
                'fas fa-barcode',
                'Sem GTIN'
              )
            );
            return cell;
          }

          const button = createProductActionButton('Cadastrar', 'fas fa-plus');
          button.dataset.productBarcode = item?.barcodeCandidates?.[0] || '';
          button.addEventListener('click', () => openProductRegistration(item));
          cell.appendChild(button);
          return cell;
        };

        const getProductIdFromRecord = (product) => {
          if (!product || typeof product !== 'object') return '';
          const candidateKeys = ['_id', 'id', 'uuid'];
          for (const key of candidateKeys) {
            const value = typeof product[key] === 'string' ? product[key].trim() : '';
            if (value) {
              return value;
            }
          }
          return '';
        };

        const ensureConversionDefaults = (item) => {
          if (!item) return;
          const toNumeric = (value) => (Number.isFinite(value) ? value : parseNumber(value));

          const multiplierFromData = toNumeric(item.conversionMultiplier);
          const dividerFromData = toNumeric(item.conversionDivider);
          const quantityFromData = toNumeric(item.quantity);
          const qTribFromData = toNumeric(item.qTrib);

          if (!Object.prototype.hasOwnProperty.call(item, 'originalConversionMultiplier') && Number.isFinite(multiplierFromData)) {
            item.originalConversionMultiplier = multiplierFromData;
          }

          if (
            !Object.prototype.hasOwnProperty.call(item, 'originalConversionDivider') &&
            Number.isFinite(dividerFromData) &&
            dividerFromData > 0
          ) {
            item.originalConversionDivider = dividerFromData;
          }

          const numerator = Number.isFinite(multiplierFromData)
            ? multiplierFromData
            : Number.isFinite(quantityFromData)
            ? quantityFromData
            : null;
          const denominator = Number.isFinite(dividerFromData) && dividerFromData > 0
            ? dividerFromData
            : Number.isFinite(qTribFromData) && qTribFromData > 0
            ? qTribFromData
            : 1;

          const conversionFactor = Number.isFinite(numerator) && Number.isFinite(denominator) && denominator > 0
            ? numerator / denominator
            : null;

          if (!Object.prototype.hasOwnProperty.call(item, 'originalConversionFactor') && Number.isFinite(conversionFactor)) {
            item.originalConversionFactor = conversionFactor;
          }

          if (Number.isFinite(conversionFactor)) {
            item.conversion = conversionFactor;
            item.conversionMultiplier = conversionFactor;
            item.conversionDivider = 1;
          } else {
            item.conversion = null;
            if (!Number.isFinite(item.conversionMultiplier)) {
              item.conversionMultiplier = Number.isFinite(quantityFromData) ? quantityFromData : 1;
            }
            if (!Number.isFinite(item.conversionDivider) || item.conversionDivider <= 0) {
              item.conversionDivider = Number.isFinite(qTribFromData) && qTribFromData > 0 ? qTribFromData : 1;
            }
          }
        };

        const updateItemConversion = (item, factor) => {
          if (!item) return;
          if (Number.isFinite(factor)) {
            item.conversion = factor;
            item.conversionMultiplier = factor;
            item.conversionDivider = 1;
          } else {
            item.conversion = null;
          }
        };

        const formatConversionInputValue = (value) => {
          if (!Number.isFinite(value)) return '';
          return formatDecimal(value, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        };

        const buildConversionCell = (item) => {
          ensureConversionDefaults(item);
          const toNumeric = (value) => (Number.isFinite(value) ? value : parseNumber(value));
          const cell = document.createElement('td');
          cell.className = 'px-2 py-1.5 text-gray-600 whitespace-nowrap align-top';

          const wrapper = document.createElement('div');
          wrapper.className = 'flex flex-col gap-1.5';

          const supplierEntry =
            item?.matchedProduct && lastNfeData
              ? findSupplierEntryForProduct(item.matchedProduct, item, lastNfeData)
              : null;
          const supplierCalcType = canonicalSupplierCalcType(supplierEntry?.tipoCalculo);
          const supplierCalcValue = parseSupplierCalcValue(supplierEntry?.valorCalculo);
          let supplierBaseFactor = null;
          let supplierFactor = null;
          if (supplierEntry && supplierCalcType && supplierCalcValue !== null) {
            supplierBaseFactor = getBaseConversionFactor(item);
            if (!Number.isFinite(supplierBaseFactor) || supplierBaseFactor <= 0) {
              supplierBaseFactor = 1;
            }
            const computedFactor =
              supplierCalcType === 'divide'
                ? supplierBaseFactor / supplierCalcValue
                : supplierBaseFactor * supplierCalcValue;
            if (Number.isFinite(computedFactor) && computedFactor > 0) {
              supplierFactor = computedFactor;
            }
          }

          const factorText = document.createElement('span');
          factorText.className = 'text-[9px] text-right font-medium text-gray-500';
          const updateFactorText = () => {
            const factor = toNumeric(item?.conversion);
            if (Number.isFinite(factor)) {
              let suffix = '';
              if (item?.supplierAppliedConversion && !item?.manualConversionOverride) {
                const appliedType = item.supplierAppliedConversion.type;
                const appliedValue = item.supplierAppliedConversion.value;
                if (appliedType && Number.isFinite(appliedValue)) {
                  const symbol = appliedType === 'divide' ? '÷' : '×';
                  const formattedAppliedValue = formatConversionInputValue(appliedValue) || appliedValue;
                  suffix = ` (Fornecedor ${symbol} ${formattedAppliedValue})`;
                }
              }
              factorText.textContent = `Fator: ${formatDecimal(factor, {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3,
              })}${suffix}`;
            } else {
              factorText.textContent = 'Fator: —';
            }
          };

          const handleTableRefresh = () => {
            const hasActiveFilters = Object.values(productTableState?.filters || {}).some(
              (value) => normalizeFilterText(value).length > 0
            );
            if (hasActiveFilters || productTableState?.sortKey) {
              requestAnimationFrame(() => updateProductTableDisplay());
            }
          };

          const commitConversionChange = (factor) => {
            const fromSupplierCalculation =
              Number.isFinite(supplierFactor) &&
              Number.isFinite(factor) &&
              Math.abs(supplierFactor - factor) <= 0.0005;

            if (fromSupplierCalculation && supplierEntry && supplierCalcType && supplierCalcValue !== null) {
              item.manualConversionOverride = false;
              item.supplierAppliedConversion = {
                type: supplierCalcType,
                value: supplierCalcValue,
                factor,
                supplierCode: canonicalSupplierProductCode(supplierEntry?.codigoProduto),
                supplierName: supplierEntry?.fornecedor || '',
                baseFactor: supplierBaseFactor ?? getBaseConversionFactor(item),
              };
            } else {
              item.manualConversionOverride = true;
              item.supplierAppliedConversion = null;
            }
            updateItemConversion(item, factor);
            updateFactorText();
            handleTableRefresh();
          };

          const createNumericEditor = (labelText, { initialValue, allowZero = false, step = 1, quickActions = [], onCommit }) => {
            let currentValue = Number.isFinite(initialValue) ? initialValue : null;
            const MIN_POSITIVE = 0.001;
            const container = document.createElement('div');
            container.className = 'flex flex-col items-end gap-1';

            const label = document.createElement('span');
            label.className = 'text-[9px] font-semibold uppercase tracking-wide text-gray-500';
            label.textContent = labelText;
            container.appendChild(label);

            const controlsRow = document.createElement('div');
            controlsRow.className = 'flex items-center gap-1';

            const input = document.createElement('input');
            input.type = 'text';
            input.inputMode = 'decimal';
            input.placeholder = '0,000';
            input.className =
              'w-20 rounded border border-gray-200 bg-white px-2 py-1 text-[11px] text-right font-semibold text-gray-700 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary/30';

            const formatValue = (value) => (Number.isFinite(value) ? formatConversionInputValue(value) : '');
            const normalizeValue = (value) => {
              const numeric = Number.isFinite(value) ? value : parseNumber(value);
              if (!Number.isFinite(numeric)) return null;
              const minValue = allowZero ? 0 : MIN_POSITIVE;
              const sanitized = numeric < minValue ? minValue : numeric;
              return Number.parseFloat(sanitized.toFixed(3));
            };

            const updateInputValue = () => {
              input.value = formatValue(currentValue);
            };

            if (Number.isFinite(currentValue)) {
              updateInputValue();
            }

            input.addEventListener('focus', () => {
              setTimeout(() => input.select(), 0);
            });

            const commitValue = (value) => {
              const normalized = normalizeValue(value);
              if (normalized === null) {
                updateInputValue();
                return;
              }
              currentValue = normalized;
              updateInputValue();
              if (typeof onCommit === 'function') {
                onCommit(normalized);
              }
            };

            const computeStep = (event) => {
              let computed = Number.isFinite(step) && step > 0 ? step : 1;
              if (event?.shiftKey) {
                computed *= 10;
              }
              if (event?.altKey) {
                computed /= 10;
              }
              if (event?.ctrlKey || event?.metaKey) {
                computed /= 100;
              }
              return computed;
            };

            const applyStep = (direction, event) => {
              const baseValue = (() => {
                const inputValue = parseNumber(input.value);
                if (Number.isFinite(inputValue)) return inputValue;
                if (Number.isFinite(currentValue)) return currentValue;
                return allowZero ? 0 : step || 1;
              })();
              const nextValue = baseValue + direction * computeStep(event);
              commitValue(nextValue);
            };

            const createStepButton = (symbol, direction) => {
              const button = document.createElement('button');
              button.type = 'button';
              button.className =
                'h-6 w-6 flex items-center justify-center rounded border border-gray-200 bg-white text-[11px] font-semibold text-gray-500 hover:bg-primary/10 hover:text-primary focus:outline-none focus:ring-1 focus:ring-primary/30';
              button.textContent = symbol;
              button.title =
                direction > 0
                  ? 'Aumentar valor (Shift=×10, Alt=÷10, Ctrl=÷100)'
                  : 'Reduzir valor (Shift=×10, Alt=÷10, Ctrl=÷100)';
              button.addEventListener('click', (event) => {
                event.preventDefault();
                applyStep(direction, event);
              });
              return button;
            };

            const decrementButton = createStepButton('−', -1);
            const incrementButton = createStepButton('+', 1);
            controlsRow.append(decrementButton, input, incrementButton);
            container.appendChild(controlsRow);

            input.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                commitValue(input.value);
                input.blur();
                return;
              }
              if (event.key === 'Escape') {
                event.preventDefault();
                updateInputValue();
                input.blur();
                return;
              }
              if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                applyStep(event.key === 'ArrowUp' ? 1 : -1, event);
              }
            });

            input.addEventListener('blur', () => commitValue(input.value));

            if (quickActions.length > 0) {
              const quickRow = document.createElement('div');
              quickRow.className = 'flex flex-wrap items-center justify-end gap-1';
              quickActions.forEach((action) => {
                const quickButton = document.createElement('button');
                quickButton.type = 'button';
                quickButton.className =
                  'rounded border border-gray-200 bg-gray-50 px-1.5 py-0.5 text-[9px] font-medium text-gray-600 hover:border-primary hover:text-primary focus:outline-none focus:ring-1 focus:ring-primary/30';
                quickButton.textContent = action.label;
                if (action.title) {
                  quickButton.title = action.title;
                }
                quickButton.addEventListener('click', (event) => {
                  event.preventDefault();
                  const actionValue = typeof action.getValue === 'function' ? action.getValue() : action.value;
                  commitValue(actionValue);
                });
                quickRow.appendChild(quickButton);
              });
              container.appendChild(quickRow);
            }

            return container;
          };

          const xmlMultiplier = toNumeric(item?.originalConversionMultiplier);
          const xmlDivider = toNumeric(item?.originalConversionDivider);
          const xmlFactor = (() => {
            const storedFactor = toNumeric(item?.originalConversionFactor);
            if (Number.isFinite(storedFactor)) {
              return storedFactor;
            }
            if (Number.isFinite(xmlMultiplier) && Number.isFinite(xmlDivider) && xmlDivider > 0) {
              return xmlMultiplier / xmlDivider;
            }
            return null;
          })();

          let conversionInitial = toNumeric(item?.conversion);
          if (!Number.isFinite(conversionInitial)) {
            conversionInitial = 1;
          }
          const quickActions = [];
          if (Number.isFinite(xmlFactor)) {
            quickActions.push({ label: 'XML', value: Number.parseFloat(xmlFactor.toFixed(3)), title: 'Valor informado no XML' });
          }
          if (Number.isFinite(supplierFactor)) {
            const supplierValueLabel = formatConversionInputValue(supplierCalcValue) || supplierCalcValue;
            const supplierTitle = supplierCalcType === 'divide'
              ? `Aplicar cálculo do fornecedor (÷ ${supplierValueLabel})`
              : `Aplicar cálculo do fornecedor (× ${supplierValueLabel})`;
            quickActions.push({
              label: 'Fornecedor',
              value: Number.parseFloat(supplierFactor.toFixed(3)),
              title: supplierTitle,
            });
          }
          quickActions.push({ label: '0', value: 0, title: 'Definir como divisão (0)' });
          quickActions.push({ label: formatDecimal(0.5, { minimumFractionDigits: 1, maximumFractionDigits: 1 }), value: 0.5 });
          quickActions.push({ label: '1', value: 1, title: 'Fator 1 (sem conversão)' });
          quickActions.push({ label: '2', value: 2 });
          quickActions.push({ label: '3', value: 3 });

          const conversionEditor = createNumericEditor('Fator', {
            initialValue: conversionInitial,
            allowZero: true,
            step: 0.5,
            quickActions,
            onCommit: (value) => {
              commitConversionChange(value);
            },
          });

          wrapper.append(conversionEditor, factorText);
          updateFactorText();

          cell.appendChild(wrapper);
          return cell;
        };

        const buildUnitarizeCell = () => {
          const cell = document.createElement('td');
          cell.className = 'px-2 py-1.5 whitespace-nowrap';
          const label = document.createElement('label');
          label.className = 'inline-flex items-center gap-2 text-[9px] text-gray-600 whitespace-nowrap';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'h-3 w-3 rounded border-gray-300 text-primary focus:ring-primary/40';
          const text = document.createElement('span');
          text.textContent = 'Unitário';
          label.append(checkbox, text);
          cell.appendChild(label);
          return cell;
        };

        const buildSelectCell = (item) => {
          const cell = document.createElement('td');
          cell.className = 'px-2 py-1.5 whitespace-nowrap';
          const button = createProductActionButton('Selecionar', 'fas fa-pen-to-square');
          const productId = getProductIdFromRecord(item?.matchedProduct);
          const canOpenExistingProduct = item?.validationStatus === 'matched' && Boolean(productId);
          const isValidationInProgress =
            item?.validationStatus === 'pending' || item?.validationStatus === 'checking';

          if (canOpenExistingProduct) {
            button.title = 'Abrir o produto cadastrado para visualizar ou editar';
            button.addEventListener('click', () => openExistingProduct(item));
          } else if (!isValidationInProgress) {
            button.title = 'Selecionar um produto cadastrado para vincular a este item';
            button.addEventListener('click', () => openProductLinkModal(item));
          } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
            button.setAttribute('aria-disabled', 'true');
            button.title =
              'Disponível após localizar o produto cadastrado pelo XML importado';
          }

          cell.appendChild(button);
          return cell;
        };

        const buildNumericFilterValue = (displayText, rawValue) => {
          const numericValue = Number.isFinite(rawValue) ? rawValue : parseNumber(rawValue);
          if (!Number.isFinite(numericValue)) {
            return displayText || '';
          }
          const plain = String(numericValue).replace('.', ',');
          const digits = plain.replace(/\D+/g, '');
          return [displayText || '', plain, digits].filter(Boolean).join(' ');
        };

        const PRODUCT_TABLE_COLUMNS = [
          {
            key: 'status',
            label: 'Cadastrar',
            headerClass: 'sticky left-0 z-20 bg-gray-50 px-2 py-1.5 text-left shadow-sm',
            renderCell: (item) => buildStatusCell(item),
            getDisplayText: (item) => getProductStatusLabel(item),
            getFilterValue: (item) => getProductStatusLabel(item),
            getSortValue: (item) => getProductStatusLabel(item),
          },
          {
            key: 'unitarize',
            label: 'Unitarizar',
            headerClass: 'px-2 py-1.5 text-left',
            renderCell: () => buildUnitarizeCell(),
            getDisplayText: () => 'Unitário',
          },
          {
            key: 'select',
            label: 'Selecionar',
            headerClass: 'px-2 py-1.5 text-left',
            renderCell: (item) => buildSelectCell(item),
            getDisplayText: () => 'Selecionado',
          },
          {
            key: 'internalCode',
            label: 'Cod. Interno (SKU)',
            headerClass: 'px-2 py-1.5 text-left',
            cellClass: 'px-2 py-1.5 font-semibold text-gray-700 whitespace-nowrap',
            getDisplayText: (item) => normalizeInternalCode(item?.internalCode) || '—',
          },
          {
            key: 'systemName',
            label: 'Nome',
            headerClass: 'px-2 py-1.5 text-left',
            cellClass: 'px-2 py-1.5 text-gray-700 whitespace-nowrap',
            getDisplayText: (item) => item?.matchedProduct?.nome || item?.description || '—',
          },
          {
            key: 'supplierCode',
            label: 'Cod_Fornecedor',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.supplierCode || '—',
          },
          {
            key: 'barcode',
            label: 'Cod_Barras',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.barcodeDisplay || 'SEM GTIN',
          },
          {
            key: 'supplierName',
            label: 'Nome no Fornecedor',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.description || '—',
          },
          {
            key: 'conversion',
            label: 'Multiplicador/Divisão',
            headerClass: 'px-2 py-1.5 text-left',
            isNumeric: true,
            sortType: 'numeric',
            renderCell: (item) => buildConversionCell(item),
            getDisplayText: (item) =>
              formatDecimal(item?.conversion, { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
            getFilterValue: (item) =>
              buildNumericFilterValue(
                formatDecimal(item?.conversion, { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
                item?.conversion
              ),
            getSortValue: (item) =>
              Number.isFinite(item?.conversion) ? item.conversion : parseNumber(item?.conversion) || 0,
          },
          {
            key: 'unit',
            label: 'Unidade',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.unit || '—',
          },
          {
            key: 'quantity',
            label: 'Quantidade',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatQuantity(item?.quantity),
            getFilterValue: (item) => buildNumericFilterValue(formatQuantity(item?.quantity), item?.quantity),
            getSortValue: (item) => (Number.isFinite(item?.quantity) ? item.quantity : parseNumber(item?.quantity) || 0),
          },
          {
            key: 'unitPrice',
            label: 'Unitário (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-700 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.unitPrice),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.unitPrice), item?.unitPrice),
            getSortValue: (item) =>
              Number.isFinite(item?.unitPrice) ? item.unitPrice : parseNumber(item?.unitPrice) || 0,
          },
          {
            key: 'discount',
            label: 'Desconto (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-700 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.discount),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.discount), item?.discount),
            getSortValue: (item) => (Number.isFinite(item?.discount) ? item.discount : parseNumber(item?.discount) || 0),
          },
          {
            key: 'total',
            label: 'Total',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-700 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.total),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.total), item?.total),
            getSortValue: (item) => (Number.isFinite(item?.total) ? item.total : parseNumber(item?.total) || 0),
          },
          {
            key: 'ncm',
            label: 'NCM',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.ncm || '—',
          },
          {
            key: 'cfop',
            label: 'CFOP',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.cfop || '—',
          },
          {
            key: 'cst',
            label: 'CST',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.cst || '—',
          },
          {
            key: 'icmsRate',
            label: 'ICMS (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.icmsRate),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.icmsRate), item?.icmsRate),
            getSortValue: (item) => (Number.isFinite(item?.icmsRate) ? item.icmsRate : parseNumber(item?.icmsRate) || 0),
          },
          {
            key: 'icmsBase',
            label: 'Base ICMS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.icmsBase),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.icmsBase), item?.icmsBase),
            getSortValue: (item) => (Number.isFinite(item?.icmsBase) ? item.icmsBase : parseNumber(item?.icmsBase) || 0),
          },
          {
            key: 'icmsValue',
            label: 'Valor ICMS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.icmsValue),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.icmsValue), item?.icmsValue),
            getSortValue: (item) => (Number.isFinite(item?.icmsValue) ? item.icmsValue : parseNumber(item?.icmsValue) || 0),
          },
          {
            key: 'iva',
            label: 'IVA (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.iva),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.iva), item?.iva),
            getSortValue: (item) => (Number.isFinite(item?.iva) ? item.iva : parseNumber(item?.iva) || 0),
          },
          {
            key: 'icmsStRate',
            label: 'ICMS ST (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.icmsStRate),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.icmsStRate), item?.icmsStRate),
            getSortValue: (item) =>
              Number.isFinite(item?.icmsStRate) ? item.icmsStRate : parseNumber(item?.icmsStRate) || 0,
          },
          {
            key: 'icmsStValue',
            label: 'Valor ICMS ST (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.icmsStValue),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.icmsStValue), item?.icmsStValue),
            getSortValue: (item) =>
              Number.isFinite(item?.icmsStValue) ? item.icmsStValue : parseNumber(item?.icmsStValue) || 0,
          },
          {
            key: 'ipiRate',
            label: 'IPI (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.ipiRate),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.ipiRate), item?.ipiRate),
            getSortValue: (item) => (Number.isFinite(item?.ipiRate) ? item.ipiRate : parseNumber(item?.ipiRate) || 0),
          },
          {
            key: 'ipiBase',
            label: 'Base IPI (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.ipiBase),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.ipiBase), item?.ipiBase),
            getSortValue: (item) => (Number.isFinite(item?.ipiBase) ? item.ipiBase : parseNumber(item?.ipiBase) || 0),
          },
          {
            key: 'ipiValue',
            label: 'Valor IPI (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.ipiValue),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.ipiValue), item?.ipiValue),
            getSortValue: (item) => (Number.isFinite(item?.ipiValue) ? item.ipiValue : parseNumber(item?.ipiValue) || 0),
          },
          {
            key: 'ipiCst',
            label: 'ST IPI',
            headerClass: 'px-2 py-1.5 text-left',
            getDisplayText: (item) => item?.ipiCst || '—',
          },
          {
            key: 'pisRate',
            label: 'Alíquota PIS (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.pisRate),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.pisRate), item?.pisRate),
            getSortValue: (item) => (Number.isFinite(item?.pisRate) ? item.pisRate : parseNumber(item?.pisRate) || 0),
          },
          {
            key: 'pisBase',
            label: 'Base PIS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.pisBase),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.pisBase), item?.pisBase),
            getSortValue: (item) => (Number.isFinite(item?.pisBase) ? item.pisBase : parseNumber(item?.pisBase) || 0),
          },
          {
            key: 'pisValue',
            label: 'Valor PIS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.pisValue),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.pisValue), item?.pisValue),
            getSortValue: (item) => (Number.isFinite(item?.pisValue) ? item.pisValue : parseNumber(item?.pisValue) || 0),
          },
          {
            key: 'cofinsRate',
            label: 'ST CONFINS (%)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatPercentValue(item?.cofinsRate),
            getFilterValue: (item) => buildNumericFilterValue(formatPercentValue(item?.cofinsRate), item?.cofinsRate),
            getSortValue: (item) =>
              Number.isFinite(item?.cofinsRate) ? item.cofinsRate : parseNumber(item?.cofinsRate) || 0,
          },
          {
            key: 'cofinsBase',
            label: 'Base CONFINS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.cofinsBase),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.cofinsBase), item?.cofinsBase),
            getSortValue: (item) =>
              Number.isFinite(item?.cofinsBase) ? item.cofinsBase : parseNumber(item?.cofinsBase) || 0,
          },
          {
            key: 'cofinsValue',
            label: 'Valor CONFINS (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.cofinsValue),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.cofinsValue), item?.cofinsValue),
            getSortValue: (item) =>
              Number.isFinite(item?.cofinsValue) ? item.cofinsValue : parseNumber(item?.cofinsValue) || 0,
          },
          {
            key: 'freight',
            label: 'Frete (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.freight),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.freight), item?.freight),
            getSortValue: (item) => (Number.isFinite(item?.freight) ? item.freight : parseNumber(item?.freight) || 0),
          },
          {
            key: 'other',
            label: 'Valor Outros (R$)',
            headerClass: 'px-2 py-1.5 text-right',
            cellClass: 'px-2 py-1.5 text-right text-gray-600 whitespace-nowrap',
            isNumeric: true,
            sortType: 'numeric',
            getDisplayText: (item) => formatMoneyValue(item?.other),
            getFilterValue: (item) => buildNumericFilterValue(formatMoneyValue(item?.other), item?.other),
            getSortValue: (item) => (Number.isFinite(item?.other) ? item.other : parseNumber(item?.other) || 0),
          },
        ];

        const PRODUCT_TABLE_COLUMNS_MAP = new Map(PRODUCT_TABLE_COLUMNS.map((column) => [column.key, column]));
        const PRODUCT_TABLE_COLUMN_COUNT = PRODUCT_TABLE_COLUMNS.length;
        const productTableState = {
          filters: {},
          sortKey: null,
          sortDirection: 'asc',
        };
        const productTableFilterInputs = new Map();
        const productTableSortButtons = new Map();
        let productTableOriginalItems = [];
        let productTableHeaderInitialized = false;

        const normalizeFilterText = (value) =>
          String(value ?? '')
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/\s+/g, ' ')
            .trim()
            .toLowerCase();

        const createTextCell = (value, className = 'px-2 py-1.5 text-gray-600 whitespace-nowrap') => {
          const cell = document.createElement('td');
          cell.className = className;
          if (!cell.classList.contains('whitespace-nowrap')) {
            cell.classList.add('whitespace-nowrap');
          }
          cell.textContent = value && value !== '' ? value : '—';
          return cell;
        };

        const setSortButtonState = (button, isActive) => {
          if (!button) return;
          if (isActive) {
            button.classList.add('text-primary', 'border-primary/40', 'bg-primary/10');
            button.classList.remove('text-gray-400');
            button.setAttribute('aria-pressed', 'true');
          } else {
            button.classList.remove('text-primary', 'border-primary/40', 'bg-primary/10');
            button.classList.add('text-gray-400');
            button.setAttribute('aria-pressed', 'false');
          }
        };

        const updateProductTableSortIndicators = () => {
          productTableSortButtons.forEach(({ ascButton, descButton }, key) => {
            const isActive = productTableState.sortKey === key;
            setSortButtonState(ascButton, isActive && productTableState.sortDirection === 'asc');
            setSortButtonState(descButton, isActive && productTableState.sortDirection === 'desc');
          });
        };

        const toggleProductTableSort = (columnKey, direction) => {
          if (!columnKey) return;
          const isSameColumn = productTableState.sortKey === columnKey && productTableState.sortDirection === direction;
          if (isSameColumn) {
            productTableState.sortKey = null;
            productTableState.sortDirection = 'asc';
          } else {
            productTableState.sortKey = columnKey;
            productTableState.sortDirection = direction === 'desc' ? 'desc' : 'asc';
          }
          updateProductTableSortIndicators();
          updateProductTableDisplay();
        };

        const setProductTableFilter = (columnKey, value) => {
          if (!columnKey) return;
          productTableState.filters[columnKey] = value || '';
          updateProductTableDisplay();
        };

        const applyProductTableState = (items) => {
          if (!Array.isArray(items)) return [];
          const activeFilters = Object.entries(productTableState.filters || {}).filter(
            ([, raw]) => normalizeFilterText(raw).length > 0
          );

          let filteredItems = items;
          if (activeFilters.length) {
            filteredItems = items.filter((item) =>
              activeFilters.every(([key, raw]) => {
                const filterValue = normalizeFilterText(raw);
                if (!filterValue) return true;
                const column = PRODUCT_TABLE_COLUMNS_MAP.get(key);
                if (!column) return true;
                const columnValue =
                  (typeof column.getFilterValue === 'function'
                    ? column.getFilterValue(item)
                    : typeof column.getDisplayText === 'function'
                    ? column.getDisplayText(item)
                    : '') ?? '';
                const normalizedColumn = normalizeFilterText(columnValue);
                return normalizedColumn.includes(filterValue);
              })
            );
          } else {
            filteredItems = items.slice();
          }

          const { sortKey, sortDirection } = productTableState;
          if (!sortKey) {
            return filteredItems;
          }

          const column = PRODUCT_TABLE_COLUMNS_MAP.get(sortKey);
          if (!column) {
            return filteredItems;
          }

          const directionMultiplier = sortDirection === 'desc' ? -1 : 1;
          const sortedItems = filteredItems.slice().sort((a, b) => {
            const valueA =
              typeof column.getSortValue === 'function'
                ? column.getSortValue(a)
                : typeof column.getFilterValue === 'function'
                ? column.getFilterValue(a)
                : typeof column.getDisplayText === 'function'
                ? column.getDisplayText(a)
                : '';
            const valueB =
              typeof column.getSortValue === 'function'
                ? column.getSortValue(b)
                : typeof column.getFilterValue === 'function'
                ? column.getFilterValue(b)
                : typeof column.getDisplayText === 'function'
                ? column.getDisplayText(b)
                : '';

            if (column.sortType === 'numeric') {
              const numericA = Number.isFinite(valueA) ? valueA : parseNumber(valueA);
              const numericB = Number.isFinite(valueB) ? valueB : parseNumber(valueB);
              const safeA = Number.isFinite(numericA) ? numericA : Number.NEGATIVE_INFINITY;
              const safeB = Number.isFinite(numericB) ? numericB : Number.NEGATIVE_INFINITY;
              if (safeA === safeB) {
                const indexA = Number.isFinite(a?.index) ? a.index : 0;
                const indexB = Number.isFinite(b?.index) ? b.index : 0;
                return indexA - indexB;
              }
              return safeA > safeB ? directionMultiplier : -directionMultiplier;
            }

            const textA = String(valueA ?? '');
            const textB = String(valueB ?? '');
            const comparison = textA.localeCompare(textB, 'pt-BR', { sensitivity: 'base', numeric: true });
            if (comparison === 0) {
              const indexA = Number.isFinite(a?.index) ? a.index : 0;
              const indexB = Number.isFinite(b?.index) ? b.index : 0;
              return indexA - indexB;
            }
            return comparison * directionMultiplier;
          });

          return sortedItems;
        };

        const initializeProductTableHeader = () => {
          if (!importProductsTableHead || productTableHeaderInitialized) return;
          productTableHeaderInitialized = true;
          importProductsTableHead.innerHTML = '';
          const headerRow = document.createElement('tr');

          PRODUCT_TABLE_COLUMNS.forEach((column) => {
            const th = document.createElement('th');
            th.dataset.columnKey = column.key;
            const baseClasses = column.headerClass ? column.headerClass.split(/\s+/) : [];
            if (baseClasses.length) {
              th.classList.add(...baseClasses);
            }
            th.classList.add('align-top', 'bg-gray-50', 'whitespace-nowrap');

            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col gap-1';

            const labelRow = document.createElement('div');
            labelRow.className = 'flex items-center justify-between gap-1';
            if (column.isNumeric) {
              labelRow.classList.add('justify-end');
            }

            const label = document.createElement('span');
            label.textContent = column.label;
            label.className = 'text-[9px] font-semibold uppercase tracking-wide text-gray-600';
            if (column.isNumeric) {
              label.classList.add('text-right');
            }
            labelRow.appendChild(label);

            const sortGroup = document.createElement('div');
            sortGroup.className = 'flex flex-col';

            const createSortButton = (direction) => {
              const button = document.createElement('button');
              button.type = 'button';
              button.dataset.sortDirection = direction;
              button.classList.add(
                'flex',
                'h-4',
                'w-4',
                'items-center',
                'justify-center',
                'rounded',
                'border',
                'border-transparent',
                'text-gray-400',
                'transition',
                'hover:text-primary',
                'focus:outline-none',
                'focus:ring-1',
                'focus:ring-primary/40'
              );
              button.setAttribute(
                'aria-label',
                `Ordenar ${direction === 'asc' ? 'crescente' : 'decrescente'} pela coluna ${column.label}`
              );
              const icon = document.createElement('i');
              icon.className = direction === 'asc' ? 'fas fa-sort-up text-[10px]' : 'fas fa-sort-down text-[10px]';
              button.appendChild(icon);
              button.addEventListener('click', () => toggleProductTableSort(column.key, direction));
              return button;
            };

            const ascButton = createSortButton('asc');
            const descButton = createSortButton('desc');
            sortGroup.append(ascButton, descButton);
            labelRow.appendChild(sortGroup);

            const filterInput = document.createElement('input');
            filterInput.type = 'text';
            filterInput.placeholder = 'Filtrar';
            filterInput.value = productTableState.filters[column.key] || '';
            filterInput.classList.add(
              'rounded',
              'border',
              'border-gray-200',
              'bg-white',
              'px-1.5',
              'py-1',
              'text-[9px]',
              'font-medium',
              'text-gray-600',
              'placeholder:text-gray-400',
              'focus:border-primary',
              'focus:outline-none',
              'focus:ring-2',
              'focus:ring-primary/20'
            );
            if (column.isNumeric) {
              filterInput.classList.add('text-right');
            }
            filterInput.addEventListener('input', (event) => {
              setProductTableFilter(column.key, event.target.value || '');
            });

            wrapper.append(labelRow, filterInput);
            th.appendChild(wrapper);
            headerRow.appendChild(th);

            productTableFilterInputs.set(column.key, filterInput);
            productTableSortButtons.set(column.key, { ascButton, descButton });
          });

          importProductsTableHead.appendChild(headerRow);
          updateProductTableSortIndicators();
        };

        const updateProductTableDisplay = () => {
          if (!importProductsTableBody) return;

          importProductsTableBody.innerHTML = '';

          if (!Array.isArray(productTableOriginalItems) || !productTableOriginalItems.length) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = PRODUCT_TABLE_COLUMN_COUNT;
            emptyCell.className = 'px-3 py-6 text-center text-[10px] text-gray-500';
            emptyCell.textContent = 'Importe um XML autorizado para listar os itens da NF-e.';
            emptyRow.appendChild(emptyCell);
            importProductsTableBody.appendChild(emptyRow);
            updateProductValidationBadge([]);
            return;
          }

          const itemsToRender = applyProductTableState(productTableOriginalItems);

          if (!itemsToRender.length) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = PRODUCT_TABLE_COLUMN_COUNT;
            emptyCell.className = 'px-3 py-6 text-center text-[10px] text-gray-500';
            emptyCell.textContent = 'Nenhum item encontrado com os filtros aplicados.';
            emptyRow.appendChild(emptyCell);
            importProductsTableBody.appendChild(emptyRow);
            updateProductValidationBadge(productTableOriginalItems);
            return;
          }

          const fragment = document.createDocumentFragment();

          itemsToRender.forEach((item) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-primary/5';
            const rowIndex = Number.isFinite(item?.index) ? item.index : productTableOriginalItems.indexOf(item);
            row.dataset.itemIndex = String(rowIndex >= 0 ? rowIndex : 0);

            if (item?.validationStatus === 'not-found') {
              row.classList.add('bg-amber-50/60');
            } else if (item?.validationStatus === 'error') {
              row.classList.add('bg-rose-50/60');
            }

            PRODUCT_TABLE_COLUMNS.forEach((column) => {
              let cell = null;
              if (typeof column.renderCell === 'function') {
                cell = column.renderCell(item);
              } else {
                const value =
                  typeof column.getDisplayText === 'function' ? column.getDisplayText(item) : item?.[column.key] || '—';
                const className = column.cellClass || 'px-2 py-1.5 text-gray-600 whitespace-nowrap';
                cell = createTextCell(value, className);
              }
              if (!cell) return;
              if (!cell.classList.contains('whitespace-nowrap')) {
                cell.classList.add('whitespace-nowrap');
              }
              row.appendChild(cell);
            });

            fragment.appendChild(row);
          });

          importProductsTableBody.appendChild(fragment);
          updateProductValidationBadge(productTableOriginalItems);
        };

        const updateProductValidationBadge = (items) => {
          if (!importXmlValidationText) return;
          if (!Array.isArray(items) || !items.length) {
            importXmlValidationText.textContent = 'Importe o XML autorizado para validar os itens.';
            applyValidationStyles('info');
            return;
          }
          const hasError = items.some((item) => item.validationStatus === 'error');
          if (hasError) {
            importXmlValidationText.textContent = 'Falha ao validar produtos na base cadastrada.';
            applyValidationStyles('error');
            return;
          }
          const isPending = items.some((item) => item.validationStatus === 'pending' || item.validationStatus === 'checking');
          if (isPending) {
            importXmlValidationText.textContent = 'Validando produtos pelo fornecedor e código de barras...';
            applyValidationStyles('info');
            return;
          }
          const withBarcode = items.filter((item) => Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length);
          const withoutBarcodeCount = items.length - withBarcode.length;
          const notFoundCount = withBarcode.filter((item) => item.validationStatus === 'not-found').length;
          if (!withBarcode.length) {
            importXmlValidationText.textContent = 'XML sem GTIN: valide os produtos manualmente.';
            applyValidationStyles('info');
            return;
          }
          if (notFoundCount > 0) {
            const suffix = notFoundCount === 1 ? '' : 's';
            importXmlValidationText.textContent = `${notFoundCount} produto${suffix} sem cadastro pelo código de barras.`;
            applyValidationStyles('warning');
            return;
          }
          if (withoutBarcodeCount > 0) {
            const suffix = withoutBarcodeCount === 1 ? '' : 's';
            importXmlValidationText.textContent = `${withoutBarcodeCount} item${suffix} sem GTIN precisa${suffix ? 'm' : ''} de revisão.`;
            applyValidationStyles('warning');
            return;
          }
          importXmlValidationText.textContent = 'Todos os produtos foram localizados na base.';
          applyValidationStyles('success');
        };

        function renderImportedProducts(items = []) {
          if (!importProductsTableBody) return;
          if (!productTableHeaderInitialized) {
            initializeProductTableHeader();
          }

          productTableOriginalItems = Array.isArray(items) ? items : [];
          if (productTableOriginalItems.length) {
            ensureUniqueInternalCodes(productTableOriginalItems);
          }

          updateProductTableDisplay();
        }

        const buildSupplierLookupKey = (supplierInfo, supplierCode) => {
          const normalizedCode = canonicalSupplierProductCode(supplierCode);
          if (!normalizedCode) return '';
          const parts = [normalizedCode];
          if (supplierInfo) {
            const supplierNameKey = canonicalSupplierName(supplierInfo.name);
            if (supplierNameKey) {
              parts.push(`NAME:${supplierNameKey}`);
            }
            const supplierDocumentKey = digitsOnly(supplierInfo.document);
            if (supplierDocumentKey) {
              parts.push(`DOC:${supplierDocumentKey}`);
            }
          }
          return parts.join('::');
        };

        const findProductBySupplierReference = async (supplierInfo, supplierCode) => {
          const normalizedCanonicalCode = canonicalSupplierProductCode(supplierCode);
          if (!normalizedCanonicalCode) return null;

          const normalizedSupplierCode = normalizeSupplierProductCode(supplierCode);
          const cacheKey = buildSupplierLookupKey(supplierInfo, supplierCode);
          if (cacheKey && supplierReferenceLookupCache.has(cacheKey)) {
            return supplierReferenceLookupCache.get(cacheKey);
          }
          if (cacheKey && supplierReferenceLookupPromises.has(cacheKey)) {
            return supplierReferenceLookupPromises.get(cacheKey);
          }

          const params = new URLSearchParams();
          params.set('supplierCode', normalizedSupplierCode);
          if (supplierInfo?.name) {
            params.set('supplierName', supplierInfo.name);
          }
          if (supplierInfo?.document) {
            const documentDigits = digitsOnly(supplierInfo.document);
            if (documentDigits) {
              params.set('supplierDocument', documentDigits);
            }
          }

          const headers = buildAuthHeaders();
          const requestPromise = (async () => {
            const response = await fetch(
              `${apiBaseUrl}/products/search-by-supplier?${params.toString()}`,
              { headers }
            );
            const payload = await response.json().catch(() => ({}));

            if (response.status === 401) {
              handleAuthError();
            }

            if (response.status === 404) {
              if (cacheKey) {
                supplierReferenceLookupCache.set(cacheKey, null);
              }
              return null;
            }

            if (!response.ok) {
              throw new Error(
                payload?.message ||
                  `Falha ao consultar produtos do fornecedor (status ${response.status}).`
              );
            }

            const product = payload?.product || null;
            if (cacheKey) {
              supplierReferenceLookupCache.set(cacheKey, product);
            }
            return product;
          })()
            .catch((error) => {
              if (cacheKey) {
                supplierReferenceLookupCache.delete(cacheKey);
              }
              throw error;
            })
            .finally(() => {
              if (cacheKey) {
                supplierReferenceLookupPromises.delete(cacheKey);
              }
            });

          if (cacheKey) {
            supplierReferenceLookupPromises.set(cacheKey, requestPromise);
          }
          return requestPromise;
        };

        const findProductByBarcode = async (barcodeDigits) => {
          const normalized = normalizeBarcodeForComparison(barcodeDigits);
          if (!normalized) return null;
          if (productLookupCache.has(normalized)) {
            return productLookupCache.get(normalized);
          }
          if (productLookupPromises.has(normalized)) {
            return productLookupPromises.get(normalized);
          }
          const promise = (async () => {
            const response = await fetch(
              `${apiBaseUrl}/products?search=${encodeURIComponent(normalized)}&limit=8`,
              { headers: buildAuthHeaders() }
            );
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
              if (response.status === 401) {
                handleAuthError();
              }
              throw new Error(payload?.message || `Falha ao consultar produtos (status ${response.status}).`);
            }
            const products = Array.isArray(payload?.products)
              ? payload.products
              : Array.isArray(payload)
              ? payload
              : [];
            const match =
              products.find((product) => getProductBarcodeFromRecord(product) === normalized) || null;
            productLookupCache.set(normalized, match);
            return match;
          })();
          productLookupPromises.set(normalized, promise);
          try {
            return await promise;
          } finally {
            productLookupPromises.delete(normalized);
          }
        };

        const findProductMatchForCandidates = async (candidates) => {
          if (!Array.isArray(candidates) || !candidates.length) return null;
          for (const candidate of candidates) {
            const product = await findProductByBarcode(candidate);
            if (product) return product;
          }
          return null;
        };

        const validateImportedProducts = async (nfeData) => {
          if (!nfeData) return;
          const items = Array.isArray(nfeData.items) ? nfeData.items : [];
          const sequence = ++productValidationSequence;

          if (!items.length) {
            renderImportedProducts([]);
            return;
          }

          const supplierInfo = resolveActiveSupplierInfo(nfeData);
          const itemsWithSupplierReference = items.filter((item) =>
            Boolean(canonicalSupplierProductCode(item?.supplierCode))
          );
          const itemsWithBarcode = items.filter(
            (item) => Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length
          );
          const pendingValidationItems = Array.from(
            new Set([...itemsWithSupplierReference, ...itemsWithBarcode])
          );
          if (pendingValidationItems.length) {
            pendingValidationItems.forEach((item) => {
              item.validationStatus = 'checking';
            });
          }

          renderImportedProducts(items);

          let hadError = false;
          const linkingTasks = [];

          for (const item of items) {
            if (sequence !== productValidationSequence) {
              return;
            }

            const hasSupplierReference = Boolean(canonicalSupplierProductCode(item?.supplierCode));
            const hasBarcodeCandidates = Array.isArray(item?.barcodeCandidates) && item.barcodeCandidates.length;
            let matchedProduct = null;
            let matched = false;

            if (hasSupplierReference) {
              try {
                matchedProduct = await findProductBySupplierReference(supplierInfo, item.supplierCode);
                if (sequence !== productValidationSequence) {
                  return;
                }
                matched = Boolean(matchedProduct);
              } catch (error) {
                console.error('Erro ao validar produto pelo fornecedor:', error);
                item.validationStatus = 'error';
                hadError = true;
                continue;
              }
            }

            if (!matched && hasBarcodeCandidates) {
              try {
                matchedProduct = await findProductMatchForCandidates(item.barcodeCandidates);
                if (sequence !== productValidationSequence) {
                  return;
                }
                matched = Boolean(matchedProduct);
              } catch (error) {
                console.error('Erro ao validar produto pelo código de barras:', error);
                item.validationStatus = 'error';
                hadError = true;
                continue;
              }
            }

            if (matched && matchedProduct) {
              item.matchedProduct = matchedProduct;
              item.validationStatus = 'matched';
              applySupplierConversionFromProduct(item, matchedProduct, nfeData);
              const linkPromise = ensureProductSupplierLink(matchedProduct, item, nfeData);
              if (linkPromise) {
                linkingTasks.push(
                  linkPromise.catch((error) => {
                    console.error('Erro ao vincular produto ao fornecedor automaticamente:', error);
                    if (!supplierLinkErrorNotified) {
                      notify(
                        'Não foi possível vincular alguns produtos ao fornecedor automaticamente. Verifique os cadastros.',
                        'warning'
                      );
                      supplierLinkErrorNotified = true;
                    }
                    return null;
                  })
                );
              }
            } else if (hasSupplierReference || hasBarcodeCandidates) {
              item.matchedProduct = null;
              item.validationStatus = 'not-found';
            }
          }

          if (sequence !== productValidationSequence) {
            return;
          }

          if (linkingTasks.length) {
            await Promise.all(linkingTasks);
            if (sequence !== productValidationSequence) {
              return;
            }
          }

          renderImportedProducts(items);

          if (hadError) {
            notify(
              'Alguns produtos não puderam ser validados automaticamente. Tente novamente em instantes.',
              'error'
            );
          }
        };

        const updateSummaryFromData = (data) => {
          if (!data) {
            setText(importSummaryEmitenteName, 'Informe a chave ou importe o XML');
            setText(importSummaryEmitenteDocument, 'Documento não identificado');
            setText(importSummaryAccessKey, '------------------------------');
            setText(importSummaryAccessKeyDetails, 'DV -- · Ambiente não identificado');
            setText(importSummaryProtocol, 'Protocolo não informado');
            setText(importSummaryProtocolReceived, 'Recebimento não disponível');
            setText(importSummarySupplierName, 'Fornecedor não localizado');
            setText(importSummarySupplierDocument, 'Documento não disponível');
            setText(importSummaryTotal, 'R$ 0,00');
            setText(importSummaryTotalStatus, 'Aguardando importação do XML');
            setText(importSummaryDestName, 'Destinatário não identificado');
            setText(importSummaryDestDocument, 'Documento não disponível');
            ['nf-number', 'nf-serie', 'nf-emissao', 'nf-entrada', 'cfop', 'natureza', 'modalidade-frete', 'indicador-ie'].forEach(
              (key) => setSummaryInput(key, '')
            );
            if (importXmlNumber) {
              importXmlNumber.textContent = 'XML não importado';
            }
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'Aguardando validação fiscal';
            }
            applyValidationStyles('info');
            productValidationSequence += 1;
            renderImportedProducts([]);
            return;
          }

          const supplierDoc = composeDocumentLine(data.emit?.document, data.emit?.stateRegistration);
          const destDoc = composeDocumentLine(data.dest?.document, data.dest?.stateRegistration);

          setText(importSummaryEmitenteName, data.emit?.name || 'Emitente não identificado');
          setText(importSummaryEmitenteDocument, supplierDoc || 'Documento não identificado');

          if (data.accessKey) {
            setText(importSummaryAccessKey, data.accessKey);
            setText(importSummaryAccessKeyDetails, `DV ${data.accessKey.slice(-1)} · ${mapEnvironment(data.ambient)}`);
            if (importXmlNumber) {
              importXmlNumber.textContent = `XML nº ${data.accessKey}`;
            }
          } else {
            setText(importSummaryAccessKey, '------------------------------');
            setText(importSummaryAccessKeyDetails, 'DV -- · Ambiente não identificado');
            if (importXmlNumber) {
              importXmlNumber.textContent = 'XML importado';
            }
          }

          const protocolNumber = data.protocol?.number || '';
          if (protocolNumber) {
            setText(importSummaryProtocol, protocolNumber);
            const received = normalizeDate(data.protocol?.receivedAt);
            const receivedText = received.displayDateTime || received.display || received.dateInput || '';
            setText(
              importSummaryProtocolReceived,
              receivedText ? `Recebido em ${receivedText}` : 'Recebimento registrado pela SEFAZ'
            );
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'XML autorizado na SEFAZ';
            }
            applyValidationStyles('success');
          } else {
            setText(importSummaryProtocol, 'Protocolo não informado');
            setText(importSummaryProtocolReceived, 'Recebimento não disponível');
            if (importXmlValidationText) {
              importXmlValidationText.textContent = 'XML importado (aguardando protocolo)';
            }
            applyValidationStyles('warning');
          }

          setText(importSummarySupplierName, data.emit?.name || 'Fornecedor não localizado');
          setText(importSummarySupplierDocument, supplierDoc || 'Documento não disponível');

          const totalFormatted = formatCurrencyBRL(data.totals?.totalValue);
          setText(importSummaryTotal, totalFormatted);
          setText(importSummaryTotalStatus, 'Valor informado pelo XML autorizado');

          setText(importSummaryDestName, data.dest?.name || 'Destinatário não identificado');
          setText(importSummaryDestDocument, destDoc || 'Documento não disponível');

          const emission = normalizeDate(data.ide?.emissionDate);
          const entry = normalizeDate(data.ide?.entryDate);

          setSummaryInput('nf-number', data.ide?.number || '');
          setSummaryInput('nf-serie', data.ide?.serie || '');
          setSummaryInput('nf-emissao', emission.display || emission.dateInput || '');
          setSummaryInput('nf-entrada', entry.display || entry.dateInput || '');
          setSummaryInput('cfop', data.ide?.cfop || '');
          setSummaryInput('natureza', data.ide?.natOp || '');
          setSummaryInput('modalidade-frete', mapFrete(data.ide?.freightMode));
          setSummaryInput('indicador-ie', formatIndIe(data.dest?.indIEDest));

          const items = Array.isArray(data.items) ? data.items : [];
          renderImportedProducts(items);
        };

        const fillMainFormFromNfeData = (data) => {
          if (!data) return;
          if (nfeNumberInput && data.ide?.number) nfeNumberInput.value = data.ide.number;
          if (nfeSeriesInput) nfeSeriesInput.value = data.ide?.serie || '';
          if (nfeProtocolInput) nfeProtocolInput.value = data.protocol?.number || '';
          if (nfeReferenceInput) nfeReferenceInput.value = data.ide?.natOp || '';
          const emission = normalizeDate(data.ide?.emissionDate);
          if (issueDateInput) issueDateInput.value = emission.dateInput || '';
          const entry = normalizeDate(data.ide?.entryDate);
          if (entryDateInput) entryDateInput.value = entry.dateInput || '';
          if (nfeModelSelect && data.ide?.model) setSelectValue(nfeModelSelect, data.ide.model);
          if (nfeTypeSelect) setSelectValue(nfeTypeSelect, mapModelToType(data.ide?.model));
          if (tipoEmissaoSelect && data.ide?.tpEmis) setSelectValue(tipoEmissaoSelect, data.ide.tpEmis);
          if (accessKeyInput && data.accessKey) accessKeyInput.value = data.accessKey;
          if (importAccessKeyInput && data.accessKey) importAccessKeyInput.value = data.accessKey;
          if (companySelect && data.dest?.document) {
            const companyDigits = digitsOnly(data.dest.document);
            const matchedCompany = Array.from(companySelect.options || []).find((option) => {
              const optionDigits = digitsOnly(`${option.value}${option.textContent || ''}`);
              return optionDigits.includes(companyDigits) || optionDigits === companyDigits;
            });
            if (matchedCompany) {
              companySelect.value = matchedCompany.value;
              companySelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        };

        const setNumericInputValue = (input, value, fractionDigits = 2) => {
          if (!input) return;
          const numericValue = parseNumber(value);
          if (Number.isFinite(numericValue)) {
            input.value = numericValue.toFixed(fractionDigits);
          } else {
            input.value = '';
          }
        };

        const fillSupplierFieldsFromNfe = (data) => {
          const supplier = data?.emit;
          if (!supplier) return;
          setInputValue(
            supplierCnpjInput,
            supplier.document ? formatDocument(supplier.document) : ''
          );
          setInputValue(supplierIeInput, supplier.stateRegistration || '');
          if (supplierUfSelect && supplier.address?.state) {
            setSelectValue(supplierUfSelect, supplier.address.state);
          }
          setInputValue(supplierEmailInput, supplier.email || '');
          setInputValue(supplierAddressInput, formatAddressLine(supplier.address));
        };

        const fillTotalsFromNfeData = (data) => {
          const totals = data?.totals || {};
          setNumericInputValue(totalsProductsInput, totals.products);
          setNumericInputValue(totalsIcmsBaseInput, totals.icmsBase);
          setNumericInputValue(totalsIcmsValueInput, totals.icmsValue);
          setNumericInputValue(totalsIcmsStInput, totals.icmsSt);
          setNumericInputValue(totalsFcpStInput, totals.fcpSt);
          setNumericInputValue(totalsServicesInput, totals.services);
          setNumericInputValue(totalsDiscountInput, totals.discount);
          setNumericInputValue(totalsOtherInput, totals.other);
          setNumericInputValue(totalsFreightInput, totals.freight);
          setNumericInputValue(totalsIpiInput, totals.ipi);
          setNumericInputValue(totalsInsuranceInput, totals.insurance);
          setInputValue(totalsAdjustmentInput, '');
          setInputValue(totalsUnitDiscountInput, '');
          setInputValue(totalsDollarInput, '');
        };

        const fillTransportFromNfeData = (data) => {
          const transport = data?.transport || {};
          const transporter = transport.transporter || {};
          const vehicle = transport.vehicle || {};
          const volume = transport.volume || {};

          setInputValue(
            transportCnpjInput,
            transporter.document ? formatDocument(transporter.document) : ''
          );
          setInputValue(transportIeInput, transporter.stateRegistration || '');
          if (transportUfSelect && transporter.uf) {
            setSelectValue(transportUfSelect, transporter.uf);
          }
          setInputValue(transportNameInput, transporter.name || '');
          setInputValue(transportPlateInput, vehicle.plate || '');
          if (transportPlateUfSelect && vehicle.uf) {
            setSelectValue(transportPlateUfSelect, vehicle.uf);
          }
          setNumericInputValue(weightGrossInput, volume.weightGross, 3);
          setNumericInputValue(weightNetInput, volume.weightNet, 3);
          if (freightModeSelect) {
            const modeValue = transport.mode || data?.ide?.freightMode || '';
            if (modeValue) {
              setSelectValue(freightModeSelect, modeValue);
            }
          }
        };

        const fillAdditionalInfoFromNfeData = (data) => {
          const additional = data?.additionalInfo || {};
          if (observationInput) {
            observationInput.value = additional.complementary || '';
          }
          if (complementaryInfoInput) {
            complementaryInfoInput.value = additional.fiscal || '';
          }

          const payments = Array.isArray(data?.payments) ? data.payments : [];
          if (paymentFormInput) {
            const descriptions = payments
              .map((payment) => payment?.description || describePaymentMethod(payment?.method))
              .filter(Boolean);
            const uniqueDescriptions = Array.from(new Set(descriptions));
            paymentFormInput.value = uniqueDescriptions.join(', ');
          }

          if (paymentConditionInput) {
            const duplicates = Array.isArray(data?.duplicates) ? data.duplicates : [];
            const emission = normalizeDate(data?.ide?.emissionDate);
            if (duplicates.length && emission.dateInput) {
              const emissionDateObj = new Date(`${emission.dateInput}T00:00:00`);
              const dueDiffs = duplicates
                .map((dup) => {
                  const dueInfo = normalizeDate(dup?.dueDate);
                  if (!dueInfo.dateInput) return null;
                  const dueDateObj = new Date(`${dueInfo.dateInput}T00:00:00`);
                  const diff = Math.round((dueDateObj - emissionDateObj) / (24 * 60 * 60 * 1000));
                  return Number.isFinite(diff) ? diff : null;
                })
                .filter((value) => value !== null)
                .sort((a, b) => a - b);
              if (dueDiffs.length) {
                paymentConditionInput.value = dueDiffs.join('/');
              } else {
                paymentConditionInput.value = `${duplicates.length} parcela${
                  duplicates.length > 1 ? 's' : ''
                }`;
              }
            } else if (payments.length) {
              paymentConditionInput.value = `${payments.length} parcela${
                payments.length > 1 ? 's' : ''
              }`;
            } else {
              paymentConditionInput.value = '';
            }
          }
        };

        const renderDocumentsFromNfe = (references = []) => {
          if (!documentsTableBody) return;
          const existingRows = documentsTableBody.querySelectorAll(
            'tr:not([data-nfe-documents-empty])'
          );
          existingRows.forEach((row) => row.remove());

          const hasReferences = Array.isArray(references) && references.length > 0;
          if (documentsEmptyRow) {
            documentsEmptyRow.classList.toggle('hidden', hasReferences);
          }
          if (!hasReferences) {
            return;
          }

          const fragment = document.createDocumentFragment();
          references.forEach((reference) => {
            const row = document.createElement('tr');

            const typeCell = document.createElement('td');
            typeCell.className = 'px-4 py-3 text-gray-600';
            typeCell.textContent = reference?.type || 'Documento referenciado';
            if (reference?.issuerUf || reference?.document) {
              const extra = document.createElement('p');
              extra.className = 'text-xs text-gray-500';
              const details = [];
              if (reference.issuerUf) details.push(`UF ${reference.issuerUf}`);
              if (reference.document) details.push(formatDocument(reference.document));
              extra.textContent = details.join(' · ');
              if (extra.textContent) {
                typeCell.appendChild(extra);
              }
            }

            const modelCell = document.createElement('td');
            modelCell.className = 'px-4 py-3 text-gray-600';
            modelCell.textContent = reference?.model || '—';

            const numberCell = document.createElement('td');
            numberCell.className = 'px-4 py-3 text-gray-600';
            const numberParts = [];
            if (reference?.number) numberParts.push(reference.number);
            if (reference?.series) numberParts.push(`Série ${reference.series}`);
            if (!numberParts.length) numberParts.push('—');
            numberCell.textContent = numberParts.join(' · ');

            const keyCell = document.createElement('td');
            keyCell.className = 'px-4 py-3 text-gray-600 font-mono text-xs';
            keyCell.textContent = reference?.accessKey || '—';

            const emissionCell = document.createElement('td');
            emissionCell.className = 'px-4 py-3 text-gray-600';
            const emission = normalizeDate(reference?.emissionDate);
            emissionCell.textContent = emission.display || emission.dateInput || '—';

            row.append(typeCell, modelCell, numberCell, keyCell, emissionCell);
            fragment.appendChild(row);
          });

          documentsTableBody.appendChild(fragment);
        };

        const renderDuplicatasFromNfe = (duplicates = [], data = null) => {
          if (!duplicatasTableBody) return;
          const existingRows = duplicatasTableBody.querySelectorAll(
            'tr:not([data-nfe-duplicatas-empty])'
          );
          existingRows.forEach((row) => row.remove());

          const hasDuplicates = Array.isArray(duplicates) && duplicates.length > 0;
          if (duplicatasEmptyRow) {
            duplicatasEmptyRow.classList.toggle('hidden', hasDuplicates);
          }
          if (!hasDuplicates) {
            return;
          }

          const emission = normalizeDate(data?.ide?.emissionDate);
          const entry = normalizeDate(data?.ide?.entryDate);
          const baseDateInput = emission.dateInput || entry.dateInput || '';
          const supplierAccount = resolveSupplierAccountingAccount();

          const fragment = document.createDocumentFragment();
          duplicates.forEach((dup, index) => {
            const row = document.createElement('tr');
            row.dataset.duplicateIndex = String(index);

            const parcelCell = document.createElement('td');
            parcelCell.className = 'px-4 py-3 text-gray-600';
            parcelCell.textContent = dup?.number || `Parcela ${index + 1}`;

            const daysCell = document.createElement('td');
            daysCell.className = 'px-4 py-3 text-gray-600';
            daysCell.dataset.duplicateTerm = String(index);
            const manualDueInfo = normalizeDate(dup?.manualDueDate);
            const dueInfo = manualDueInfo.dateInput ? manualDueInfo : normalizeDate(dup?.dueDate);
            let diffText = '—';
            if (Number.isFinite(dup?.termDays)) {
              diffText = String(dup.termDays);
            } else if (baseDateInput) {
              const diffBase = dueInfo.dateInput || manualDueInfo.dateInput;
              if (diffBase) {
                const diff = computeDateDiffInDays(baseDateInput, diffBase);
                if (Number.isFinite(diff)) {
                  diffText = String(diff);
                }
              }
            }
            daysCell.textContent = diffText;

            const dueCell = document.createElement('td');
            dueCell.className = 'px-4 py-3';
            const dueInput = document.createElement('input');
            dueInput.type = 'date';
            dueInput.className =
              'w-full rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20';
            dueInput.dataset.duplicateDueInput = 'true';
            dueInput.dataset.duplicateIndex = String(index);

            let dueInputInfo = manualDueInfo.dateInput ? manualDueInfo : dueInfo;
            if (!dueInputInfo.dateInput && Number.isFinite(dup?.termDays) && baseDateInput) {
              const fallbackDueInput = addDaysToDateInput(baseDateInput, dup.termDays);
              dueInputInfo = normalizeDate(fallbackDueInput);
            }
            dueInput.value = dueInputInfo.dateInput || '';
            dueCell.appendChild(dueInput);

            const valueCell = document.createElement('td');
            valueCell.className = 'px-4 py-3 text-right text-gray-800 font-semibold';
            valueCell.textContent = formatCurrencyBRL(dup?.value);

            const observationCell = document.createElement('td');
            observationCell.className = 'px-4 py-3 text-gray-600';
            const observationParts = [];
            const methodDescription =
              dup?.paymentDescription ||
              (dup?.paymentMethod ? describePaymentMethod(dup.paymentMethod) : '');
            if (methodDescription) {
              observationParts.push(methodDescription);
            }
            const paymentTypeRaw = dup?.paymentType;
            let paymentTypeLabel = '';
            if (paymentTypeRaw === '0') paymentTypeLabel = 'À vista';
            else if (paymentTypeRaw === '1') paymentTypeLabel = 'À prazo';
            else if (paymentTypeRaw === '2') paymentTypeLabel = 'Outros';
            if (paymentTypeLabel) {
              observationParts.push(paymentTypeLabel);
            }
            observationCell.textContent = observationParts.join(' · ') || '—';

            const accountCell = document.createElement('td');
            accountCell.className = 'px-4 py-3 text-gray-600';
            accountCell.textContent = supplierAccount?.name || '—';

            const accountCodeCell = document.createElement('td');
            accountCodeCell.className = 'px-4 py-3 text-gray-600';
            accountCodeCell.textContent = supplierAccount?.code || '—';

            const bankCell = document.createElement('td');
            bankCell.className = 'px-4 py-3 text-gray-600';
            const resolvedBankAccount =
              findBankAccountById(dup?.bankAccount) || resolveSelectedBankAccount(data);
            bankCell.textContent = resolvedBankAccount
              ? buildBankAccountLabel(resolvedBankAccount)
              : '—';

            row.append(
              parcelCell,
              daysCell,
              dueCell,
              valueCell,
              observationCell,
              accountCell,
              accountCodeCell,
              bankCell
            );
            fragment.appendChild(row);
          });

          duplicatasTableBody.appendChild(fragment);
        };

        const refreshAccountingAccountBindings = () => {
          const account = resolveSupplierAccountingAccount();
          if (accountingAccountInput) {
            accountingAccountInput.value = formatAccountingAccountValue(account);
          }
          return account;
        };

        const syncAccountingAccountWithDuplicates = () => {
          const account = refreshAccountingAccountBindings();
          if (lastNfeData && Array.isArray(lastNfeData.duplicates)) {
            renderDuplicatasFromNfe(lastNfeData.duplicates, lastNfeData);
          }
          return account;
        };

        const renderMainProductsFromNfe = (items = []) => {
          if (!mainProductsTableBody) return;
          const existingRows = mainProductsTableBody.querySelectorAll(
            'tr:not([data-nfe-products-empty])'
          );
          existingRows.forEach((row) => row.remove());

          const hasItems = Array.isArray(items) && items.length > 0;
          if (mainProductsEmptyRow) {
            mainProductsEmptyRow.classList.toggle('hidden', hasItems);
          }
          if (!hasItems) {
            return;
          }

          const fragment = document.createDocumentFragment();

          items.forEach((item, index) => {
            const row = document.createElement('tr');

            ensureItemCostWithTaxes(item);

            const indexCell = document.createElement('td');
            indexCell.className = 'px-4 py-3 text-gray-600';
            indexCell.textContent = String(index + 1);

            const icmsCell = document.createElement('td');
            icmsCell.className = 'px-4 py-3';
            const icmsLabel = document.createElement('label');
            icmsLabel.className = 'inline-flex items-center gap-2 text-xs text-gray-600';
            const icmsCheckbox = document.createElement('input');
            icmsCheckbox.type = 'checkbox';
            icmsCheckbox.disabled = true;
            icmsCheckbox.className = 'rounded border-gray-300 text-primary focus:ring-primary/30';
            icmsLabel.append(icmsCheckbox, document.createTextNode('Não'));
            icmsCell.appendChild(icmsLabel);

            const codeCell = document.createElement('td');
            codeCell.className = 'px-4 py-3 text-gray-600';
            const matchedCode = item?.matchedProduct
              ? normalizeInternalCode(getProductCodeFromRecord(item.matchedProduct))
              : '';
            const supplierCode = item?.supplierCode || '';
            codeCell.textContent = matchedCode || supplierCode || '—';

            const descriptionCell = document.createElement('td');
            descriptionCell.className = 'px-4 py-3 text-gray-700';
            descriptionCell.textContent = item?.description || 'Item sem descrição';

            const detailLine1 = document.createElement('p');
            detailLine1.className = 'text-xs text-gray-500';
            const line1Parts = [];
            if (item?.unit) line1Parts.push(`UN: ${item.unit}`);
            if (item?.unitTrib && item.unitTrib !== item.unit) line1Parts.push(`Trib: ${item.unitTrib}`);
            if (item?.ncm) line1Parts.push(`NCM ${item.ncm}`);
            if (item?.cest) line1Parts.push(`CEST ${item.cest}`);
            detailLine1.textContent = line1Parts.join(' · ') || '—';

            const detailLine2 = document.createElement('p');
            detailLine2.className = 'text-xs text-gray-500';
            const line2Parts = [];
            if (item?.cfop) line2Parts.push(`CFOP ${item.cfop}`);
            if (item?.cst) line2Parts.push(`CST ${item.cst}`);
            line2Parts.push(`ICMS ${formatPercentValue(item?.icmsRate)}`);
            line2Parts.push(`ICMS ST ${formatPercentValue(item?.icmsStRate)}`);
            detailLine2.textContent = line2Parts.join(' · ');

            const detailLine3 = document.createElement('p');
            detailLine3.className = 'text-xs text-gray-500';
            detailLine3.textContent = `IPI ${formatPercentValue(item?.ipiRate)} · PIS ${formatPercentValue(
              item?.pisRate
            )} · COFINS ${formatPercentValue(item?.cofinsRate)}`;

            const detailLine4 = document.createElement('p');
            detailLine4.className = 'text-xs text-gray-500';
            detailLine4.textContent = `GTIN: ${item?.barcodeDisplay || formatGtinDisplay(item?.ean || item?.eanTrib) || 'SEM GTIN'}`;

            descriptionCell.append(detailLine1, detailLine2, detailLine3, detailLine4);

            const quantityCell = document.createElement('td');
            quantityCell.className = 'px-4 py-3 text-right text-gray-600';
            quantityCell.textContent = formatQuantity(item?.quantity);

            const conversionFromItem = toNumeric(item?.conversion);
            const multiplierValue = toNumeric(item?.conversionMultiplier);
            const dividerValue = toNumeric(item?.conversionDivider);
            let conversionFactor = Number.isFinite(conversionFromItem)
              ? conversionFromItem
              : null;
            if (!Number.isFinite(conversionFactor)) {
              if (Number.isFinite(multiplierValue) && Number.isFinite(dividerValue) && dividerValue !== 0) {
                conversionFactor = multiplierValue / dividerValue;
              } else if (Number.isFinite(multiplierValue)) {
                conversionFactor = multiplierValue;
              } else if (Number.isFinite(dividerValue) && dividerValue !== 0) {
                conversionFactor = 1 / dividerValue;
              }
            }

            const conversionCell = document.createElement('td');
            conversionCell.className = 'px-4 py-3 text-right text-gray-600';
            conversionCell.textContent = Number.isFinite(conversionFactor)
              ? formatQuantity(conversionFactor)
              : '—';

            const quantityValue = toNumeric(item?.quantity);
            const qTribValue = toNumeric(item?.qTrib);
            let entryStockValue = Number.isFinite(item?.entryStockQuantity)
              ? item.entryStockQuantity
              : null;
            if (!Number.isFinite(entryStockValue)) {
              if (Number.isFinite(quantityValue) && Number.isFinite(conversionFactor)) {
                entryStockValue = quantityValue * conversionFactor;
              } else if (Number.isFinite(qTribValue)) {
                entryStockValue = qTribValue;
              } else if (Number.isFinite(quantityValue)) {
                entryStockValue = quantityValue;
              }
            }
            if (Number.isFinite(entryStockValue) && !Number.isFinite(item.entryStockQuantity)) {
              item.entryStockQuantity = entryStockValue;
              ensureItemCostWithTaxes(item);
            }

            const entryStockCell = document.createElement('td');
            entryStockCell.className = 'px-4 py-3 text-right text-gray-600';
            entryStockCell.textContent = Number.isFinite(entryStockValue)
              ? formatQuantity(entryStockValue)
              : '—';

            const unitCostWithTaxesValue = toNumeric(item?.unitCostWithTaxes);
            const calculatedCostCell = document.createElement('td');
            calculatedCostCell.className = 'px-4 py-3 text-right text-gray-600';
            calculatedCostCell.textContent = Number.isFinite(unitCostWithTaxesValue)
              ? formatMoneyValue(unitCostWithTaxesValue)
              : '—';

            const unitPriceCell = document.createElement('td');
            unitPriceCell.className = 'px-4 py-3 text-right text-gray-600';
            unitPriceCell.textContent = formatMoneyValue(item?.unitPrice);

            const discountCell = document.createElement('td');
            discountCell.className = 'px-4 py-3 text-right text-gray-600';
            discountCell.textContent = formatPercentValue(item?.discountPercent);

            row.append(
              indexCell,
              icmsCell,
              codeCell,
              descriptionCell,
              quantityCell,
              conversionCell,
              entryStockCell,
              calculatedCostCell,
              unitPriceCell,
              discountCell
            );
            fragment.appendChild(row);
          });

          mainProductsTableBody.appendChild(fragment);
        };

        const updateDuplicataSummaryFromData = (data) => {
          const duplicates = Array.isArray(data?.duplicates) ? data.duplicates : [];
          const emission = normalizeDate(data?.ide?.emissionDate);
          const entry = normalizeDate(data?.ide?.entryDate);
          const baseDateInput = emission.dateInput || entry.dateInput || '';

          if (duplicataEmissionInput) {
            duplicataEmissionInput.value = emission.dateInput || '';
          }
          if (duplicataCountInput) {
            duplicataCountInput.value = duplicates.length ? String(duplicates.length) : '';
          }

          const firstDuplicate = duplicates[0];
          const firstManual = normalizeDate(firstDuplicate?.manualDueDate);
          const firstDue = firstManual.dateInput
            ? firstManual
            : normalizeDate(firstDuplicate?.dueDate);

          if (duplicataFirstDueInput) {
            if (firstDuplicate) {
              if (firstDue.dateInput) {
                duplicataFirstDueInput.value = firstDue.dateInput;
              } else if (Number.isFinite(firstDuplicate?.termDays) && baseDateInput) {
                const fallbackDue = addDaysToDateInput(baseDateInput, firstDuplicate.termDays);
                duplicataFirstDueInput.value = fallbackDue || '';
              } else {
                duplicataFirstDueInput.value = '';
              }
            } else {
              duplicataFirstDueInput.value = '';
            }
          }

          if (duplicataInitialDaysInput) {
            if (firstDuplicate) {
              if (Number.isFinite(firstDuplicate?.termDays)) {
                duplicataInitialDaysInput.value = String(firstDuplicate.termDays);
              } else if (baseDateInput && (firstDue.dateInput || firstManual.dateInput)) {
                const diffBase = firstDue.dateInput || firstManual.dateInput;
                const diff = computeDateDiffInDays(baseDateInput, diffBase);
                duplicataInitialDaysInput.value = Number.isFinite(diff) ? String(diff) : '';
              } else {
                duplicataInitialDaysInput.value = '';
              }
            } else {
              duplicataInitialDaysInput.value = '';
            }
          }

          if (duplicataDaysInput) {
            duplicataDaysInput.value = '';
          }
          if (duplicataDaysTypeSelect) {
            setSelectValue(duplicataDaysTypeSelect, duplicates.length ? 'data' : 'dias');
          }
        };

        const fillDuplicatasFromNfeData = (data) => {
          const duplicates = Array.isArray(data?.duplicates) ? data.duplicates : [];
          updateDuplicataSummaryFromData(data);

          if (bankAccountSelect) {
            const desiredValue = data?.selectedBankAccountId || '';
            if (desiredValue) {
              const applied = setBankAccountSelectValue(desiredValue);
              if (!applied) {
                pendingBankAccountId = desiredValue;
              } else if (pendingBankAccountId === desiredValue) {
                pendingBankAccountId = '';
              }
            } else {
              bankAccountSelect.value = '';
              pendingBankAccountId = '';
            }
          }

          const activeBankAccountId = bankAccountSelect ? bankAccountSelect.value : '';
          if (data) {
            data.selectedBankAccountId = activeBankAccountId || pendingBankAccountId || '';
          }
          duplicates.forEach((duplicate) => {
            if (!duplicate || typeof duplicate !== 'object') return;
            if (!duplicate.originalDueDate) {
              duplicate.originalDueDate = duplicate.dueDate || '';
            }
            duplicate.bankAccount = activeBankAccountId ? String(activeBankAccountId) : null;
          });

          renderDuplicatasFromNfe(duplicates, data);
        };

        const applyImportedDataToMainForm = (data) => {
          if (!data) return;
          fillMainFormFromNfeData(data);
          fillSupplierFieldsFromNfe(data);
          fillTotalsFromNfeData(data);
          fillTransportFromNfeData(data);
          fillDuplicatasFromNfeData(data);
          fillAdditionalInfoFromNfeData(data);
          renderDocumentsFromNfe(data.references);
          renderMainProductsFromNfe(data.items);
          if (totalAmountDisplay) {
            totalAmountDisplay.textContent = formatCurrencyBRL(data.totals?.totalValue);
          }
        };

        const resetImportedNfeState = () => {
          lastNfeData = null;
          lastSupplierData = null;
          lastSupplierRecord = null;
          supplierLinkErrorNotified = false;
          productValidationSequence += 1;
          resetProductLookupCaches();
          productSupplierLinkCache.clear();
          productSupplierLinkPromises.clear();
          supplierReferenceLookupCache.clear();
          supplierReferenceLookupPromises.clear();
          if (refreshImportedProductsButton) {
            setRefreshImportedProductsButtonState(false);
          }
          if (importFileInput) {
            importFileInput.value = '';
          }
          clearStatusMessages();
          try {
            sessionStorage.removeItem(PRODUCT_DRAFT_STORAGE_KEY);
          } catch (error) {
            console.warn('Não foi possível limpar o rascunho de produtos da importação.', error);
          }

          const inputsToReset = [
            nfeNumberInput,
            nfeSeriesInput,
            nfeProtocolInput,
            nfeReferenceInput,
            issueDateInput,
            entryDateInput,
            importAccessKeyInput,
            accessKeyInput,
            supplierCnpjInput,
            supplierIeInput,
            supplierEmailInput,
            supplierAddressInput,
            transportCnpjInput,
            transportIeInput,
            transportPlateInput,
            transportNameInput,
            weightGrossInput,
            weightNetInput,
            totalsProductsInput,
            totalsIcmsBaseInput,
            totalsIcmsValueInput,
            totalsIcmsStInput,
            totalsFcpStInput,
            totalsServicesInput,
            totalsAdjustmentInput,
            totalsDiscountInput,
            totalsOtherInput,
            totalsFreightInput,
            totalsIpiInput,
            totalsUnitDiscountInput,
            totalsInsuranceInput,
            totalsDollarInput,
            duplicataEmissionInput,
            duplicataCountInput,
            duplicataFirstDueInput,
            duplicataDaysInput,
            duplicataInitialDaysInput,
            accountingAccountInput,
            paymentConditionInput,
            paymentFormInput,
            observationInput,
            complementaryInfoInput,
          ];

          inputsToReset.forEach((input) => setInputValue(input, ''));

          const selectsToReset = [
            { element: supplierSelect, value: '' },
            { element: supplierUfSelect, value: '' },
            { element: companySelect, value: '' },
            { element: bankAccountSelect, value: '' },
            { element: nfeModelSelect, value: '55' },
            { element: nfeTypeSelect, value: 'NF' },
            { element: tipoEmissaoSelect, value: '1' },
            { element: finalidadeSelect, value: 'normal' },
            { element: indicadorPresencaSelect, value: '0' },
            { element: depositSelect, value: '' },
            { element: transportUfSelect, value: '' },
            { element: transportPlateUfSelect, value: '' },
            { element: freightModeSelect, value: '0' },
            { element: duplicataDaysTypeSelect, value: 'dias' },
          ];

          selectsToReset.forEach(({ element, value }) => resetSelectValue(element, value));

          pendingBankAccountId = '';
          setBankAccountPlaceholder('Selecione uma empresa para listar as contas correntes');

          if (totalAmountDisplay) {
            totalAmountDisplay.textContent = 'R$ 0,00';
          }

          updateSummaryFromData(null);
          setSupplierSummary(null);
          renderDocumentsFromNfe([]);
          renderDuplicatasFromNfe([], null);
          renderMainProductsFromNfe([]);
        };

        const handleSupplierSelection = async (supplier) => {
          setSupplierSummary(supplier);
          lastSupplierData = supplier || null;
          lastSupplierRecord = null;
          if (!supplier || !supplier.document) {
            updateSupplierStatusCard(
              'warning',
              'Documento do emitente não encontrado no XML.',
              'Revise o arquivo para garantir que os dados do fornecedor estejam completos.'
            );
            syncAccountingAccountWithDuplicates();
            return;
          }
          const documentDigits = digitsOnly(supplier.document);
          if (!documentDigits) {
            updateSupplierStatusCard(
              'warning',
              'Documento do emitente não encontrado no XML.',
              'Revise o arquivo para garantir que os dados do fornecedor estejam completos.'
            );
            syncAccountingAccountWithDuplicates();
            return;
          }
          const formattedDocument = formatDocument(documentDigits);
          let matchedOption = supplierSelect ? findSupplierOptionByDocument(documentDigits) : null;

          await loadSuppliersFromApi();
          let registeredSupplier = supplierRegistry.byDocument.get(documentDigits) || null;
          lastSupplierRecord = registeredSupplier || null;

          if (!registeredSupplier && !matchedOption) {
            await loadSuppliersFromApi(true);
            registeredSupplier = supplierRegistry.byDocument.get(documentDigits) || null;
            lastSupplierRecord = registeredSupplier || null;
          }

          if (!matchedOption && registeredSupplier) {
            matchedOption = ensureSupplierOption(registeredSupplier, documentDigits);
          }

          if (!lastSupplierRecord && matchedOption) {
            const optionSupplierName =
              (matchedOption.dataset && matchedOption.dataset.supplierName) ||
              matchedOption.textContent ||
              '';
            lastSupplierRecord = {
              _id: matchedOption.dataset?.supplierId || null,
              legalName: optionSupplierName,
              cnpj: matchedOption.dataset?.supplierDocument || '',
            };
          }

          if (matchedOption) {
            supplierSelect.value = matchedOption.value;
            supplierSelect.dispatchEvent(new Event('change', { bubbles: true }));
            const supplierName =
              registeredSupplier?.legalName ||
              registeredSupplier?.fantasyName ||
              matchedOption.dataset?.supplierName ||
              supplier.name ||
              formattedDocument;
            updateSupplierStatusCard(
              'success',
              `Fornecedor localizado: ${supplierName}`,
              `Aplicamos automaticamente o fornecedor cadastrado (${formattedDocument}).`
            );
            syncAccountingAccountWithDuplicates();
            return;
          }
          const registerUrl = buildSupplierRegistrationUrl(supplier, lastNfeData);
          updateSupplierStatusCard(
            'warning',
            supplierRegistry.error
              ? `Não foi possível confirmar o cadastro do fornecedor (${formattedDocument}).`
              : `Fornecedor não cadastrado (${formattedDocument})`,
            supplierRegistry.error
              ? 'Tente novamente em instantes ou atualize a página para sincronizar a base de fornecedores.'
              : 'Abriremos o cadastro de fornecedores em nova aba com os dados importados do XML.',
            [
              {
                label: supplierRegistry.error ? 'Tentar novamente' : 'Cadastrar fornecedor',
                icon: supplierRegistry.error ? 'fas fa-sync' : 'fas fa-user-plus',
                variant: supplierRegistry.error ? 'secondary' : 'primary',
                action: () => {
                  if (supplierRegistry.error) {
                    loadSuppliersFromApi(true);
                  } else {
                    window.open(registerUrl, '_blank', 'noopener');
                  }
                },
              },
              !supplierRegistry.error
                ? null
                : {
                    label: 'Cadastrar fornecedor',
                    icon: 'fas fa-user-plus',
                    variant: 'primary',
                    action: () => {
                      window.open(registerUrl, '_blank', 'noopener');
                    },
                  },
            ].filter(Boolean)
          );
          syncAccountingAccountWithDuplicates();
        };

        const parseNfeXml = (xmlText) => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, 'application/xml');
          if (xml.querySelector('parsererror')) {
            throw new Error('O arquivo XML está inválido ou corrompido.');
          }
          const infNFe = xml.getElementsByTagName('infNFe')[0];
          if (!infNFe) {
            throw new Error('Não foi possível localizar os dados principais da NF-e (infNFe).');
          }
          const getText = (context, tagName) => {
            if (!context) return '';
            const element = context.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
          };
          const ide = infNFe.getElementsByTagName('ide')[0];
          const emit = infNFe.getElementsByTagName('emit')[0];
          const dest = infNFe.getElementsByTagName('dest')[0];
          const total = infNFe.getElementsByTagName('ICMSTot')[0];
          const transp = infNFe.getElementsByTagName('transp')[0];
          const transporta = transp ? transp.getElementsByTagName('transporta')[0] : null;
          const veicTransp = transp ? transp.getElementsByTagName('veicTransp')[0] : null;
          const volElement = transp ? transp.getElementsByTagName('vol')[0] : null;
          const detElements = Array.from(infNFe.getElementsByTagName('det'));
          const prot = xml.getElementsByTagName('protNFe')[0];
          const infProt = prot ? prot.getElementsByTagName('infProt')[0] : null;
          const cobr = infNFe.getElementsByTagName('cobr')[0];
          const dupElements = cobr ? Array.from(cobr.getElementsByTagName('dup')) : [];
          const pagElements = Array.from(infNFe.getElementsByTagName('pag'));
          const detPagElements = pagElements.reduce((acc, pagElement) => {
            const detPagList = Array.from(pagElement.getElementsByTagName('detPag'));
            if (detPagList.length) {
              acc.push(...detPagList);
            }
            return acc;
          }, []);
          const nfRefElements = ide ? Array.from(ide.getElementsByTagName('NFref')) : [];
          const infAdic = infNFe.getElementsByTagName('infAdic')[0] || null;

          const accessKey = (infNFe.getAttribute('Id') || infNFe.getAttribute('id') || '').replace(/^NFe/i, '');
          const emissionDate = getText(ide, 'dhEmi') || getText(ide, 'dEmi');
          const entryDate = getText(ide, 'dhSaiEnt') || getText(ide, 'dSaiEnt');
          const items = detElements.map((detElement, index) => {
            const prod = detElement.getElementsByTagName('prod')[0];
            const imposto = detElement.getElementsByTagName('imposto')[0];
            const icms = imposto ? imposto.getElementsByTagName('ICMS')[0] : null;
            const icmsNode = icms
              ? Array.from(icms.children || []).find((child) => child.nodeType === 1)
              : null;
            const ipi = imposto ? imposto.getElementsByTagName('IPI')[0] : null;
            const ipiNode = ipi
              ? ipi.getElementsByTagName('IPITrib')[0] ||
                ipi.getElementsByTagName('IPINT')[0] ||
                ipi
              : null;
            const ii = imposto ? imposto.getElementsByTagName('II')[0] : null;
            const pis = imposto ? imposto.getElementsByTagName('PIS')[0] : null;
            const pisNode = pis
              ? Array.from(pis.children || []).find((child) => child.nodeType === 1)
              : null;
            const cofins = imposto ? imposto.getElementsByTagName('COFINS')[0] : null;
            const cofinsNode = cofins
              ? Array.from(cofins.children || []).find((child) => child.nodeType === 1)
              : null;

            const supplierCode = getText(prod, 'cProd');
            const description = getText(prod, 'xProd');
            const unit = getText(prod, 'uCom');
            const quantityRaw = parseNumber(getText(prod, 'qCom'));
            const quantity = Number.isFinite(quantityRaw) ? quantityRaw : 0;
            const unitPriceRaw = parseNumber(getText(prod, 'vUnCom'));
            const unitPrice = Number.isFinite(unitPriceRaw) ? unitPriceRaw : 0;
            const discountRaw = parseNumber(getText(prod, 'vDesc'));
            const discount = Number.isFinite(discountRaw) ? discountRaw : 0;
            const totalRaw = parseNumber(getText(prod, 'vProd'));
            const total = Number.isFinite(totalRaw) ? totalRaw : quantity * unitPrice;
            const ncm = getText(prod, 'NCM');
            const cfopItem = getText(prod, 'CFOP');
            const cest = getText(prod, 'CEST');
            const ean = getText(prod, 'cEAN');
            const eanTrib = getText(prod, 'cEANTrib');
            const barcodeCandidates = Array.from(new Set([normalizeGtin(ean), normalizeGtin(eanTrib)].filter(Boolean)));
            const barcodeDisplay = formatGtinDisplay(ean || eanTrib);
            const qTribRaw = parseNumber(getText(prod, 'qTrib'));
            const qTrib = Number.isFinite(qTribRaw) ? qTribRaw : quantity;
            const conversionDivider = Number.isFinite(qTrib) && qTrib > 0 ? qTrib : 1;
            const conversionMultiplier = Number.isFinite(quantity) ? quantity : 1;
            const conversion = Number.isFinite(conversionMultiplier) && Number.isFinite(conversionDivider) && conversionDivider
              ? conversionMultiplier / conversionDivider
              : 1;
            const freightRaw = parseNumber(getText(prod, 'vFrete'));
            const freight = Number.isFinite(freightRaw) ? freightRaw : 0;
            const insuranceRaw = parseNumber(getText(prod, 'vSeg'));
            const insurance = Number.isFinite(insuranceRaw) ? insuranceRaw : 0;
            const otherRaw = parseNumber(getText(prod, 'vOutro'));
            const other = (Number.isFinite(otherRaw) ? otherRaw : 0) + (Number.isFinite(insurance) ? insurance : 0);
            const grossAmount = Number.isFinite(quantity) && Number.isFinite(unitPrice) ? quantity * unitPrice : total;
            const discountPercent =
              Number.isFinite(grossAmount) && grossAmount > 0 ? (discount / grossAmount) * 100 : 0;

            const icmsCst = getText(icmsNode, 'CST') || getText(icmsNode, 'CSOSN') || '';
            const icmsRateRaw = parseNumber(getText(icmsNode, 'pICMS'));
            const icmsRate = Number.isFinite(icmsRateRaw) ? icmsRateRaw : 0;
            const icmsBaseRaw = parseNumber(getText(icmsNode, 'vBC'));
            const icmsBase = Number.isFinite(icmsBaseRaw) ? icmsBaseRaw : 0;
            const icmsValueRaw = parseNumber(getText(icmsNode, 'vICMS'));
            const icmsValue = Number.isFinite(icmsValueRaw) ? icmsValueRaw : 0;
            const ivaRaw = parseNumber(getText(icmsNode, 'pMVAST'));
            const iva = Number.isFinite(ivaRaw) ? ivaRaw : 0;
            const icmsStRateRaw = parseNumber(getText(icmsNode, 'pICMSST'));
            const icmsStRate = Number.isFinite(icmsStRateRaw) ? icmsStRateRaw : 0;
            const icmsStValueRaw = parseNumber(getText(icmsNode, 'vICMSST'));
            const icmsStValue = Number.isFinite(icmsStValueRaw) ? icmsStValueRaw : 0;

            const fcpValueRaw = parseNumber(getText(icmsNode, 'vFCP'));
            const fcpValue = Number.isFinite(fcpValueRaw) ? fcpValueRaw : 0;
            const fcpStValueRaw = parseNumber(getText(icmsNode, 'vFCPST'));
            const fcpStValue = Number.isFinite(fcpStValueRaw) ? fcpStValueRaw : 0;
            const fcpStRetRaw = parseNumber(getText(icmsNode, 'vFCPSTRet'));
            const fcpStRetainedValue = Number.isFinite(fcpStRetRaw) ? fcpStRetRaw : 0;

            const ipiRateRaw = parseNumber(getText(ipiNode, 'pIPI'));
            const ipiRate = Number.isFinite(ipiRateRaw) ? ipiRateRaw : 0;
            const ipiBaseRaw = parseNumber(getText(ipiNode, 'vBC'));
            const ipiBase = Number.isFinite(ipiBaseRaw) ? ipiBaseRaw : 0;
            const ipiValueRaw = parseNumber(getText(ipiNode, 'vIPI'));
            const ipiValue = Number.isFinite(ipiValueRaw) ? ipiValueRaw : 0;
            const ipiCst = getText(ipiNode, 'CST') || getText(ipi, 'CST') || '';

            const iiValueRaw = parseNumber(getText(ii, 'vII'));
            const iiValue = Number.isFinite(iiValueRaw) ? iiValueRaw : 0;

            const pisRateRaw = parseNumber(getText(pisNode, 'pPIS'));
            const pisRate = Number.isFinite(pisRateRaw) ? pisRateRaw : 0;
            const pisBaseRaw = parseNumber(getText(pisNode, 'vBC'));
            const pisBase = Number.isFinite(pisBaseRaw) ? pisBaseRaw : 0;
            const pisValueRaw = parseNumber(getText(pisNode, 'vPIS'));
            const pisValue = Number.isFinite(pisValueRaw) ? pisValueRaw : 0;

            const cofinsRateRaw = parseNumber(getText(cofinsNode, 'pCOFINS'));
            const cofinsRate = Number.isFinite(cofinsRateRaw) ? cofinsRateRaw : 0;
            const cofinsBaseRaw = parseNumber(getText(cofinsNode, 'vBC'));
            const cofinsBase = Number.isFinite(cofinsBaseRaw) ? cofinsBaseRaw : 0;
            const cofinsValueRaw = parseNumber(getText(cofinsNode, 'vCOFINS'));
            const cofinsValue = Number.isFinite(cofinsValueRaw) ? cofinsValueRaw : 0;

            const itemData = {
              index,
              nItem: detElement.getAttribute('nItem') || String(index + 1),
              supplierCode,
              description,
              unit,
              quantity,
              unitPrice,
              discount,
              total,
              ncm,
              cfop: cfopItem,
              cest,
              cst: icmsCst,
              icmsRate,
              icmsBase,
              icmsValue,
              iva,
              icmsStRate,
              icmsStValue,
              fcpValue,
              fcpStValue,
              fcpStRetainedValue,
              ipiRate,
              ipiBase,
              ipiValue,
              ipiCst,
              iiValue,
              pisRate,
              pisBase,
              pisValue,
              cofinsRate,
              cofinsBase,
              cofinsValue,
              freight,
              other,
              barcodeDisplay,
              barcodeCandidates,
              unitTrib: getText(prod, 'uTrib'),
              qTrib,
              discountPercent,
              ean,
              eanTrib,
              conversionMultiplier: Number.isFinite(conversionMultiplier) ? conversionMultiplier : 1,
              conversionDivider: Number.isFinite(conversionDivider) ? conversionDivider : 1,
              conversion: Number.isFinite(conversion) ? conversion : 1,
              originalConversionFactor: Number.isFinite(conversion) ? conversion : null,
              validationStatus: barcodeCandidates.length ? 'pending' : 'no-barcode',
              matchedProduct: null,
            };
            ensureItemCostWithTaxes(itemData);
            return itemData;
          });
          const cfop = items.find((item) => item.cfop)?.cfop || '';
          const addressFrom = (element) => {
            if (!element) return {};
            return {
              street: getText(element, 'xLgr'),
              number: getText(element, 'nro'),
              complement: getText(element, 'xCpl'),
              neighborhood: getText(element, 'xBairro'),
              city: getText(element, 'xMun'),
              state: getText(element, 'UF'),
              cep: getText(element, 'CEP'),
              country: getText(element, 'xPais') || 'Brasil',
            };
          };

          const duplicatesFromXml = dupElements.map((dup, index) => ({
            index,
            number: getText(dup, 'nDup'),
            dueDate: getText(dup, 'dVenc'),
            value: toNumeric(getText(dup, 'vDup')),
          }));

          const payments = detPagElements.map((detPag, index) => {
            const cardNode = detPag.getElementsByTagName('card')[0] || null;
            const methodCode = getText(detPag, 'tPag');
            const rawDueDate = getText(detPag, 'dVenc');
            let termDays = null;
            const emissionInfo = normalizeDate(emissionDate);
            const paymentDueInfo = normalizeDate(rawDueDate);
            if (emissionInfo.dateInput && paymentDueInfo.dateInput) {
              const diff = computeDateDiffInDays(emissionInfo.dateInput, paymentDueInfo.dateInput);
              if (Number.isFinite(diff)) {
                termDays = diff;
              }
            }
            const payment = {
              index,
              method: methodCode,
              description: describePaymentMethod(methodCode),
              type: getText(detPag, 'indPag'),
              dueDate: rawDueDate,
              amount: toNumeric(getText(detPag, 'vPag')),
              integrationType: getText(cardNode, 'tpIntegra'),
              cardCnpj: getText(cardNode, 'CNPJ'),
              cardBrand: getText(cardNode, 'tBand'),
              termDays: Number.isFinite(termDays) ? termDays : null,
            };
            return payment;
          });

          let duplicates = duplicatesFromXml.length
            ? duplicatesFromXml
            : payments.map((payment) => ({
                index: payment.index,
                number: '',
                dueDate: payment.dueDate,
                value: payment.amount,
                paymentMethod: payment.method,
                paymentDescription: payment.description,
                paymentType: payment.type,
                termDays: payment.termDays,
              }));

          const emissionInfo = normalizeDate(emissionDate);
          const entryInfo = normalizeDate(entryDate);
          const fallbackBaseDateInput = entryInfo.dateInput || emissionInfo.dateInput || '';
          const paymentByIndex = new Map();
          payments.forEach((payment) => {
            const paymentIndex = Number.isFinite(payment.index) ? payment.index : paymentByIndex.size;
            paymentByIndex.set(paymentIndex, payment);
          });

          duplicates = duplicates.map((duplicate, position) => {
            const resolvedIndex = Number.isFinite(duplicate?.index) ? duplicate.index : position;
            const paymentRef = paymentByIndex.get(resolvedIndex) || paymentByIndex.get(position) || null;

            let amountValue = toNumeric(duplicate?.value);
            if (!Number.isFinite(amountValue) || Math.abs(amountValue) <= 0) {
              const paymentAmount = toNumeric(paymentRef?.amount);
              if (Number.isFinite(paymentAmount)) {
                amountValue = paymentAmount;
              }
            }

            let termDays = Number.isFinite(duplicate?.termDays) ? duplicate.termDays : null;
            if (!Number.isFinite(termDays) && Number.isFinite(paymentRef?.termDays)) {
              termDays = paymentRef.termDays;
            }

            let dueDateValue = duplicate?.dueDate || paymentRef?.dueDate || '';
            const dueInfo = normalizeDate(dueDateValue);
            if (!Number.isFinite(termDays) && emissionInfo.dateInput && dueInfo.dateInput) {
              const diff = computeDateDiffInDays(emissionInfo.dateInput, dueInfo.dateInput);
              if (Number.isFinite(diff)) {
                termDays = diff;
              }
            }

            if ((!dueInfo.dateInput || !dueDateValue) && fallbackBaseDateInput) {
              let fallbackDays = Number.isFinite(termDays) ? termDays : null;
              if (!Number.isFinite(fallbackDays)) {
                if (Number.isFinite(paymentRef?.termDays)) {
                  fallbackDays = paymentRef.termDays;
                } else {
                  const paymentType = paymentRef?.type;
                  if (paymentType === '0') {
                    fallbackDays = 0;
                  } else if (paymentType === '1' || paymentType === '2') {
                    fallbackDays = (position + 1) * 30;
                  } else {
                    fallbackDays = position === 0 ? 0 : position * 30;
                  }
                }
              }
              if (Number.isFinite(fallbackDays)) {
                dueDateValue = addDaysToDateInput(fallbackBaseDateInput, fallbackDays);
                if (!Number.isFinite(termDays)) {
                  termDays = fallbackDays;
                }
              }
            }

            const normalizedDue = normalizeDate(dueDateValue);
            let resolvedTermDays = Number.isFinite(termDays) ? termDays : null;
            if (!Number.isFinite(resolvedTermDays) && emissionInfo.dateInput && normalizedDue.dateInput) {
              const diff = computeDateDiffInDays(emissionInfo.dateInput, normalizedDue.dateInput);
              if (Number.isFinite(diff)) {
                resolvedTermDays = diff;
              }
            }

            const numberLabel = duplicate?.number || paymentRef?.number || `Parcela ${position + 1}`;
            const resolvedDueInput = normalizedDue.dateInput || dueDateValue || '';

            return {
              index: resolvedIndex,
              number: numberLabel,
              dueDate: resolvedDueInput,
              originalDueDate: resolvedDueInput,
              manualDueDate: duplicate?.manualDueDate || '',
              value: Number.isFinite(amountValue) ? amountValue : null,
              paymentMethod: duplicate?.paymentMethod || paymentRef?.method || '',
              paymentDescription:
                duplicate?.paymentDescription || paymentRef?.description || describePaymentMethod(paymentRef?.method),
              paymentType: duplicate?.paymentType || paymentRef?.type || '',
              termDays: Number.isFinite(resolvedTermDays) ? resolvedTermDays : null,
              bankAccount: duplicate?.bankAccount || null,
            };
          });

          const references = nfRefElements
            .map((ref) => {
              const key = getText(ref, 'refNFe');
              if (key) {
                return {
                  type: 'NF-e referenciada',
                  model: '55',
                  accessKey: key,
                };
              }
              const refNF = ref.getElementsByTagName('refNF')[0];
              if (refNF) {
                return {
                  type: 'NF modelo 1/1A',
                  model: getText(refNF, 'mod'),
                  series: getText(refNF, 'serie'),
                  number: getText(refNF, 'nNF'),
                  emissionDate: getText(refNF, 'dEmi'),
                  issuerUf: getText(refNF, 'UF'),
                };
              }
              const refNFP = ref.getElementsByTagName('refNFP')[0];
              if (refNFP) {
                return {
                  type: 'NF produtor rural',
                  model: getText(refNFP, 'mod'),
                  series: getText(refNFP, 'serie'),
                  number: getText(refNFP, 'nNF'),
                  emissionDate: getText(refNFP, 'dEmi'),
                  issuerUf: getText(refNFP, 'UF'),
                  document: getText(refNFP, 'CPF') || getText(refNFP, 'CNPJ'),
                };
              }
              const refCTe = getText(ref, 'refCTe');
              if (refCTe) {
                return {
                  type: 'CT-e referenciado',
                  model: '57',
                  accessKey: refCTe,
                };
              }
              const refECF = ref.getElementsByTagName('refECF')[0];
              if (refECF) {
                return {
                  type: 'ECF referenciado',
                  model: getText(refECF, 'mod'),
                  number: getText(refECF, 'nECF'),
                  coo: getText(refECF, 'nCOO'),
                  series: getText(refECF, 'nserie'),
                };
              }
              return null;
            })
            .filter(Boolean);

          const totalsData = {
            totalValue: getText(total, 'vNF'),
            products: getText(total, 'vProd'),
            icmsBase: getText(total, 'vBC'),
            icmsValue: getText(total, 'vICMS'),
            icmsSt: getText(total, 'vST'),
            fcp: getText(total, 'vFCP'),
            fcpSt: getText(total, 'vFCPST'),
            fcpStRet: getText(total, 'vFCPSTRet'),
            discount: getText(total, 'vDesc'),
            other: getText(total, 'vOutro'),
            freight: getText(total, 'vFrete'),
            ipi: getText(total, 'vIPI'),
            ii: getText(total, 'vII'),
            insurance: getText(total, 'vSeg'),
            services: getText(total, 'vServ'),
          };

          alignItemsWithTotals(items, totalsData);

          return {
            accessKey,
            ambient: getText(ide, 'tpAmb'),
            ide: {
              number: getText(ide, 'nNF'),
              serie: getText(ide, 'serie'),
              emissionDate,
              entryDate,
              natOp: getText(ide, 'natOp'),
              model: getText(ide, 'mod'),
              tpNF: getText(ide, 'tpNF'),
              tpEmis: getText(ide, 'tpEmis'),
              cfop,
              freightMode: getText(transp, 'modFrete'),
            },
            emit: {
              name: getText(emit, 'xNome'),
              fantasyName: getText(emit, 'xFant'),
              document: getText(emit, 'CNPJ') || getText(emit, 'CPF'),
              stateRegistration: getText(emit, 'IE'),
              email: getText(emit, 'email'),
              phone: getText(emit, 'fone'),
              address: addressFrom(emit?.getElementsByTagName('enderEmit')[0]),
            },
            dest: {
              name: getText(dest, 'xNome') || getText(dest, 'xFant'),
              document: getText(dest, 'CNPJ') || getText(dest, 'CPF'),
              stateRegistration: getText(dest, 'IE'),
              indIEDest: getText(dest, 'indIEDest'),
              email: getText(dest, 'email'),
              phone: getText(dest, 'fone'),
              address: addressFrom(dest?.getElementsByTagName('enderDest')[0]),
            },
            totals: totalsData,
            protocol: {
              number: getText(infProt, 'nProt'),
              receivedAt: getText(infProt, 'dhRecbto'),
              status: getText(infProt, 'cStat'),
            },
            transport: {
              mode: getText(transp, 'modFrete'),
              transporter: {
                name: getText(transporta, 'xNome'),
                document: getText(transporta, 'CNPJ') || getText(transporta, 'CPF'),
                stateRegistration: getText(transporta, 'IE'),
                uf: getText(transporta, 'UF'),
              },
              vehicle: {
                plate: getText(veicTransp, 'placa'),
                uf: getText(veicTransp, 'UF'),
              },
              volume: {
                quantity: getText(volElement, 'qVol'),
                species: getText(volElement, 'esp'),
                brand: getText(volElement, 'marca'),
                number: getText(volElement, 'nVol'),
                weightGross: getText(volElement, 'pesoB'),
                weightNet: getText(volElement, 'pesoL'),
              },
            },
            additionalInfo: {
              complementary: getText(infAdic, 'infCpl'),
              fiscal: getText(infAdic, 'infAdFisco'),
            },
            payments,
            duplicates,
            references,
            items,
          };
        };

        const processXmlFile = (file) => {
          if (!file) return;
          clearStatusMessages();
          productSupplierLinkCache.clear();
          productSupplierLinkPromises.clear();
          supplierReferenceLookupCache.clear();
          supplierReferenceLookupPromises.clear();
          supplierLinkErrorNotified = false;
          const extension = file.name.split('.').pop()?.toLowerCase();
          if (extension !== 'xml') {
            showFileFeedback('Selecione um arquivo XML autorizado pela SEFAZ (extensão .xml).', 'error');
            return;
          }
          showFileFeedback(`Lendo o arquivo ${file.name}...`, 'info');
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              const result =
                typeof reader.result === 'string'
                  ? reader.result
                  : typeof TextDecoder !== 'undefined'
                  ? new TextDecoder('utf-8').decode(reader.result)
                  : '';
              if (!result) {
                throw new Error('Não foi possível interpretar o conteúdo do XML informado.');
              }
              const parsed = parseNfeXml(result);
              parsed.selectedBankAccountId = bankAccountSelect ? bankAccountSelect.value || '' : '';
              lastNfeData = parsed;
              updateSummaryFromData(parsed);
              showFileFeedback('Validando fornecedor importado...', 'info');
              await handleSupplierSelection(parsed.emit);
              showFileFeedback('Validando produtos pelo fornecedor e código de barras...', 'info');
              await validateImportedProducts(parsed);

              const nfNumberText = parsed.ide?.number ? `NF ${parsed.ide.number}` : 'NF-e';
              const emitterText = parsed.emit?.name || 'Emitente não identificado';
              const baseMessage = `XML importado com sucesso. ${nfNumberText} - ${emitterText}.`;
              const items = Array.isArray(parsed.items) ? parsed.items : [];
              const errorCount = items.filter((item) => item.validationStatus === 'error').length;
              const unmatchedCount = items.filter((item) => item.validationStatus === 'not-found').length;

              if (errorCount > 0) {
                const suffix = errorCount === 1 ? '' : 's';
                showFileFeedback(
                  `${baseMessage} Não foi possível validar ${errorCount} item${suffix} devido a uma falha na consulta.`,
                  'warning'
                );
              } else if (unmatchedCount > 0) {
                const suffix = unmatchedCount === 1 ? '' : 's';
                showFileFeedback(
                  `${baseMessage} ${unmatchedCount} produto${suffix} precisa${suffix ? 'm' : ''} ser cadastrado pelo código de barras.`,
                  'warning'
                );
              } else {
                showFileFeedback(baseMessage, 'success');
              }
            } catch (error) {
              console.error('Erro ao processar XML da NF-e:', error);
              showFileFeedback(error.message || 'Não foi possível processar o XML informado.', 'error');
            }
          };
          reader.onerror = () => {
            console.error('Erro ao ler o arquivo XML selecionado.', reader.error);
            showFileFeedback('Não foi possível ler o arquivo XML selecionado.', 'error');
          };
          reader.readAsText(file);
        };

        function trapFocus(event) {
          if (!importModal || importModal.classList.contains('hidden')) return;
          if (productIframeModal && !productIframeModal.classList.contains('hidden')) return;
          if (event.key !== 'Tab') return;

          const focusableElements = importModalCard
            ? Array.from(importModalCard.querySelectorAll(MODAL_FOCUSABLE_SELECTORS)).filter(
                (element) => element instanceof HTMLElement && element.offsetParent !== null
              )
            : [];
          if (focusableElements.length === 0) return;

          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          if (event.shiftKey && document.activeElement === firstElement) {
            event.preventDefault();
            lastElement.focus();
          } else if (!event.shiftKey && document.activeElement === lastElement) {
            event.preventDefault();
            firstElement.focus();
          }
        }

        function openImportModal() {
          previouslyFocusedElement = document.activeElement;
          importModal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');

          if (importModalCard) {
            importModalCard.classList.add('opacity-0', 'scale-95');
            requestAnimationFrame(() => {
              importModalCard.classList.remove('opacity-0', 'scale-95');
              importModalCard.classList.add('opacity-100', 'scale-100');
            });

            const focusableElements = importModalCard.querySelectorAll(MODAL_FOCUSABLE_SELECTORS);
            if (focusableElements.length) {
              focusableElements[0].focus();
            }
          }

          document.addEventListener('keydown', trapFocus);
        }

        function closeImportModal() {
          if (importModalCard) {
            importModalCard.classList.remove('opacity-100', 'scale-100');
            importModalCard.classList.add('opacity-0', 'scale-95');
          }

          if (!productIframeModal || productIframeModal.classList.contains('hidden')) {
            document.body.classList.remove('overflow-hidden');
          }
          document.removeEventListener('keydown', trapFocus);

          setTimeout(() => {
            importModal.classList.add('hidden');
            if (previouslyFocusedElement && typeof previouslyFocusedElement.focus === 'function') {
              previouslyFocusedElement.focus();
            }
          }, 180);
        }

        function activateImportTab(tabId) {
          importTabButtons.forEach((button) => {
            const isActive = button.dataset.importTab === tabId;
            button.classList.toggle('active', isActive);
            button.classList.toggle('bg-primary/10', isActive);
            button.classList.toggle('text-primary', isActive);
            button.classList.toggle('border', true);
            button.classList.toggle('border-transparent', isActive);
            button.classList.toggle('border-gray-200', !isActive);
            button.classList.toggle('text-gray-600', !isActive);
            button.classList.add('inline-flex', 'items-center', 'gap-2', 'rounded-lg', 'px-3', 'py-2', 'text-xs', 'font-semibold', 'transition');
          });

          importTabPanels.forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.importTabPanel !== tabId);
          });
        }

        function updateImportMode() {
          const selectedRadio = importModal.querySelector('input[name="import-mode"]:checked');
          const selectedValue = selectedRadio ? selectedRadio.value : null;

          importModePanels.forEach((panel) => {
            const isActive = panel.dataset.importModePanel === selectedValue;
            panel.classList.toggle('hidden', !isActive);
          });

          clearStatusMessages();

          if (importFileInput) {
            importFileInput.value = '';
          }
        }

        openImportModalButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            openImportModal();
            activateImportTab('xml');
            updateImportMode();
          });
        });

        closeImportModalButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            closeImportModal();
          });
        });

        importModal.addEventListener('click', (event) => {
          const target = event.target;
          if (target instanceof Element && target.hasAttribute('data-close-import-modal')) {
            closeImportModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            if (productIframeModal && !productIframeModal.classList.contains('hidden')) {
              return;
            }
            if (!importModal.classList.contains('hidden')) {
              closeImportModal();
            }
          }
        });

        if (refreshImportedProductsButton) {
          refreshImportedProductsButton.addEventListener('click', (event) => {
            event.preventDefault();
            refreshImportedProductsList();
          });
        }

        if (companySelect) {
          companySelect.addEventListener('change', () => {
            refreshBankAccountOptions({ preserveSelection: false }).catch(() => {});
          });
        }

        if (bankAccountSelect) {
          bankAccountSelect.addEventListener('change', () => {
            if (lastNfeData && Array.isArray(lastNfeData.duplicates)) {
              lastNfeData.selectedBankAccountId = bankAccountSelect.value || '';
            }
            syncBankAccountWithDuplicates();
          });
        }

        if (duplicatasTableBody) {
          duplicatasTableBody.addEventListener('change', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) return;
            if (target.dataset.duplicateDueInput !== 'true') return;

            const index = Number.parseInt(target.dataset.duplicateIndex || '', 10);
            if (!Number.isFinite(index)) return;
            if (!lastNfeData || !Array.isArray(lastNfeData.duplicates)) return;
            const duplicate = lastNfeData.duplicates[index];
            if (!duplicate || typeof duplicate !== 'object') return;

            const newDueValue = target.value || '';
            duplicate.manualDueDate = newDueValue || '';

            if (newDueValue) {
              duplicate.dueDate = newDueValue;
            } else if (duplicate.originalDueDate) {
              duplicate.dueDate = duplicate.originalDueDate;
            }

            const emissionInfo = normalizeDate(lastNfeData?.ide?.emissionDate);
            const entryInfo = normalizeDate(lastNfeData?.ide?.entryDate);
            const baseDateInput = emissionInfo.dateInput || entryInfo.dateInput || '';
            const effectiveDueInput = duplicate.dueDate || '';

            let computedTerm = null;
            if (baseDateInput && effectiveDueInput) {
              const diff = computeDateDiffInDays(baseDateInput, effectiveDueInput);
              if (Number.isFinite(diff)) {
                computedTerm = diff;
              }
            }
            duplicate.termDays = Number.isFinite(computedTerm) ? computedTerm : null;

            const row = target.closest('tr');
            if (row) {
              const daysCell = row.querySelector('[data-duplicate-term]');
              if (daysCell) {
                const fallbackDiff = baseDateInput && effectiveDueInput
                  ? computeDateDiffInDays(baseDateInput, effectiveDueInput)
                  : null;
                daysCell.textContent = Number.isFinite(duplicate.termDays)
                  ? String(duplicate.termDays)
                  : Number.isFinite(fallbackDiff)
                  ? String(fallbackDiff)
                  : '—';
              }
            }

            updateDuplicataSummaryFromData(lastNfeData);
          });
        }

        if (clearImportButton) {
          clearImportButton.addEventListener('click', (event) => {
            event.preventDefault();
            try {
              resetImportedNfeState();
              notify('Campos limpos. Pronto para uma nova importação.', 'info');
            } catch (error) {
              console.error('Erro ao limpar os dados importados da nota:', error);
              notify('Não foi possível limpar os dados importados. Atualize a página e tente novamente.', 'error');
            }
          });
        }

        importTabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            activateImportTab(button.dataset.importTab);
          });
        });

        importModeRadios.forEach((radio) => {
          radio.addEventListener('change', updateImportMode);
        });

        if (importFilePanel && importFileInput) {
          const toggleHover = (isActive) => {
            importFilePanel.classList.toggle('border-primary/60', isActive);
            importFilePanel.classList.toggle('bg-primary/5', isActive);
          };

          ['dragenter', 'dragover'].forEach((eventName) => {
            importFilePanel.addEventListener(eventName, (event) => {
              event.preventDefault();
              toggleHover(true);
            });
          });

          ['dragleave', 'dragend'].forEach((eventName) => {
            importFilePanel.addEventListener(eventName, (event) => {
              event.preventDefault();
              toggleHover(false);
            });
          });

          importFilePanel.addEventListener('drop', (event) => {
            event.preventDefault();
            toggleHover(false);
            if (!event.dataTransfer) return;
            const [file] = event.dataTransfer.files;
            if (file) {
              importFileInput.files = event.dataTransfer.files;
              processXmlFile(file);
            } else {
              clearStatusMessages();
            }
          });

          importFileInput.addEventListener('change', () => {
            const file = importFileInput.files && importFileInput.files[0];
            if (file) {
              processXmlFile(file);
            } else {
              clearStatusMessages();
            }
          });
        }

        const confirmImportButton = importModal.querySelector('[data-confirm-import]');
        if (confirmImportButton) {
          confirmImportButton.addEventListener('click', (event) => {
            event.preventDefault();
            if (!lastNfeData) {
              notify('Importe um XML autorizado antes de aplicar os dados na nota.', 'warning');
              return;
            }

            const items = Array.isArray(lastNfeData.items) ? lastNfeData.items : [];
            if (!items.length) {
              notify('O XML informado não possui itens para importar.', 'warning');
              return;
            }

            const unresolvedItems = items.filter(
              (item) => item?.validationStatus !== 'matched' || !item?.matchedProduct
            );
            if (unresolvedItems.length) {
              notify(
                'Existem produtos sem cadastro confirmado. Cadastre ou vincule todos os itens antes de importar.',
                'warning'
              );
              return;
            }

            try {
              applyImportedDataToMainForm(lastNfeData);
              notify('Dados do XML aplicados à entrada da nota.', 'success');
              closeImportModal();
            } catch (error) {
              console.error('Erro ao aplicar dados importados na nota:', error);
              notify('Não foi possível aplicar os dados do XML na nota. Tente novamente.', 'error');
            }
          });
        }

        indexExistingSupplierOptions();
        loadSuppliersFromApi().catch(() => {});
        refreshBankAccountOptions({ preserveSelection: true }).catch(() => {});

        window.addEventListener('focus', () => {
          const now = Date.now();
          if (now - supplierRegistry.lastLoadedAt > 15000) {
            loadSuppliersFromApi(true).catch(() => {});
          }
        });

        updateSummaryFromData(null);
        setSupplierSummary(null);
        applyValidationStyles('info');
        activateImportTab('pending');
        updateImportMode();
      }
    });
  </script>
</body>
</html>
