(function () {
  const state = {
    stores: [],
    deposits: [],
    responsaveis: [],
    items: [],
    selectedProduct: null,
    currentTransferId: null,
    currentTransferStatus: null,
    currentTransferNumber: null,
    isReadOnly: false,
    autoGeneratedNumber: null,
    isLoadingTransfer: false,
  };

  const selectors = {
    form: document.getElementById('transfer-form'),
    numberInput: document.getElementById('transfer-number'),
    dateInput: document.getElementById('transfer-date'),
    originCompany: document.getElementById('origin-company'),
    originDeposit: document.getElementById('transfer-origin'),
    destinationCompany: document.getElementById('destination-company'),
    destinationDeposit: document.getElementById('transfer-destination'),
    responsibleInput: document.getElementById('transfer-responsible-search'),
    responsibleId: document.getElementById('transfer-responsible'),
    responsibleDataList: document.getElementById('responsible-list'),
    referenceInput: document.getElementById('transfer-reference'),
    notesInput: document.getElementById('transfer-notes'),
    vehicleInput: document.getElementById('transfer-vehicle'),
    driverInput: document.getElementById('transfer-driver'),
    itemsTableBody: document.getElementById('transfer-items-body'),
    totalVolume: document.getElementById('transfer-total-volume'),
    totalWeight: document.getElementById('transfer-total-weight'),
    totalValue: document.getElementById('transfer-total-value'),
    totalSale: document.getElementById('transfer-total-sale'),
    saveButton: document.getElementById('transfer-save-button'),
    clearButton: document.getElementById('transfer-clear-button'),
    transportMode: document.getElementById('transfer-transport'),
    selectedProductContainer: document.getElementById('transfer-selected-product'),
    selectedProductName: document.getElementById('transfer-selected-product-name'),
    selectedProductSku: document.getElementById('transfer-selected-product-sku'),
    selectedProductBarcode: document.getElementById('transfer-selected-product-barcode'),
    selectedProductUnit: document.getElementById('transfer-selected-product-unit'),
    selectedOriginDeposit: document.getElementById('transfer-selected-product-origin-deposit'),
    selectedDestinationDeposit: document.getElementById('transfer-selected-product-destination-deposit'),
    selectedOriginStock: document.getElementById('transfer-selected-product-origin-stock'),
    selectedDestinationStock: document.getElementById('transfer-selected-product-destination-stock'),
    selectedOriginCost: document.getElementById('transfer-selected-product-origin-cost'),
    selectedDestinationCost: document.getElementById('transfer-selected-product-destination-cost'),
    selectedOriginSale: document.getElementById('transfer-selected-product-origin-sale'),
    selectedDestinationSale: document.getElementById('transfer-selected-product-destination-sale'),
    selectedOriginUnit: document.getElementById('transfer-selected-product-origin-unit'),
    selectedDestinationUnit: document.getElementById('transfer-selected-product-destination-unit'),
    selectedProductQuantity: document.getElementById('transfer-selected-product-quantity'),
    selectedProductAddButton: document.getElementById('transfer-selected-product-add'),
    selectedProductClearButton: document.getElementById('transfer-selected-product-clear'),
    selectedProductWarning: document.getElementById('transfer-selected-product-warning'),
  };

  const productSearchSelectors = {
    input: document.getElementById('transfer-item-search'),
    results: document.getElementById('transfer-item-results'),
  };

  const searchState = {
    timeout: null,
    controller: null,
    lastResults: [],
    hideTimeout: null,
  };

  function showProductResults() {
    const container = productSearchSelectors.results;
    if (!container) return;
    if (searchState.hideTimeout) {
      clearTimeout(searchState.hideTimeout);
      searchState.hideTimeout = null;
    }
    container.classList.remove('hidden');
  }

  function hideProductResults() {
    const container = productSearchSelectors.results;
    if (!container) return;
    container.classList.add('hidden');
  }

  function renderProductSearchMessage(message, type = 'neutral', options = {}) {
    if (!productSearchSelectors.results) return;

    const { show = true } = options;

    let classes = 'px-4 py-3 text-sm text-gray-600';
    if (type === 'loading') {
      classes = 'flex items-center gap-2 px-4 py-3 text-sm text-primary-600';
    } else if (type === 'error') {
      classes = 'px-4 py-3 text-sm text-red-600';
    } else if (type === 'info') {
      classes = 'px-4 py-3 text-sm text-amber-600';
    }

    productSearchSelectors.results.dataset.state = 'message';
    productSearchSelectors.results.innerHTML = `<div class="max-h-80 overflow-y-auto"><div class="${classes}">${message}</div></div>`;

    if (show) {
      showProductResults();
    }
  }

  const allowedRolesLabels = {

    admin: 'Admin',

    admin_master: 'Admin Master',

    funcionario: 'Funcionário',

    franqueado: 'Franqueado',

    franqueador: 'Franqueador',

  };

  function getToken() {
    try {
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      return loggedInUser?.token || '';
    } catch (error) {
      console.warn('Não foi possível obter o token de autenticação.', error);
      return '';
    }
  }

  function formatCnpj(value) {
    const digits = String(value || '').replace(/\D/g, '');
    if (digits.length !== 14) return '';
    return `${digits.slice(0, 2)}.${digits.slice(2, 5)}.${digits.slice(5, 8)}/${digits.slice(8, 12)}-${digits.slice(12)}`;
  }

  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatCurrency(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return 'R$ 0,00';
    }
    return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function normalizeFiniteNumber(value) {
    if (value === null || value === undefined) {
      return null;
    }

    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) {
        return null;
      }
      const normalizedString = trimmed.includes(',')
        ? trimmed.replace(/\./g, '').replace(',', '.')
        : trimmed;
      const normalized = Number(normalizedString);
      return Number.isFinite(normalized) ? normalized : null;
    }

    const number = Number(value);
    return Number.isFinite(number) ? number : null;
  }

  function formatWeight(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return '0 kg';
    }
    return `${number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg`;
  }

  function formatQuantityDisplay(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return '0';
    }
    if (Number.isInteger(number)) {
      return number.toLocaleString('pt-BR');
    }
    return number.toLocaleString('pt-BR', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 3,
    });
  }

  function getDepositNameById(id) {
    if (!id) return '';
    const deposit = state.deposits.find((item) => String(item._id) === String(id));
    return deposit?.nome || '';
  }

  function findStockForDeposit(stocks, depositId) {
    if (!depositId || !Array.isArray(stocks)) return null;
    return stocks.find((stock) => String(stock.depositId) === String(depositId));
  }

  function toggleSelectedProductWarning(show) {
    const warning = selectors.selectedProductWarning;
    if (!warning) return;
    warning.classList.toggle('hidden', !show);
  }

  function renderSelectedProduct() {
    const container = selectors.selectedProductContainer;
    if (!container) return;

    if (state.isReadOnly) {
      container.classList.add('hidden');
      toggleSelectedProductWarning(false);
      return;
    }

    const product = state.selectedProduct;
    if (!product) {
      container.classList.add('hidden');
      toggleSelectedProductWarning(false);
      return;
    }

    container.classList.remove('hidden');

    if (selectors.selectedProductName) {
      selectors.selectedProductName.textContent = product.description || 'Produto sem descrição';
    }
    if (selectors.selectedProductSku) {
      selectors.selectedProductSku.textContent = product.sku || '—';
    }
    if (selectors.selectedProductBarcode) {
      selectors.selectedProductBarcode.textContent = product.barcode || '—';
    }
    if (selectors.selectedProductUnit) {
      selectors.selectedProductUnit.textContent = product.unit || '—';
    }

    const originDepositId = selectors.originDeposit?.value || '';
    const destinationDepositId = selectors.destinationDeposit?.value || '';

    if (selectors.selectedOriginDeposit) {
      const originName = getDepositNameById(originDepositId);
      selectors.selectedOriginDeposit.textContent = originName || 'Selecione o depósito';
    }
    if (selectors.selectedDestinationDeposit) {
      const destinationName = getDepositNameById(destinationDepositId);
      selectors.selectedDestinationDeposit.textContent = destinationName || 'Selecione o depósito';
    }

    const originStock = findStockForDeposit(product.stocks, originDepositId);
    const destinationStock = findStockForDeposit(product.stocks, destinationDepositId);

    if (selectors.selectedOriginStock) {
      selectors.selectedOriginStock.textContent = formatQuantityDisplay(originStock?.quantity || 0);
    }
    if (selectors.selectedDestinationStock) {
      selectors.selectedDestinationStock.textContent = formatQuantityDisplay(destinationStock?.quantity || 0);
    }

    const costText = formatCurrency(product.unitCost);
    const saleText = formatCurrency(product.unitSale);

    if (selectors.selectedOriginCost) {
      selectors.selectedOriginCost.textContent = costText;
    }
    if (selectors.selectedDestinationCost) {
      selectors.selectedDestinationCost.textContent = costText;
    }
    if (selectors.selectedOriginSale) {
      selectors.selectedOriginSale.textContent = saleText;
    }
    if (selectors.selectedDestinationSale) {
      selectors.selectedDestinationSale.textContent = saleText;
    }

    if (selectors.selectedOriginUnit) {
      selectors.selectedOriginUnit.textContent = originStock?.unit || product.unit || '—';
    }
    if (selectors.selectedDestinationUnit) {
      selectors.selectedDestinationUnit.textContent = destinationStock?.unit || product.unit || '—';
    }

    toggleSelectedProductWarning(!originDepositId || !destinationDepositId);
  }

  function clearSelectedProduct() {
    state.selectedProduct = null;
    if (selectors.selectedProductQuantity) {
      selectors.selectedProductQuantity.value = '1';
    }
    renderSelectedProduct();
  }

  function restoreNumberInputValue() {
    if (!selectors.numberInput) return;
    if (Number.isFinite(state.currentTransferNumber) && state.currentTransferNumber > 0) {
      selectors.numberInput.value = String(state.currentTransferNumber);
      return;
    }
    if (Number.isFinite(state.autoGeneratedNumber) && state.autoGeneratedNumber > 0) {
      selectors.numberInput.value = String(state.autoGeneratedNumber);
      return;
    }
    selectors.numberInput.value = '';
  }

  function setFormReadOnly(isReadOnly) {
    state.isReadOnly = Boolean(isReadOnly);
    if (!selectors.form) return;

    const elements = selectors.form.querySelectorAll('input, select, textarea, button');
    elements.forEach((element) => {
      if (!element || element.id === 'transfer-number' || element.type === 'hidden') {
        return;
      }

      if (!element.dataset.initiallyDisabled) {
        element.dataset.initiallyDisabled = element.disabled ? 'true' : 'false';
      }

      if (state.isReadOnly) {
        element.setAttribute('disabled', 'true');
      } else if (element.dataset.initiallyDisabled !== 'true') {
        element.removeAttribute('disabled');
      }
    });

    if (selectors.saveButton) {
      if (state.isReadOnly) {
        selectors.saveButton.setAttribute('disabled', 'true');
        selectors.saveButton.classList.add('opacity-70', 'cursor-not-allowed');
      } else {
        selectors.saveButton.removeAttribute('disabled');
        selectors.saveButton.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }

    if (state.isReadOnly) {
      clearSelectedProduct();
      resetProductSearch();
    }
  }

  function applyTransferToForm(transfer) {
    if (!transfer) return;

    state.currentTransferId = transfer.id || null;
    state.currentTransferStatus = transfer.status || null;

    const numberValue = Number(transfer.number);
    state.currentTransferNumber = Number.isFinite(numberValue) && numberValue > 0 ? numberValue : null;
    if (selectors.numberInput) {
      selectors.numberInput.value = state.currentTransferNumber ? String(state.currentTransferNumber) : '';
    }
    state.autoGeneratedNumber = null;

    const normalizedStatus = typeof transfer.status === 'string' ? transfer.status.toLowerCase() : '';
    const canEdit = transfer.canEdit !== undefined ? Boolean(transfer.canEdit) : normalizedStatus !== 'aprovada';
    setFormReadOnly(!canEdit);

    if (selectors.dateInput) {
      selectors.dateInput.value = formatDateToInput(transfer.requestDate) || selectors.dateInput.value || '';
    }

    if (selectors.originCompany) {
      selectors.originCompany.value = transfer.originCompany?.id || '';
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
    }
    if (selectors.originDeposit) {
      selectors.originDeposit.value = transfer.originDeposit?.id || '';
    }
    if (selectors.destinationCompany) {
      selectors.destinationCompany.value = transfer.destinationCompany?.id || '';
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
    }
    if (selectors.destinationDeposit) {
      selectors.destinationDeposit.value = transfer.destinationDeposit?.id || '';
    }

    if (selectors.responsibleId) {
      selectors.responsibleId.value = transfer.responsible?.id || '';
    }
    if (selectors.responsibleInput) {
      selectors.responsibleInput.value = transfer.responsible?.name || '';
    }

    if (selectors.referenceInput) {
      selectors.referenceInput.value = transfer.referenceDocument || '';
    }
    if (selectors.notesInput) {
      selectors.notesInput.value = transfer.observations || '';
    }
    if (selectors.vehicleInput) {
      selectors.vehicleInput.value = transfer.transport?.vehicle || '';
    }
    if (selectors.driverInput) {
      selectors.driverInput.value = transfer.transport?.driver || '';
    }
    if (selectors.transportMode && transfer.transport?.mode) {
      const normalizedMode = String(transfer.transport.mode || '').toLowerCase();
      const hasOption = Array.from(selectors.transportMode.options || []).some(
        (option) => option.value === normalizedMode
      );
      selectors.transportMode.value = hasOption ? normalizedMode : selectors.transportMode.value;
    }

    state.items = Array.isArray(transfer.items)
      ? transfer.items.map((item) => ({
          productId: item.productId || null,
          sku: item.sku || '',
          barcode: item.barcode || '',
          description: item.description || item.productName || '',
          quantity: Number(item.quantity) || 0,
          unit: item.unit || '',
          lot: item.lot || '',
          validity: formatDateToInput(item.validity),
          unitCost:
            item.unitCost === null || item.unitCost === undefined ? null : Number(item.unitCost),
          unitSale:
            item.unitSale === null || item.unitSale === undefined ? null : Number(item.unitSale),
          unitWeight:
            item.unitWeight === null || item.unitWeight === undefined ? null : Number(item.unitWeight),
        }))
      : [];

    renderItemsTable();
    clearSelectedProduct();
    resetProductSearch();
  }

  async function fetchNextTransferNumber() {
    if (!selectors.numberInput) return;

    try {
      const token = getToken();
      if (!token) {
        return;
      }

      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/next-number`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data?.message || 'Não foi possível gerar o próximo número da transferência.');
      }

      const number = Number(data?.number);
      if (Number.isFinite(number) && number > 0) {
        state.autoGeneratedNumber = number;
        if (!state.currentTransferId) {
          selectors.numberInput.value = String(number);
        }
      }
    } catch (error) {
      console.error('Erro ao obter próximo número da transferência:', error);
    }
  }

  async function loadTransferByNumber(number) {
    if (state.isLoadingTransfer) return;
    const token = getToken();
    if (!token) {
      showModal({
        title: 'Sessão expirada',
        message: 'Sua sessão expirou. Faça login novamente para continuar.',
        confirmText: 'Fazer login',
        onConfirm: () => window.location.replace('/pages/login.html'),
      });
      return;
    }

    state.isLoadingTransfer = true;

    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/by-number/${number}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        const message = data?.message || 'Não foi possível carregar a transferência informada.';
        throw new Error(message);
      }

      if (!data?.transfer) {
        throw new Error('Transferência não encontrada.');
      }

      applyTransferToForm(data.transfer);
    } catch (error) {
      console.error('Erro ao carregar transferência por número:', error);
      const message = error?.message || 'Não foi possível carregar a transferência informada.';
      const type = /não encontrada/i.test(message) ? 'warning' : 'error';
      showToast(message, type, 4000);
      restoreNumberInputValue();
    } finally {
      state.isLoadingTransfer = false;
    }
  }

  async function handleTransferNumberSearch() {
    if (!selectors.numberInput) return;
    const rawValue = selectors.numberInput.value.trim();

    if (!rawValue) {
      if (state.currentTransferId || state.currentTransferNumber) {
        resetForm();
      } else {
        restoreNumberInputValue();
        if (!state.autoGeneratedNumber) {
          await fetchNextTransferNumber();
        }
      }
      return;
    }

    const number = Number(rawValue);
    if (!Number.isFinite(number) || number <= 0) {
      showToast('Informe um número válido de transferência.', 'warning', 4000);
      restoreNumberInputValue();
      return;
    }

    if (state.currentTransferId && state.currentTransferNumber === number) {
      return;
    }

    if (!state.currentTransferId && state.autoGeneratedNumber === number) {
      return;
    }

    await loadTransferByNumber(number);
  }

  function setTodayDate() {
    const input = selectors.dateInput;
    if (!input || input.value) return;
    const today = new Date();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    input.value = `${today.getFullYear()}-${month}-${day}`;
  }

  function formatDateToInput(value) {
    if (!value) return '';
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) {
      return '';
    }
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${date.getFullYear()}-${month}-${day}`;
  }

  function buildStoreLabel(store) {
    const name = store?.nomeFantasia || store?.nome || 'Empresa sem nome';
    const cnpj = formatCnpj(store?.cnpj);
    return cnpj ? `${name} • CNPJ ${cnpj}` : name;
  }

  function populateCompanySelect(select) {
    if (!select) return;
    const previousValue = select.value;
    select.innerHTML = '<option value="">Selecione</option>';
    state.stores.forEach((store) => {
      const option = document.createElement('option');
      option.value = store._id;
      option.textContent = buildStoreLabel(store);
      select.appendChild(option);
    });
    if (previousValue) {
      select.value = previousValue;
    }
  }

  function updateDepositSelect(companySelect, depositSelect) {
    if (!depositSelect) return;
    const previousValue = depositSelect.value;
    const companyId = companySelect?.value || '';
    depositSelect.innerHTML = '<option value="">Selecione</option>';
    if (!companyId) {
      depositSelect.disabled = true;
      return;
    }

    const availableDeposits = state.deposits.filter((deposit) => String(deposit.empresa) === String(companyId));
    if (!availableDeposits.length) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Nenhum depósito cadastrado para esta empresa';
      option.disabled = true;
      depositSelect.appendChild(option);
      depositSelect.disabled = false;
      depositSelect.value = '';
      return;
    }

    availableDeposits.forEach((deposit) => {
      const option = document.createElement('option');
      option.value = deposit._id;
      option.textContent = deposit.nome || 'Depósito sem nome';
      depositSelect.appendChild(option);
    });

    depositSelect.disabled = false;
    if (previousValue && availableDeposits.some((deposit) => String(deposit._id) === String(previousValue))) {
      depositSelect.value = previousValue;
    }
  }

  function buildResponsibleDisplay(user) {
    const name = user?.nomeCompleto || user?.apelido || user?.email;
    const roleLabel = allowedRolesLabels[user?.role] || 'Colaborador';
    const email = user?.email || '';
    return [name, roleLabel, email].filter(Boolean).join(' • ');
  }

  function populateResponsibleList() {
    const list = selectors.responsibleDataList;
    if (!list) return;
    list.innerHTML = '';
    state.responsaveis.forEach((user) => {
      const option = document.createElement('option');
      option.value = buildResponsibleDisplay(user);
      option.dataset.id = user._id;
      list.appendChild(option);
    });
  }

  function findResponsibleId(displayValue) {
    const list = selectors.responsibleDataList;
    if (!list) return '';
    const value = displayValue?.trim();
    if (!value) return '';
    const options = Array.from(list.options);
    const matched = options.find((option) => option.value === value && option.dataset.id);
    return matched?.dataset.id || '';
  }

  function handleResponsibleInputEvents() {
    if (!selectors.responsibleInput) return;

    selectors.responsibleInput.addEventListener('input', () => {
      selectors.responsibleId.value = '';
    });

    selectors.responsibleInput.addEventListener('change', () => {
      const id = findResponsibleId(selectors.responsibleInput.value);
      selectors.responsibleId.value = id;
      if (!id && selectors.responsibleInput.value) {
        showToast('Selecione um responsável válido a partir da lista sugerida.', 'warning', 4000);
      }
    });
  }

  function updateSummary() {
    const weightTotal = state.items.reduce((sum, item) => {
      const quantity = Number(item.quantity);
      const unitWeight = Number(item.unitWeight);
      if (!Number.isFinite(quantity) || !Number.isFinite(unitWeight)) {
        return sum;
      }
      return sum + quantity * unitWeight;
    }, 0);

    const totals = state.items.reduce(
      (acc, item) => {
        const quantity = Number(item.quantity);
        const unitCost = Number(item.unitCost);
        const unitSale = Number(item.unitSale);

        if (Number.isFinite(quantity)) {
          acc.volume += quantity;

          if (Number.isFinite(unitCost)) {
            acc.cost += quantity * unitCost;
          }

          if (Number.isFinite(unitSale)) {
            acc.sale += quantity * unitSale;
          }
        }

        return acc;
      },
      { volume: 0, cost: 0, sale: 0 }
    );

    if (selectors.totalVolume) {
      selectors.totalVolume.textContent = `${totals.volume.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 })} unidades`;
    }
    if (selectors.totalWeight) {
      selectors.totalWeight.textContent = formatWeight(weightTotal);
    }
    if (selectors.totalValue) {
      selectors.totalValue.textContent = formatCurrency(totals.cost);
    }
    if (selectors.totalSale) {
      selectors.totalSale.textContent = formatCurrency(totals.sale);
    }
  }

  function renderItemsTable() {
    const tbody = selectors.itemsTableBody;
    if (!tbody) return;

    if (!state.items.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-gray-500">Nenhum item adicionado até o momento.</td></tr>';
      updateSummary();
      return;
    }

    const rows = state.items.map((item, index) => {
      const quantityValue = Number(item.quantity);
      const quantity = Number.isFinite(quantityValue) ? quantityValue : 0;
      const lot = escapeHtml(item.lot || '');
      const unit = escapeHtml(item.unit || '');
      const description = escapeHtml(item.description || 'Produto sem descrição');
      const sku = escapeHtml(item.sku || '—');
      const barcode = escapeHtml(item.barcode || '—');
      const validity = item.validity ? escapeHtml(item.validity) : '';
      const unitCost = Number(item.unitCost);
      const unitSale = Number(item.unitSale);
      const totalSale = Number.isFinite(unitSale) && Number.isFinite(quantity)
        ? unitSale * quantity
        : 0;
      const costText = Number.isFinite(unitCost) ? formatCurrency(unitCost) : 'R$ 0,00';
      const saleText = Number.isFinite(unitSale) ? formatCurrency(unitSale) : 'R$ 0,00';
      const totalSaleText = formatCurrency(totalSale);
      const quantityInputClasses = state.isReadOnly
        ? 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const unitInputClasses = state.isReadOnly
        ? 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm uppercase bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm uppercase focus:border-primary focus:ring-2 focus:ring-primary/20';
      const lotInputClasses = state.isReadOnly
        ? 'w-32 rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-32 rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const validityInputClasses = state.isReadOnly
        ? 'rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const removeButtonClasses = state.isReadOnly
        ? 'inline-flex items-center gap-2 rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-400 opacity-60 cursor-not-allowed'
        : 'inline-flex items-center gap-2 rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-600 hover:bg-red-50 transition';
      const disabledAttr = state.isReadOnly ? 'disabled' : '';

      return `
        <tr class="bg-white">
          <td class="px-4 py-3 align-top font-medium text-gray-800">
            <div class="flex flex-col">
              <span>${sku}</span>
              <span class="text-xs font-normal text-gray-500">EAN: ${barcode || '—'}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-gray-700">
            <span class="font-medium text-gray-800">${description}</span>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="number" min="0.01" step="0.01" class="${quantityInputClasses}" data-field="quantity" data-index="${index}" value="${quantity}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="text" class="${unitInputClasses}" data-field="unit" data-index="${index}" value="${unit}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="text" class="${lotInputClasses}" data-field="lot" data-index="${index}" value="${lot}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="date" class="${validityInputClasses}" data-field="validity" data-index="${index}" value="${validity}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-700">
            <span>${costText}</span>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-700">
            <span>${saleText}</span>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-800" data-role="sale-total" data-index="${index}">
            ${totalSaleText}
          </td>
          <td class="px-4 py-3 align-top text-right">
            <button type="button" class="${removeButtonClasses}" data-action="remove-item" data-index="${index}" ${disabledAttr}>
              <i class="fas fa-trash"></i>
              Remover
            </button>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join('');
    updateSummary();
  }

  function attachTableListeners() {
    const tbody = selectors.itemsTableBody;
    if (!tbody) return;

    tbody.addEventListener('input', (event) => {
      if (state.isReadOnly) return;
      const target = event.target;
      const field = target?.dataset?.field;
      if (!field) return;
      const index = Number(target.dataset.index);
      if (!Number.isInteger(index) || index < 0 || index >= state.items.length) return;
      const item = state.items[index];
      if (!item) return;

      if (field === 'quantity') {
        const value = Number(target.value);
        if (Number.isFinite(value) && value > 0) {
          item.quantity = value;
          const saleCell = tbody.querySelector(`[data-role="sale-total"][data-index="${index}"]`);
          if (saleCell) {
            const unitSale = Number(item.unitSale);
            const saleTotal = Number.isFinite(unitSale) ? unitSale * item.quantity : 0;
            saleCell.textContent = formatCurrency(saleTotal);
          }
        }
        updateSummary();
      } else if (field === 'unit') {
        item.unit = target.value.toUpperCase();
      } else if (field === 'lot') {
        item.lot = target.value;
      } else if (field === 'validity') {
        item.validity = target.value;
      }
    });

    tbody.addEventListener('change', (event) => {
      if (state.isReadOnly) return;
      const target = event.target;
      if (target?.dataset?.field === 'quantity') {
        const index = Number(target.dataset.index);
        const value = Number(target.value);
        if (!Number.isFinite(value) || value <= 0) {
          target.value = state.items[index]?.quantity || 0;
          showToast('Informe uma quantidade maior que zero.', 'warning', 4000);
        }
      }
    });

    tbody.addEventListener('click', (event) => {
      if (state.isReadOnly) return;
      const button = event.target.closest('button[data-action="remove-item"]');
      if (!button) return;
      const index = Number(button.dataset.index);
      if (!Number.isInteger(index) || index < 0 || index >= state.items.length) return;
      state.items.splice(index, 1);
      renderItemsTable();
      showToast('Item removido da transferência.', 'info');
    });
  }

  function attachNumberInputEvents() {
    const input = selectors.numberInput;
    if (!input) return;

    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleTransferNumberSearch();
      }
    });

    input.addEventListener('blur', () => {
      handleTransferNumberSearch();
    });
  }

  function resetProductSearch() {
    if (searchState.controller) {
      searchState.controller.abort();
      searchState.controller = null;
    }
    if (searchState.timeout) {
      clearTimeout(searchState.timeout);
      searchState.timeout = null;
    }
    searchState.lastResults = [];
    if (productSearchSelectors.input) {
      productSearchSelectors.input.value = '';
    }
    renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.', 'neutral', {
      show: false,
    });
    hideProductResults();
  }

  function renderSearchResults(products) {
    if (!productSearchSelectors.results) return;
    if (!products.length) {
      renderProductSearchMessage('Nenhum produto encontrado com os critérios informados.', 'info');
      return;
    }

    const rows = products.map((product, index) => {
      const nome = escapeHtml(product.nome || 'Produto sem nome');
      const sku = escapeHtml(product.cod || '—');
      const barcode = escapeHtml(product.codbarras || '—');
      const unidade = escapeHtml(product.unidade || '');
      const peso = Number.isFinite(Number(product.peso))
        ? `${Number(product.peso).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg`
        : '—';
      const unitCost = Number.isFinite(Number(product.custo))
        ? formatCurrency(Number(product.custo))
        : '—';

      return `
        <li>
          <button type="button" class="flex w-full items-start gap-3 px-4 py-3 text-left transition hover:bg-primary/5 focus:bg-primary/5" data-action="select-product" data-index="${index}">
            <div class="flex-1">
              <p class="text-sm font-semibold text-gray-800">${nome}</p>
              <p class="mt-1 text-xs text-gray-500">SKU ${sku} • EAN ${barcode}</p>
            </div>
            <div class="flex flex-col items-end gap-1 text-xs text-gray-500">
              <span class="font-medium text-gray-600">Unidade: <span class="text-gray-700">${unidade || '—'}</span></span>
              <span class="font-medium text-gray-600">Peso: <span class="text-gray-700">${peso}</span></span>
              <span class="font-medium text-gray-600">Custo: <span class="text-gray-700">${unitCost}</span></span>
            </div>
          </button>
        </li>
      `;
    });

    productSearchSelectors.results.dataset.state = 'results';
    productSearchSelectors.results.innerHTML = `
      <ul class="max-h-80 overflow-y-auto divide-y divide-gray-100">
        ${rows.join('')}
      </ul>
    `;
    showProductResults();
  }

  async function searchProducts(term) {
    if (!term || term.length < 3) {
      searchState.lastResults = [];
      if (!term) {
        renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.');
      } else {
        renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.', 'info');
      }
      return;
    }

    if (searchState.controller) {
      searchState.controller.abort();
      searchState.controller = null;
    }

    const controller = new AbortController();
    searchState.controller = controller;
    const { signal } = controller;

    renderProductSearchMessage('<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Pesquisando produtos...</div>', 'loading');

    try {
      const token = getToken();
      if (!token) {
        throw new Error('Sessão expirada. Faça login novamente.');
      }

      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/search-products?term=${encodeURIComponent(term)}`, {
        headers: { Authorization: `Bearer ${token}` },
        signal,
      });

      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.message || 'Não foi possível buscar produtos.');
      }

      const data = await response.json();
      const products = Array.isArray(data?.products) ? data.products : [];
      searchState.lastResults = products;
      renderSearchResults(products);
    } catch (error) {
      if (error.name === 'AbortError') {
        return;
      }
      console.error('Erro ao pesquisar produtos:', error);
      renderProductSearchMessage(escapeHtml(error.message || 'Erro ao buscar produtos.'), 'error');
    } finally {
      if (searchState.controller === controller) {
        searchState.controller = null;
      }
    }
  }

  async function fetchProductDetails(productId) {
    if (!productId) {
      throw new Error('Produto inválido selecionado.');
    }

    const token = getToken();
    if (!token) {
      throw new Error('Sessão expirada. Faça login novamente.');
    }

    const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/products/${productId}`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const data = await response.json().catch(() => ({}));

    if (!response.ok) {
      throw new Error(data?.message || 'Não foi possível carregar os detalhes do produto.');
    }

    const product = data?.product || {};
    const stocks = Array.isArray(data?.stocks)
      ? data.stocks.map((stock) => ({
          depositId: stock?.depositId ? String(stock.depositId) : '',
          quantity: Number(stock?.quantity) || 0,
          unit: stock?.unit || '',
        }))
      : [];

    return {
      productId: String(product?._id || productId),
      sku: product?.cod || '',
      barcode: product?.codbarras || '',
      description: product?.nome || '',
      unit: product?.unidade || '',
      unitWeight: normalizeFiniteNumber(product?.peso),
      unitCost: normalizeFiniteNumber(product?.custo),
      unitSale: normalizeFiniteNumber(product?.venda),
      stocks,
    };
  }

  async function handleProductSelection(product) {
    if (state.isReadOnly) return;
    if (!product || !product._id) {
      showToast('Produto inválido selecionado.', 'error');
      return;
    }

    try {
      renderProductSearchMessage('<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Carregando detalhes do produto...</div>', 'loading');
      const detailedProduct = await fetchProductDetails(product._id);
      state.selectedProduct = detailedProduct;
      if (selectors.selectedProductQuantity) {
        selectors.selectedProductQuantity.value = '1';
      }
      renderSelectedProduct();
      hideProductResults();
      if (productSearchSelectors.input) {
        productSearchSelectors.input.value = '';
      }
    } catch (error) {
      console.error('Erro ao carregar detalhes do produto selecionado:', error);
      showToast(error.message || 'Não foi possível carregar os detalhes do produto selecionado.', 'error');
      renderProductSearchMessage(escapeHtml(error.message || 'Erro ao carregar detalhes do produto.'), 'error');
    }
  }

  function scheduleSearch(term) {
    if (searchState.timeout) {
      clearTimeout(searchState.timeout);
    }
    searchState.timeout = setTimeout(() => {
      searchProducts(term);
      searchState.timeout = null;
    }, 450);
  }

  function attachProductSearchEvents() {
    const input = productSearchSelectors.input;
    if (input) {
      input.addEventListener('input', (event) => {
        const term = event.target.value.trim();

        if (searchState.controller) {
          searchState.controller.abort();
          searchState.controller = null;
        }

        if (searchState.timeout) {
          clearTimeout(searchState.timeout);
          searchState.timeout = null;
        }

        if (!term) {
          searchState.lastResults = [];
          renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.');
          return;
        }

        if (term.length < 3) {
          searchState.lastResults = [];
          renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.', 'info');
          return;
        }

        scheduleSearch(term);
      });

      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const term = event.target.value.trim();
          if (!term) {
            renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.');
            return;
          }
          searchProducts(term);
        }
      });

      input.addEventListener('focus', () => {
        if (!productSearchSelectors.results) return;
        if (!input.value.trim()) {
          renderProductSearchMessage('Digite ao menos três caracteres para localizar produtos cadastrados.', 'neutral', {
            show: false,
          });
        } else if (searchState.lastResults.length) {
          renderSearchResults(searchState.lastResults);
        }
        showProductResults();
      });

      input.addEventListener('blur', () => {
        searchState.hideTimeout = setTimeout(() => {
          hideProductResults();
        }, 150);
      });
    }

    const results = productSearchSelectors.results;
    if (results) {
      results.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action="select-product"]');
        if (!button) return;
        const index = Number(button.dataset.index);
        if (!Number.isInteger(index) || index < 0 || index >= searchState.lastResults.length) return;
        const product = searchState.lastResults[index];
        handleProductSelection(product);
      });
      results.addEventListener('mouseenter', () => {
        if (searchState.hideTimeout) {
          clearTimeout(searchState.hideTimeout);
          searchState.hideTimeout = null;
        }
      });
      results.addEventListener('mouseleave', () => {
        searchState.hideTimeout = setTimeout(() => {
          hideProductResults();
        }, 150);
      });
    }

    document.addEventListener('click', (event) => {
      if (!productSearchSelectors.input || !productSearchSelectors.results) return;
      if (productSearchSelectors.input.contains(event.target)) return;
      if (productSearchSelectors.results.contains(event.target)) return;
      hideProductResults();
    });
  }

  function attachSelectedProductControls() {
    selectors.selectedProductAddButton?.addEventListener('click', addSelectedProductToTransfer);

    selectors.selectedProductClearButton?.addEventListener('click', () => {
      clearSelectedProduct();
      if (productSearchSelectors.input) {
        productSearchSelectors.input.value = '';
        productSearchSelectors.input.focus();
      }
    });

    selectors.selectedProductQuantity?.addEventListener('blur', (event) => {
      const value = Number(event.target.value);
      if (!Number.isFinite(value) || value <= 0) {
        event.target.value = '1';
      }
    });
  }

  function addSelectedProductToTransfer() {
    if (state.isReadOnly) return;
    const selected = state.selectedProduct;
    if (!selected || !selected.productId) {
      showToast('Selecione um produto antes de adicionar.', 'warning');
      return;
    }

    const originDepositId = selectors.originDeposit?.value || '';
    const destinationDepositId = selectors.destinationDeposit?.value || '';
    if (!originDepositId || !destinationDepositId) {
      showToast('Defina os depósitos de origem e destino antes de adicionar o item.', 'warning');
      return;
    }

    const quantityInput = selectors.selectedProductQuantity;
    const quantityValue = Number(quantityInput?.value);
    if (!Number.isFinite(quantityValue) || quantityValue <= 0) {
      showToast('Informe uma quantidade válida para transferir.', 'warning');
      if (quantityInput) {
        quantityInput.focus();
      }
      return;
    }

    const existing = state.items.find((item) => item.productId === selected.productId);
    if (existing) {
      existing.quantity = Number(existing.quantity || 0) + quantityValue;
      const normalizedUnitCost = normalizeFiniteNumber(selected.unitCost);
      const existingUnitCost = normalizeFiniteNumber(existing.unitCost);
      if (normalizedUnitCost !== null && (existingUnitCost === null || existingUnitCost === 0)) {
        existing.unitCost = normalizedUnitCost;
      }

      const normalizedUnitSale = normalizeFiniteNumber(selected.unitSale);
      const existingUnitSale = normalizeFiniteNumber(existing.unitSale);
      if (normalizedUnitSale !== null && (existingUnitSale === null || existingUnitSale === 0)) {
        existing.unitSale = normalizedUnitSale;
      }
      renderItemsTable();
      showToast('Quantidade do item atualizada.', 'info');
    } else {
      state.items.push({
        productId: selected.productId,
        sku: selected.sku || '',
        barcode: selected.barcode || '',
        description: selected.description || '',
        quantity: quantityValue,
        unit: selected.unit || '',
        lot: '',
        validity: '',
        unitWeight: selected.unitWeight,
        unitCost: normalizeFiniteNumber(selected.unitCost),
        unitSale: normalizeFiniteNumber(selected.unitSale),
      });
      renderItemsTable();
      showToast('Item adicionado à transferência.', 'success');
    }

    clearSelectedProduct();
    if (productSearchSelectors.input) {
      productSearchSelectors.input.focus();
    }
  }

  async function loadFormData() {
    try {
      const token = getToken();
      if (!token) {
        throw new Error('Sessão expirada. Faça login novamente.');
      }

      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/form-data`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.message || 'Não foi possível carregar os dados da transferência.');
      }

      const data = await response.json();
      state.stores = Array.isArray(data?.stores) ? data.stores : [];
      state.deposits = Array.isArray(data?.deposits) ? data.deposits : [];
      state.responsaveis = Array.isArray(data?.responsaveis) ? data.responsaveis : [];

      populateCompanySelect(selectors.originCompany);
      populateCompanySelect(selectors.destinationCompany);
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
      populateResponsibleList();
      renderSelectedProduct();
    } catch (error) {
      console.error('Erro ao carregar dados iniciais:', error);
      showModal({
        title: 'Erro ao carregar dados',
        message: error.message || 'Não foi possível carregar as empresas e colaboradores. Atualize a página e tente novamente.',
        confirmText: 'Entendi',
      });
    }
  }

  function hasTransferData() {
    if (state.currentTransferId) {
      return true;
    }

    if (Array.isArray(state.items) && state.items.length > 0) {
      return true;
    }

    const fields = [
      selectors.originCompany?.value,
      selectors.originDeposit?.value,
      selectors.destinationCompany?.value,
      selectors.destinationDeposit?.value,
      selectors.responsibleId?.value,
      selectors.responsibleInput?.value,
      selectors.referenceInput?.value,
      selectors.notesInput?.value,
      selectors.vehicleInput?.value,
      selectors.driverInput?.value,
    ];

    return fields.some((value) => typeof value === 'string' && value.trim() !== '');
  }

  function handleClearButtonClick() {
    if (state.isReadOnly) {
      return;
    }

    if (hasTransferData()) {
      const confirmed = window.confirm(
        'Limpar os dados atuais da transferência? Esta ação apagará as informações não salvas.'
      );
      if (!confirmed) {
        return;
      }
    }

    resetForm();
    showToast('Formulário limpo para nova transferência.', 'info', 3000);
  }

  function resetForm() {
    selectors.form?.reset();
    if (selectors.numberInput) {
      selectors.numberInput.value = '';
    }
    selectors.responsibleId.value = '';
    state.currentTransferId = null;
    state.currentTransferStatus = null;
    state.currentTransferNumber = null;
    state.autoGeneratedNumber = null;
    state.isLoadingTransfer = false;
    setFormReadOnly(false);
    setTodayDate();
    updateDepositSelect(selectors.originCompany, selectors.originDeposit);
    updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
    state.items = [];
    renderItemsTable();
    clearSelectedProduct();
    resetProductSearch();
    fetchNextTransferNumber();
  }

  async function handleSubmit(event) {
    event.preventDefault();
    if (!selectors.form) return;

    if (!state.items.length) {
      showModal({
        title: 'Itens obrigatórios',
        message: 'Adicione ao menos um item antes de salvar a transferência.',
        confirmText: 'Entendi',
      });
      return;
    }

    const invalidItem = state.items.find((item) => !Number.isFinite(Number(item.quantity)) || Number(item.quantity) <= 0);
    if (invalidItem) {
      showModal({
        title: 'Quantidade inválida',
        message: 'Todas as quantidades devem ser maiores que zero.',
        confirmText: 'Ajustar',
      });
      return;
    }

    if (!selectors.responsibleId.value) {
      showModal({
        title: 'Responsável não definido',
        message: 'Selecione um responsável válido na lista de colaboradores autorizados.',
        confirmText: 'Entendi',
      });
      selectors.responsibleInput?.focus();
      return;
    }

    const payload = {
      requestDate: selectors.dateInput?.value || '',
      originCompany: selectors.originCompany?.value || '',
      originDeposit: selectors.originDeposit?.value || '',
      destinationCompany: selectors.destinationCompany?.value || '',
      destinationDeposit: selectors.destinationDeposit?.value || '',
      responsible: selectors.responsibleId.value,
      referenceDocument: selectors.referenceInput?.value || '',
      observations: selectors.notesInput?.value || '',
      transport: {
        mode: selectors.transportMode?.value || '',
        vehicle: selectors.vehicleInput?.value || '',
        driver: selectors.driverInput?.value || '',
      },
      items: state.items.map((item) => {
        const unitCost = normalizeFiniteNumber(item.unitCost);
        const unitSale = normalizeFiniteNumber(item.unitSale);
        const quantity = Number(item.quantity);
        const normalizedQuantity = Number.isFinite(quantity) ? quantity : 0;
        const totalSale = unitSale !== null && Number.isFinite(quantity)
          ? Math.round(unitSale * normalizedQuantity * 100) / 100
          : null;

        return {
          productId: item.productId,
          quantity: normalizedQuantity,
          unit: item.unit || '',
          lot: item.lot || '',
          validity: item.validity || '',
          unitCost,
          unitSale,
          totalSale,
        };
      }),
    };

    const requiredFields = [
      payload.requestDate,
      payload.originCompany,
      payload.originDeposit,
      payload.destinationCompany,
      payload.destinationDeposit,
      payload.responsible,
    ];

    if (requiredFields.some((value) => !value)) {
      showModal({
        title: 'Campos obrigatórios',
        message: 'Preencha todos os campos obrigatórios da transferência.',
        confirmText: 'Entendi',
      });
      return;
    }

    const isEditing = Boolean(state.currentTransferId);
    const token = getToken();
    if (!token) {
      showModal({
        title: 'Sessão expirada',
        message: 'Sua sessão expirou. Faça login novamente para continuar.',
        confirmText: 'Fazer login',
        onConfirm: () => window.location.replace('/pages/login.html'),
      });
      return;
    }

    selectors.saveButton?.setAttribute('disabled', 'true');
    selectors.saveButton?.classList.add('opacity-70', 'cursor-not-allowed');

    try {
      const endpoint = isEditing
        ? `${API_CONFIG.BASE_URL}/transfers/${state.currentTransferId}`
        : `${API_CONFIG.BASE_URL}/transfers`;
      const method = isEditing ? 'PUT' : 'POST';

      const response = await fetch(endpoint, {
        method,
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data?.message || 'Não foi possível salvar a transferência.');
      }

      if (isEditing) {
        showToast('Transferência atualizada com sucesso!', 'success', 4000);
        if (data?.transfer) {
          applyTransferToForm(data.transfer);
        }
      } else {
        showToast('Transferência salva com sucesso!', 'success', 4000);
        if (selectors.numberInput && Number.isFinite(Number(data?.transfer?.number))) {
          selectors.numberInput.value = String(Number(data.transfer.number));
        }
        resetForm();
      }
    } catch (error) {
      console.error('Erro ao salvar transferência:', error);
      showModal({
        title: 'Erro ao salvar',
        message: error.message || 'Não foi possível salvar a transferência. Tente novamente mais tarde.',
        confirmText: 'Entendi',
      });
    } finally {
      selectors.saveButton?.removeAttribute('disabled');
      selectors.saveButton?.classList.remove('opacity-70', 'cursor-not-allowed');
    }
  }

  function attachFormEvents() {
    selectors.originCompany?.addEventListener('change', () => {
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
      renderSelectedProduct();
    });

    selectors.destinationCompany?.addEventListener('change', () => {
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
      renderSelectedProduct();
    });

    selectors.originDeposit?.addEventListener('change', () => {
      renderSelectedProduct();
    });

    selectors.destinationDeposit?.addEventListener('change', () => {
      renderSelectedProduct();
    });

    selectors.form?.addEventListener('submit', handleSubmit);
    selectors.clearButton?.addEventListener('click', handleClearButtonClick);
  }

  function init() {
    setFormReadOnly(false);
    setTodayDate();
    attachTableListeners();
    attachProductSearchEvents();
    attachSelectedProductControls();
    attachFormEvents();
    attachNumberInputEvents();
    handleResponsibleInputEvents();
    resetProductSearch();
    renderItemsTable();
    loadFormData().finally(() => {
      if (!state.currentTransferId) {
        fetchNextTransferNumber();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', init);
})();
