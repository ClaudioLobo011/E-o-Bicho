(function () {
  const state = {
    stores: [],
    allowedStores: [],
    deposits: [],
    responsaveis: [],
    items: [],
    selectedProduct: null,
    currentTransferId: null,
    currentTransferStatus: null,
    currentTransferNumber: null,
    isReadOnly: false,
    autoGeneratedNumber: null,
    isLoadingTransfer: false,
  };

  const selectors = {
    form: document.getElementById('transfer-form'),
    numberInput: document.getElementById('transfer-number'),
    dateInput: document.getElementById('transfer-date'),
    originCompany: document.getElementById('origin-company'),
    originDeposit: document.getElementById('transfer-origin'),
    destinationCompany: document.getElementById('destination-company'),
    destinationDeposit: document.getElementById('transfer-destination'),
    responsibleInput: document.getElementById('transfer-responsible-search'),
    responsibleId: document.getElementById('transfer-responsible'),
    responsibleDataList: document.getElementById('responsible-list'),
    referenceInput: document.getElementById('transfer-reference'),
    notesInput: document.getElementById('transfer-notes'),
    vehicleInput: document.getElementById('transfer-vehicle'),
    driverInput: document.getElementById('transfer-driver'),
    itemsTableBody: document.getElementById('transfer-items-body'),
    totalVolume: document.getElementById('transfer-total-volume'),
    totalWeight: document.getElementById('transfer-total-weight'),
    totalValue: document.getElementById('transfer-total-value'),
    totalSale: document.getElementById('transfer-total-sale'),
    saveButton: document.getElementById('transfer-save-button'),
    clearButton: document.getElementById('transfer-clear-button'),
    printButton: document.getElementById('transfer-import-button'),
    transportMode: document.getElementById('transfer-transport'),
    selectedProductContainer: document.getElementById('transfer-selected-product'),
    selectedProductName: document.getElementById('transfer-selected-product-name'),
    selectedProductSku: document.getElementById('transfer-selected-product-sku'),
    selectedProductBarcode: document.getElementById('transfer-selected-product-barcode'),
    selectedProductUnit: document.getElementById('transfer-selected-product-unit'),
    selectedOriginDeposit: document.getElementById('transfer-selected-product-origin-deposit'),
    selectedDestinationDeposit: document.getElementById('transfer-selected-product-destination-deposit'),
    selectedOriginStock: document.getElementById('transfer-selected-product-origin-stock'),
    selectedDestinationStock: document.getElementById('transfer-selected-product-destination-stock'),
    selectedOriginCost: document.getElementById('transfer-selected-product-origin-cost'),
    selectedDestinationCost: document.getElementById('transfer-selected-product-destination-cost'),
    selectedOriginSale: document.getElementById('transfer-selected-product-origin-sale'),
    selectedDestinationSale: document.getElementById('transfer-selected-product-destination-sale'),
    selectedOriginUnit: document.getElementById('transfer-selected-product-origin-unit'),
    selectedDestinationUnit: document.getElementById('transfer-selected-product-destination-unit'),
    selectedProductQuantity: document.getElementById('transfer-selected-product-quantity'),
    selectedProductAddButton: document.getElementById('transfer-selected-product-add'),
    selectedProductClearButton: document.getElementById('transfer-selected-product-clear'),
    selectedProductWarning: document.getElementById('transfer-selected-product-warning'),
  };

  const productSearchSelectors = {
    input: document.getElementById('transfer-item-search'),
    results: document.getElementById('transfer-item-results'),
  };

  const searchState = {
    timeout: null,
    controller: null,
    lastResults: [],
    hideTimeout: null,
  };

  function showProductResults() {
    const container = productSearchSelectors.results;
    if (!container) return;
    if (searchState.hideTimeout) {
      clearTimeout(searchState.hideTimeout);
      searchState.hideTimeout = null;
    }
    container.classList.remove('hidden');
  }

  function hideProductResults() {
    const container = productSearchSelectors.results;
    if (!container) return;
    container.classList.add('hidden');
  }

  function renderProductSearchMessage(message, type = 'neutral', options = {}) {
    if (!productSearchSelectors.results) return;

    const { show = true } = options;

    let classes = 'px-4 py-3 text-sm text-gray-600';
    if (type === 'loading') {
      classes = 'flex items-center gap-2 px-4 py-3 text-sm text-primary-600';
    } else if (type === 'error') {
      classes = 'px-4 py-3 text-sm text-red-600';
    } else if (type === 'info') {
      classes = 'px-4 py-3 text-sm text-amber-600';
    }

    productSearchSelectors.results.dataset.state = 'message';
    productSearchSelectors.results.innerHTML = `<div class="max-h-80 overflow-y-auto"><div class="${classes}">${message}</div></div>`;

    if (show) {
      showProductResults();
    }
  }

  const allowedRolesLabels = {

    admin: 'Admin',

    admin_master: 'Admin Master',

    funcionario: 'Funcionario',

    franqueado: 'Franqueado',

    franqueador: 'Franqueador',

  };

  function getToken() {
    try {
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      return loggedInUser?.token || '';
    } catch (error) {
      console.warn('Nao foi possivel obter o token de autenticacao.', error);
      return '';
    }
  }

  function formatCnpj(value) {
    const digits = String(value || '').replace(/\D/g, '');
    if (digits.length !== 14) return '';
    return `${digits.slice(0, 2)}.${digits.slice(2, 5)}.${digits.slice(5, 8)}/${digits.slice(8, 12)}-${digits.slice(12)}`;
  }

  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatCurrency(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return 'R$ 0,00';
    }
    return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function normalizeFiniteNumber(value) {
    if (value === null || value === undefined) {
      return null;
    }

    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) {
        return null;
      }
      const normalizedString = trimmed.includes(',')
        ? trimmed.replace(/\./g, '').replace(',', '.')
        : trimmed;
      const normalized = Number(normalizedString);
      return Number.isFinite(normalized) ? normalized : null;
    }

    const number = Number(value);
    return Number.isFinite(number) ? number : null;
  }

  function formatWeight(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return '0 kg';
    }
    return `${number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg`;
  }

  function formatQuantityDisplay(value) {
    const number = Number(value);
    if (!Number.isFinite(number)) {
      return '0';
    }
    if (Number.isInteger(number)) {
      return number.toLocaleString('pt-BR');
    }
    return number.toLocaleString('pt-BR', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 3,
    });
  }

  function getDepositNameById(id) {
    if (!id) return '';
    const deposit = state.deposits.find((item) => String(item._id) === String(id));
    return deposit?.nome || '';
  }

  function findStockForDeposit(stocks, depositId) {
    if (!depositId || !Array.isArray(stocks)) return null;
    return stocks.find((stock) => String(stock.depositId) === String(depositId));
  }

  function toggleSelectedProductWarning(show) {
    const warning = selectors.selectedProductWarning;
    if (!warning) return;
    warning.classList.toggle('hidden', !show);
  }

  function renderSelectedProduct() {
    const container = selectors.selectedProductContainer;
    if (!container) return;

    if (state.isReadOnly) {
      container.classList.add('hidden');
      toggleSelectedProductWarning(false);
      return;
    }

    const product = state.selectedProduct;
    if (!product) {
      container.classList.add('hidden');
      toggleSelectedProductWarning(false);
      return;
    }

    container.classList.remove('hidden');

    if (selectors.selectedProductName) {
      selectors.selectors.selectedProductName.textContent = product.description || 'Produto sem descricao';
    }
    if (selectors.selectedProductSku) {
      selectors.selectors.selectedProductSku.textContent = product.sku || '-';
    }
    if (selectors.selectedProductBarcode) {
      selectors.selectors.selectedProductBarcode.textContent = product.barcode || '-';
    }
    if (selectors.selectedProductUnit) {
      selectors.selectors.selectedProductUnit.textContent = product.unit || '-';
    }

    const originDepositId = selectors.originDeposit?.value || '';
    const destinationDepositId = selectors.destinationDeposit?.value || '';

    if (selectors.selectedOriginDeposit) {
      const originName = getDepositNameById(originDepositId);
      selectors.selectors.selectedOriginDeposit.textContent = originName || 'Selecione o deposito';
    }
    if (selectors.selectedDestinationDeposit) {
      const destinationName = getDepositNameById(destinationDepositId);
      selectors.selectors.selectedDestinationDeposit.textContent = destinationName || 'Selecione o deposito';
    }

    const originStock = findStockForDeposit(product.stocks, originDepositId);
    const destinationStock = findStockForDeposit(product.stocks, destinationDepositId);

    if (selectors.selectedOriginStock) {
      selectors.selectedOriginStock.textContent = formatQuantityDisplay(originStock?.quantity || 0);
    }
    if (selectors.selectedDestinationStock) {
      selectors.selectedDestinationStock.textContent = formatQuantityDisplay(destinationStock?.quantity || 0);
    }

    const costText = formatCurrency(product.unitCost);
    const saleText = formatCurrency(product.unitSale);

    if (selectors.selectedOriginCost) {
      selectors.selectedOriginCost.textContent = costText;
    }
    if (selectors.selectedDestinationCost) {
      selectors.selectedDestinationCost.textContent = costText;
    }
    if (selectors.selectedOriginSale) {
      selectors.selectedOriginSale.textContent = saleText;
    }
    if (selectors.selectedDestinationSale) {
      selectors.selectedDestinationSale.textContent = saleText;
    }

    if (selectors.selectedOriginUnit) {
      selectors.selectors.selectedOriginUnit.textContent = originStock?.unit || product.unit || '-';
    }
    if (selectors.selectedDestinationUnit) {
      selectors.selectors.selectedDestinationUnit.textContent = destinationStock?.unit || product.unit || '-';
    }

    toggleSelectedProductWarning(!originDepositId || !destinationDepositId);
  }

  function clearSelectedProduct() {
    state.selectedProduct = null;
    if (selectors.selectedProductQuantity) {
      selectors.selectedProductQuantity.value = '1';
    }
    renderSelectedProduct();
  }

  function restoreNumberInputValue() {
    if (!selectors.numberInput) return;
    if (Number.isFinite(state.currentTransferNumber) && state.currentTransferNumber > 0) {
      selectors.numberInput.value = String(state.currentTransferNumber);
      return;
    }
    if (Number.isFinite(state.autoGeneratedNumber) && state.autoGeneratedNumber > 0) {
      selectors.numberInput.value = String(state.autoGeneratedNumber);
      return;
    }
    selectors.numberInput.value = '';
  }

  function setFormReadOnly(isReadOnly) {
    state.isReadOnly = Boolean(isReadOnly);
    if (!selectors.form) return;

    const elements = selectors.form.querySelectorAll('input, select, textarea, button');
    elements.forEach((element) => {
      if (!element || element.id === 'transfer-number' || element.type === 'hidden') {
        return;
      }

      if (!element.dataset.initiallyDisabled) {
        element.dataset.initiallyDisabled = element.disabled ? 'true' : 'false';
      }

      if (state.isReadOnly) {
        element.setAttribute('disabled', 'true');
      } else if (element.dataset.initiallyDisabled !== 'true') {
        element.removeAttribute('disabled');
      }
    });

    if (selectors.saveButton) {
      if (state.isReadOnly) {
        selectors.saveButton.setAttribute('disabled', 'true');
        selectors.saveButton.classList.add('opacity-70', 'cursor-not-allowed');
      } else {
        selectors.saveButton.removeAttribute('disabled');
        selectors.saveButton.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }

    if (state.isReadOnly) {
      clearSelectedProduct();
      resetProductSearch();
    }
  }

  function applyTransferToForm(transfer) {
    if (!transfer) return;

    state.currentTransferId = transfer.id || null;
    state.currentTransferStatus = transfer.status || null;

    const numberValue = Number(transfer.number);
    state.currentTransferNumber = Number.isFinite(numberValue) && numberValue > 0 ? numberValue : null;
    if (selectors.numberInput) {
      selectors.numberInput.value = state.currentTransferNumber ? String(state.currentTransferNumber) : '';
    }
    state.autoGeneratedNumber = null;

    const normalizedStatus = typeof transfer.status === 'string' ? transfer.status.toLowerCase() : '';
    const canEdit = transfer.canEdit !== undefined ? Boolean(transfer.canEdit) : normalizedStatus !== 'aprovada';
    setFormReadOnly(!canEdit);

    if (selectors.dateInput) {
      selectors.dateInput.value = formatDateToInput(transfer.requestDate) || selectors.dateInput.value || '';
    }

    if (selectors.originCompany) {
      selectors.originCompany.value = transfer.originCompany?.id || '';
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
    }
    if (selectors.originDeposit) {
      selectors.originDeposit.value = transfer.originDeposit?.id || '';
    }
    if (selectors.destinationCompany) {
      selectors.destinationCompany.value = transfer.destinationCompany?.id || '';
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
    }
    if (selectors.destinationDeposit) {
      selectors.destinationDeposit.value = transfer.destinationDeposit?.id || '';
    }

    if (selectors.responsibleId) {
      selectors.responsibleId.value = transfer.responsible?.id || '';
    }
    if (selectors.responsibleInput) {
      selectors.responsibleInput.value = transfer.responsible?.name || '';
    }

    if (selectors.referenceInput) {
      selectors.referenceInput.value = transfer.referenceDocument || '';
    }
    if (selectors.notesInput) {
      selectors.notesInput.value = transfer.observations || '';
    }
    if (selectors.vehicleInput) {
      selectors.vehicleInput.value = transfer.transport?.vehicle || '';
    }
    if (selectors.driverInput) {
      selectors.driverInput.value = transfer.transport?.driver || '';
    }
    if (selectors.transportMode && transfer.transport?.mode) {
      const normalizedMode = String(transfer.transport.mode || '').toLowerCase();
      const hasOption = Array.from(selectors.transportMode.options || []).some(
        (option) => option.value === normalizedMode
      );
      selectors.transportMode.value = hasOption ? normalizedMode : selectors.transportMode.value;
    }

    state.items = Array.isArray(transfer.items)
      ? transfer.items.map((item) => ({
          productId: item.productId || null,
          sku: item.sku || '',
          barcode: item.barcode || '',
          description: item.description || item.productName || '',
          ncm: item.ncm || '',
          quantity: Number(item.quantity) || 0,
          unit: item.unit || '',
          lot: item.lot || '',
          validity: formatDateToInput(item.validity),
          unitCost:
            item.unitCost === null || item.unitCost === undefined ? null : Number(item.unitCost),
          unitSale:
            item.unitSale === null || item.unitSale === undefined ? null : Number(item.unitSale),
          unitWeight:
            item.unitWeight === null || item.unitWeight === undefined ? null : Number(item.unitWeight),
        }))
      : [];

    renderItemsTable();
    clearSelectedProduct();
    resetProductSearch();
  }

  async function fetchNextTransferNumber() {
    if (!selectors.numberInput) return;

    try {
      const token = getToken();
      if (!token) {
        return;
      }

      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/next-number`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data?.message || 'Nao foi possivel gerar o proximo numero da transferencia.');
      }

      const number = Number(data?.number);
      if (Number.isFinite(number) && number > 0) {
        state.autoGeneratedNumber = number;
        if (!state.currentTransferId) {
          selectors.numberInput.value = String(number);
        }
      }
    } catch (error) {
      console.error('Erro ao obter proximo numero da transferencia:', error);
    }
  }

  async function loadTransferByNumber(number) {
    if (state.isLoadingTransfer) return;
    const token = getToken();
    if (!token) {
      showModal({
        title: 'Sessao expirada',
        message: 'Sua sessao expirou. Faca login novamente para continuar.',
        confirmText: 'Fazer login',
        onConfirm: () => window.location.replace('/pages/login.html'),
      });
      return;
    }

    state.isLoadingTransfer = true;

    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/by-number/${number}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        const message = data?.message || 'Nao foi possivel carregar a transferencia informada.';
        throw new Error(message);
      }

      if (!data?.transfer) {
        throw new Error('Transferencia nao encontrada.');
      }

      applyTransferToForm(data.transfer);
    } catch (error) {
      console.error('Erro ao carregar transferencia por numero:', error);
      const message = error?.message || 'Nao foi possivel carregar a transferencia informada.';
      const type = /nao encontrada/i.test(message) ? 'warning' : 'error';
      showToast(message, type, 4000);
      restoreNumberInputValue();
    } finally {
      state.isLoadingTransfer = false;
    }
  }

  async function handleTransferNumberSearch() {
    if (!selectors.numberInput) return;
    const rawValue = selectors.numberInput.value.trim();

    if (!rawValue) {
      if (state.currentTransferId || state.currentTransferNumber) {
        resetForm();
      } else {
        restoreNumberInputValue();
        if (!state.autoGeneratedNumber) {
          await fetchNextTransferNumber();
        }
      }
      return;
    }

    const number = Number(rawValue);
    if (!Number.isFinite(number) || number <= 0) {
      showToast('Informe um numero valido de transferencia.', 'warning', 4000);
      restoreNumberInputValue();
      return;
    }

    if (state.currentTransferId && state.currentTransferNumber === number) {
      return;
    }

    if (!state.currentTransferId && state.autoGeneratedNumber === number) {
      return;
    }

    await loadTransferByNumber(number);
  }

  function setTodayDate() {
    const input = selectors.dateInput;
    if (!input || input.value) return;
    const today = new Date();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    input.value = `${today.getFullYear()}-${month}-${day}`;
  }

  function formatDateToInput(value) {
    if (!value) return '';
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) {
      return '';
    }
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${date.getFullYear()}-${month}-${day}`;
  }

  function buildStoreLabel(store) {
    const name = store?.nomeFantasia || store?.nome || 'Empresa sem nome';
    const cnpj = formatCnpj(store?.cnpj);
    return cnpj ? `${name} - CNPJ ${cnpj}` : name;
  }

  function populateCompanySelect(select, stores = state.stores) {
    if (!select) return;
    const list = Array.isArray(stores) ? stores : [];
    const previousValue = select.value;
    select.innerHTML = '<option value="">Selecione</option>';
    list.forEach((store) => {
      const option = document.createElement('option');
      option.value = store._id;
      option.textContent = buildStoreLabel(store);
      select.appendChild(option);
    });
    if (previousValue) {
      select.value = previousValue;
    }
  }

  function updateDepositSelect(companySelect, depositSelect) {
    if (!depositSelect) return;
    const previousValue = depositSelect.value;
    const companyId = companySelect?.value || '';
    depositSelect.innerHTML = '<option value="">Selecione</option>';
    if (!companyId) {
      depositSelect.disabled = true;
      return;
    }

    const availableDeposits = state.deposits.filter((deposit) => String(deposit.empresa) === String(companyId));
    if (!availableDeposits.length) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Nenhum deposito cadastrado para esta empresa';
      option.disabled = true;
      depositSelect.appendChild(option);
      depositSelect.disabled = false;
      depositSelect.value = '';
      return;
    }

    availableDeposits.forEach((deposit) => {
      const option = document.createElement('option');
      option.value = deposit._id;
      option.textContent = deposit.nome || 'Depositos sem nome';
      depositSelect.appendChild(option);
    });

    depositSelect.disabled = false;
    if (previousValue && availableDeposits.some((deposit) => String(deposit._id) === String(previousValue))) {
      depositSelect.value = previousValue;
    }
  }

  function buildResponsibleDisplay(user) {
    const name = user?.nomeCompleto || user?.apelido || user?.email;
    const roleLabel = allowedRolesLabels[user?.role] || 'Colaborador';
    const email = user?.email || '';
    return [name, roleLabel, email].filter(Boolean).join(' - ');
  }

  function populateResponsibleList() {
    const list = selectors.responsibleDataList;
    if (!list) return;
    list.innerHTML = '';
    state.responsaveis.forEach((user) => {
      const option = document.createElement('option');
      option.value = buildResponsibleDisplay(user);
      option.dataset.id = user._id;
      list.appendChild(option);
    });
  }

  function findResponsibleId(displayValue) {
    const list = selectors.responsibleDataList;
    if (!list) return '';
    const value = displayValue?.trim();
    if (!value) return '';
    const options = Array.from(list.options);
    const matched = options.find((option) => option.value === value && option.dataset.id);
    return matched?.dataset.id || '';
  }

  function handleResponsibleInputEvents() {
    if (!selectors.responsibleInput) return;

    selectors.responsibleInput.addEventListener('input', () => {
      selectors.responsibleId.value = '';
    });

    selectors.responsibleInput.addEventListener('change', () => {
      const id = findResponsibleId(selectors.responsibleInput.value);
      selectors.responsibleId.value = id;
      if (!id && selectors.responsibleInput.value) {
        showToast('Selecione um responsavel valido a partir da lista sugerida.', 'warning', 4000);
      }
    });
  }

  function updateSummary() {
    const weightTotal = state.items.reduce((sum, item) => {
      const quantity = Number(item.quantity);
      const unitWeight = Number(item.unitWeight);
      if (!Number.isFinite(quantity) || !Number.isFinite(unitWeight)) {
        return sum;
      }
      return sum + quantity * unitWeight;
    }, 0);

    const totals = state.items.reduce(
      (acc, item) => {
        const quantity = Number(item.quantity);
        const unitCost = Number(item.unitCost);
        const unitSale = Number(item.unitSale);

        if (Number.isFinite(quantity)) {
          acc.volume += quantity;

          if (Number.isFinite(unitCost)) {
            acc.cost += quantity * unitCost;
          }

          if (Number.isFinite(unitSale)) {
            acc.sale += quantity * unitSale;
          }
        }

        return acc;
      },
      { volume: 0, cost: 0, sale: 0 }
    );

    if (selectors.totalVolume) {
      selectors.totalVolume.textContent = `${totals.volume.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 })} unidades`;
    }
    if (selectors.totalWeight) {
      selectors.totalWeight.textContent = formatWeight(weightTotal);
    }
    if (selectors.totalValue) {
      selectors.totalValue.textContent = formatCurrency(totals.cost);
    }
    if (selectors.totalSale) {
      selectors.totalSale.textContent = formatCurrency(totals.sale);
    }
  }

  function renderItemsTable() {
    const tbody = selectors.itemsTableBody;
    if (!tbody) return;

    if (!state.items.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-gray-500">Nenhum item adicionado at√© o momento.</td></tr>';
      updateSummary();
      return;
    }

    const rows = state.items.map((item, index) => {
      const quantityValue = Number(item.quantity);
      const quantity = Number.isFinite(quantityValue) ? quantityValue : 0;
      const lot = escapeHtml(item.lot || '');
      const unit = escapeHtml(item.unit || '');
      const description = escapeHtml(item.description || 'Produto sem descricao');
      const sku = escapeHtml(item.sku || '-');
      const barcode = escapeHtml(item.barcode || '-');
      const validity = item.validity ? escapeHtml(item.validity) : '';
      const unitCost = Number(item.unitCost);
      const unitSale = Number(item.unitSale);
      const totalSale = Number.isFinite(unitSale) && Number.isFinite(quantity)
        ? unitSale * quantity
        : 0;
      const costText = Number.isFinite(unitCost) ? formatCurrency(unitCost) : 'R$ 0,00';
      const saleText = Number.isFinite(unitSale) ? formatCurrency(unitSale) : 'R$ 0,00';
      const totalSaleText = formatCurrency(totalSale);
      const quantityInputClasses = state.isReadOnly
        ? 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const unitInputClasses = state.isReadOnly
        ? 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm uppercase bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-24 rounded-md border border-gray-300 px-2 py-1 text-sm uppercase focus:border-primary focus:ring-2 focus:ring-primary/20';
      const lotInputClasses = state.isReadOnly
        ? 'w-32 rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'w-32 rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const validityInputClasses = state.isReadOnly
        ? 'rounded-md border border-gray-300 px-2 py-1 text-sm bg-gray-100 text-gray-500 cursor-not-allowed'
        : 'rounded-md border border-gray-300 px-2 py-1 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20';
      const removeButtonClasses = state.isReadOnly
        ? 'inline-flex items-center gap-2 rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-400 opacity-60 cursor-not-allowed'
        : 'inline-flex items-center gap-2 rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-600 hover:bg-red-50 transition';
      const disabledAttr = state.isReadOnly ? 'disabled' : '';

      return `
        <tr class="bg-white">
          <td class="px-4 py-3 align-top font-medium text-gray-800">
            <div class="flex flex-col">
              <span>${sku}</span>
              <span class="text-xs font-normal text-gray-500">EAN: ${barcode || '-'}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-gray-700">
            <span class="font-medium text-gray-800">${description}</span>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="number" min="0.01" step="0.01" class="${quantityInputClasses}" data-field="quantity" data-index="${index}" value="${quantity}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="text" class="${unitInputClasses}" data-field="unit" data-index="${index}" value="${unit}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="text" class="${lotInputClasses}" data-field="lot" data-index="${index}" value="${lot}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top">
            <input type="date" class="${validityInputClasses}" data-field="validity" data-index="${index}" value="${validity}" ${disabledAttr}>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-700">
            <span>${costText}</span>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-700">
            <span>${saleText}</span>
          </td>
          <td class="px-4 py-3 align-top text-right text-gray-800" data-role="sale-total" data-index="${index}">
            ${totalSaleText}
          </td>
          <td class="px-4 py-3 align-top text-right">
            <button type="button" class="${removeButtonClasses}" data-action="remove-item" data-index="${index}" ${disabledAttr}>
              <i class="fas fa-trash"></i>
              Remover
            </button>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join('');
    updateSummary();
  }

  function attachTableListeners() {
    const tbody = selectors.itemsTableBody;
    if (!tbody) return;

    tbody.addEventListener('input', (event) => {
      if (state.isReadOnly) return;
      const target = event.target;
      const field = target?.dataset?.field;
      if (!field) return;
      const index = Number(target.dataset.index);
      if (!Number.isInteger(index) || index < 0 || index >= state.items.length) return;
      const item = state.items[index];
      if (!item) return;

      if (field === 'quantity') {
        const value = Number(target.value);
        if (Number.isFinite(value) && value > 0) {
          item.quantity = value;
          const saleCell = tbody.querySelector(`[data-role="sale-total"][data-index="${index}"]`);
          if (saleCell) {
            const unitSale = Number(item.unitSale);
            const saleTotal = Number.isFinite(unitSale) ? unitSale * item.quantity : 0;
            saleCell.textContent = formatCurrency(saleTotal);
          }
        }
        updateSummary();
      } else if (field === 'unit') {
        item.unit = target.value.toUpperCase();
      } else if (field === 'lot') {
        item.lot = target.value;
      } else if (field === 'validity') {
        item.validity = target.value;
      }
    });

    tbody.addEventListener('change', (event) => {
      if (state.isReadOnly) return;
      const target = event.target;
      if (target?.dataset?.field === 'quantity') {
        const index = Number(target.dataset.index);
        const value = Number(target.value);
        if (!Number.isFinite(value) || value <= 0) {
          target.value = state.items[index]?.quantity || 0;
          showToast('Informe uma quantidade maior que zero.', 'warning', 4000);
        }
      }
    });

    tbody.addEventListener('click', (event) => {
      if (state.isReadOnly) return;
      const button = event.target.closest('button[data-action="remove-item"]');
      if (!button) return;
      const index = Number(button.dataset.index);
      if (!Number.isInteger(index) || index < 0 || index >= state.items.length) return;
      state.items.splice(index, 1);
      renderItemsTable();
      showToast('Item removido da transferencia.', 'info');
    });
  }

  function attachNumberInputEvents() {
    const input = selectors.numberInput;
    if (!input) return;

    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleTransferNumberSearch();
      }
    });

    input.addEventListener('blur', () => {
      handleTransferNumberSearch();
    });
  }

  function resetProductSearch() {
    if (searchState.controller) {
      searchState.controller.abort();
      searchState.controller = null;
    }
    if (searchState.timeout) {
      clearTimeout(searchState.timeout);
      searchState.timeout = null;
    }
    searchState.lastResults = [];
    if (productSearchSelectors.input) {
      productSearchSelectors.input.value = '';
    }
    renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.', 'neutral', {
      show: false,
    });
    hideProductResults();
  }

  function renderSearchResults(products) {
    if (!productSearchSelectors.results) return;
    if (!products.length) {
      renderProductSearchMessage('Nenhum produto encontrado com os criterios informados.', 'info');
      return;
    }

    const rows = products.map((product, index) => {
      const nome = escapeHtml(product.nome || 'Produto sem nome');
      const sku = escapeHtml(product.cod || '-');
      const barcode = escapeHtml(product.codbarras || '-');
      const unidade = escapeHtml(product.unidade || '');
      const peso = Number.isFinite(Number(product.peso))
        ? `${Number(product.peso).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg`
        : '-';
      const unitCost = Number.isFinite(Number(product.custo))
        ? formatCurrency(Number(product.custo))
        : '-';

      return `
        <li>
          <button type="button" class="flex w-full items-start gap-3 px-4 py-3 text-left transition hover:bg-primary/5 focus:bg-primary/5" data-action="select-product" data-index="${index}">
            <div class="flex-1">
              <p class="text-sm font-semibold text-gray-800">${nome}</p>
              <p class="mt-1 text-xs text-gray-500">SKU ${sku} - EAN ${barcode}</p>
            </div>
            <div class="flex flex-col items-end gap-1 text-xs text-gray-500">
              <span class="font-medium text-gray-600">Unidade: <span class="text-gray-700">${unidade || '-'}</span></span>
              <span class="font-medium text-gray-600">Peso: <span class="text-gray-700">${peso}</span></span>
              <span class="font-medium text-gray-600">Custo: <span class="text-gray-700">${unitCost}</span></span>
            </div>
          </button>
        </li>
      `;
    });

    productSearchSelectors.results.dataset.state = 'results';
    productSearchSelectors.results.innerHTML = `
      <ul class="max-h-80 overflow-y-auto divide-y divide-gray-100">
        ${rows.join('')}
      </ul>
    `;
    showProductResults();
  }

  async function searchProducts(term) {
    if (!term || term.length < 3) {
      searchState.lastResults = [];
      if (!term) {
        renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.');
      } else {
        renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.', 'info');
      }
      return;
    }

    if (searchState.controller) {
      searchState.controller.abort();
      searchState.controller = null;
    }

    const controller = new AbortController();
    searchState.controller = controller;
    const { signal } = controller;

    renderProductSearchMessage('<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Pesquisando produtos...</div>', 'loading');

    try {
      const token = getToken();
      if (!token) {
        throw new Error('Sessao expirada. Faca login novamente.');
      }

      const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/search-products?term=${encodeURIComponent(term)}`, {
        headers: { Authorization: `Bearer ${token}` },
        signal,
      });

      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.message || 'Nao foi possivel buscar produtos.');
      }

      const data = await response.json();
      const products = Array.isArray(data?.products) ? data.products : [];
      searchState.lastResults = products;
      renderSearchResults(products);
    } catch (error) {
      if (error.name === 'AbortError') {
        return;
      }
      console.error('Erro ao pesquisar produtos:', error);
      renderProductSearchMessage(escapeHtml(error.message || 'Erro ao buscar produtos.'), 'error');
    } finally {
      if (searchState.controller === controller) {
        searchState.controller = null;
      }
    }
  }

  async function fetchProductDetails(productId) {
    if (!productId) {
      throw new Error('Produto invalido selecionado.');
    }

    const token = getToken();
    if (!token) {
      throw new Error('Sessao expirada. Faca login novamente.');
    }

    const response = await fetch(`${API_CONFIG.BASE_URL}/transfers/products/${productId}`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const data = await response.json().catch(() => ({}));

    if (!response.ok) {
      throw new Error(data?.message || 'Nao foi possivel carregar os detalhes do produto.');
    }

    const product = data?.product || {};
    const stocks = Array.isArray(data?.stocks)
      ? data.stocks.map((stock) => ({
          depositId: stock?.depositId ? String(stock.depositId) : '',
          quantity: Number(stock?.quantity) || 0,
          unit: stock?.unit || '',
        }))
      : [];

    return {
      productId: String(product?._id || productId),
      sku: product?.cod || '',
      barcode: product?.codbarras || '',
      description: product?.nome || '',
      ncm: product?.ncm || '',
      unit: product?.unidade || '',
      unitWeight: normalizeFiniteNumber(product?.peso),
      unitCost: normalizeFiniteNumber(product?.custo),
      unitSale: normalizeFiniteNumber(product?.venda),
      stocks,
    };
  }

  async function handleProductSelection(product) {
    if (state.isReadOnly) return;
    if (!product || !product._id) {
      showToast('Produto invalido selecionado.', 'error');
      return;
    }

    try {
      renderProductSearchMessage('<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Carregando detalhes do produto...</div>', 'loading');
      const detailedProduct = await fetchProductDetails(product._id);
      state.selectedProduct = detailedProduct;
      if (selectors.selectedProductQuantity) {
        selectors.selectedProductQuantity.value = '1';
      }
      renderSelectedProduct();
      hideProductResults();
      if (productSearchSelectors.input) {
        productSearchSelectors.input.value = '';
      }
    } catch (error) {
      console.error('Erro ao carregar detalhes do produto selecionado:', error);
      showToast(error.message || 'Nao foi possivel carregar os detalhes do produto selecionado.', 'error');
      renderProductSearchMessage(escapeHtml(error.message || 'Erro ao carregar detalhes do produto.'), 'error');
    }
  }

  function scheduleSearch(term) {
    if (searchState.timeout) {
      clearTimeout(searchState.timeout);
    }
    searchState.timeout = setTimeout(() => {
      searchProducts(term);
      searchState.timeout = null;
    }, 450);
  }

  function attachProductSearchEvents() {
    const input = productSearchSelectors.input;
    if (input) {
      input.addEventListener('input', (event) => {
        const term = event.target.value.trim();

        if (searchState.controller) {
          searchState.controller.abort();
          searchState.controller = null;
        }

        if (searchState.timeout) {
          clearTimeout(searchState.timeout);
          searchState.timeout = null;
        }

        if (!term) {
          searchState.lastResults = [];
          renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.');
          return;
        }

        if (term.length < 3) {
          searchState.lastResults = [];
          renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.', 'info');
          return;
        }

        scheduleSearch(term);
      });

      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const term = event.target.value.trim();
          if (!term) {
            renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.');
            return;
          }
          searchProducts(term);
        }
      });

      input.addEventListener('focus', () => {
        if (!productSearchSelectors.results) return;
        if (!input.value.trim()) {
          renderProductSearchMessage('Digite ao menos tres caracteres para localizar produtos cadastrados.', 'neutral', {
            show: false,
          });
        } else if (searchState.lastResults.length) {
          renderSearchResults(searchState.lastResults);
        }
        showProductResults();
      });

      input.addEventListener('blur', () => {
        searchState.hideTimeout = setTimeout(() => {
          hideProductResults();
        }, 150);
      });
    }

    const results = productSearchSelectors.results;
    if (results) {
      results.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action="select-product"]');
        if (!button) return;
        const index = Number(button.dataset.index);
        if (!Number.isInteger(index) || index < 0 || index >= searchState.lastResults.length) return;
        const product = searchState.lastResults[index];
        handleProductSelection(product);
      });
      results.addEventListener('mouseenter', () => {
        if (searchState.hideTimeout) {
          clearTimeout(searchState.hideTimeout);
          searchState.hideTimeout = null;
        }
      });
      results.addEventListener('mouseleave', () => {
        searchState.hideTimeout = setTimeout(() => {
          hideProductResults();
        }, 150);
      });
    }

    document.addEventListener('click', (event) => {
      if (!productSearchSelectors.input || !productSearchSelectors.results) return;
      if (productSearchSelectors.input.contains(event.target)) return;
      if (productSearchSelectors.results.contains(event.target)) return;
      hideProductResults();
    });
  }

  function attachSelectedProductControls() {
    selectors.selectedProductAddButton?.addEventListener('click', addSelectedProductToTransfer);

    selectors.selectedProductClearButton?.addEventListener('click', () => {
      clearSelectedProduct();
      if (productSearchSelectors.input) {
        productSearchSelectors.input.value = '';
        productSearchSelectors.input.focus();
      }
    });

    selectors.selectedProductQuantity?.addEventListener('blur', (event) => {
      const value = Number(event.target.value);
      if (!Number.isFinite(value) || value <= 0) {
        event.target.value = '1';
      }
    });
  }

  function addSelectedProductToTransfer() {
    if (state.isReadOnly) return;
    const selected = state.selectedProduct;
    if (!selected || !selected.productId) {
      showToast('Selecione um produto antes de adicionar.', 'warning');
      return;
    }

    const originDepositId = selectors.originDeposit?.value || '';
    const destinationDepositId = selectors.destinationDeposit?.value || '';
    if (!originDepositId || !destinationDepositId) {
      showToast('Defina os depositos de origem e destino antes de adicionar o item.', 'warning');
      return;
    }

    const quantityInput = selectors.selectedProductQuantity;
    const quantityValue = Number(quantityInput?.value);
    if (!Number.isFinite(quantityValue) || quantityValue <= 0) {
      showToast('Informe uma quantidade valida para transferir.', 'warning');
      if (quantityInput) {
        quantityInput.focus();
      }
      return;
    }

    const existing = state.items.find((item) => item.productId === selected.productId);
    if (existing) {
      existing.quantity = Number(existing.quantity || 0) + quantityValue;
      const normalizedUnitCost = normalizeFiniteNumber(selected.unitCost);
      const existingUnitCost = normalizeFiniteNumber(existing.unitCost);
      if (normalizedUnitCost !== null && (existingUnitCost === null || existingUnitCost === 0)) {
        existing.unitCost = normalizedUnitCost;
      }

      const normalizedUnitSale = normalizeFiniteNumber(selected.unitSale);
      const existingUnitSale = normalizeFiniteNumber(existing.unitSale);
      if (normalizedUnitSale !== null && (existingUnitSale === null || existingUnitSale === 0)) {
        existing.unitSale = normalizedUnitSale;
      }
      renderItemsTable();
      showToast('Quantidade do item atualizada.', 'info');
    } else {
      state.items.push({
        productId: selected.productId,
        sku: selected.sku || '',
        barcode: selected.barcode || '',
        description: selected.description || '',
        ncm: selected.ncm || '',
        quantity: quantityValue,
        unit: selected.unit || '',
        lot: '',
        validity: '',
        unitWeight: selected.unitWeight,
        unitCost: normalizeFiniteNumber(selected.unitCost),
        unitSale: normalizeFiniteNumber(selected.unitSale),
      });
      renderItemsTable();
      showToast('Item adicionado a transferencia.', 'success');
    }

    clearSelectedProduct();
    if (productSearchSelectors.input) {
      productSearchSelectors.input.focus();
    }
  }

  async function loadFormData() {
    try {
      const token = getToken();
      if (!token) {
        throw new Error('Sessao expirada. Faca login novamente.');
      }

      const [response, allowedResponse] = await Promise.all([
        fetch(`${API_CONFIG.BASE_URL}/transfers/form-data`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
        fetch(`${API_CONFIG.BASE_URL}/stores/allowed`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
      ]);

      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.message || 'Nao foi possivel carregar os dados da transferencia.');
      }

      const data = await response.json();
      const allowedPayload = await allowedResponse.json().catch(() => ({}));
      if (!allowedResponse.ok) {
        throw new Error(allowedPayload?.message || 'Nao foi possivel carregar as empresas permitidas.');
      }
      state.stores = Array.isArray(data?.stores) ? data.stores : [];
      state.deposits = Array.isArray(data?.deposits) ? data.deposits : [];
      state.responsaveis = Array.isArray(data?.responsaveis) ? data.responsaveis : [];
      const allowedStores = Array.isArray(allowedPayload?.stores)
        ? allowedPayload.stores
        : Array.isArray(allowedPayload)
        ? allowedPayload
        : [];
      state.allowedStores = Array.isArray(allowedStores) ? allowedStores : [];

      populateCompanySelect(selectors.originCompany, state.allowedStores);
      populateCompanySelect(selectors.destinationCompany, state.stores);
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
      populateResponsibleList();
      renderSelectedProduct();
    } catch (error) {
      console.error('Erro ao carregar dados iniciais:', error);
      showModal({
        title: 'Erro ao carregar dados',
        message: error.message || 'Nao foi possivel carregar as empresas e colaboradores. Atualize a pagina e tente novamente.',
        confirmText: 'Entendi',
      });
    }
  }

  function hasTransferData() {
    if (state.currentTransferId) {
      return true;
    }

    if (Array.isArray(state.items) && state.items.length > 0) {
      return true;
    }

    const fields = [
      selectors.originCompany?.value,
      selectors.originDeposit?.value,
      selectors.destinationCompany?.value,
      selectors.destinationDeposit?.value,
      selectors.responsibleId?.value,
      selectors.responsibleInput?.value,
      selectors.referenceInput?.value,
      selectors.notesInput?.value,
      selectors.vehicleInput?.value,
      selectors.driverInput?.value,
    ];

    return fields.some((value) => typeof value === 'string' && value.trim() !== '');
  }

  function handleClearButtonClick() {
    if (state.isReadOnly) {
      return;
    }

    if (hasTransferData()) {
      const confirmed = window.confirm('Limpar os dados atuais da transferencia? Esta acao apagara as informacoes nao salvas.');
      if (!confirmed) {
        return;
      }
    }

    resetForm();
    showToast('Formulario limpo para nova transferencia.', 'info', 3000);
  }

  function resetForm() {
    selectors.form?.reset();
    if (selectors.numberInput) {
      selectors.numberInput.value = '';
    }
    selectors.responsibleId.value = '';
    state.currentTransferId = null;
    state.currentTransferStatus = null;
    state.currentTransferNumber = null;
    state.autoGeneratedNumber = null;
    state.isLoadingTransfer = false;
    setFormReadOnly(false);
    setTodayDate();
    updateDepositSelect(selectors.originCompany, selectors.originDeposit);
    updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
    state.items = [];
    renderItemsTable();
    clearSelectedProduct();
    resetProductSearch();
    fetchNextTransferNumber();
  }

  async function handleSubmit(event) {
    event.preventDefault();
    if (!selectors.form) return;

    if (!state.items.length) {
      showModal({
        title: 'Itens obrigatorios',
        message: 'Adicione ao menos um item antes de salvar a transferencia.',
        confirmText: 'Entendi',
      });
      return;
    }

    const invalidItem = state.items.find((item) => !Number.isFinite(Number(item.quantity)) || Number(item.quantity) <= 0);
    if (invalidItem) {
      showModal({
        title: 'Quantidade invalida',
        message: 'Todas as quantidades devem ser maiores que zero.',
        confirmText: 'Ajustar',
      });
      return;
    }

    if (!selectors.responsibleId.value) {
      showModal({
        title: 'Responsavel nao definido',
        message: 'Selecione um responsavel valido na lista de colaboradores autorizados.',
        confirmText: 'Entendi',
      });
      selectors.responsibleInput?.focus();
      return;
    }

    const payload = {
      requestDate: selectors.dateInput?.value || '',
      originCompany: selectors.originCompany?.value || '',
      originDeposit: selectors.originDeposit?.value || '',
      destinationCompany: selectors.destinationCompany?.value || '',
      destinationDeposit: selectors.destinationDeposit?.value || '',
      responsible: selectors.responsibleId.value,
      referenceDocument: selectors.referenceInput?.value || '',
      observations: selectors.notesInput?.value || '',
      transport: {
        mode: selectors.transportMode?.value || '',
        vehicle: selectors.vehicleInput?.value || '',
        driver: selectors.driverInput?.value || '',
      },
      items: state.items.map((item) => {
        const unitCost = normalizeFiniteNumber(item.unitCost);
        const unitSale = normalizeFiniteNumber(item.unitSale);
        const quantity = Number(item.quantity);
        const normalizedQuantity = Number.isFinite(quantity) ? quantity : 0;
        const totalSale = unitSale !== null && Number.isFinite(quantity)
          ? Math.round(unitSale * normalizedQuantity * 100) / 100
          : null;

        return {
          productId: item.productId,
          quantity: normalizedQuantity,
          unit: item.unit || '',
          lot: item.lot || '',
          validity: item.validity || '',
          unitCost,
          unitSale,
          totalSale,
        };
      }),
    };

    const requiredFields = [
      payload.requestDate,
      payload.originCompany,
      payload.originDeposit,
      payload.destinationCompany,
      payload.destinationDeposit,
      payload.responsible,
    ];

    if (requiredFields.some((value) => !value)) {
      showModal({
        title: 'Campos obrigatorios',
        message: 'Preencha todos os campos obrigatorios da transferencia.',
        confirmText: 'Entendi',
      });
      return;
    }

    const isEditing = Boolean(state.currentTransferId);
    const token = getToken();
    if (!token) {
      showModal({
        title: 'Sessao expirada',
        message: 'Sua sessao expirou. Faca login novamente para continuar.',
        confirmText: 'Fazer login',
        onConfirm: () => window.location.replace('/pages/login.html'),
      });
      return;
    }

    selectors.saveButton?.setAttribute('disabled', 'true');
    selectors.saveButton?.classList.add('opacity-70', 'cursor-not-allowed');

    try {
      const endpoint = isEditing
        ? `${API_CONFIG.BASE_URL}/transfers/${state.currentTransferId}`
        : `${API_CONFIG.BASE_URL}/transfers`;
      const method = isEditing ? 'PUT' : 'POST';

      const response = await fetch(endpoint, {
        method,
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(data?.message || 'Nao foi possivel salvar a transferencia.');
      }

      if (isEditing) {
        showToast('Transferencia atualizada com sucesso!', 'success', 4000);
        if (data?.transfer) {
          applyTransferToForm(data.transfer);
        }
      } else {
        showToast('Transferencia salva com sucesso!', 'success', 4000);
        if (selectors.numberInput && Number.isFinite(Number(data?.transfer?.number))) {
          selectors.numberInput.value = String(Number(data.transfer.number));
        }
        resetForm();
      }
    } catch (error) {
      console.error('Erro ao salvar transferencia:', error);
      showModal({
        title: 'Erro ao salvar',
        message: error.message || 'Nao foi possivel salvar a transferencia. Tente novamente mais tarde.',
        confirmText: 'Entendi',
      });
    } finally {
      selectors.saveButton?.removeAttribute('disabled');
      selectors.saveButton?.classList.remove('opacity-70', 'cursor-not-allowed');
    }
  }


  function normalizeDigits(value) {
    return String(value || '').replace(/\D/g, '');
  }

  function pickFirstValue(...values) {
    for (const value of values) {
      if (typeof value === 'string' && value.trim()) return value.trim();
      if (value !== null && value !== undefined && value !== '') return String(value).trim();
    }
    return '';
  }

  function escapeXml(value) {
    return String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&apos;');
  }

  function toIsoDateTimeForDanfe(value) {
    if (!value) return new Date().toISOString();
    if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
      return `${value}T00:00:00-03:00`;
    }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return new Date().toISOString();
    return date.toISOString();
  }

  function toNfeDecimal(value, decimals = 2) {
    const num = Number(value);
    const safe = Number.isFinite(num) ? num : 0;
    return safe.toFixed(decimals);
  }

  function splitPhone(raw) {
    const digits = String(raw || '').replace(/\D/g, '');
    if (!digits) return { ddd: '', number: '' };
    if (digits.length >= 10) return { ddd: digits.slice(0, 2), number: digits.slice(2) };
    return { ddd: '', number: digits };
  }

  function buildFallbackAddressFromStore(store, depositName) {
    const addressObj = store?.endereco || store?.enderecoFiscal || store?.address || store?.enderecos?.[0] || {};
    const street = pickFirstValue(
      addressObj.logradouro,
      addressObj.rua,
      addressObj.endereco,
      store?.logradouro,
      store?.rua,
      store?.endereco,
      depositName ? `Deposito ${depositName}` : ''
    );
    const number = pickFirstValue(addressObj.numero, store?.numero, 'S/N');
    const complement = pickFirstValue(addressObj.complemento, store?.complemento);
    const bairro = pickFirstValue(addressObj.bairro, store?.bairro);
    const city = pickFirstValue(addressObj.cidade, addressObj.municipio, store?.cidade, store?.municipio, 'RIO DE JANEIRO');
    const uf = pickFirstValue(addressObj.uf, store?.uf, 'RJ').toUpperCase();
    const cep = String(pickFirstValue(addressObj.cep, store?.cep)).replace(/\D/g, '');
    const phone = splitPhone(pickFirstValue(addressObj.telefone, store?.telefone, store?.celular));
    return { street, number, complement, bairro, city, uf, cep, phone };
  }

  function buildTransferDanfeAccessKey(number) {
    const dt = new Date();
    const year = String(dt.getFullYear()).slice(-2);
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const cnpjBase = '00000000000000';
    const model = '55';
    const serie = '001';
    const nNF = String(Number(number) || 0).padStart(9, '0').slice(-9);
    const tpEmis = '1';
    const code = String(Date.now()).replace(/\D/g, '').slice(-8).padStart(8, '0');
    const body43 = `35${year}${month}${cnpjBase}${model}${serie}${nNF}${tpEmis}${code}`.slice(0, 43);
    let weight = 2;
    let sum = 0;
    for (let i = body43.length - 1; i >= 0; i--) {
      sum += Number(body43[i]) * weight;
      weight = weight === 9 ? 2 : weight + 1;
    }
    const mod = sum % 11;
    const dv = mod === 0 || mod === 1 ? 0 : 11 - mod;
    return `${body43}${dv}`;
  }

  async function ensureDanfeItemsNcmLoaded() {
    const items = Array.isArray(state.items) ? state.items : [];
    const missingItems = items.filter(
      (item) => item?.productId && !normalizeDigits(item?.ncm).slice(0, 8),
    );
    if (!missingItems.length) return;

    const cache = new Map();
    await Promise.all(
      missingItems.map(async (item) => {
        const productId = String(item.productId || '').trim();
        if (!productId) return;
        if (!cache.has(productId)) {
          cache.set(productId, fetchProductDetails(productId).catch(() => null));
        }
        const product = await cache.get(productId);
        const ncm = normalizeDigits(product?.ncm).slice(0, 8);
        if (ncm) {
          item.ncm = ncm;
        }
        if (!Number.isFinite(Number(item?.unitWeight)) && Number.isFinite(Number(product?.unitWeight))) {
          item.unitWeight = Number(product.unitWeight);
        }
      }),
    );
  }

  async function buildTransferDanfeXmlFromCurrentState() {
    const numberValue = selectors.numberInput?.value?.trim();
    const transferNumber = Number(numberValue) || state.currentTransferNumber || state.autoGeneratedNumber || 1;
    const requestDate = selectors.dateInput?.value || new Date().toISOString();
    const originCompanyId = selectors.originCompany?.value || '';
    const originDepositId = selectors.originDeposit?.value || '';
    const destinationCompanyId = selectors.destinationCompany?.value || '';
    const destinationDepositId = selectors.destinationDeposit?.value || '';

    const originStore = state.stores.find((item) => String(item?._id) === String(originCompanyId)) || null;
    const destinationStore = state.stores.find((item) => String(item?._id) === String(destinationCompanyId)) || null;
    const originDeposit = state.deposits.find((item) => String(item?._id) === String(originDepositId)) || null;
    const destinationDeposit = state.deposits.find((item) => String(item?._id) === String(destinationDepositId)) || null;
    const responsible = state.responsaveis.find((item) => String(item?._id) === String(selectors.responsibleId?.value || '')) || null;

    const required = [requestDate, originCompanyId, originDepositId, destinationCompanyId, destinationDepositId];
    if (required.some((value) => !String(value || '').trim())) {
      throw new Error('Preencha origem, destino e data para imprimir a DANFE.');
    }
    if (!Array.isArray(state.items) || !state.items.length) {
      throw new Error('Adicione ao menos um item para imprimir a DANFE.');
    }

    const emitName = pickFirstValue(originStore?.razaoSocial, originStore?.nomeFantasia, originStore?.nome, 'Empresa de origem');
    const emitFant = pickFirstValue(originStore?.nomeFantasia, originStore?.nome);
    const emitCnpj = normalizeDigits(originStore?.cnpj).padStart(14, '0').slice(-14);
    const emitIe = pickFirstValue(originStore?.inscricaoEstadual, originStore?.ie, 'ISENTO');
    const emitAddress = buildFallbackAddressFromStore(originStore, originDeposit?.nome);

    const destName = pickFirstValue(destinationStore?.razaoSocial, destinationStore?.nomeFantasia, destinationStore?.nome, 'Empresa de destino');
    const destCnpj = normalizeDigits(destinationStore?.cnpj).padStart(14, '0').slice(-14);
    const destIe = pickFirstValue(destinationStore?.inscricaoEstadual, destinationStore?.ie, 'ISENTO');
    const destAddress = buildFallbackAddressFromStore(destinationStore, destinationDeposit?.nome);

    const totalProducts = state.items.reduce((sum, item) => {
      const qty = Number(item?.quantity);
      const unitCost = Number(item?.unitCost);
      const unitSale = Number(item?.unitSale);
      const unitValue = Number.isFinite(unitCost) ? unitCost : (Number.isFinite(unitSale) ? unitSale : 0);
      return Number.isFinite(qty) ? sum + qty * unitValue : sum;
    }, 0);

    const totalVolume = state.items.reduce((sum, item) => {
      const qty = Number(item?.quantity);
      return Number.isFinite(qty) ? sum + qty : sum;
    }, 0);
    const totalWeight = state.items.reduce((sum, item) => {
      const qty = Number(item?.quantity);
      const unitWeight = Number(item?.unitWeight);
      if (!Number.isFinite(qty) || !Number.isFinite(unitWeight)) return sum;
      return sum + qty * unitWeight;
    }, 0);

    const adicionais = [
      'DOCUMENTO INTERNO DE TRANSFERENCIA - SEM VALOR FISCAL.',
      originDeposit?.nome ? `DEPOSITO ORIGEM: ${originDeposit.nome}` : '',
      destinationDeposit?.nome ? `DEPOSITO DESTINO: ${destinationDeposit.nome}` : '',
      selectors.referenceInput?.value ? `DOC REF: ${selectors.referenceInput.value}` : '',
      selectors.driverInput?.value ? `MOTORISTA: ${selectors.driverInput.value}` : '',
      responsible ? `RESPONSAVEL: ${pickFirstValue(responsible?.nomeCompleto, responsible?.apelido, responsible?.email)}` : '',
      selectors.notesInput?.value || '',
    ].filter(Boolean).join(' ');

    const chave = buildTransferDanfeAccessKey(transferNumber);
    const dhEmi = toIsoDateTimeForDanfe(requestDate);
    const vehiclePlate = pickFirstValue(selectors.vehicleInput?.value);
    const driverName = pickFirstValue(selectors.driverInput?.value);

    await ensureDanfeItemsNcmLoaded();

    const itemXml = state.items.map((item, index) => {
      const qty = Number(item?.quantity);
      const quantity = Number.isFinite(qty) && qty > 0 ? qty : 0;
      const unitCost = Number(item?.unitCost);
      const unitSale = Number(item?.unitSale);
      const unitValue = Number.isFinite(unitCost) ? unitCost : (Number.isFinite(unitSale) ? unitSale : 0);
      const total = Math.round(quantity * unitValue * 100) / 100;
      const sku = pickFirstValue(item?.sku, item?.productId, String(index + 1));
      const desc = pickFirstValue(item?.description, 'Produto sem descricao');
      const unit = pickFirstValue(item?.unit, 'UN').toUpperCase();
      const ncm = normalizeDigits(item?.ncm).slice(0, 8) || '00000000';
      const cfop = pickFirstValue(item?.cfop, '5152');
      return `
        <det nItem="${index + 1}">
          <prod>
            <cProd>${escapeXml(sku)}</cProd>
            <xProd>${escapeXml(desc)}</xProd>
            <NCM>${escapeXml(ncm)}</NCM>
            <CFOP>${escapeXml(cfop)}</CFOP>
            <uCom>${escapeXml(unit)}</uCom>
            <qCom>${toNfeDecimal(quantity, 4)}</qCom>
            <vUnCom>${toNfeDecimal(unitValue, 3)}</vUnCom>
            <vProd>${toNfeDecimal(total, 2)}</vProd>
          </prod>
          <imposto>
            <ICMS><ICMS00><orig>0</orig><CST>00</CST><modBC>3</modBC><vBC>0.00</vBC><pICMS>0.00</pICMS><vICMS>0.00</vICMS></ICMS00></ICMS>
            <IPI><IPITrib><CST>99</CST><vBC>0.00</vBC><pIPI>0.00</pIPI><vIPI>0.00</vIPI></IPITrib></IPI>
          </imposto>
        </det>`;
    }).join('');

    return `<?xml version="1.0" encoding="UTF-8"?>
<nfeProc>
  <NFe>
    <infNFe Id="NFe${chave}">
      <ide>
        <cUF>35</cUF>
        <natOp>Transferencia entre depositos</natOp>
        <mod>55</mod>
        <serie>1</serie>
        <nNF>${Math.max(1, Number(transferNumber) || 1)}</nNF>
        <dhEmi>${escapeXml(dhEmi)}</dhEmi>
        <dhSaiEnt>${escapeXml(dhEmi)}</dhSaiEnt>
        <tpNF>1</tpNF>
        <tpAmb>2</tpAmb>
      </ide>
      <emit>
        <xNome>${escapeXml(emitName)}</xNome>
        <xFant>${escapeXml(emitFant)}</xFant>
        <CNPJ>${emitCnpj}</CNPJ>
        <IE>${escapeXml(emitIe)}</IE>
        <enderEmit>
          <xLgr>${escapeXml(emitAddress.street)}</xLgr>
          <nro>${escapeXml(emitAddress.number)}</nro>
          <xCpl>${escapeXml(emitAddress.complement)}</xCpl>
          <xBairro>${escapeXml(emitAddress.bairro)}</xBairro>
          <xMun>${escapeXml(emitAddress.city)}</xMun>
          <UF>${escapeXml(emitAddress.uf)}</UF>
          <CEP>${escapeXml(emitAddress.cep)}</CEP>
        </enderEmit>
      </emit>
      <dest>
        <xNome>${escapeXml(destName)}</xNome>
        <CNPJ>${destCnpj}</CNPJ>
        <IE>${escapeXml(destIe)}</IE>
        <fone>${escapeXml(destAddress.phone.ddd + destAddress.phone.number)}</fone>
        <enderDest>
          <xLgr>${escapeXml(destAddress.street)}</xLgr>
          <nro>${escapeXml(destAddress.number)}</nro>
          <xCpl>${escapeXml(destAddress.complement)}</xCpl>
          <xBairro>${escapeXml(destAddress.bairro)}</xBairro>
          <xMun>${escapeXml(destAddress.city)}</xMun>
          <UF>${escapeXml(destAddress.uf)}</UF>
          <CEP>${escapeXml(destAddress.cep)}</CEP>
        </enderDest>
      </dest>
      ${itemXml}
      <total>
        <ICMSTot>
          <vBC>0.00</vBC><vICMS>0.00</vICMS><vBCST>0.00</vBCST><vST>0.00</vST>
          <vProd>${toNfeDecimal(totalProducts, 2)}</vProd><vFrete>0.00</vFrete><vSeg>0.00</vSeg><vDesc>0.00</vDesc><vOutro>0.00</vOutro>
          <vIPI>0.00</vIPI><vTotTrib>0.00</vTotTrib><vNF>${toNfeDecimal(totalProducts, 2)}</vNF>
        </ICMSTot>
      </total>
      <transp>
        <modFrete>9</modFrete>
        <transporta>
          <xNome>${escapeXml(driverName || 'NAO INFORMADO')}</xNome>
          <xEnder>${escapeXml(vehiclePlate)}</xEnder>
          <xMun>${escapeXml(destAddress.city)}</xMun>
          <UF>${escapeXml(destAddress.uf)}</UF>
        </transporta>
        <vol><qVol>${toNfeDecimal(totalVolume, 0)}</qVol><esp>VOLUMES</esp><marca>TRANSFERENCIA</marca><pesoB>${toNfeDecimal(totalWeight, 3)}</pesoB></vol>
      </transp>
      <infAdic><infCpl>${escapeXml(adicionais)}</infCpl></infAdic>
    </infNFe>
  </NFe>
</nfeProc>`;
  }

  async function handlePrintDanfeClick() {
    try {
      const xmlText = await buildTransferDanfeXmlFromCurrentState();
      const xmlDoc = parseXml(xmlText);
      if (!xmlDoc || xmlDoc.querySelector('parsererror')) {
        throw new Error('Nao foi possivel montar a DANFE da transferencia.');
      }
      const chave = (xmlDoc.querySelector('infNFe')?.getAttribute('Id') || '').replace(/^NFe/, '');
      const html = buildDanfeHtml(xmlDoc, { mode: 'full' });
      openPrintWindow(html, 'DANFE', { withBarcode: true, chave });
    } catch (error) {
      console.error('Erro ao imprimir DANFE da transferencia:', error);
      showModal({
        title: 'Erro ao imprimir',
        message: error.message || 'Nao foi possivel gerar a DANFE da transferencia.',
        confirmText: 'Entendi',
      });
    }
  }
  function parseXml(xmlText) {
    const parser = new DOMParser();
    return parser.parseFromString(xmlText || '', 'text/xml');
  }

  function xmlGetText(node, selector) {
    if (!node) return '';
    const target = selector ? node.querySelector(selector) : node;
    return target?.textContent?.trim() || '';
  }

  function parseXmlNumber(raw) {
    if (typeof raw === 'number') return raw;
    const value = String(raw || '').trim();
    if (!value) return 0;
    const hasComma = value.includes(',');
    const hasDot = value.includes('.');
    let normalized = value;
    if (hasComma && hasDot) {
      normalized = value.replace(/\./g, '').replace(',', '.');
    } else if (hasComma) {
      normalized = value.replace(/\./g, '').replace(',', '.');
    } else if (hasDot) {
      normalized = value.replace(/,/g, '');
    } else {
      normalized = value;
    }
    normalized = normalized.replace(/[^\d.-]/g, '');
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : 0;
  }

  function formatNumber(value, decimals = 2) {
    const num = parseXmlNumber(value);
    return Number.isFinite(num) ? num.toFixed(decimals).replace('.', ',') : '0,00';
  }

  function formatBRL(value) {
    return formatNumber(value, 2);
  }

  function formatDateTime(iso) {
    if (!iso) return '';
    const normalized = iso.replace('T', ' ');
    return normalized.length > 19 ? normalized.slice(0, 19) : normalized;
  }


  function onlyDigits(value) {
    return String(value || '').replace(/\D/g, '');
  }

  function formatCep(value) {
    const digits = onlyDigits(value);
    return digits ? digits.slice(0, 8) : '';
  }

  function formatChave(value) {
    const digits = onlyDigits(value);
    if (!digits) return '';
    return digits.replace(/(.{4})/g, '$1 ').trim();
  }

  function formatDateTimeBR(value) {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return formatDateTime(String(value));
    }
    const pad = (num) => String(num).padStart(2, '0');
    return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(
      date.getHours(),
    )}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
  }

  function buildDanfeHtml(xmlDoc, { mode = 'full' } = {}) {
    const infNFe = xmlDoc.querySelector('infNFe');
    const ide = xmlDoc.querySelector('ide');
    const emit = xmlDoc.querySelector('emit');
    const dest = xmlDoc.querySelector('dest');
    const total = xmlDoc.querySelector('total ICMSTot');
    const prot = xmlDoc.querySelector('protNFe infProt');
    const transp = xmlDoc.querySelector('transp');
    const volumes = Array.from(xmlDoc.querySelectorAll('vol'));
    const cobr = xmlDoc.querySelector('cobr');
    const dupList = Array.from(xmlDoc.querySelectorAll('dup'));
    const dets = Array.from(xmlDoc.querySelectorAll('det'));

    const modeKey = mode === 'simple' || mode === 'simplified' ? 'simple' : 'full';
    const chave = (infNFe?.getAttribute('Id') || '').replace(/^NFe/, '');
    const chaveFormatada = formatChave(chave);
    const numero = xmlGetText(ide, 'nNF');
    const serie = xmlGetText(ide, 'serie');
    const natOp = xmlGetText(ide, 'natOp');
    const naturezaCodigo = xmlGetText(dets[0]?.querySelector('prod'), 'CFOP');
    const naturezaDescricao = natOp;
    const naturezaLabel =
      naturezaCodigo && naturezaDescricao
        ? normalizeDigits(naturezaDescricao).startsWith(naturezaCodigo)
          ? naturezaDescricao
          : `${naturezaCodigo} - ${naturezaDescricao}`
        : naturezaDescricao || naturezaCodigo || '';
    const dhEmiRaw = xmlGetText(ide, 'dhEmi') || xmlGetText(ide, 'dEmi');
    const dhEmi = formatDateTimeBR(dhEmiRaw);
    const tpNF = xmlGetText(ide, 'tpNF');
    const tpAmb = xmlGetText(ide, 'tpAmb');
    const mod = xmlGetText(ide, 'mod');
    const dhSaiEntRaw = xmlGetText(ide, 'dhSaiEnt') || '';
    const dSaiEnt = xmlGetText(ide, 'dSaiEnt');
    const hSaiEnt = xmlGetText(ide, 'hSaiEnt');
    const saidaDateTime = dhSaiEntRaw ? formatDateTimeBR(dhSaiEntRaw) : '';
    const saidaDate = saidaDateTime ? saidaDateTime.split(' ')[0] : dSaiEnt || '';
    const saidaTime = saidaDateTime ? saidaDateTime.split(' ')[1] : hSaiEnt || '';
    const protocolo = prot
      ? `${xmlGetText(prot, 'nProt')} - ${formatDateTimeBR(xmlGetText(prot, 'dhRecbto'))}`
      : 'SEM PROTOCOLO';
    const adicionais = xmlGetText(xmlDoc, 'infAdic infCpl') || xmlGetText(xmlDoc, 'infAdic infAdFisco') || '';
    const isHomologacao = tpAmb === '2';
    const emitFant = xmlGetText(emit, 'xFant');
    const emitFantHtml = emitFant ? `<div>${emitFant}</div>` : '';
    const homologRowFull = isHomologacao
      ? '<tr><td colspan="4" class="homolog">NF-e EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL</td></tr>'
      : '';
    const homologRowSimple = isHomologacao
      ? '<tr><td colspan="3" class="homolog">NF-e EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL</td></tr>'
      : '';

    const emitAddressLine = [
      xmlGetText(emit, 'enderEmit xLgr'),
      xmlGetText(emit, 'enderEmit nro'),
      xmlGetText(emit, 'enderEmit xCpl'),
      xmlGetText(emit, 'enderEmit xBairro'),
      xmlGetText(emit, 'enderEmit xMun'),
      xmlGetText(emit, 'enderEmit UF'),
    ]
      .filter(Boolean)
      .join(' - ');

    const emitCep = formatCep(xmlGetText(emit, 'enderEmit CEP'));

    const destStreet = xmlGetText(dest, 'enderDest xLgr');
    const destNumber = xmlGetText(dest, 'enderDest nro');
    const destComplement = xmlGetText(dest, 'enderDest xCpl');
    const destBairro = xmlGetText(dest, 'enderDest xBairro');
    const destMunicipio = xmlGetText(dest, 'enderDest xMun');
    const destUf = xmlGetText(dest, 'enderDest UF');
    const destCep = formatCep(xmlGetText(dest, 'enderDest CEP'));
    const destFone = xmlGetText(dest, 'fone') || xmlGetText(dest, 'enderDest fone');
    const destAddress = [
      destStreet,
      destNumber,
      destComplement,
      destBairro,
      destMunicipio && destUf ? `${destMunicipio} - ${destUf}` : destMunicipio || destUf,
    ]
      .filter(Boolean)
      .join(' - ');

    const transportName = xmlGetText(transp, 'transporta xNome');
    const transportDoc = xmlGetText(transp, 'transporta CNPJ') || xmlGetText(transp, 'transporta CPF');
    const transportIe = xmlGetText(transp, 'transporta IE');
    const transportAddress = xmlGetText(transp, 'transporta xEnder');
    const transportMun = xmlGetText(transp, 'transporta xMun');
    const transportUf = xmlGetText(transp, 'transporta UF');
    const modFrete = xmlGetText(transp, 'modFrete');

    const productsRows = dets
      .map((det, index) => {
        const prod = det.querySelector('prod');
        const imposto = det.querySelector('imposto');
        const icmsNode = imposto?.querySelector('ICMS')?.firstElementChild || null;
        const ipiNode = imposto?.querySelector('IPI')?.firstElementChild || null;
        const cst = xmlGetText(icmsNode, 'CST') || xmlGetText(icmsNode, 'CSOSN');
        const cfop = xmlGetText(prod, 'CFOP');
        const vBC = xmlGetText(icmsNode, 'vBC');
        const vICMS = xmlGetText(icmsNode, 'vICMS');
        const pICMS = xmlGetText(icmsNode, 'pICMS');
        const vIPI = xmlGetText(ipiNode, 'vIPI');
        const pIPI = xmlGetText(ipiNode, 'pIPI');
        return `
          <tr>
            <td class="center">${index + 1}</td>
            <td>${xmlGetText(prod, 'cProd')}</td>
            <td>${xmlGetText(prod, 'xProd')}</td>
            <td class="center ncm">${xmlGetText(prod, 'NCM')}</td>
            <td class="center">${cst || '0'}</td>
            <td class="center">${cfop}</td>
            <td class="center">${xmlGetText(prod, 'uCom')}</td>
            <td class="num">${formatNumber(xmlGetText(prod, 'qCom'), 4)}</td>
            <td class="num">${formatNumber(xmlGetText(prod, 'vUnCom'), 3)}</td>
            <td class="num">${formatNumber(xmlGetText(prod, 'vProd'), 2)}</td>
            <td class="num">${formatNumber(vBC, 2)}</td>
            <td class="num">${formatNumber(vICMS, 2)}</td>
            <td class="num">${formatNumber(vIPI, 2)}</td>
            <td class="num">${formatNumber(pICMS, 2)}</td>
            <td class="num">${formatNumber(pIPI, 2)}</td>
          </tr>
        `;
      })
      .join('');

    const dupCards = dupList.map(
      (dup) => `
        <table class="dup-card">
          <tr>
            <td class="label">Num.</td>
            <td class="value right">${xmlGetText(dup, 'nDup')}</td>
          </tr>
          <tr>
            <td class="label">Venc.</td>
            <td class="value right">${xmlGetText(dup, 'dVenc')}</td>
          </tr>
          <tr>
            <td class="label">Valor</td>
            <td class="value right">${formatBRL(xmlGetText(dup, 'vDup'))}</td>
          </tr>
        </table>
      `,
    );

    const dupGridRows = (() => {
      if (!dupCards.length) {
        return '<tr><td class="value">Sem duplicatas.</td></tr>';
      }
      const rows = [];
      const columns = 6;
      for (let i = 0; i < dupCards.length; i += columns) {
        const chunk = dupCards.slice(i, i + columns);
        rows.push(`<tr>${chunk.map((card) => `<td>${card}</td>`).join('')}</tr>`);
      }
      return rows.join('');
    })();

    const faturaHtml = cobr
      ? `
        <table class="block grid small">
          <colgroup>
            <col style="width:20%">
            <col style="width:30%">
            <col style="width:20%">
            <col style="width:30%">
          </colgroup>
          <tr>
            <td colspan="4" class="section-title">FATURA / DUPLICATA</td>
          </tr>
          <tr>
            <td class="label">Numero</td>
            <td class="value">${xmlGetText(cobr, 'fat nFat')}</td>
            <td class="label">Valor</td>
            <td class="value right">${formatBRL(xmlGetText(cobr, 'fat vLiq'))}</td>
          </tr>
          <tr>
            <td colspan="4" class="dup-grid-wrapper">
              <table class="dup-grid">
                <tbody>
                  ${dupGridRows}
                </tbody>
              </table>
            </td>
          </tr>
        </table>
      `
      : '';

    const volumesHtml = volumes.length
      ? volumes
          .map(
            (vol) => `
              <tr>
                <td>
                  <div class="label">Qtd</div>
                  <div class="value right">${xmlGetText(vol, 'qVol')}</div>
                </td>
                <td>
                  <div class="label">Especie</div>
                  <div class="value">${xmlGetText(vol, 'esp')}</div>
                </td>
                <td>
                  <div class="label">Marca</div>
                  <div class="value">${xmlGetText(vol, 'marca')}</div>
                </td>
                <td>
                  <div class="label">Peso Bruto</div>
                  <div class="value right">${xmlGetText(vol, 'pesoB')}</div>
                </td>
              </tr>
            `,
          )
          .join('')
      : `
        <tr>
          <td colspan="4" class="value">Sem volumes informados.</td>
        </tr>
      `;
    if (modeKey === 'simple') {
      return `<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Transferencia</title>
  <style>
    @page { size: A4; margin: 6mm; }
    body { font-family: Arial, Helvetica, sans-serif; font-size: 7.5pt; color: #111; line-height: 1.25; }
    table { width: 100%; border-collapse: collapse; }
    td, th { border: 1px solid #000; padding: 2px 3px; vertical-align: top; }
    .label { font-size: 6.3pt; text-transform: uppercase; }
    .value { font-size: 7.5pt; font-weight: 600; }
    .center { text-align: center; }
    .right { text-align: right; }
    .num { text-align: right; white-space: nowrap; }
    .block { margin-bottom: 4px; }
    .section-title { font-size: 6.5pt; font-weight: 700; text-transform: uppercase; text-align: center; }
    .barcode-box { display: flex; flex-direction: column; gap: 2px; }
    .barcode-fallback { border: 1px solid #000; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 7pt; }
    .homolog { font-weight: 700; text-align: center; }
    thead { display: table-header-group; }
    .items { table-layout: fixed; }
    .items thead th { background: #f5f5f5; }
    .items tbody tr { page-break-inside: avoid; }
    .items .ncm { font-size: 6.2pt; letter-spacing: -0.2px; white-space: nowrap; }
  </style>
</head>
<body>
  <table>
    <tr>
      <td colspan="3" class="section-title">TRANSFERENCIA</td>
    </tr>
    <tr>
      <td>
        <div class="label">Emitente</div>
        <div class="value">${xmlGetText(emit, 'xNome')}</div>
        <div>${emitAddressLine}</div>
      </td>
      <td class="center">
        <div class="label">Transferencia</div>
        <div class="value">N&#186; ${numero}</div>
        <div class="label">Serie</div>
        <div class="value">${serie}</div>
        <div class="label">Modelo</div>
        <div class="value">${mod || '55'}</div>
      </td>
      <td class="center">
        <div class="label">Chave de Acesso</div>
        <div class="value">${chaveFormatada}</div>
        <svg id="danfe-barcode"></svg>
        <div class="barcode-fallback" data-barcode-fallback>${chave}</div>
      </td>
    </tr>
    <tr>
      <td colspan="3">
        <div class="label">Destinatario</div>
        <div class="value">${xmlGetText(dest, 'xNome')}</div>
        <div>${destAddress}</div>
      </td>
    </tr>
    ${homologRowSimple}
    <tr>
      <td colspan="3" class="section-title">DADOS DOS PRODUTOS / SERVICOS</td>
    </tr>
  </table>
  <table class="items">
    <colgroup>
      <col style="width:6%">
      <col style="width:44%">
      <col style="width:12%">
      <col style="width:12%">
      <col style="width:12%">
      <col style="width:14%">
    </colgroup>
    <thead>
      <tr>
        <th class="center">Item</th>
        <th>Descricao</th>
        <th class="center">Qtde</th>
        <th class="center">V. Unit</th>
        <th class="center">V. Total</th>
        <th class="center">CFOP</th>
      </tr>
    </thead>
    <tbody>
      ${
        dets.length
          ? dets
              .map((det, index) => {
                const prod = det.querySelector('prod');
                return `
                  <tr>
                    <td class="center">${index + 1}</td>
                    <td>${xmlGetText(prod, 'xProd')}</td>
                    <td class="right">${formatNumber(xmlGetText(prod, 'qCom'), 4)}</td>
                    <td class="right">${formatNumber(xmlGetText(prod, 'vUnCom'), 3)}</td>
                    <td class="right">${formatNumber(xmlGetText(prod, 'vProd'), 2)}</td>
                    <td class="center">${xmlGetText(prod, 'CFOP')}</td>
                  </tr>
                `;
              })
              .join('')
          : '<tr><td colspan="6" class="center">Nenhum item informado.</td></tr>'
      }
    </tbody>
  </table>
  <table>
    <tr>
      <td>
        <div class="label">Total Transferencia</div>
        <div class="value right">${formatBRL(xmlGetText(total, 'vNF'))}</div>
      </td>
      <td>
        <div class="label">Data de Emissao</div>
        <div class="value">${dhEmi}</div>
      </td>
      <td>
        <div class="label">Protocolo</div>
        <div class="value">${protocolo}</div>
      </td>
    </tr>
  </table>
</body>
</html>`;
    }

    return `<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Transferencia</title>
  <style>
    @page { size: A4; margin: 6mm; }
    body { font-family: Arial, Helvetica, sans-serif; font-size: 7.5pt; color: #111; line-height: 1.25; }
    table { width: 100%; border-collapse: collapse; }
    td, th { border: 1px solid #000; padding: 2px 3px; vertical-align: top; }
    .danfe { width: 100%; }
    .label { font-size: 6.2pt; text-transform: uppercase; }
    .value { font-size: 7.5pt; font-weight: 600; }
    .center { text-align: center; }
    .right { text-align: right; }
    .num { text-align: right; white-space: nowrap; }
    .nowrap { white-space: nowrap; }
    .block { margin-bottom: 4px; }
    .small { font-size: 6.8pt; }
    .section-title { font-size: 6.5pt; font-weight: 700; text-transform: uppercase; text-align: center; }
    .muted { font-weight: 400; font-size: 6.5pt; }
    .barcode-box { display: flex; flex-direction: column; gap: 2px; }
    .barcode-fallback { border: 1px solid #000; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 7pt; }
    .homolog { font-weight: 700; text-align: center; font-size: 7.5pt; }
    .items { table-layout: fixed; }
    .items thead th { background: #f5f5f5; }
    .items tbody tr { page-break-inside: avoid; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    .danfe-box { display: flex; flex-direction: column; gap: 2px; align-items: stretch; }
    .danfe-title { font-size: 12pt; font-weight: 700; letter-spacing: 0.5px; }
    .danfe-subtitle { font-size: 6.5pt; text-transform: uppercase; }
    .danfe-entry-row { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    .danfe-entry-text { font-size: 6.5pt; text-transform: uppercase; text-align: left; line-height: 1.2; }
    .danfe-entry-box { width: 18px; height: 18px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 9pt; }
    .danfe-meta { font-size: 8pt; font-weight: 700; }
    .danfe-folha { font-size: 7pt; text-transform: uppercase; font-weight: 600; }
    .dup-grid { width: auto; border-collapse: collapse; table-layout: fixed; }
    .dup-grid td { border: 1px solid #000; padding: 1px 2px; vertical-align: top; width: 86px; text-align: left; }
    .dup-grid-wrapper { padding: 0; text-align: left; }
    .dup-card { width: 100%; border-collapse: collapse; font-size: 6pt; text-align: left; }
    .dup-card td { border: none; padding: 0 1px; line-height: 1.1; text-align: left; }
    .dup-card .label { font-size: 5.2pt; }
    .dup-card .value { font-size: 6pt; font-weight: 700; }
  </style>
</head>
<body>
  <div class="danfe">
    <table class="block">
      <colgroup>
        <col style="width:82%">
        <col style="width:18%">
      </colgroup>
      <tr>
        <td class="label">
          RECEBEMOS DE ${xmlGetText(emit, 'xNome')} OS PRODUTOS E/OU SERVICOS CONSTANTES DA NOTA FISCAL
          ELETRONICA INDICADA ABAIXO. EMISSAO: ${dhEmi} VALOR TOTAL: ${formatBRL(xmlGetText(total, 'vNF'))}
          DESTINATARIO: ${xmlGetText(dest, 'xNome')} - ${destAddress}
        </td>
        <td class="center" rowspan="2">
          <div class="section-title">Transferencia</div>
          <div class="value">N&#186; ${numero}</div>
          <div class="value">Serie ${serie}</div>
        </td>
      </tr>
      <tr>
        <td>
          <table style="width:100%; border-collapse:collapse;">
            <colgroup>
              <col style="width:20%">
              <col style="width:80%">
            </colgroup>
            <tr>
              <td style="height:14px; position:relative;">
                <span style="font-size:5pt; text-transform:uppercase; position:absolute; left:2px; bottom:2px;">Data de Recebimento</span>
              </td>
              <td style="height:14px; position:relative;">
                <span style="font-size:5pt; text-transform:uppercase; position:absolute; left:2px; bottom:2px;">Identificacao e Assinatura do Recebedor</span>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>

    <table class="block">
      <colgroup>
        <col style="width:46%">
        <col style="width:24%">
        <col style="width:30%">
      </colgroup>
      <tr>
        <td>
          <div class="section-title" style="font-style:italic;">Identificacao do Emitente</div>
          <div class="value">${xmlGetText(emit, 'xNome')}</div>
          ${emitFantHtml}
          <div>${emitAddressLine}</div>
          <div class="muted">CEP ${emitCep}</div>
          <div class="muted">CNPJ ${xmlGetText(emit, 'CNPJ')}</div>
          <div class="muted">IE ${xmlGetText(emit, 'IE')}</div>
        </td>
        <td class="center">
          <div class="danfe-box">
            <div class="danfe-title">Transferencia</div>
            <div class="danfe-subtitle">Documento Auxiliar da Transferencia</div>
            <div class="danfe-entry-row">
              <div class="danfe-entry-text">
                0 - ENTRADA<br>
                1 - SAIDA
              </div>
              <div class="danfe-entry-box">${tpNF || ''}</div>
            </div>
            <div class="danfe-meta">N&#186; ${numero}</div>
            <div class="danfe-meta">Serie ${serie}</div>
            <div class="danfe-folha">Folha 1/1</div>
          </div>
        </td>
        <td>
          <table style="width:100%; border-collapse:collapse;">
            <tr>
              <td style="border:1px solid #000; padding:2px 3px;">
                <div class="barcode-box">
                  <svg id="danfe-barcode"></svg>
                  <div class="barcode-fallback" data-barcode-fallback>${chave}</div>
                </div>
              </td>
            </tr>
            <tr>
              <td style="border:1px solid #000; padding:2px 3px;">
                <div class="label center">Chave de Acesso</div>
                <div class="value center">${chaveFormatada}</div>
              </td>
            </tr>
            <tr>
              <td style="border:1px solid #000; padding:2px 3px;">
                <div class="muted center">
                  Consulta de autenticidade no portal nacional da NF-e
                  www.nfe.fazenda.gov.br/portal
                  ou no site da SEFAZ Autorizadora
                </div>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>

    <table class="block">
      <colgroup>
        <col style="width:70%">
        <col style="width:30%">
      </colgroup>
      <tr>
        <td>
          <div class="label">Natureza da Operacao</div>
          <div class="value">${naturezaLabel}</div>
        </td>
        <td>
          <div class="label">Protocolo de Autorizacao de Uso</div>
          <div class="value">${protocolo}</div>
        </td>
      </tr>
    </table>

    <table class="block">
      <colgroup>
        <col style="width:48%">
        <col style="width:17%">
        <col style="width:13%">
        <col style="width:22%">
      </colgroup>
      <tr>
        <td>
          <div class="label">Destinatario / Remetente</div>
          <div class="value">${xmlGetText(dest, 'xNome')}</div>
        </td>
        <td>
          <div class="label">CNPJ/CPF</div>
          <div class="value">${xmlGetText(dest, 'CPF') || xmlGetText(dest, 'CNPJ')}</div>
        </td>
        <td>
          <div class="label">IE</div>
          <div class="value">${xmlGetText(dest, 'IE')}</div>
        </td>
        <td>
          <div class="label">Data Emissao</div>
          <div class="value">${dhEmi}</div>
        </td>
      </tr>
      <tr>
        <td>
          <div class="label">Endereco</div>
          <div class="value">${[destStreet, destNumber, destComplement].filter(Boolean).join(', ')}</div>
        </td>
        <td>
          <div class="label">Bairro</div>
          <div class="value">${destBairro}</div>
        </td>
        <td>
          <div class="label">CEP</div>
          <div class="value">${destCep}</div>
        </td>
        <td>
          <div class="label">Data Saida/Entrada</div>
          <div class="value">${saidaDate}</div>
        </td>
      </tr>
      <tr>
        <td>
          <div class="label">Municipio</div>
          <div class="value">${destMunicipio}</div>
        </td>
        <td>
          <div class="label">UF</div>
          <div class="value">${destUf}</div>
        </td>
        <td>
          <div class="label">Fone/Fax</div>
          <div class="value">${destFone}</div>
        </td>
        <td>
          <div class="label">Hora Saida/Entrada</div>
          <div class="value">${saidaTime}</div>
        </td>
      </tr>
      ${homologRowFull}
    </table>

    ${faturaHtml}

    <table class="block">
      <colgroup>
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
        <col style="width:8.33%">
      </colgroup>
      <tr>
        <td colspan="12" class="section-title">Calculo do Imposto</td>
      </tr>
      <tr>
        <td class="label">BC ICMS</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vBC'))}</td>
        <td class="label">V. ICMS</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vICMS'))}</td>
        <td class="label">BC ICMS ST</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vBCST'))}</td>
        <td class="label">V. ICMS ST</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vST'))}</td>
        <td class="label">V. IPI</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vIPI'))}</td>
        <td class="label">V. Total Transferencia</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vNF'))}</td>
      </tr>
      <tr>
        <td class="label">V. Frete</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vFrete'))}</td>
        <td class="label">V. Seguro</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vSeg'))}</td>
        <td class="label">Desconto</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vDesc'))}</td>
        <td class="label">Outras Desp.</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vOutro'))}</td>
        <td class="label">V. Produtos</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vProd'))}</td>
        <td class="label">V. Tot. Trib.</td>
        <td class="value right">${formatBRL(xmlGetText(total, 'vTotTrib'))}</td>
      </tr>
    </table>

    <table class="block small">
      <colgroup>
        <col style="width:35%">
        <col style="width:15%">
        <col style="width:15%">
        <col style="width:35%">
      </colgroup>
      <tr>
        <td colspan="4" class="section-title">Transportador / Volumes Transportados</td>
      </tr>
      <tr>
        <td>
          <div class="label">Nome / Razao Social</div>
          <div class="value">${transportName}</div>
        </td>
        <td>
          <div class="label">Frete</div>
          <div class="value">${modFrete}</div>
        </td>
        <td>
          <div class="label">CNPJ/CPF</div>
          <div class="value">${transportDoc}</div>
        </td>
        <td>
          <div class="label">Endereco</div>
          <div class="value">${transportAddress}</div>
        </td>
      </tr>
      <tr>
        <td>
          <div class="label">Municipio</div>
          <div class="value">${transportMun}</div>
        </td>
        <td>
          <div class="label">UF</div>
          <div class="value">${transportUf}</div>
        </td>
        <td>
          <div class="label">IE</div>
          <div class="value">${transportIe}</div>
        </td>
        <td></td>
      </tr>
      ${volumesHtml}
    </table>

    <table class="items">
      <colgroup>
        <col style="width:4%">
        <col style="width:6%">
        <col style="width:22%">
        <col style="width:6%">
        <col style="width:5%">
        <col style="width:5%">
        <col style="width:4%">
        <col style="width:6%">
        <col style="width:7%">
        <col style="width:7%">
        <col style="width:7%">
        <col style="width:6%">
        <col style="width:5%">
        <col style="width:5%">
        <col style="width:5%">
      </colgroup>
      <thead>
        <tr>
          <th class="center">Item</th>
          <th class="center">Cod</th>
          <th>Descricao</th>
          <th class="center ncm">NCM</th>
          <th class="center">CST</th>
          <th class="center">CFOP</th>
          <th class="center">UN</th>
          <th class="center">QTD</th>
          <th class="center">V. Unit</th>
          <th class="center">V. Total</th>
          <th class="center">BC ICMS</th>
          <th class="center">V. ICMS</th>
          <th class="center">V. IPI</th>
          <th class="center">Aliq ICMS</th>
          <th class="center">Aliq IPI</th>
        </tr>
      </thead>
      <tbody>
        ${productsRows || '<tr><td colspan="15" class="center">Nenhum item informado.</td></tr>'}
      </tbody>
    </table>

    <table class="block">
      <colgroup>
        <col style="width:75%">
        <col style="width:25%">
      </colgroup>
      <tr>
        <td class="section-title">Dados Adicionais</td>
        <td class="section-title">Reservado ao Fisco</td>
      </tr>
      <tr>
        <td>${adicionais || 'Sem informacoes adicionais.'}</td>
        <td></td>
      </tr>
    </table>
  </div>
</body>
</html>`;
  }

  function openPrintWindow(html, title, { withBarcode = false, chave = '' } = {}) {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      throw new Error('Nao foi possivel abrir a janela de impressao.');
    }
    printWindow.document.open();
    printWindow.document.write(html);
    printWindow.document.close();
    if (withBarcode && chave) {
      const script = printWindow.document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
      script.onload = () => {
        try {
          const svg = printWindow.document.getElementById('danfe-barcode');
          if (svg && typeof printWindow.JsBarcode === 'function') {
            printWindow.JsBarcode(svg, chave, {
              format: 'CODE128',
              displayValue: false,
              height: 48,
              margin: 0,
              width: 1.2,
            });
            const fallback = printWindow.document.querySelector('[data-barcode-fallback]');
            if (fallback) fallback.style.display = 'none';
          }
        } catch (_) {
          // ignore
        } finally {
          printWindow.focus();
          setTimeout(() => printWindow.print(), 250);
        }
      };
      script.onerror = () => {
        printWindow.focus();
        setTimeout(() => printWindow.print(), 250);
      };
      printWindow.document.head.appendChild(script);
    } else {
      printWindow.focus();
      setTimeout(() => printWindow.print(), 250);
    }
  }


  function attachFormEvents() {
    selectors.originCompany?.addEventListener('change', () => {
      updateDepositSelect(selectors.originCompany, selectors.originDeposit);
      renderSelectedProduct();
    });

    selectors.destinationCompany?.addEventListener('change', () => {
      updateDepositSelect(selectors.destinationCompany, selectors.destinationDeposit);
      renderSelectedProduct();
    });

    selectors.originDeposit?.addEventListener('change', () => {
      renderSelectedProduct();
    });

    selectors.destinationDeposit?.addEventListener('change', () => {
      renderSelectedProduct();
    });

    selectors.form?.addEventListener('submit', handleSubmit);
    selectors.clearButton?.addEventListener('click', handleClearButtonClick);
    selectors.printButton?.addEventListener('click', handlePrintDanfeClick);
  }

  function init() {
    setFormReadOnly(false);
    setTodayDate();
    attachTableListeners();
    attachProductSearchEvents();
    attachSelectedProductControls();
    attachFormEvents();
    attachNumberInputEvents();
    handleResponsibleInputEvents();
    resetProductSearch();
    renderItemsTable();
    loadFormData().finally(() => {
      if (!state.currentTransferId) {
        fetchNextTransferNumber();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', init);
})();
